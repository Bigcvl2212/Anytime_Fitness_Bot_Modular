{% extends "base.html" %}

{% block title %}Members - Anytime Fitness Club Management{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link.active {
        font-weight: 600;
        color: #0d6efd !important;
        border-bottom: 2px solid #0d6efd;
        background-color: transparent;
    }
    
    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-radius: 0;
        padding: 1rem 1.5rem;
    }
    
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        border-color: transparent;
    }
    
    .tab-content {
        padding: 2rem 0;
    }
    
    .member-card {
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        margin-bottom: 1rem;
    }
    
    .member-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        border-color: #0d6efd;
    }
    
    .member-card.selected {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .count-display {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .status-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .member-detail-sidebar {
        position: fixed;
        top: 0;
        right: -500px;
        width: 500px;
        height: 100vh;
        background: white;
        box-shadow: -3px 0 15px rgba(0,0,0,0.1);
        z-index: 1050;
        transition: right 0.3s ease;
        overflow-y: auto;
    }
    
    .member-detail-sidebar.show {
        right: 0;
    }
    
    .sidebar-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0,0,0,0.5);
        z-index: 1040;
        display: none;
    }
    
    .sidebar-overlay.show {
        display: block;
    }
    
    .message-thread {
        border-left: 3px solid #0d6efd;
        padding-left: 1rem;
        margin-bottom: 1rem;
    }
    
    .message-bubble {
        max-width: 80%;
        padding: 0.75rem 1rem;
        border-radius: 1rem;
        margin-bottom: 0.5rem;
    }
    
    .message-outbound {
        background: #0d6efd;
        color: white;
        margin-left: auto;
        border-bottom-right-radius: 0.25rem;
    }
    
    .message-inbound {
        background: #f8f9fa;
        color: #212529;
        border-bottom-left-radius: 0.25rem;
    }
    
    .funding-status-funded {
        background: #d1e7dd;
        color: #0f5132;
        border: 1px solid #badbcc;
    }
    
    .funding-status-past-due {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c2c7;
    }
    
    .funding-status-unknown {
        background: #e2e3e5;
        color: #41464b;
        border: 1px solid #c4c8cc;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Member Management
                    </h1>
                    <p class="text-muted mb-0">Manage and view all club members with enhanced filtering</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-outline-primary" onclick="startBulkCheckIn()">
                        <i class="fas fa-sign-in-alt me-1"></i>
                        Bulk Check-In
                    </button>
                    <button class="btn btn-primary" onclick="refreshMemberData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter and Search Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Search Members</label>
                            <div class="input-group">
                                <input type="text" id="memberSearch" class="form-control" placeholder="Name, email, or phone...">
                                <button class="btn btn-outline-secondary" onclick="searchMembers()">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Status Filter</label>
                            <select id="statusFilter" class="form-select" onchange="filterMembers()">
                                <option value="">All Members</option>
                                <option value="active">Active</option>
                                <option value="ppv">Pay Per Visit</option>
                                <option value="comp">Complimentary</option>
                                <option value="frozen">Frozen/Hold</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Page Size</label>
                            <select id="pageSize" class="form-select" onchange="loadMembers()">
                                <option value="25">25 per page</option>
                                <option value="50" selected>50 per page</option>
                                <option value="100">100 per page</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <div>
                                <button class="btn btn-success w-100" onclick="showBatchInvoiceModal()">
                                    <i class="fas fa-file-invoice-dollar me-1"></i>
                                    Batch Invoice
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card stats-card">
                <div class="card-body text-center">
                    <div class="count-display" id="totalMembersCount">-</div>
                    <div>Total Members</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-success text-white">
                <div class="card-body text-center">
                    <div class="count-display" id="activeMembersCount">-</div>
                    <div>Active Members</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-warning text-dark">
                <div class="card-body text-center">
                    <div class="count-display" id="pastDueMembersCount">-</div>
                    <div>Past Due</div>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info text-white">
                <div class="card-body text-center">
                    <div class="count-display" id="frozenMembersCount">-</div>
                    <div>Frozen/Hold</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Members List -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-list me-2"></i>
                        Members Directory
                    </h5>
                    <div id="membersLoadingIndicator" style="display: none;">
                        <div class="spinner-border spinner-border-sm text-primary" role="status"></div>
                        <span class="ms-2">Loading...</span>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Members Container -->
                    <div id="membersContainer">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-3">Loading members...</p>
                        </div>
                    </div>
                    
                    <!-- Pagination -->
                    <div id="membersPagination" class="d-flex justify-content-between align-items-center mt-4" style="display: none !important;">
                        <div>
                            <span id="membersResultsInfo" class="text-muted"></span>
                        </div>
                        <div>
                            <nav>
                                <ul class="pagination mb-0" id="membersPaginationList">
                                    <!-- Pagination buttons will be inserted here -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Member Detail Sidebar -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeMemberDetail()"></div>
<div class="member-detail-sidebar" id="memberDetailSidebar">
    <div class="p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h4 class="mb-0" id="memberDetailName">Member Details</h4>
            <button class="btn btn-outline-secondary btn-sm" onclick="closeMemberDetail()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="memberDetailContent">
            <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-3">Loading member details...</p>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Check-In Status Modal -->
<div class="modal fade" id="bulkCheckInModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-sign-in-alt me-2"></i>
                    Bulk Member Check-In
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="bulkCheckInStatus">
                    <div class="text-center py-3">
                        <button class="btn btn-primary btn-lg" onclick="startBulkCheckInProcess()">
                            <i class="fas fa-play me-2"></i>
                            Start Bulk Check-In
                        </button>
                        <p class="text-muted mt-3">This will check in all eligible members (excluding PPV, comp, and frozen members)</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Batch Invoice Modal -->
<div class="modal fade" id="batchInvoiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-invoice-dollar me-2"></i>
                    Batch Invoice Creation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="batchInvoiceForm">
                    <div class="mb-3">
                        <label class="form-label">Target Members</label>
                        <select class="form-select" name="target_type">
                            <option value="members">All Members</option>
                            <option value="training_clients">Training Clients</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Filter Criteria</label>
                        <select class="form-select" name="filter">
                            <option value="past_due">Past Due Only</option>
                            <option value="all">All Selected Members</option>
                        </select>
                    </div>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        This will create Square invoices for all matching members. Please confirm you want to proceed.
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-warning" onclick="processBatchInvoices()">
                    <i class="fas fa-file-invoice me-1"></i>
                    Create Invoices
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentPage = 1;
let currentFilter = '';
let currentSearch = '';
let membersData = [];
let bulkCheckInInterval = null;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    loadMembers();
    loadMemberStats();
    
    // Auto-refresh bulk check-in status if modal is open
    $('#bulkCheckInModal').on('shown.bs.modal', function() {
        checkBulkCheckInStatus();
    });
    
    $('#bulkCheckInModal').on('hidden.bs.modal', function() {
        if (bulkCheckInInterval) {
            clearInterval(bulkCheckInInterval);
            bulkCheckInInterval = null;
        }
    });
});

// Load members with pagination and filtering
async function loadMembers(page = 1) {
    currentPage = page;
    const container = document.getElementById('membersContainer');
    const loadingIndicator = document.getElementById('membersLoadingIndicator');
    
    loadingIndicator.style.display = 'block';
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: document.getElementById('pageSize').value,
            status: currentFilter,
            search: currentSearch
        });
        
        const response = await fetch(`/api/members/list?${params}`);
        const data = await response.json();
        
        if (data.success) {
            membersData = data.members;
            renderMembers(data.members);
            renderPagination(data.pagination);
        } else {
            container.innerHTML = `<div class="alert alert-danger">Error loading members: ${data.error}</div>`;
        }
    } catch (error) {
        container.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
    } finally {
        loadingIndicator.style.display = 'none';
    }
}

// Render members list
function renderMembers(members) {
    const container = document.getElementById('membersContainer');
    
    if (!members || members.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-users fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No members found</h5>
                <p class="text-muted">Try adjusting your search or filter criteria</p>
            </div>
        `;
        return;
    }
    
    const membersHtml = members.map(member => `
        <div class="member-card card mb-3" onclick="showMemberDetail(${member.id})">
            <div class="card-body">
                <div class="row align-items-center">
                    <div class="col-md-4">
                        <h6 class="mb-1">${escapeHtml(member.full_name || 'Unknown Name')}</h6>
                        <p class="text-muted mb-0 small">
                            <i class="fas fa-envelope me-1"></i>
                            ${escapeHtml(member.email || 'No email')}
                        </p>
                    </div>
                    <div class="col-md-3">
                        <p class="mb-0 small">
                            <i class="fas fa-phone me-1"></i>
                            ${escapeHtml(member.mobile_phone || 'No phone')}
                        </p>
                    </div>
                    <div class="col-md-3">
                        ${renderMemberStatus(member)}
                    </div>
                    <div class="col-md-2 text-end">
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" onclick="event.stopPropagation(); showMemberDetail(${member.id})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline-success" onclick="event.stopPropagation(); createSingleInvoice(${member.id})">
                                <i class="fas fa-file-invoice"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = membersHtml;
}

// Render member status badge
function renderMemberStatus(member) {
    let badgeClass = 'bg-secondary';
    let statusText = 'Unknown';
    
    if (member.trial) {
        badgeClass = 'bg-info';
        statusText = 'Trial';
    } else if (member.status === 1) {
        badgeClass = 'bg-success';
        statusText = 'Active';
    } else if (member.status === 2 || member.status === 3) {
        badgeClass = 'bg-warning text-dark';
        statusText = 'Frozen';
    } else {
        badgeClass = 'bg-danger';
        statusText = 'Inactive';
    }
    
    return `<span class="badge ${badgeClass} status-badge">${statusText}</span>`;
}

// Render pagination
function renderPagination(pagination) {
    const paginationContainer = document.getElementById('membersPagination');
    const infoElement = document.getElementById('membersResultsInfo');
    const listElement = document.getElementById('membersPaginationList');
    
    if (!pagination || pagination.pages <= 1) {
        paginationContainer.style.display = 'none';
        return;
    }
    
    paginationContainer.style.display = 'flex';
    
    // Update results info
    const start = ((pagination.page - 1) * pagination.per_page) + 1;
    const end = Math.min(pagination.page * pagination.per_page, pagination.total);
    infoElement.textContent = `Showing ${start}-${end} of ${pagination.total} members`;
    
    // Generate pagination buttons
    let paginationHtml = '';
    
    // Previous button
    if (pagination.page > 1) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadMembers(${pagination.page - 1})">Previous</a></li>`;
    }
    
    // Page numbers
    const startPage = Math.max(1, pagination.page - 2);
    const endPage = Math.min(pagination.pages, pagination.page + 2);
    
    for (let i = startPage; i <= endPage; i++) {
        const active = i === pagination.page ? 'active' : '';
        paginationHtml += `<li class="page-item ${active}"><a class="page-link" href="#" onclick="loadMembers(${i})">${i}</a></li>`;
    }
    
    // Next button
    if (pagination.page < pagination.pages) {
        paginationHtml += `<li class="page-item"><a class="page-link" href="#" onclick="loadMembers(${pagination.page + 1})">Next</a></li>`;
    }
    
    listElement.innerHTML = paginationHtml;
}

// Load member statistics
async function loadMemberStats() {
    try {
        // Load counts for different member types
        const activeResponse = await fetch('/api/members/list?status=active&per_page=1');
        const activeData = await activeResponse.json();
        if (activeData.success) {
            document.getElementById('activeMembersCount').textContent = activeData.pagination.total;
        }
        
        // Similar calls for other stats...
        const totalResponse = await fetch('/api/members/list?per_page=1');
        const totalData = await totalResponse.json();
        if (totalData.success) {
            document.getElementById('totalMembersCount').textContent = totalData.pagination.total;
        }
    } catch (error) {
        console.error('Error loading member stats:', error);
    }
}

// Search and filter functions
function searchMembers() {
    currentSearch = document.getElementById('memberSearch').value;
    loadMembers(1);
}

function filterMembers() {
    currentFilter = document.getElementById('statusFilter').value;
    loadMembers(1);
}

function refreshMemberData() {
    loadMembers(currentPage);
    loadMemberStats();
}

// Member detail functions
async function showMemberDetail(memberId) {
    const sidebar = document.getElementById('memberDetailSidebar');
    const overlay = document.getElementById('sidebarOverlay');
    const content = document.getElementById('memberDetailContent');
    
    // Show sidebar
    sidebar.classList.add('show');
    overlay.classList.add('show');
    
    // Load member details
    try {
        const response = await fetch(`/api/members/${memberId}`);
        const data = await response.json();
        
        if (data.success) {
            renderMemberDetail(data.member);
        } else {
            content.innerHTML = `<div class="alert alert-danger">Error loading member details: ${data.error}</div>`;
        }
    } catch (error) {
        content.innerHTML = `<div class="alert alert-danger">Network error: ${error.message}</div>`;
    }
}

function closeMemberDetail() {
    document.getElementById('memberDetailSidebar').classList.remove('show');
    document.getElementById('sidebarOverlay').classList.remove('show');
}

function renderMemberDetail(member) {
    const content = document.getElementById('memberDetailContent');
    const nameElement = document.getElementById('memberDetailName');
    
    nameElement.textContent = member.full_name || 'Unknown Member';
    
    content.innerHTML = `
        <div class="member-detail-content">
            <!-- Basic Info -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-user me-2"></i>Basic Information</h6>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-12">
                            <strong>Email:</strong> ${escapeHtml(member.email || 'N/A')}
                        </div>
                        <div class="col-12">
                            <strong>Phone:</strong> ${escapeHtml(member.mobile_phone || 'N/A')}
                        </div>
                        <div class="col-12">
                            <strong>Status:</strong> ${renderMemberStatus(member)}
                        </div>
                        <div class="col-12">
                            <strong>Member Since:</strong> ${formatDate(member.created_at)}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Funding Status -->
            ${renderFundingStatus(member.funding_status)}
            
            <!-- Recent Transactions -->
            ${renderTransactionHistory(member.transactions)}
            
            <!-- Messaging -->
            ${renderMessagingHistory(member.message_threads)}
            
            <!-- Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-cogs me-2"></i>Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-success" onclick="createSingleInvoice(${member.id})">
                            <i class="fas fa-file-invoice me-2"></i>Create Invoice
                        </button>
                        <button class="btn btn-info" onclick="sendMessage(${member.id})">
                            <i class="fas fa-envelope me-2"></i>Send Message
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
}

function renderFundingStatus(funding) {
    if (!funding) {
        return `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Funding Status</h6>
                </div>
                <div class="card-body">
                    <span class="badge funding-status-unknown">No funding data available</span>
                </div>
            </div>
        `;
    }
    
    const statusClass = funding.payment_status === 'Current' ? 'funding-status-funded' : 
                       funding.payment_status === 'Past Due' ? 'funding-status-past-due' : 'funding-status-unknown';
    
    return `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-credit-card me-2"></i>Funding Status</h6>
            </div>
            <div class="card-body">
                <span class="badge ${statusClass} mb-2">${funding.payment_status || 'Unknown'}</span>
                <div class="small text-muted">
                    Last Updated: ${formatDate(funding.last_updated)}
                </div>
            </div>
        </div>
    `;
}

function renderTransactionHistory(transactions) {
    if (!transactions || transactions.length === 0) {
        return `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-history me-2"></i>Transaction History</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-0">No recent transactions</p>
                </div>
            </div>
        `;
    }
    
    const transactionsList = transactions.slice(0, 5).map(tx => `
        <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div>
                <div class="fw-medium">${escapeHtml(tx.description || tx.type)}</div>
                <small class="text-muted">${formatDate(tx.created_at)}</small>
            </div>
            <div class="text-end">
                <div class="fw-medium">$${(tx.amount || 0).toFixed(2)}</div>
                <small class="badge ${tx.status === 'paid' ? 'bg-success' : tx.status === 'sent' ? 'bg-warning' : 'bg-secondary'}">${tx.status}</small>
            </div>
        </div>
    `).join('');
    
    return `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-history me-2"></i>Recent Transactions</h6>
            </div>
            <div class="card-body">
                ${transactionsList}
            </div>
        </div>
    `;
}

function renderMessagingHistory(threads) {
    if (!threads || threads.length === 0) {
        return `
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Messages</h6>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-0">No recent messages</p>
                </div>
            </div>
        `;
    }
    
    const threadsList = threads.slice(0, 3).map(thread => `
        <div class="message-thread">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <strong>${escapeHtml(thread.thread_subject || thread.thread_type)}</strong>
                <small class="text-muted">${formatDate(thread.last_message_at)}</small>
            </div>
            ${thread.recent_messages ? thread.recent_messages.slice(0, 2).map(msg => `
                <div class="message-bubble ${msg.direction === 'outbound' ? 'message-outbound' : 'message-inbound'}">
                    ${escapeHtml(msg.message_content || '')}
                </div>
            `).join('') : ''}
        </div>
    `).join('');
    
    return `
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="fas fa-comments me-2"></i>Recent Messages</h6>
            </div>
            <div class="card-body">
                ${threadsList}
            </div>
        </div>
    `;
}

// Bulk operations
function startBulkCheckIn() {
    const modal = new bootstrap.Modal(document.getElementById('bulkCheckInModal'));
    modal.show();
}

async function startBulkCheckInProcess() {
    try {
        const response = await fetch('/api/bulk-checkin', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        });
        const data = await response.json();
        
        if (data.success) {
            // Start monitoring progress
            bulkCheckInInterval = setInterval(checkBulkCheckInStatus, 2000);
            checkBulkCheckInStatus();
        } else {
            alert('Error starting bulk check-in: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function checkBulkCheckInStatus() {
    try {
        const response = await fetch('/api/bulk-checkin-status');
        const data = await response.json();
        
        if (data.success) {
            updateBulkCheckInUI(data.status);
            
            if (!data.status.is_running) {
                if (bulkCheckInInterval) {
                    clearInterval(bulkCheckInInterval);
                    bulkCheckInInterval = null;
                }
            }
        }
    } catch (error) {
        console.error('Error checking bulk check-in status:', error);
    }
}

function updateBulkCheckInUI(status) {
    const container = document.getElementById('bulkCheckInStatus');
    
    if (!status.is_running && !status.completed_at) {
        // Not started yet
        return;
    }
    
    const progressPercent = status.progress || 0;
    const statusMessage = status.message || 'Processing...';
    
    container.innerHTML = `
        <div class="text-center">
            <div class="progress mb-3" style="height: 30px;">
                <div class="progress-bar progress-bar-striped ${status.is_running ? 'progress-bar-animated' : ''}" 
                     role="progressbar" style="width: ${progressPercent}%">
                    ${progressPercent}%
                </div>
            </div>
            <p class="mb-3">${escapeHtml(statusMessage)}</p>
            <div class="row text-center">
                <div class="col-3">
                    <strong>${status.total_members || 0}</strong><br>
                    <small class="text-muted">Total</small>
                </div>
                <div class="col-3">
                    <strong>${status.processed_members || 0}</strong><br>
                    <small class="text-muted">Processed</small>
                </div>
                <div class="col-3">
                    <strong>${status.total_checkins || 0}</strong><br>
                    <small class="text-muted">Checked In</small>
                </div>
                <div class="col-3">
                    <strong>${(status.ppv_excluded || 0) + (status.comp_excluded || 0) + (status.frozen_excluded || 0)}</strong><br>
                    <small class="text-muted">Excluded</small>
                </div>
            </div>
            ${status.completed_at ? `
                <div class="alert alert-success mt-3">
                    <i class="fas fa-check-circle me-2"></i>
                    Bulk check-in completed successfully!
                </div>
            ` : ''}
        </div>
    `;
}

// Invoice functions
function showBatchInvoiceModal() {
    const modal = new bootstrap.Modal(document.getElementById('batchInvoiceModal'));
    modal.show();
}

async function processBatchInvoices() {
    const form = document.getElementById('batchInvoiceForm');
    const formData = new FormData(form);
    
    try {
        const response = await fetch('/api/invoices/batch', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(Object.fromEntries(formData))
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`Batch invoicing completed. ${data.summary.successful} invoices created successfully.`);
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchInvoiceModal'));
            modal.hide();
        } else {
            alert('Error creating batch invoices: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

async function createSingleInvoice(memberId) {
    const amount = prompt('Enter invoice amount:');
    if (!amount || isNaN(amount)) return;
    
    const description = prompt('Enter invoice description:', 'Training Package Payment');
    if (!description) return;
    
    try {
        const response = await fetch('/api/invoices/create', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                member_id: memberId,
                amount: parseFloat(amount),
                description: description
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert('Invoice created successfully!');
            if (document.getElementById('memberDetailSidebar').classList.contains('show')) {
                showMemberDetail(memberId); // Refresh member details
            }
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    } catch (error) {
        alert('Network error: ' + error.message);
    }
}

// Utility functions
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    try {
        return new Date(dateString).toLocaleDateString();
    } catch {
        return 'Invalid Date';
    }
}

function sendMessage(memberId) {
    alert('Messaging feature coming soon!');
}

// Enable search on enter key
document.addEventListener('DOMContentLoaded', function() {
    document.getElementById('memberSearch').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            searchMembers();
        }
    });
});
</script>
{% endblock %}
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .search-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .search-input {
        border-radius: 25px;
        border: 1px solid #dee2e6;
        padding: 0.75rem 1.5rem;
    }
    
    .search-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .member-detail-value {
        font-weight: 600;
        color: #212529;
    }
    
    .form-label-muted {
        color: #6c757d;
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .outlook-badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
    }
    
    .outlook-badge-success {
        color: #ffffff;
        background-color: #198754;
    }
    
    .outlook-badge-warning {
        color: #000000;
        background-color: #ffc107;
    }
    
    .outlook-badge-danger {
        color: #ffffff;
        background-color: #dc3545;
    }
    
    .outlook-badge-info {
        color: #ffffff;
        background-color: #0dcaf0;
    }
    
    .outlook-badge-secondary {
        color: #ffffff;
        background-color: #6c757d;
    }
    
    .prospect-card {
        border: 2px solid #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #f8fff9 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Member Management
                    </h1>
                    <p class="text-muted mb-0">Manage and view all club members</p>
                </div>
                <div>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="membersTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="all-members-tab" data-bs-toggle="tab" data-bs-target="#all-members" type="button" role="tab" aria-controls="all-members" aria-selected="true">
                        All Members
                        <span class="badge bg-primary ms-2">{{ total_members }}</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="past-due-tab" data-bs-toggle="tab" data-bs-target="#past-due" type="button" role="tab" aria-controls="past-due" aria-selected="false" onclick="loadPastDueMembers()">
                        Past Due
                        <span id="red-count-badge" class="badge bg-danger ms-2">-</span>
                        <span id="yellow-count-badge" class="badge bg-warning text-dark ms-1">-</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="membersTabContent">
        <!-- All Members Tab -->
        <div class="tab-pane fade show active" id="all-members" role="tabpanel" aria-labelledby="all-members-tab">
            <!-- Search Section -->
            <div class="search-section">
                <div class="row">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" class="form-control search-input" placeholder="Search members by name, email, or phone..." id="memberSearch">
                        </div>
                    </div>
                    <div class="col-md-2">
                        <select class="form-select search-input" id="statusFilter">
                            <option value="">All Status</option>
                            <option value="active">Active</option>
                            <option value="inactive">Inactive</option>
                            <option value="suspended">Suspended</option>
                            <option value="frozen">Frozen</option>
                        </select>
                    </div>
                    <div class="col-md-2 mt-3 mt-md-0">
                        <select class="form-select search-input" id="priorityFilter">
                            <option value="">All Outlook</option>
                            <option value="red">Past Due (Red)</option>
                            <option value="yellow">Due Soon (Yellow)</option>
                            <option value="ppv">PPV</option>
                            <option value="none">Active/Other</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Members Grid -->
            <div class="row" id="membersContainer"></div>

            {% if not members %}
            <div class="empty-state">
                <i class="fas fa-users"></i>
                <h4>No Members Found</h4>
                <p>There are currently no members in the system.</p>
            </div>
            {% endif %}
        </div>

        <!-- Past Due Tab -->
        <div class="tab-pane fade" id="past-due" role="tabpanel" aria-labelledby="past-due-tab">
            <!-- Loading State -->
            <div id="past-due-loading" class="text-center py-5">
                <div class="loading-spinner"></div>
                <p class="text-muted mt-3">Loading past due members...</p>
            </div>

            <!-- No Past Due Members -->
            <div id="no-past-due" class="empty-state" style="display: none;">
                <i class="fas fa-check-circle text-success"></i>
                <h4>No Past Due Members</h4>
                <p>All members are current with their payments.</p>
            </div>

            <!-- Past Due Content -->
            <div id="past-due-content" style="display: none;">
                <div class="row mb-4">
                    <div class="col-12 text-end">
                        <button class="btn btn-primary" onclick="showBatchInvoiceModal()">
                            <i class="fas fa-file-invoice-dollar me-1"></i>
                            Batch Invoicing
                        </button>
                    </div>
                </div>
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center">
                                <h5 class="card-title">Critical</h5>
                                <h2 id="red-count-display" class="count-display">-</h2>
                                <p class="card-text">Members requiring immediate attention</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card text-dark bg-warning">
                            <div class="card-body text-center">
                                <h5 class="card-title">Attention Needed</h5>
                                <h2 id="yellow-count-display" class="count-display">-</h2>
                                <p class="card-text">Members with payment issues</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row" id="past-due-members-container">
                    <!-- Past due members will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoicePreviewModalLabel">Invoice Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Member:</strong> <span id="invoice-member-name"></span></p>
                <div class="mb-3">
                    <label for="invoice-amount" class="form-label">Amount ($)</label>
                    <input type="number" class="form-control" id="invoice-amount" placeholder="e.g., 50.00">
                </div>
                <div class="mb-3">
                    <label for="invoice-description" class="form-label">Description</label>
                    <textarea class="form-control" id="invoice-description" rows="3" placeholder="e.g., August Membership Dues + Late Fee"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendFinalInvoice()">Send Invoice</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Invoice Modal -->
<div class="modal fade" id="batchInvoiceModal" tabindex="-1" aria-labelledby="batchInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchInvoiceModalLabel">Batch Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The following members will be sent an invoice:</p>
                <ul id="batch-invoice-member-list">
                    <!-- Selected members will be listed here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendBatchInvoices()">Send Invoices</button>
            </div>
        </div>
    </div>
</div>

<!-- Member Profile Modal -->
<div class="modal fade" id="memberProfileModal" tabindex="-1" aria-labelledby="memberProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberProfileModalLabel">
                    <i class="fas fa-user me-2"></i>
                    <span id="modal-member-name">Member Profile</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="member-profile-loading" class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading member profile...</p>
                </div>

                <!-- Profile Content -->
                <div id="member-profile-content" style="display: none;">
                    <div class="row">
                        <!-- Personal Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user me-2"></i>
                                        Personal Information
                                    </h6>
                                </div>
                                <div class="card-body" id="personal-info-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-address-book me-2"></i>
                                        Contact Information
                                    </h6>
                                </div>
                                <div class="card-body" id="contact-info-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Agreements -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-contract me-2"></i>
                                        Agreements
                                    </h6>
                                </div>
                                <div class="card-body" id="agreements-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Payment History -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Payment History
                                    </h6>
                                </div>
                                <div class="card-body" id="payments-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Invoice History -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        Invoice History
                                    </h6>
                                </div>
                                <div class="card-body" id="invoice-history-content">
                                    <p class="text-muted">Invoice history will be displayed here.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="showInvoicePreview()">
                    <i class="fas fa-file-invoice-dollar me-1"></i>
                    Send Invoice
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshData() {
    const refreshButton = document.querySelector('button[onclick="refreshData()"]');
    if (refreshButton) {
        refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
        refreshButton.disabled = true;
    }
    
    fetch('/api/refresh-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Data refreshed successfully!\nMembers: ${data.counts.members}\nProspects: ${data.counts.prospects}`);
            window.location.reload();
        } else {
            alert('Error refreshing data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error refreshing data. Please try again.');
    })
    .finally(() => {
        if (refreshButton) {
            refreshButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Now';
            refreshButton.disabled = false;
        }
    });
}

// Auto-check data status every 5 minutes
setInterval(function() {
    fetch('/api/data-status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.needs_refresh) {
                console.log('Data is stale, consider refreshing');
            }
        })
        .catch(error => console.error('Error checking data status:', error));
}, 300000);

// Member Profile Modal Functions
function openMemberProfile(memberId, memberName, memberEmail) {
    console.log(`Opening profile for member: ${memberName} (ID: ${memberId})`);
    
    document.getElementById('modal-member-name').textContent = memberName;
    document.getElementById('member-profile-loading').style.display = 'block';
    document.getElementById('member-profile-content').style.display = 'none';
    
    const modalElement = document.getElementById('memberProfileModal');
    const modal = new bootstrap.Modal(modalElement);
    
    modalElement.addEventListener('shown.bs.modal', function() {
        const closeButton = modalElement.querySelector('.btn-close');
        if (closeButton) {
            closeButton.focus();
        }
    }, { once: true });
    
    modal.show();
    fetchMemberDetails(memberId, memberName, memberEmail);
}

function fetchMemberDetails(memberId, memberName, memberEmail) {
    // Store the current member ID for invoice creation
    window.currentMemberId = memberId;
    window.currentMemberName = memberName;
    window.currentMemberEmail = memberEmail;
    
    fetch(`/api/member/${memberId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('member-profile-loading').style.display = 'none';
                document.getElementById('member-profile-content').style.display = 'block';
                
                populatePersonalInfo(data.member, data.payment_status);
                populateContactInfo(data.member);
                populateAgreements(data.agreements);
                populatePayments(data.payments);
            } else {
                document.getElementById('member-profile-loading').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger">Error loading member profile: ${data.error}</p>
                        <button class="btn btn-outline-secondary" onclick="fetchMemberDetails(${memberId}, '${memberName}', '${memberEmail}')">
                            <i class="fas fa-redo me-1"></i>Try Again
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching member details:', error);
            document.getElementById('member-profile-loading').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Network error loading member profile</p>
                    <button class="btn btn-outline-secondary" onclick="fetchMemberDetails(${memberId}, '${memberName}', '${memberEmail}')">
                        <i class="fas fa-redo me-1"></i>Try Again
                    </button>
                </div>
            `;
        });
}

function populatePersonalInfo(member, paymentStatus) {
    const personalInfoContent = document.getElementById('personal-info-content');
    
    // Format member since date
    let memberSince = 'Unknown';
    if (member.membership_start || member.membershipStart) {
        try {
            const startDate = new Date(member.membership_start || member.membershipStart);
            memberSince = startDate.toLocaleDateString();
        } catch (e) {
            memberSince = member.membership_start || member.membershipStart;
        }
    } else if (member.created_at) {
        try {
            const createdDate = new Date(member.created_at);
            memberSince = createdDate.toLocaleDateString();
        } catch (e) {
            memberSince = member.created_at;
        }
    }
    
    // Format last visit date
    let lastVisit = 'Never';
    if (member.last_visit || member.lastVisit) {
        try {
            const visitDate = new Date(member.last_visit || member.lastVisit);
            lastVisit = visitDate.toLocaleDateString();
        } catch (e) {
            lastVisit = member.last_visit || member.lastVisit;
        }
    }
    
    // Format membership end date if available
    let membershipEnd = 'N/A';
    if (member.membership_end || member.membershipEnd) {
        try {
            const endDate = new Date(member.membership_end || member.membershipEnd);
            membershipEnd = endDate.toLocaleDateString();
        } catch (e) {
            membershipEnd = member.membership_end || member.membershipEnd;
        }
    }
    
    // Format next payment date
    let nextPaymentDate = 'N/A';
    let nextPaymentAmount = 'N/A';
    if (paymentStatus && paymentStatus.next_payment_date) {
        try {
            const payDate = new Date(paymentStatus.next_payment_date);
            nextPaymentDate = payDate.toLocaleDateString();
            nextPaymentAmount = paymentStatus.next_payment_amount ? 
                `$${parseFloat(paymentStatus.next_payment_amount).toFixed(2)}` : 'N/A';
        } catch (e) {
            nextPaymentDate = paymentStatus.next_payment_date;
            nextPaymentAmount = paymentStatus.next_payment_amount || 'N/A';
        }
    }
    
    // Add payment status badge
    const statusBadge = `<span class="outlook-badge outlook-badge-${paymentStatus.class}">${paymentStatus.text}</span>`;
    
    // Create data source badges
    let dataSourceBadge;
    if (member.fresh_data_error) {
        dataSourceBadge = '<span class="badge bg-warning ms-2" title="' + member.fresh_data_error + '">API Error</span>';
    } else if (member.fresh_data) {
        dataSourceBadge = '<span class="badge bg-success ms-2">Live Data</span>';
    } else {
        dataSourceBadge = '<span class="badge bg-secondary ms-2">Database Data</span>';
    }
    
    personalInfoContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Full Name</label>
            <div class="member-detail-value">${member.full_name || 
                ((member.first_name || '') + ' ' + (member.last_name || '')).trim() || 
                ((member.firstName || '') + ' ' + (member.lastName || '')).trim() || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Email</label>
            <div class="member-detail-value">${member.email || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Phone</label>
            <div class="member-detail-value">${member.mobile_phone || member.mobilePhone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member ID</label>
            <div class="member-detail-value">${member.id} ${dataSourceBadge}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">ClubOS ID</label>
            <div class="member-detail-value">${member.clubos_member_id || member.prospectId || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member Status</label>
            <div>${member.status ? '<span class="outlook-badge outlook-badge-info">' + member.status + '</span>' : 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Payment Status</label>
            <div>${statusBadge}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Next Payment</label>
            <div class="member-detail-value">
                ${nextPaymentDate !== 'N/A' ? `${nextPaymentDate} (${nextPaymentAmount})` : 'N/A'}
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member Since</label>
            <div class="member-detail-value">${memberSince}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Last Visit</label>
            <div class="member-detail-value">${lastVisit}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Membership End</label>
            <div class="member-detail-value">${membershipEnd}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">User Type</label>
            <div class="member-detail-value">${member.user_type || member.memberType || 'N/A'}</div>
        </div>
    `;
}

function populateContactInfo(member) {
    const contactInfoContent = document.getElementById('contact-info-content');
    contactInfoContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Mobile Phone</label>
            <div class="member-detail-value">${member.mobile_phone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Home Phone</label>
            <div class="member-detail-value">${member.home_phone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Address</label>
            <div class="member-detail-value">${member.address || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Emergency Contact</label>
            <div class="member-detail-value">${member.emergency_contact || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Date of Birth</label>
            <div class="member-detail-value">${member.date_of_birth || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Gender</label>
            <div class="member-detail-value">${member.gender || 'N/A'}</div>
        </div>
    `;
}

function populateAgreements(agreements) {
    const agreementsContent = document.getElementById('agreements-content');
    
    if (!agreements || agreements.length === 0) {
        agreementsContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                <p class="text-muted">No agreements found</p>
            </div>
        `;
        return;
    }
    
    let agreementsHtml = '<div class="row">';
    agreements.forEach(agreement => {
        agreementsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${agreement.agreement_type || 'Agreement'}</h6>
                        <p class="card-text">
                            <small class="text-muted">Start: ${agreement.start_date || 'N/A'}</small><br>
                            <small class="text-muted">End: ${agreement.end_date || 'N/A'}</small><br>
                            <small class="text-muted">Rate: $${agreement.rate || '0.00'}</small>
                        </p>
                        ${agreement.status ? '<span class="outlook-badge outlook-badge-info">' + agreement.status + '</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    });
    agreementsHtml += '</div>';
    
    agreementsContent.innerHTML = agreementsHtml;
}

function populatePayments(payments) {
    const paymentsContent = document.getElementById('payments-content');
    
    if (!payments || payments.length === 0) {
        paymentsContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                <p class="text-muted">No payment history found</p>
            </div>
        `;
        return;
    }
    
    let paymentsHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    payments.forEach(payment => {
        const paymentDate = payment.payment_date ? new Date(payment.payment_date).toLocaleDateString() : 'N/A';
        const amount = payment.amount ? `$${parseFloat(payment.amount).toFixed(2)}` : 'N/A';
        
        paymentsHtml += `
            <tr>
                <td>${paymentDate}</td>
                <td>${amount}</td>
                <td>${payment.payment_type || 'N/A'}</td>
                <td>
                    ${payment.status ? '<span class="outlook-badge outlook-badge-' + (payment.status === 'completed' ? 'success' : 'warning') + '">' + payment.status + '</span>' : 'N/A'}
                </td>
            </tr>
        `;
    });
    
    paymentsHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    paymentsContent.innerHTML = paymentsHtml;
}

function populateInvoices(invoices) {
    const invoiceHistoryContent = document.getElementById('invoice-history-content');
    
    if (!invoices || invoices.length === 0) {
        invoiceHistoryContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                <p class="text-muted">No invoice history found</p>
            </div>
        `;
        return;
    }
    
    let invoicesHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Invoice ID</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    invoices.forEach(invoice => {
        const invoiceDate = invoice.date ? new Date(invoice.date).toLocaleDateString() : 'N/A';
        const amount = invoice.amount ? `$${parseFloat(invoice.amount).toFixed(2)}` : 'N/A';
        
        invoicesHtml += `
            <tr>
                <td>${invoiceDate}</td>
                <td>${invoice.id || 'N/A'}</td>
                <td>${amount}</td>
                <td>
                    ${invoice.status ? '<span class="outlook-badge outlook-badge-' + (invoice.status === 'paid' ? 'success' : 'warning') + '">' + invoice.status + '</span>' : 'N/A'}
                </td>
            </tr>
        `;
    });
    
    invoicesHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    invoiceHistoryContent.innerHTML = invoicesHtml;
}

// TEST FUNCTION - Call this from browser console to test API
function testPastDueAPI() {
    console.log(' TESTING Past Due API directly...');
    loadPastDueMembers();
}

// Past Due Members Loading - SIMPLIFIED AND MORE RELIABLE
// pastDueMembersLoaded is declared at the top with allMembersLoaded

// Add immediate test
console.log(' SCRIPT LOADED - Testing past due members functionality');

document.addEventListener('DOMContentLoaded', function() {
    console.log(' DOM LOADED - Setting up past due members');
    const pastDueTab = document.getElementById('past-due-tab');
    
    if (pastDueTab) {
        // Listen for Bootstrap tab show event (when tab becomes active)
        pastDueTab.addEventListener('shown.bs.tab', function() {
            console.log(' Past Due tab SHOWN - Bootstrap event triggered');
            pastDueMembersLoaded = false;
            loadPastDueMembers();
        });
        
        // Also listen for regular click as backup
        pastDueTab.addEventListener('click', function(e) {
            console.log(' Past Due tab CLICKED - Click event triggered', e);
            pastDueMembersLoaded = false;
            loadPastDueMembers();
        });
        
        // Test with mousedown event too
        pastDueTab.addEventListener('mousedown', function(e) {
            console.log(' Past Due tab MOUSEDOWN - Mousedown event triggered', e);
            pastDueMembersLoaded = false;
            setTimeout(() => loadPastDueMembers(), 100);
        });
        
        console.log(' Past due tab event listeners added successfully');
    } else {
         console.error(' CRITICAL: Could not find the past-due-tab element.');
    }
    
    // Load past due members immediately on page load as backup
    console.log(' Page loaded, automatically loading past due members...');
    setTimeout(() => {
        console.log(' Timeout triggered, calling loadPastDueMembers');
        loadPastDueMembers();
    }, 1000); // Reduce delay for testing
});

// IMMEDIATE TEST - Call API directly when script loads
console.log(' IMMEDIATE CALL - Testing loadPastDueMembers directly');
setTimeout(() => {
    console.log(' CALLING loadPastDueMembers() NOW');
    if (typeof loadPastDueMembers === 'function') {
        loadPastDueMembers();
    } else {
        console.error(' loadPastDueMembers function not found!');
    }
}, 500);

function loadPastDueMembers() {
    console.log(' loadPastDueMembers() CALLED - Starting to load past due members...');
    
    // Reset the loaded flag and always fetch fresh data
    pastDueMembersLoaded = false;
    
    // Show loading state
    const loadingElement = document.getElementById('past-due-loading');
    const contentElement = document.getElementById('past-due-content');
    const noPastDueElement = document.getElementById('no-past-due');
    
    console.log(' Element check:', {
        loading: !!loadingElement,
        content: !!contentElement,
        noPastDue: !!noPastDueElement
    });
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (contentElement) contentElement.style.display = 'none';
    if (noPastDueElement) noPastDueElement.style.display = 'none';
    
    console.log(' Fetching past due members from API...');
    
    fetch('/api/members/past-due')
        .then(response => {
            console.log(' API response received:', response.status);
            if (!response.ok) {
                console.error('API returned error status:', response.status);
                return response.json().then(errorData => {
                    console.error('API error details:', errorData);
                    throw new Error(`API error: ${errorData.error || 'Unknown error'}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Past due data received:', data);
            if (!data || (data.past_due_members && !Array.isArray(data.past_due_members))) {
                console.error('Invalid data format received:', data);
                throw new Error('Invalid data format received from server');
            }
            pastDueMembersLoaded = true;

            // Handle direct array response or wrapped object
            let members = Array.isArray(data) ? data : (data.past_due_members || []);
            let redCount = members.filter(m => m.priority_status === 'red').length;
            let yellowCount = members.filter(m => m.priority_status === 'yellow').length;

            // Update badges in nav tabs
            document.getElementById('red-count-badge').textContent = redCount;
            document.getElementById('yellow-count-badge').textContent = yellowCount;
            const redDisplay = document.getElementById('red-count-display');
            const yellowDisplay = document.getElementById('yellow-count-display');
            if (redDisplay) redDisplay.textContent = redCount;
            if (yellowDisplay) yellowDisplay.textContent = yellowCount;

            if (members.length > 0) {
                console.log(`Displaying ${members.length} past due members`);
                displayPastDueMembers(members);
                document.getElementById('past-due-loading').style.display = 'none';
                document.getElementById('past-due-content').style.display = 'block';
            } else {
                console.log('No past due members found');
                document.getElementById('past-due-loading').style.display = 'none';
                document.getElementById('no-past-due').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading past due members:', error);
            document.getElementById('past-due-loading').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Error loading past due members: ${error.message}</p>
                    <p class="text-muted mb-3">This may be due to expired credentials or API changes.</p>
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="retryLoadPastDue()">Try Again</button>
                        <button class="btn btn-outline-secondary ms-2" onclick="contactSupport()">Contact Support</button>
                    </div>
                </div>
            `;
        });
}

function displayPastDueMembers(members) {
    const container = document.getElementById('past-due-members-container');
    let html = '';
    
    members.forEach(member => {
        // Skip rendering a card if the member ID is missing or there's no name/email
        if (!member.id || (!member.full_name && !member.first_name && !member.last_name && !member.email)) {
            console.warn('Skipping member with insufficient data:', member);
            return; // Skip this iteration
        }

        const cardClass = member.priority_status === 'red' ? 'border-danger' : 'border-warning';
        const badgeClass = member.priority_status === 'red' ? 'bg-danger' : 'bg-warning';
        
        // Generate a better display name
        let displayName = 'Unknown Name';
        
        // Try full name first
        if (member.full_name && member.full_name.trim()) {
            displayName = member.full_name;
        } 
        // Then try first + last name
        else if (member.first_name && member.last_name) {
            displayName = `${member.first_name} ${member.last_name}`;
        }
        // Then try just first or last name
        else if (member.first_name) {
            displayName = member.first_name;
        }
        else if (member.last_name) {
            displayName = member.last_name;
        }
        // Try to extract from email as last resort
        else if (member.email && member.email.includes('@')) {
            const emailName = member.email.split('@')[0];
            const cleanedName = emailName.replace(/[0-9_\.]/g, ' ').replace(/\s+/g, ' ').trim();
            if (cleanedName) {
                displayName = cleanedName.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ') + ' (from email)';
            }
        }
        
        html += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card ${cardClass}">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <h6 class="card-title" style="cursor: pointer;" onclick="openMemberProfile(${member.id}, '${displayName.replace(/'/g, "\\'")}', '${member.email ? member.email.replace(/'/g, "\\'") : ''}')">${displayName}</h6>
                            <input type="checkbox" class="form-check-input batch-invoice-checkbox" data-member-id="${member.id}" data-member-name="${displayName}">
                        </div>
                        <p class="card-text">
                            <small class="text-muted">${member.email || 'No email'}</small><br>
                            <span class="badge ${badgeClass}">${member.status_text}</span>
                        </p>
                        ${member.mobile_phone ? `<small class="text-muted"> ${member.mobile_phone}</small>` : ''}
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    console.log('Past due members displayed successfully');
}

function retryLoadPastDue() {
    console.log('Retrying past due members loading...');
    pastDueMembersLoaded = false;
    document.getElementById('past-due-loading').innerHTML = `
        <div class="loading-spinner"></div>
        <p class="text-muted mt-3">Loading past due members...</p>
    `;
    loadPastDueMembers();
}

function sendSquareInvoice() {
    const memberName = document.getElementById('modal-member-name').textContent;
    const amount = 100.00; // Placeholder amount
    const description = 'Membership Dues'; // Placeholder description

    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_name: memberName,
            amount: amount,
            description: description,
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully!');
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the invoice.');
    });
}

function createSquareInvoice() {
    alert('Square invoice creation will be implemented here');
}

function contactSupport() {
    // Open email client with pre-populated email
    const subject = encodeURIComponent('Gym Bot Support - Past Due Members Not Loading');
    const body = encodeURIComponent('I am experiencing an issue with the Past Due members tab not loading in the Gym Bot application. Please assist.');
    window.location.href = `mailto:support@example.com?subject=${subject}&body=${body}`;
}

function sendBatchInvoices() {
    const selectedMembers = [];
    document.querySelectorAll('.batch-invoice-checkbox:checked').forEach(checkbox => {
        selectedMembers.push({
            id: checkbox.dataset.memberId,
            name: checkbox.dataset.memberName
        });
    });

    if (selectedMembers.length === 0) {
        alert('Please select at least one member to invoice.');
        return;
    }

    const amount = 100.00; // Placeholder amount
    const description = 'Membership Dues'; // Placeholder description

    selectedMembers.forEach(member => {
        fetch('/api/create-invoice', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                member_name: member.name,
                amount: amount,
                description: description,
            }),
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                console.log(`Invoice created for ${member.name}`);
            } else {
                console.error(`Error creating invoice for ${member.name}: ${data.error}`);
            }
        })
        .catch(error => {
            console.error(`An error occurred while creating the invoice for ${member.name}:`, error);
        });
    });

    alert(`Invoices are being created for ${selectedMembers.length} members. Check the console for progress.`);
}

function showBatchInvoiceModal() {
    const selectedMembers = [];
    document.querySelectorAll('.batch-invoice-checkbox:checked').forEach(checkbox => {
        selectedMembers.push({
            id: checkbox.dataset.memberId,
            name: checkbox.dataset.memberName
        });
    });

    if (selectedMembers.length === 0) {
        alert('Please select at least one member to invoice.');
        return;
    }

    const memberList = document.getElementById('batch-invoice-member-list');
    memberList.innerHTML = '';
    selectedMembers.forEach(member => {
        const li = document.createElement('li');
        li.textContent = member.name;
        memberList.appendChild(li);
    });

    const modal = new bootstrap.Modal(document.getElementById('batchInvoiceModal'));
    modal.show();
}

function showInvoicePreview() {
    const memberId = window.currentMemberId; // Use global variable set in fetchMemberDetails
    const memberName = document.getElementById('modal-member-name').textContent;
    
    if (!memberId) {
        alert('No member selected. Please open a member profile first.');
        return;
    }
    
    // Show loading state
    document.getElementById('invoice-member-name').textContent = memberName;
    document.getElementById('invoice-amount').value = 'Calculating...';
    document.getElementById('invoice-description').value = 'Loading...';
    
    // Auto-calculate the correct amount with late fees
    fetch('/api/calculate-invoice-amount', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('invoice-amount').value = data.total_amount.toFixed(2);
            document.getElementById('invoice-description').value = data.description;
            
            // Store the calculated data for sending
            window.invoiceData = {
                member_name: data.member_name,
                amount: data.total_amount,
                description: data.description,
                past_due_amount: data.past_due_amount,
                late_fee: data.late_fee
            };
        } else {
            alert('Error calculating invoice amount: ' + data.error);
            // Set defaults
            document.getElementById('invoice-amount').value = '50.00';
            document.getElementById('invoice-description').value = 'Membership Payment';
        }
    })
    .catch(error => {
        console.error('Error calculating invoice:', error);
        alert('Error calculating invoice amount');
        // Set defaults
        document.getElementById('invoice-amount').value = '50.00';
        document.getElementById('invoice-description').value = 'Membership Payment';
    });

    const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
    modal.show();
}

function sendFinalInvoice() {
    const memberName = document.getElementById('invoice-member-name').textContent;
    const amount = parseFloat(document.getElementById('invoice-amount').value);
    const description = document.getElementById('invoice-description').value;
    
    if (!memberName || !amount || amount <= 0) {
        alert('Please provide valid invoice details');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Creating Invoice...';
    button.disabled = true;
    
    // Create the invoice
    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_name: memberName,
            amount: amount,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully! URL: ' + data.invoice_url);
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('invoicePreviewModal'));
            modal.hide();
            
            // Add to invoice history (future enhancement)
            // TODO: Save invoice to member's history
            
        } else {
            alert('Failed to create invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating invoice:', error);
        alert('Error creating invoice: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

// Global variables for async loading
let allMembersLoaded = false;
let pastDueMembersLoaded = false;

// Async function to load all members
async function loadAllMembers(page = 1, search = '', statusFilter = '') {
    if (allMembersLoaded && !search && !statusFilter && page === 1) {
        console.log(' All members already loaded, skipping...');
        return;
    }

    console.log(' Loading all members asynchronously...');
    
    const membersContainer = document.getElementById('membersContainer');
    const loadingHTML = `
        <div class="col-12 text-center py-5" id="members-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading members...</p>
        </div>
    `;
    
    // Show loading state
    if (page === 1) {
        membersContainer.innerHTML = loadingHTML;
    }
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            search: search,
            status: statusFilter
        });
        
        const response = await fetch(`/api/members/all?${params}`);
        const data = await response.json();
        
        if (data.success) {
            console.log(` Loaded ${data.members.length} members from API`);
            
            // Clear loading state
            if (page === 1) {
                membersContainer.innerHTML = '';
            }
            
            // Generate member cards HTML
            let html = '';
            data.members.forEach(member => {
                // Generate a proper full name
                let displayName = 'Unknown Name';
                if (member.full_name && member.full_name.trim() !== '') {
                    displayName = member.full_name;
                } else if (member.first_name || member.last_name) {
                    displayName = `${member.first_name || ''} ${member.last_name || ''}`.trim();
                } else if (member.email && member.email.includes('@')) {
                    // Try to extract a name from email
                    const emailName = member.email.split('@')[0];
                    const cleanedName = emailName.replace(/[^a-zA-Z ]/g, ' ').replace(/\s+/g, ' ').trim();
                    if (cleanedName) {
                        displayName = cleanedName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                        displayName += ' (from email)';
                    }
                }
                
                const priority = member.priority_status || '';
                const badgeClass = member.payment_status_class || (priority === 'red' ? 'danger' : priority === 'yellow' ? 'warning' : (priority === 'ppv' ? 'info' : 'primary'));
                const statusText = member.status_text || member.status || 'Active';

                html += `
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4 member-item" 
                         data-name="${(displayName || '').toLowerCase()}" 
                         data-email="${(member.email || '').toLowerCase()}" 
                         data-status="${(member.status || '').toLowerCase()}"
                         data-priority="${priority}">
                        <div class="card member-card h-100" onclick="openMemberProfile(${member.id}, '${displayName}', '${member.email || ''}')">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">${displayName}</h6>
                                    <span class="badge bg-${badgeClass}">${statusText}</span>
                                </div>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-envelope me-1"></i>${member.email || 'No email'}
                                </p>
                                ${member.mobile_phone ? `
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-phone me-1"></i>${member.mobile_phone}
                                </p>
                                ` : ''}
                                <div class="d-flex justify-content-between align-items-end">
                                    <small class="text-muted">ID: ${member.id}</small>
                                    ${member.membership_start ? `
                                    <small class="text-muted">Since: ${member.membership_start.substring(0, 10)}</small>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (data.members.length === 0 && page === 1) {
                html = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No Members Found</h4>
                            <p>There are currently no members matching your criteria.</p>
                        </div>
                    </div>
                `;
            }
            
            membersContainer.innerHTML = html;
            allMembersLoaded = true;
            
            // Update search and filter dropdowns
            updateStatusFilterOptions(data.statuses || []);
            
            console.log(' All members loaded and displayed successfully');
        } else {
            throw new Error(data.error || 'Failed to load members');
        }
    } catch (error) {
        console.error(' Error loading members:', error);
        membersContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading members: ${error.message}
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadAllMembers()">
                        <i class="fas fa-retry me-1"></i>Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// Function to update status filter options
function updateStatusFilterOptions(statuses) {
    const statusFilter = document.getElementById('statusFilter');
    const priorityFilter = document.getElementById('priorityFilter');
    if (statusFilter && statuses.length > 0) {
        const currentValue = statusFilter.value;
        statusFilter.innerHTML = '<option value="">All Status</option>';
        
        statuses.forEach(status => {
            if (status && status.trim()) {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusFilter.appendChild(option);
            }
        });
        
        statusFilter.value = currentValue;
    }
}

// Consolidated DOMContentLoaded listener for all page functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log(' Members page DOM loaded - setting up async functionality');
    
    // Load all members immediately on page load
    loadAllMembers();
    
    // Member search functionality
    const searchInput = document.getElementById('memberSearch');
    const statusFilter = document.getElementById('statusFilter');
    
    function filterMembers() {
        const searchTerm = searchInput ? searchInput.value.toLowerCase() : '';
        const statusTerm = statusFilter ? statusFilter.value.toLowerCase() : '';
    const memberItems = document.querySelectorAll('.member-item');
        
        memberItems.forEach(item => {
            const name = item.dataset.name || '';
            const email = item.dataset.email || '';
            const status = item.dataset.status || '';
            const priority = item.dataset.priority || '';
            
            const matchesSearch = name.includes(searchTerm) || email.includes(searchTerm);
            const matchesStatus = !statusTerm || status.includes(statusTerm);
            const matchesPriority = !(priorityFilter && priorityFilter.value) || (priority === (priorityFilter.value || '')) || (priorityFilter.value === 'none' && (!priority || priority === ''));
            
            if (matchesSearch && matchesStatus && matchesPriority) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    if (searchInput) {
        searchInput.addEventListener('input', filterMembers);
    }
    
    if (statusFilter) {
        statusFilter.addEventListener('change', filterMembers);
    }
    if (priorityFilter) {
        priorityFilter.addEventListener('change', filterMembers);
    }

    // Tab switching functionality
    const allMembersTab = document.getElementById('all-members-tab');
    const pastDueTab = document.getElementById('past-due-tab');
    
    if (allMembersTab) {
        allMembersTab.addEventListener('shown.bs.tab', function() {
            console.log(' All Members tab shown');
            loadAllMembers();
        });
    }
    
    if (pastDueTab) {
        pastDueTab.addEventListener('shown.bs.tab', function() {
            console.log(' Past Due tab shown');
            loadPastDueMembers();
        });
    }
    
    console.log(' Members page async setup complete');
});
</script>
{% endblock %}
