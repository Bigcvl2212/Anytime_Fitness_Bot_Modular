name: Build Gym Bot Installers

on:
  push:
    branches: [ main, master, restore/2025-08-29-15-21 ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: write  # Required for creating releases

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Build with PyInstaller
      run: |
        pyinstaller gym_bot.spec

    - name: Install Inno Setup
      run: |
        choco install innosetup -y
      shell: pwsh

    - name: Create Windows Installer
      run: |
        iscc installer_windows.iss
      shell: pwsh

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-Windows-Installer
        path: Output/GymBotInstaller.exe
        retention-days: 30

    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Output/GymBotInstaller.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
        pip3 install pyinstaller

    - name: Install create-dmg
      run: |
        brew install create-dmg

    - name: Build with PyInstaller
      run: |
        pyinstaller gym_bot.spec

    - name: Create DMG Installer
      run: |
        # Create DMG from the app bundle (without custom icon)
        create-dmg \
          --volname "Gym Bot Installer" \
          --window-pos 200 120 \
          --window-size 800 400 \
          --icon-size 100 \
          --icon "GymBot.app" 200 190 \
          --hide-extension "GymBot.app" \
          --app-drop-link 600 185 \
          --no-internet-enable \
          "dist/GymBotInstaller.dmg" \
          "dist/GymBot.app" || true

        # Fallback: If create-dmg fails, create simple DMG
        if [ ! -f "dist/GymBotInstaller.dmg" ]; then
          echo "Creating simple DMG as fallback..."
          hdiutil create -volname "Gym Bot Installer" \
            -srcfolder "dist/GymBot.app" \
            -ov -format UDZO \
            "dist/GymBotInstaller.dmg"
        fi

    - name: Upload macOS Installer
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-macOS-Installer
        path: dist/GymBotInstaller.dmg
        retention-days: 30

    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/GymBotInstaller.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]

    steps:
    - name: Print build info
      run: |
        echo "âœ… Windows and macOS installers built successfully!"
        echo ""
        echo "ðŸ“¦ Artifacts available for download in Actions tab"
        echo ""
        echo "To download:"
        echo "1. Go to Actions tab in GitHub"
        echo "2. Click on this workflow run"
        echo "3. Scroll down to Artifacts section"
        echo "4. Download GymBot-Windows-Installer.exe or GymBot-macOS-Installer.dmg"
        echo ""
        echo "To create a release:"
        echo "1. Create and push a tag: git tag v1.0.0 && git push origin v1.0.0"
        echo "2. Installers will be automatically attached to the release"
