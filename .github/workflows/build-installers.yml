name: Build Gym Bot Installers

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Run pre-flight checks
      run: python test_build.py
      continue-on-error: false

    - name: Verify source files before build
      shell: pwsh
      run: |
        Write-Host "=== VERSION ==="
        Get-Content VERSION
        Write-Host "=== gymbot_launcher.py buttons ==="
        Select-String -Path "gymbot_launcher.py" -Pattern "Check Updates|options_frame|View Logs"

    - name: Clear all caches
      shell: pwsh
      run: |
        Remove-Item -Path "build" -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item -Path "dist" -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Filter "*.pyc" | Remove-Item -Force -ErrorAction SilentlyContinue
        # Remove any .spec files to force fresh generation
        Remove-Item -Path "*.spec" -Force -ErrorAction SilentlyContinue
        # Clear PyInstaller work directory
        $pyiWork = Join-Path $env:TEMP "pyinstaller"
        if (Test-Path $pyiWork) { Remove-Item -Path $pyiWork -Recurse -Force -ErrorAction SilentlyContinue }

    - name: Debug gymbot_launcher.py before build
      shell: python
      run: |
        import os
        print('=== Current directory ===')
        print(os.getcwd())
        print('=== gymbot_launcher.py location ===')
        print(os.path.abspath('gymbot_launcher.py'))
        print('=== gymbot_launcher.py size ===')
        print(os.path.getsize('gymbot_launcher.py'))
        print('=== Checking for options_frame in gymbot_launcher.py ===')
        with open('gymbot_launcher.py', 'r', encoding='utf-8') as f:
            content = f.read()
            if 'options_frame' in content:
                print('YES - options_frame found')
                # Print the line
                for i, line in enumerate(content.split('\n')):
                    if 'options_frame' in line:
                        print(f'Line {i+1}: {line}')
            else:
                print('NO - options_frame NOT found')
            if 'Check Updates' in content:
                print('YES - Check Updates found')
            else:
                print('NO - Check Updates NOT found')

    - name: Build directly without spec file
      run: |
        python -m PyInstaller gymbot_launcher.py --name GymBot --onedir --console --clean --noconfirm --add-data "templates;templates" --add-data "static;static" --add-data "run_dashboard.py;." --add-data "gymbot_setup_wizard.py;." --add-data "VERSION;." --add-data "src;src" --add-data "config;config" --hidden-import flask --hidden-import jinja2 --hidden-import werkzeug --hidden-import requests --hidden-import flask_socketio --hidden-import socketio --hidden-import dotenv

    - name: Verify exe contains expected strings
      run: python verify_exe.py dist/GymBot

    - name: Verify build output
      shell: pwsh
      run: |
        if (Test-Path "dist\GymBot\GymBot.exe") {
          Write-Host "Build successful"
          $size = (Get-Item "dist\GymBot\GymBot.exe").Length / 1MB
          Write-Host "Size: $([math]::Round($size, 2)) MB"
          Get-Content "dist\GymBot\_internal\VERSION" -ErrorAction SilentlyContinue
        } else {
          Write-Error "Build failed"
          exit 1
        }

    - name: Install Inno Setup
      shell: pwsh
      run: choco install innosetup -y

    - name: Create Windows Installer
      shell: pwsh
      run: iscc installer_windows.iss

    - name: Upload Windows Installer
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-Windows-Installer
        path: Output/GymBotInstaller.exe
        retention-days: 30

    - name: Upload build logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: Windows-Build-Logs
        path: |
          build/GymBot/warn-GymBot.txt
          build/GymBot/*.log
        retention-days: 7
        if-no-files-found: ignore

    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: Output/GymBotInstaller.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
        pip3 install pyinstaller

    - name: Run pre-flight checks
      run: python3 test_build.py
      continue-on-error: false

    - name: Install create-dmg
      run: brew install create-dmg

    - name: Clear caches
      run: |
        rm -rf build dist __pycache__
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -delete

    - name: Generate fresh spec file
      run: python3 generate_spec.py

    - name: Build with PyInstaller
      run: python3 -m PyInstaller gym_bot_fresh.spec --clean --noconfirm

    - name: Verify build output
      run: |
        if [ -d "dist/GymBot" ]; then
          echo "Build successful"
          cat dist/GymBot/_internal/VERSION 2>/dev/null || echo "No VERSION file"
        else
          echo "Build failed"
          exit 1
        fi

    - name: Create DMG Installer
      run: |
        if [ -d "dist/GymBot.app" ]; then
          create-dmg \
            --volname "Gym Bot Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            --no-internet-enable \
            "dist/GymBotInstaller.dmg" \
            "dist/GymBot.app" || true
        fi
        if [ ! -f "dist/GymBotInstaller.dmg" ] && [ -d "dist/GymBot" ]; then
          hdiutil create -volname "Gym Bot" -srcfolder "dist/GymBot" -ov -format UDZO "dist/GymBotInstaller.dmg"
        fi

    - name: Upload macOS Installer
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-macOS-Installer
        path: dist/GymBotInstaller.dmg
        retention-days: 30
        if-no-files-found: warn

    - name: Create Release (if tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: dist/GymBotInstaller.dmg
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    if: always()

    steps:
    - name: Print build info
      run: |
        echo "Build complete"
        echo "Download artifacts from the Actions tab"
