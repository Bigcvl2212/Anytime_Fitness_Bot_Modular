name: Build Gym Bot Installers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  SPEC_FILE: GymBot.spec

jobs:
  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Run pre-flight checks
      run: python test_build.py

    - name: Clean build artifacts
      shell: pwsh
      run: |
        Remove-Item build -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Directory -Filter "__pycache__" | Remove-Item -Recurse -Force -ErrorAction SilentlyContinue
        Get-ChildItem -Path . -Recurse -Filter "*.pyc" | Remove-Item -Force -ErrorAction SilentlyContinue

    - name: Build executable
      run: python -m PyInstaller ${{ env.SPEC_FILE }} --clean --noconfirm

    - name: Verify build output
      shell: pwsh
      run: |
        if (-Not (Test-Path "dist/GymBot/GymBot.exe")) {
          Write-Error "GymBot.exe missing"
          exit 1
        }
        $size = (Get-Item "dist/GymBot/GymBot.exe").Length / 1MB
        Write-Host "Build size: $([math]::Round($size, 2)) MB"

    - name: Install Inno Setup
      shell: pwsh
      run: choco install innosetup -y

    - name: Build Windows installer
      shell: pwsh
      run: iscc installer_windows.iss

    - name: Upload portable build
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-Windows-Dist
        path: dist/GymBot

    - name: Upload Windows installer
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-Windows-Installer
        path: Output/GymBotInstaller.exe
        if-no-files-found: error

  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
        pip3 install pyinstaller

    - name: Run pre-flight checks
      run: python3 test_build.py

    - name: Clean build artifacts
      run: |
        rm -rf build dist __pycache__
        find . -name "*.pyc" -delete
        find . -name "__pycache__" -type d -delete

    - name: Build app bundle
      run: python3 -m PyInstaller ${{ env.SPEC_FILE }} --clean --noconfirm

    - name: Verify app bundle
      run: |
        if [ ! -d "dist/GymBot.app" ] && [ ! -d "dist/GymBot" ]; then
          echo "PyInstaller output missing" && exit 1
        fi

    - name: Install create-dmg
      run: brew install create-dmg

    - name: Create DMG installer
      run: |
        if [ -d "dist/GymBot.app" ]; then
          create-dmg \
            --volname "Gym Bot Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            --no-internet-enable \
            dist/GymBotInstaller.dmg \
            dist/GymBot.app || true
        fi
        if [ ! -f "dist/GymBotInstaller.dmg" ]; then
          hdiutil create -volname "Gym Bot" -srcfolder "dist/GymBot" -ov -format UDZO dist/GymBotInstaller.dmg
        fi

    - name: Upload macOS installer
      uses: actions/upload-artifact@v4
      with:
        name: GymBot-macOS-Installer
        path: dist/GymBotInstaller.dmg
        if-no-files-found: error

  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    if: always()

    steps:
    - name: Print summary
      run: |
        echo "Windows status: ${{ needs.build-windows.result }}"
        echo "macOS status: ${{ needs.build-macos.result }}"
