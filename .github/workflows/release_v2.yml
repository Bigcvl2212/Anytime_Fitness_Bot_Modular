name: Build Gym Bot Installers

on:
  push:
    branches: [ main ]
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  SPEC_FILE: GymBot.spec

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Get version from VERSION file
      id: version
      run: |
        VERSION=$(cat VERSION)
        echo "version=v${VERSION}" >> $GITHUB_OUTPUT
        echo "Version: v${VERSION}"

    outputs:
      version: ${{ steps.version.outputs.version }}

  build-windows:
    name: Build Windows Installer
    runs-on: windows-latest
    needs: build-and-release

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Run pre-flight checks
      run: python test_build.py

    - name: Clean build artifacts
      shell: pwsh
      run: |
        Remove-Item build -Recurse -Force -ErrorAction SilentlyContinue
        Remove-Item dist -Recurse -Force -ErrorAction SilentlyContinue

    - name: Generate build info
      shell: pwsh
      run: |
        $content = @()
        $content += "Build Time: $(Get-Date -Format o)"
        $content += "Runner OS: $env:RUNNER_OS"
        $content += "Git SHA: $env:GITHUB_SHA"
        $content += "Version: ${{ needs.build-and-release.outputs.version }}"
        Set-Content -Path build_info.txt -Value $content

    - name: Build executable
      run: python -m PyInstaller ${{ env.SPEC_FILE }} --clean --noconfirm

    - name: Verify build output
      shell: pwsh
      run: |
        if (-Not (Test-Path "dist/GymBot/GymBot.exe")) {
          Write-Error "GymBot.exe missing"
          exit 1
        }
        $size = (Get-Item "dist/GymBot/GymBot.exe").Length / 1MB
        Write-Host "Build size: $([math]::Round($size, 2)) MB"

    - name: Install Inno Setup
      shell: pwsh
      run: choco install innosetup -y

    - name: Build Windows installer
      shell: pwsh
      run: iscc installer_windows.iss

    - name: Upload Windows installer to release
      shell: pwsh
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $version = "${{ needs.build-and-release.outputs.version }}"
        Write-Host "Uploading to release $version"
        
        # Check if release exists
        $releaseExists = gh release view $version --json tagName 2>$null
        
        if (-not $releaseExists) {
          Write-Host "Creating release $version"
          gh release create $version --title "Gym Bot $version" --notes "## Gym Bot $version`n`n### Downloads`n- **Windows**: GymBotInstaller.exe`n- **macOS**: GymBotInstaller.dmg" --latest
        }
        
        # Upload asset
        Write-Host "Uploading Windows installer"
        gh release upload $version "Output/GymBotInstaller.exe" --clobber

  build-macos:
    name: Build macOS Installer
    runs-on: macos-latest
    needs: build-and-release

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Install dependencies
      run: |
        python3 -m pip install --upgrade pip
        pip3 install -r requirements.txt
        pip3 install pyinstaller

    - name: Run pre-flight checks
      run: python3 test_build.py

    - name: Clean build artifacts
      run: rm -rf build dist __pycache__

    - name: Generate build info
      run: |
        {
          echo "Build Time: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "Runner OS: $RUNNER_OS"
          echo "Git SHA: $GITHUB_SHA"
          echo "Version: ${{ needs.build-and-release.outputs.version }}"
        } > build_info.txt

    - name: Build app bundle
      run: python3 -m PyInstaller ${{ env.SPEC_FILE }} --clean --noconfirm

    - name: Verify app bundle
      run: |
        if [ ! -d "dist/GymBot.app" ] && [ ! -d "dist/GymBot" ]; then
          echo "PyInstaller output missing" && exit 1
        fi
        ls -la dist/

    - name: Install create-dmg
      run: brew install create-dmg

    - name: Create DMG installer
      run: |
        if [ -d "dist/GymBot.app" ]; then
          create-dmg \
            --volname "Gym Bot Installer" \
            --window-pos 200 120 \
            --window-size 800 400 \
            --icon-size 100 \
            --app-drop-link 600 185 \
            --no-internet-enable \
            dist/GymBotInstaller.dmg \
            dist/GymBot.app || true
        fi
        if [ ! -f "dist/GymBotInstaller.dmg" ]; then
          hdiutil create -volname "Gym Bot" -srcfolder "dist/GymBot" -ov -format UDZO dist/GymBotInstaller.dmg
        fi
        ls -la dist/

    - name: Upload macOS installer to release
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        version="${{ needs.build-and-release.outputs.version }}"
        echo "Uploading to release $version"
        
        # Check if release exists
        if ! gh release view "$version" --json tagName 2>/dev/null; then
          echo "Creating release $version"
          gh release create "$version" --title "Gym Bot $version" --notes "## Gym Bot $version

### Downloads
- **Windows**: GymBotInstaller.exe
- **macOS**: GymBotInstaller.dmg" --latest
        fi
        
        # Upload asset
        echo "Uploading macOS installer"
        gh release upload "$version" "dist/GymBotInstaller.dmg" --clobber
