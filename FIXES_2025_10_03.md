# Database and API Fixes - October 3, 2025

## Issues Fixed

### 1. Database Schema - Missing `mobile_phone` Column in Prospects Table
**Error:**
```
ERROR:src.services.database_manager:Error saving prospects: table prospects has no column named mobile_phone
```

**Root Cause:**  
The prospects table schema in `database_manager.py` includes the `mobile_phone` column, but the actual database table was created before this column was added to the schema definition.

**Solution:**  
Created and ran `fix_prospects_schema.py` migration script to add the missing column:
- Checks if `mobile_phone` column exists in prospects table
- Adds column if missing using `ALTER TABLE`
- Verifies the fix was successful

**Status:** ✅ FIXED  
The column was successfully added to the database.

---

### 2. Past-Due Status API - Type Error on COUNT Query
**Error:**
```
ERROR:src.routes.api:❌ Database error looking up training client Leisa Morgan: object of type 'int' has no len()
```

**Root Cause:**  
In `src/routes/api.py` line 185, the code attempted to call `len()` on the result of a COUNT query. The database manager can return different types depending on the query:
- Sometimes returns an integer directly
- Sometimes returns a list of rows
- Sometimes returns Row objects

**Solution:**  
Updated `/api/member/past-due-status` endpoint to handle all possible return types:
```python
# Handle different return types from execute_query
total_clients = 0
if table_count:
    # If table_count is an integer (direct result from some implementations)
    if isinstance(table_count, int):
        total_clients = table_count
    # If table_count is a list/tuple of rows
    elif isinstance(table_count, (list, tuple)) and len(table_count) > 0:
        count_row = table_count[0]
        # Handle dictionary-like row
        if hasattr(count_row, '__getitem__'):
            total_clients = count_row['count'] if 'count' in count_row else list(count_row.values())[0]
        # Handle plain integer/value
        else:
            total_clients = int(count_row) if count_row else 0
```

**Status:** ✅ FIXED  
The endpoint now properly handles all return types from the database manager.

---

### 3. ClubOS Authentication Failing (Placeholder Credentials)
**Error:**
```
WARNING:src.services.authentication.secure_secrets_manager:⚠️ Placeholder value detected for clubos-username, skipping
WARNING:src.services.authentication.secure_secrets_manager:⚠️ Placeholder value detected for clubos-password, skipping
ERROR:src.services.clubos_integration:❌ ClubOS authentication failed
```

**Root Cause:**  
The SecureSecretsManager is detecting placeholder values for ClubOS credentials and skipping them, causing authentication to fail. The system then falls back to environment variables which contain the placeholder text `your_clubos_username_here`.

**Status:** ⚠️ REQUIRES ADMIN ACTION  
This is not a code issue but a configuration issue. Real ClubOS credentials need to be added to either:
1. The SecureSecretsManager database (preferred), or
2. The `.env` file (fallback)

**Action Required:**  
Replace the placeholder ClubOS credentials with real values:
- `CLUBOS_USERNAME` - Real ClubOS username
- `CLUBOS_PASSWORD` - Real ClubOS password

---

## Testing

### To verify the fixes:
1. **Prospects mobile_phone column:**
   ```bash
   python -c "import sqlite3; conn = sqlite3.connect('gym_bot.db'); cursor = conn.cursor(); cursor.execute('PRAGMA table_info(prospects)'); print([row[1] for row in cursor.fetchall()])"
   ```
   Should show `mobile_phone` in the column list.

2. **Past-due status API:**
   - Restart the Flask server
   - Navigate to dashboard
   - Check that event cards no longer show 500 errors for training clients
   - Check browser console and server logs for errors

3. **ClubOS Authentication:**
   - Add real credentials to `.env` file
   - Restart Flask server
   - Check logs for successful authentication messages

---

## Files Modified

1. ✅ Created: `fix_prospects_schema.py` - Migration script for prospects table
2. ✅ Modified: `src/routes/api.py` - Fixed past-due status API type error
3. ℹ️ Action Needed: `.env` - Update ClubOS credentials (admin task)

---

## Next Steps

1. ✅ Restart the Flask application to apply API fixes
2. ⏳ Monitor error logs to ensure fixes are working
3. ⏳ Add real ClubOS credentials to resolve authentication issue
4. ⏳ Test event cards on dashboard to verify past-due status works
5. ⏳ Test messaging functionality to verify prospects can receive messages
