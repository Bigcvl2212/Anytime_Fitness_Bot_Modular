<script>
// Event details popup functions
function openEventDetails(element) {
    debugLog('üöÄ openEventDetails called');
    debugLog('Element:', element);
    
    // Get data from the clicked row
    const participant = element.getAttribute('data-participant') || 'Unknown';
    const allParticipants = element.getAttribute('data-all-participants') || participant;
    const time = element.getAttribute('data-time') || '';
    const trainer = element.getAttribute('data-trainer') || 'Not specified';
    const eventType = element.getAttribute('data-type') || 'Training Session';
    const location = element.getAttribute('data-location') || 'Training Floor';
    const isAppointment = element.getAttribute('data-is-appointment') === 'true';
    const eventId = element.getAttribute('data-event-id') || '';
    
    debugLog(`üéØ Opening event details for: ${allParticipants}`);
    
    // Immediately show the modal with basic info
    document.getElementById('modal-participant').textContent = allParticipants;
    document.getElementById('modal-time').textContent = time;
    document.getElementById('modal-trainer').textContent = trainer;
    document.getElementById('modal-type').textContent = eventType;
    document.getElementById('modal-location').textContent = location;
    
    // Show loading state for funding details
    document.getElementById('modal-funding').innerHTML = `
        <span class="outlook-badge outlook-badge-secondary">
            <i class="fas fa-spinner fa-spin"></i>
            Loading...
        </span>
    `;
    document.getElementById('training-package-details').style.display = 'none';
    
    // Show the modal
    const modalElement = document.getElementById('eventDetailsModal');
    if (modalElement) {
        if (typeof bootstrap !== 'undefined' && bootstrap.Modal) {
            const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
            modal.show();
            debugLog('‚úÖ Modal opened with Bootstrap');
        } else {
            debugLog('Bootstrap not available, using fallback');
            modalElement.style.display = 'block';
            modalElement.classList.add('show');
        }
    }
    
    // Load funding status in background
    if (isAppointment) {
        document.getElementById('modal-funding').innerHTML = `
            <span class="outlook-badge outlook-badge-info">
                <i class="fas fa-handshake"></i>
                Free Consultation
            </span>
        `;
    } else {
        const participants = allParticipants.split(', ').filter(p => p && p !== 'Unknown');
        if (participants.length > 0) {
            checkMultipleParticipantsFunding(participants, time);
        }
    }
}

function checkMultipleParticipantsFunding(participants, time) {
    debugLog(`üîç Checking funding for ${participants.length} participants:`, participants);
    
    const fundingPromises = participants.map(participant => 
    fetch('/api/training/payment-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                participant: participant.trim(),
                time: time
            })
        }).then(response => response.json())
    );
    
    Promise.allSettled(fundingPromises).then(results => {
        const fundingResults = [];
        
        results.forEach((result, index) => {
            if (result.status === 'fulfilled' && result.value.success) {
                fundingResults.push({
                    participant: participants[index],
                    funding: result.value.funding
                });
            } else {
                fundingResults.push({
                    participant: participants[index],
                    funding: {
                        status_text: 'Status Unknown',
                        status_class: 'secondary',
                        status_icon: 'fas fa-question-circle'
                    }
                });
            }
        });
        
        displayMultipleParticipantsFunding(fundingResults);
    });
}

function displayMultipleParticipantsFunding(fundingResults) {
    let fundingHtml = '';
    
    fundingResults.forEach(result => {
        const funding = result.funding;
        const statusIcon = funding.status_icon || 'fas fa-question-circle';
        const statusText = funding.status_text || 'Status Unknown';
        const statusClass = `outlook-badge-${funding.status_class || 'secondary'}`;
        
        fundingHtml += `
            <div class="mb-2">
                <strong>${result.participant}:</strong>
                <span class="outlook-badge ${statusClass} ms-2">
                    <i class="${statusIcon}"></i>
                    ${statusText}
                </span>
            </div>
        `;
    });
    
    document.getElementById('modal-funding').innerHTML = fundingHtml;
    
    const validFunding = fundingResults.find(r => r.funding.sessions_remaining);
    if (validFunding && validFunding.funding.package_type) {
        const funding = validFunding.funding;
        document.getElementById('sessions-remaining').textContent = funding.sessions_remaining;
        document.getElementById('package-type').textContent = funding.package_type;
        document.getElementById('package-expiration').textContent = funding.expiration_date || 'Not specified';
        document.getElementById('purchase-date').textContent = funding.purchase_date || 'Not specified';
        document.getElementById('total-paid').textContent = funding.total_paid ? `$${funding.total_paid.toLocaleString()}` : 'Not specified';
        
        document.getElementById('training-package-details').style.display = 'block';
    }
}

function refreshFundingCache() {
    debugLog('üîÑ Refreshing funding cache...');
    
    const refreshBtn = document.getElementById('refresh-funding-btn');
    const originalText = refreshBtn.innerHTML;
    
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Refreshing...';
    refreshBtn.disabled = true;
    
    fetch('/api/refresh-funding', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            debugLog('‚úÖ Funding cache refreshed:', data);
            refreshBtn.innerHTML = '<i class="fas fa-check"></i> Updated ' + data.success_count + ' clients';
            refreshBtn.className = 'outlook-btn outlook-btn-success';
            
            setTimeout(() => {
                checkAllFundingStatusesAsync();
            }, 1000);
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.className = 'outlook-btn outlook-btn-warning';
                refreshBtn.disabled = false;
            }, 3000);
        } else {
            debugError('‚ùå Funding cache refresh failed:', data.error);
            refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Error';
            refreshBtn.className = 'outlook-btn outlook-btn-danger';
            
            setTimeout(() => {
                refreshBtn.innerHTML = originalText;
                refreshBtn.className = 'outlook-btn outlook-btn-warning';
                refreshBtn.disabled = false;
            }, 3000);
        }
    })
    .catch(error => {
        debugError('‚ùå Network error:', error);
        refreshBtn.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Network Error';
        refreshBtn.className = 'outlook-btn outlook-btn-danger';
        
        setTimeout(() => {
            refreshBtn.innerHTML = originalText;
            refreshBtn.className = 'outlook-btn outlook-btn-warning';
            refreshBtn.disabled = false;
        }, 3000);
    });
}

function checkAllFundingStatusesAsync() {
    debugLog('üîç Starting asynchronous funding status checks...');
    
    const fundingElements = document.querySelectorAll('[id^="funding-status-"]');
    debugLog(`Found ${fundingElements.length} funding status elements to check`);
    
    fundingElements.forEach((element, index) => {
        const participant = element.getAttribute('data-participant');
        const time = element.getAttribute('data-time');
        
        debugLog(`Element ${index + 1}: participant="${participant}", time="${time}"`);
        
        if (participant && participant.trim() !== '' && participant !== 'Unknown') {
            setTimeout(() => {
                checkEventCardFunding(element, participant, time);
            }, index * 300);
        } else {
            debugLog(`Skipping element ${index + 1} - no valid participant`);
            element.innerHTML = `
                <span class="outlook-badge outlook-badge-secondary">
                    <i class="fas fa-question-circle"></i>
                    Unknown
                </span>
            `;
        }
    });
}

function checkEventCardFunding(element, participant, time) {
    debugLog(`üîç Checking funding for event card: ${participant}`);
    debugLog('API endpoint: /api/training/payment-status');
    debugLog('Request data:', { participant, time });
    
    fetch('/api/training/payment-status', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            participant: participant,
            time: time
        })
    })
    .then(response => {
        debugLog('API response status:', response.status);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        debugLog('API response data:', data);
        if (data.success) {
            const funding = data.funding;
            debugLog(`‚úÖ Funding data received for ${participant}:`, funding);
            
            const statusIcon = funding.status_icon || 'fas fa-question-circle';
            const statusText = funding.status_text || 'Unknown';
            const statusClass = `outlook-badge-${funding.status_class || 'secondary'}`;
            
            element.innerHTML = `
                <span class="outlook-badge ${statusClass}">
                    <i class="${statusIcon}"></i>
                    ${statusText}
                </span>
            `;
        } else {
            debugError('‚ùå API error for', participant, ':', data.error);
            element.innerHTML = `
                <span class="outlook-badge outlook-badge-danger">
                    <i class="fas fa-exclamation-triangle"></i>
                    Error
                </span>
            `;
        }
    })
    .catch(error => {
        debugError('‚ùå Network error checking funding for', participant, ':', error);
        element.innerHTML = `
            <span class="outlook-badge outlook-badge-secondary">
                <i class="fas fa-wifi"></i>
                Network Error
            </span>
        `;
    });
}

// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
    debugLog('üöÄ Dashboard loaded - attaching event listeners');
    
    checkAllFundingStatusesAsync();
    
    const refreshFundingBtn = document.getElementById('refresh-funding-btn');
    if (refreshFundingBtn) {
        refreshFundingBtn.addEventListener('click', refreshFundingCache);
    }
    
    document.querySelectorAll('.session-row').forEach(row => {
        row.style.cursor = 'pointer';
        
        row.addEventListener('click', function(e) {
            if (e.target.closest('button, a, form')) return;
            debugLog('üñ±Ô∏è Card clicked, opening details...');
            openEventDetails(this);
        });
        
        row.addEventListener('mouseenter', function() {
            this.style.background = 'var(--af-gray-100)';
            this.style.borderLeft = '4px solid var(--af-purple-primary)';
        });
        
        row.addEventListener('mouseleave', function() {
            this.style.background = 'white';
            this.style.borderLeft = 'none';
        });
    });
    
    debugLog('‚úÖ Dashboard initialization complete');
});
</script>
{% endblock %}
