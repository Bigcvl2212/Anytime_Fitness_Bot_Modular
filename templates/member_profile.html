{% extends "base.html" %}

{% block title %}{{ member.full_name or ((member.first_name or '') + ' ' + (member.last_name or '')).strip() or 'Unknown Member' }} - Member Profile{% endblock %}

{% block content %}
{% set summary = membership_summary or {} %}
{% set plan = payment_plan %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <nav aria-label="breadcrumb">
                        <ol class="breadcrumb">
                            <li class="breadcrumb-item"><a href="/">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="/members">Members</a></li>
                            <li class="breadcrumb-item active">{{ member.full_name or ((member.first_name or '') + ' ' + (member.last_name or '')).strip() or 'Unknown Member' }}</li>
                        </ol>
                    </nav>
                    <h1 class="h2 mb-0">
                        <i class="fas fa-user me-2 text-primary"></i>
                        {{ member.full_name or ((member.first_name or '') + ' ' + (member.last_name or '')).strip() or 'Unknown Member' }}
                        {% if member.fresh_data %}
                        <span class="badge bg-success ms-2">Live Data</span>
                        {% elif member.fresh_data_error %}
                        <span class="badge bg-warning ms-2" title="{{ member.fresh_data_error }}">API Error</span>
                        {% else %}
                        <span class="badge bg-secondary ms-2">Database Data</span>
                        {% endif %}
                    </h1>
                    <p class="text-muted mb-0">Member ID: {{ member.id }} | ClubOS ID: {{ member.clubos_member_id or 'N/A' }}</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/members" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Members
                    </a>
                    <button class="btn btn-warning" onclick="showInvoiceModal()">
                        <i class="fas fa-file-invoice-dollar me-1"></i>Create Invoice
                    </button>
                    <button class="btn btn-primary" onclick="refreshMemberData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh Data
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Alert -->
    {% if payment_status and payment_status.text != 'Current' %}
    <div class="row mb-4">
        <div class="col-12">
            <div class="alert alert-{{ 'danger' if payment_status.class == 'danger' else 'warning' }}">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Payment Status:</strong> {{ payment_status.text }}
                {% if payment_status.next_payment_date %}
                | Next Payment Due: {{ payment_status.next_payment_date }}
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <div class="row">
        <!-- Left Column - Personal & Contact Info -->
        <div class="col-md-4 mb-4">
            <!-- Personal Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user me-2"></i>Personal Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted">Full Name</label>
                            <p class="fw-bold">{{ member.full_name or ((member.first_name or '') + ' ' + (member.last_name or '')).strip() or 'N/A' }}</p>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted">Member Status</label>
                            <p><span class="badge bg-{{ 'success' if member.status == 'Active' else 'warning' }}">{{ member.status or 'Active' }}</span></p>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted">Date of Birth</label>
                            <p>{{ member.date_of_birth or 'N/A' }}</p>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted">Gender</label>
                            <p>{{ member.gender or 'N/A' }}</p>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted">Member Since</label>
                            <p>{{ member.membership_start[:10] if member.membership_start else (member.created_at[:10] if member.created_at else 'N/A') }}</p>
                        </div>
                        <div class="col-sm-6 mb-3">
                            <label class="form-label text-muted">User Type</label>
                            <p>{{ member.user_type or 'Member' }}</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contact Information Card -->
            <div class="card mb-4">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-address-book me-2"></i>Contact Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label text-muted">Email</label>
                        {% if member.email %}
                        <p><a href="mailto:{{ member.email }}">{{ member.email }}</a></p>
                        {% else %}
                        <p class="text-muted">N/A</p>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted">Mobile Phone</label>
                        {% if member.mobile_phone %}
                        <p><a href="tel:{{ member.mobile_phone }}">{{ member.mobile_phone }}</a></p>
                        {% else %}
                        <p class="text-muted">N/A</p>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted">Home Phone</label>
                        {% if member.home_phone %}
                        <p><a href="tel:{{ member.home_phone }}">{{ member.home_phone }}</a></p>
                        {% else %}
                        <p class="text-muted">N/A</p>
                        {% endif %}
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted">Address</label>
                        <p>{{ member.address or 'N/A' }}</p>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted">Emergency Contact</label>
                        <p>{{ member.emergency_contact or 'N/A' }}</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Column - Membership & Agreements -->
        <div class="col-md-8">
            <!-- Payment Status Card -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0">
                        <i class="fas fa-credit-card me-2"></i>Billing Overview
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <small class="text-muted">Payment Status</small>
                                <div class="mt-1">
                                    <span class="badge bg-{{ payment_status.class if payment_status else 'secondary' }}">
                                        {{ payment_status.text if payment_status else 'Unknown' }}
                                    </span>
                                </div>
                                <div class="mt-3">
                                    <small class="text-muted">Next Payment</small>
                                    <p class="fw-bold mb-1">{{ summary.next_payment_date or 'N/A' }}</p>
                                    <p class="fs-5 mb-0">${{ "%.2f"|format(summary.next_payment_amount or 0) }}</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <small class="text-muted">Past Due Breakdown</small>
                                <h3 class="text-danger my-2">${{ "%.2f"|format(summary.amount_past_due or 0) }}</h3>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted">Base</small>
                                        <p class="fw-bold mb-0">${{ "%.2f"|format(summary.base_amount_past_due or 0) }}</p>
                                    </div>
                                    <div>
                                        <small class="text-muted">Late Fees</small>
                                        <p class="fw-bold mb-0">${{ "%.2f"|format(summary.late_fees or 0) }}</p>
                                    </div>
                                    <div>
                                        <small class="text-muted">Missed</small>
                                        <p class="fw-bold mb-0">{{ summary.missed_payments or 0 }}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="border rounded p-3 h-100">
                                <small class="text-muted">Payment Plan</small>
                                {% if plan %}
                                <p class="fw-bold mb-1">{{ plan.plan_name or 'Manual Plan' }}</p>
                                <p class="text-muted mb-1">Next Due: {{ plan.next_payment_due or '‚Äî' }}</p>
                                <h4 class="mb-1">${{ "%.2f"|format(plan.balance_remaining or 0) }}</h4>
                                <p class="text-muted mb-0">{{ plan.installments_paid or 0 }} of {{ plan.installments_total or 0 }} installments paid</p>
                                {% else %}
                                <div class="text-muted">No payment plan on file.</div>
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="document.getElementById('paymentPlanFormCard').scrollIntoView({behavior:'smooth'});">
                                    Create Plan
                                </button>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Training Information -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-dumbbell me-2"></i>Training Agreements
                    </h5>
                </div>
                <div class="card-body">
                    {% if training_packages %}
                    <div class="row">
                        {% for pkg in training_packages %}
                        <div class="col-md-6 mb-3">
                            <div class="border rounded p-3 h-100">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <div>
                                        <h6 class="mb-1">{{ pkg.package_type or 'Training Package' }}</h6>
                                        <small class="text-muted">Trainer: {{ pkg.trainer_name or 'Unassigned' }}</small>
                                    </div>
                                    <span class="badge bg-{{ 'success' if pkg.payment_status and 'current' in pkg.payment_status|lower else 'warning' }}">
                                        {{ pkg.payment_status or 'Unknown' }}
                                    </span>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <small class="text-muted">Sessions Remaining</small>
                                        <p class="fw-bold mb-0">{{ pkg.sessions_remaining or 0 }}</p>
                                    </div>
                                    <div>
                                        <small class="text-muted">Past Due</small>
                                        <p class="fw-bold text-danger mb-0">${{ "%.2f"|format(pkg.total_past_due or 0) }}</p>
                                    </div>
                                </div>
                                {% if pkg.active_packages %}
                                <hr class="my-2">
                                <small class="text-muted d-block">Active Packages</small>
                                <ul class="mb-0">
                                    {% for active in pkg.active_packages %}
                                    <li>{{ active.package_name or active.name }} - {{ active.sessions_remaining or 0 }} sessions left</li>
                                    {% endfor %}
                                </ul>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-dumbbell fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No training agreements on file</h6>
                        <p class="text-muted">Link ClubOS training clients to see package utilization and past-due status.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Agreements/Memberships Card -->
            <div class="card mb-4" id="paymentPlanFormCard">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-handshake me-2"></i>Payment Plan Tracker
                    </h5>
                </div>
                <div class="card-body">
                    <div id="paymentPlanAlert" class="alert d-none" role="alert"></div>

                    {% if plan %}
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <small class="text-muted">Plan Name</small>
                            <p class="fw-bold mb-0">{{ plan.plan_name or 'Manual Plan' }}</p>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Balance Remaining</small>
                            <p class="fw-bold mb-0">${{ "%.2f"|format(plan.balance_remaining or 0) }}</p>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Installments</small>
                            <p class="fw-bold mb-0">{{ plan.installments_paid or 0 }} / {{ plan.installments_total or 0 }}</p>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Next Due</small>
                            <p class="fw-bold mb-0">{{ plan.next_payment_due or 'Scheduled' }}</p>
                        </div>
                    </div>

                    <div class="table-responsive mb-4">
                        <table class="table table-sm align-middle">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for installment in plan.installments %}
                                <tr>
                                    <td>{{ installment.installment_number }}</td>
                                    <td>{{ installment.due_date or 'N/A' }}</td>
                                    <td>${{ "%.2f"|format(installment.amount or 0) }}</td>
                                    <td>
                                        {% if installment.status == 'paid' %}
                                        <span class="badge bg-success">Paid {{ installment.paid_date or '' }}</span>
                                        {% else %}
                                        <span class="badge bg-warning text-dark">Pending</span>
                                        {% endif %}
                                    </td>
                                    <td class="text-end">
                                        {% if installment.status != 'paid' %}
                                        <button class="btn btn-sm btn-outline-success" onclick="markInstallmentPaid({{ installment.id }})">
                                            Mark Paid
                                        </button>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-3">
                        <i class="fas fa-hand-holding-usd fa-2x text-muted mb-2"></i>
                        <p class="text-muted mb-0">No payment plan on file. Use the form below to create one.</p>
                    </div>
                    {% endif %}

                    <div class="border rounded p-3">
                        <h6 class="mb-3">Create / Update Payment Plan</h6>
                        <form id="paymentPlanForm" onsubmit="submitPaymentPlan(event)">
                            <div class="row g-3">
                                <div class="col-md-4">
                                    <label class="form-label">Plan Name</label>
                                    <input type="text" class="form-control" id="planName" placeholder="Manual Plan" value="{{ plan.plan_name if plan else '' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Total Amount ($)</label>
                                    <input type="number" step="0.01" min="0" class="form-control" id="planTotalAmount" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Installments</label>
                                    <input type="number" min="1" class="form-control" id="planInstallments" value="4" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Frequency (days)</label>
                                    <input type="number" min="1" class="form-control" id="planFrequency" value="14" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Start Date</label>
                                    <input type="date" class="form-control" id="planStartDate" value="{{ summary.next_payment_date[:10] if summary.next_payment_date else '' }}" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Notes</label>
                                    <input type="text" class="form-control" id="planNotes" placeholder="Include plan context">
                                </div>
                            </div>
                            <div class="text-end mt-3">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save me-1"></i>Save Payment Plan
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Agreements/Memberships Card -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-contract me-2"></i>Membership Agreements
                        {% if agreements %}
                        <span class="badge bg-primary ms-2">{{ agreements|length }}</span>
                        {% endif %}
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <small class="text-muted">Agreement Type</small>
                            <p class="fw-bold mb-0">{{ summary.agreement_type or 'Membership' }}</p>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Status</small>
                            <p class="fw-bold mb-0">{{ summary.status_message or 'Unknown' }}</p>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Start Date</small>
                            <p class="fw-bold mb-0">{{ summary.agreement_start_date or 'N/A' }}</p>
                        </div>
                        <div class="col-md-3">
                            <small class="text-muted">Recurring Rate</small>
                            <p class="fw-bold mb-0">${{ "%.2f"|format(summary.agreement_recurring_cost or 0) }}</p>
                        </div>
                    </div>
                    <hr>
                    {% if agreements and agreements|length > 0 %}
                    <div class="row">
                        {% for agreement in agreements %}
                        <div class="col-md-6 mb-3">
                            <div class="card border-primary">
                                <div class="card-body">
                                    <h6 class="card-title">{{ agreement.package_name or 'Membership Agreement' }}</h6>
                                    {% if agreement.v2 and agreement.v2.packageAgreement %}
                                    <p class="card-text">
                                        <small class="text-muted">
                                            Start: {{ agreement.v2.packageAgreement.startDate or 'N/A' }}<br>
                                            End: {{ agreement.v2.packageAgreement.endDate or 'N/A' }}
                                        </small>
                                    </p>
                                    {% endif %}
                                    <span class="badge bg-{{ 'success' if agreement.status == 'Current' else 'warning' }}">
                                        {{ agreement.status or 'Active' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No membership agreements found</h6>
                        <p class="text-muted">This member may have a basic membership without specific agreements.</p>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Invoice History Card -->
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="fas fa-file-invoice-dollar me-2"></i>Invoice History
                    </h5>
                </div>
                <div class="card-body">
                    {% if invoices %}
                    <div class="table-responsive">
                        <table class="table table-striped align-middle">
                            <thead>
                                <tr>
                                    <th>Invoice #</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Status</th>
                                    <th>Paid Date</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for invoice in invoices %}
                                <tr>
                                    <td>{{ invoice.square_invoice_id or invoice.id }}</td>
                                    <td>{{ invoice.due_date or 'N/A' }}</td>
                                    <td>${{ "%.2f"|format(invoice.amount or 0) }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if invoice.status and 'paid' in invoice.status|lower else 'warning' }}">
                                            {{ invoice.status or 'Pending' }}
                                        </span>
                                    </td>
                                    <td>{{ invoice.payment_date or '‚Äî' }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="text-center py-4">
                        <i class="fas fa-file-invoice-dollar fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">No invoices recorded</h6>
                        <p class="text-muted">Create invoices from this page or sync from Square to see payment history.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Message History Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>Message History
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <input type="text" class="form-control" id="messageSearch" placeholder="Search messages...">
                        </div>
                        <div class="col-md-6 text-end">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane me-1"></i>Send Message
                            </button>
                        </div>
                    </div>
                    
                    <div id="messageHistory">
                        <div class="text-center py-4">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Loading...</span>
                            </div>
                            <p class="text-muted mt-2">Loading message history...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Modal -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Create Invoice for {{ member.full_name or 'Member' }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="invoiceForm">
                    <div class="mb-3">
                        <label for="invoiceAmount" class="form-label">Amount ($)</label>
                        <input type="number" class="form-control" id="invoiceAmount" step="0.01" min="0" required>
                    </div>
                    <div class="mb-3">
                        <label for="invoiceDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="invoiceDescription" rows="3" placeholder="e.g., Monthly Membership Dues" required></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="createInvoice()">Create Invoice</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const memberId = {{ (member.guid or member.prospect_id or member_id)|tojson }};
const memberName = {{ (member.full_name or ((member.first_name or '') ~ ' ' ~ (member.last_name or '')).strip() or 'Unknown Member')|tojson }};
function showInvoiceModal() {
    const modal = new bootstrap.Modal(document.getElementById('invoiceModal'));
    modal.show();
}

function createInvoice() {
    const amount = document.getElementById('invoiceAmount').value;
    const description = document.getElementById('invoiceDescription').value;
    
    if (!amount || !description) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_name: memberName,
            member_email: '{{ member.email or "" }}',
            amount: parseFloat(amount),
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully! URL: ' + data.invoice_url);
            const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
            modal.hide();
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        debugError('Error:', error);
        alert('Error creating invoice');
    });
}

function refreshMemberData() {
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    button.disabled = true;
    
    // Reload the page to get fresh data
    window.location.reload();
}

function showPlanAlert(message, variant = 'success') {
    const alertBox = document.getElementById('paymentPlanAlert');
    if (!alertBox) {
        alert(message);
        return;
    }
    alertBox.className = `alert alert-${variant}`;
    alertBox.textContent = message;
    alertBox.classList.remove('d-none');
    setTimeout(() => alertBox.classList.add('d-none'), 5000);
}

function submitPaymentPlan(event) {
    event.preventDefault();
    const totalAmount = parseFloat(document.getElementById('planTotalAmount').value || '0');
    const installments = parseInt(document.getElementById('planInstallments').value || '0', 10);
    const frequency = parseInt(document.getElementById('planFrequency').value || '14', 10);
    const startDate = document.getElementById('planStartDate').value;
    const planNameValue = document.getElementById('planName').value.trim();
    const notes = document.getElementById('planNotes').value.trim();

    if (!totalAmount || totalAmount <= 0 || !installments || installments <= 0 || !startDate) {
        showPlanAlert('Total amount, installments, and start date are required.', 'danger');
        return;
    }

    const payload = {
        plan_name: planNameValue,
        total_amount: totalAmount,
        installments_total: installments,
        frequency_days: frequency,
        start_date: startDate,
        notes: notes
    };

    fetch(`/api/members/${encodeURIComponent(memberId)}/payment-plan`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPlanAlert('Payment plan saved successfully.', 'success');
            setTimeout(() => window.location.reload(), 1000);
        } else {
            showPlanAlert(data.error || 'Unable to save payment plan.', 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Error saving payment plan:', error);
        showPlanAlert('Unexpected error saving payment plan.', 'danger');
    });
}

function markInstallmentPaid(installmentId) {
    const amountInput = prompt('Enter payment amount (leave blank to use scheduled amount):');
    let amountValue = null;
    if (amountInput && amountInput.trim() !== '') {
        const parsed = parseFloat(amountInput);
        if (!isNaN(parsed) && parsed > 0) {
            amountValue = parsed;
        }
    }

    fetch(`/api/members/${encodeURIComponent(memberId)}/payment-plan/installments/${installmentId}`, {
        method: 'PATCH',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ amount_paid: amountValue })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showPlanAlert('Installment marked as paid.', 'success');
            setTimeout(() => window.location.reload(), 800);
        } else {
            showPlanAlert(data.error || 'Unable to update installment.', 'danger');
        }
    })
    .catch(error => {
        console.error('‚ùå Error updating installment:', error);
        showPlanAlert('Unexpected error updating installment.', 'danger');
    });
}

// Message History Functions
function loadMessageHistory() {
    console.log('üì¨ Loading message history for member ID:', memberId, 'Name:', memberName);
    
    // Try ClubOS FollowUp API first for real-time message history
    fetch(`/api/messaging/member-history/${encodeURIComponent(memberId)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.message_history && data.message_history.length > 0) {
                // SUCCESS - Display messages and exit promise chain
                displayMessageHistory(data.message_history, data.source);
                console.log('‚úÖ Loaded', data.count, 'messages from', data.source);
            } else {
                // No messages from primary API - try fallback
                console.log('üîÑ Falling back to legacy message API');
                return fetch(`/api/messages/member/${encodeURIComponent(memberName)}`)
                    .then(fallbackResponse => fallbackResponse.json())
                    .then(fallbackData => {
                        if (fallbackData && fallbackData.success && fallbackData.messages.length > 0) {
                            displayMessageHistory(fallbackData.messages, 'database_legacy');
                            console.log('‚úÖ Loaded', fallbackData.messages.length, 'messages from database fallback');
                        } else {
                            // No messages found anywhere
                            document.getElementById('messageHistory').innerHTML = `
                                <div class="text-center py-4">
                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                    <h6 class="text-muted">No messages found</h6>
                                    <p class="text-muted">No message history available for this member.</p>
                                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadMessageHistory()">
                                        <i class="fas fa-refresh me-1"></i>Retry
                                    </button>
                                </div>
                            `;
                        }
                    });
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading messages:', error);
            document.getElementById('messageHistory').innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-muted mb-3"></i>
                    <h6 class="text-muted">Error loading messages</h6>
                    <p class="text-muted">Network error occurred while loading message history</p>
                    <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadMessageHistory()">
                        <i class="fas fa-refresh me-1"></i>Retry
                    </button>
                </div>
            `;
        });
}

function displayMessageHistory(messages, source = 'unknown') {
    const container = document.getElementById('messageHistory');
    
    if (!messages || messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h6 class="text-muted">No messages found</h6>
                <p class="text-muted">No message history available for this member.</p>
                <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadMessageHistory()">
                    <i class="fas fa-refresh me-1"></i>Retry
                </button>
            </div>
        `;
        return;
    }
    
    // Source indicator
    const sourceInfo = {
        'clubos_followup_api': { icon: 'fas fa-cloud', text: 'ClubOS Live Data', color: 'success' },
        'database_fallback': { icon: 'fas fa-database', text: 'Database Cache', color: 'warning' },
        'database_legacy': { icon: 'fas fa-archive', text: 'Legacy Database', color: 'secondary' }
    };
    
    const sourceDisplay = sourceInfo[source] || { icon: 'fas fa-question', text: 'Unknown Source', color: 'secondary' };
    
    const messagesHtml = messages.map(message => {
        const timestamp = new Date(message.timestamp || message.created_at);
        const timeString = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        
        // Determine message type and styling
        const messageType = message.message_type || 'conversation';
        const status = message.status || 'received';
        
        const typeIcons = {
            'sms': 'fas fa-sms',
            'email': 'fas fa-envelope',
            'call': 'fas fa-phone',
            'conversation': 'fas fa-comments'
        };
        
        const statusStyles = {
            'sent': 'bg-primary text-white',
            'received': 'bg-light text-dark',
            'pending': 'bg-warning text-dark'
        };
        
        return `
            <div class="message-item p-3 border-bottom">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <div class="${statusStyles[status] || 'bg-secondary text-white'} rounded-circle d-flex align-items-center justify-content-center me-2" style="width: 32px; height: 32px; font-size: 14px; font-weight: bold;">
                                ${message.from_user ? message.from_user.split(' ').map(n => n[0]).join('').toUpperCase() : 'U'}
                            </div>
                            <div>
                                <strong class="d-block">${message.from_user || 'Unknown User'}</strong>
                                <small class="text-muted">
                                    <i class="${typeIcons[messageType] || 'fas fa-comments'} me-1"></i>
                                    ${timeString}
                                    ${status === 'sent' ? '<span class="badge bg-primary ms-1">Sent</span>' : ''}
                                </small>
                            </div>
                        </div>
                        <div class="message-content">
                            <p class="mb-0">${message.content || message.message || 'No content available'}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = `
        <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center">
                <span class="badge bg-${sourceDisplay.color}">
                    <i class="${sourceDisplay.icon} me-1"></i>
                    ${sourceDisplay.text} (${messages.length} messages)
                </span>
                <button class="btn btn-sm btn-outline-secondary" onclick="loadMessageHistory()">
                    <i class="fas fa-refresh me-1"></i>Refresh
                </button>
            </div>
        </div>
        <div class="messages-list" style="max-height: 500px; overflow-y: auto;">
            ${messagesHtml}
        </div>
    `;
}

function sendMessage() {
    // Create a modal for message input
    const modalHtml = `
        <div class="modal fade" id="sendMessageModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Send Message to ${memberName}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">Message Type</label>
                            <select class="form-select" id="messageType">
                                <option value="sms">SMS Text Message</option>
                                <option value="email">Email</option>
                            </select>
                        </div>
                        <div class="mb-3" id="emailSubjectGroup" style="display: none;">
                            <label class="form-label">Subject</label>
                            <input type="text" class="form-control" id="emailSubject" placeholder="Email subject">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" id="messageContent" rows="4" placeholder="Type your message here..."></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Internal Notes (Managers Only)</label>
                            <textarea class="form-control" id="messageNotes" rows="2" placeholder="Add internal notes for tracking (not sent to client)..."></textarea>
                            <small class="form-text text-muted">These notes are only visible to managers and help track message history.</small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="submitMessage()">
                            <i class="fas fa-paper-plane me-1"></i>Send Message
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('sendMessageModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to body
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('sendMessageModal'));
    modal.show();
    
    // Handle message type change
    document.getElementById('messageType').addEventListener('change', function() {
        const emailSubjectGroup = document.getElementById('emailSubjectGroup');
        if (this.value === 'email') {
            emailSubjectGroup.style.display = 'block';
        } else {
            emailSubjectGroup.style.display = 'none';
        }
    });
}

function submitMessage() {
    const messageType = document.getElementById('messageType').value;
    const messageContent = document.getElementById('messageContent').value.trim();
    const emailSubject = document.getElementById('emailSubject').value.trim();
    const messageNotes = document.getElementById('messageNotes').value.trim();
    
    if (!messageContent) {
        alert('Please enter a message');
        return;
    }
    
    if (messageType === 'email' && !emailSubject) {
        alert('Please enter an email subject');
        return;
    }
    
    // Disable send button and show loading
    const sendButton = document.querySelector('#sendMessageModal .btn-primary');
    const originalText = sendButton.innerHTML;
    sendButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
    sendButton.disabled = true;
    
    // Prepare request data
    const requestData = {
        member_name: memberName,
        message: messageContent,
        message_type: messageType,
        notes: messageNotes
    };
    
    if (messageType === 'email') {
        requestData.subject = emailSubject;
    }
    
    // Send message
    fetch('/api/messages/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('sendMessageModal'));
            modal.hide();
            // Reload message history
            loadMessageHistory();
        } else {
            alert(`‚ùå Error: ${data.error}`);
        }
    })
    .catch(error => {
        debugError('Error sending message:', error);
        alert('‚ùå Error sending message. Please try again.');
    })
    .finally(() => {
        // Re-enable send button
        sendButton.innerHTML = originalText;
        sendButton.disabled = false;
    });
}

// Load message history when page loads
document.addEventListener('DOMContentLoaded', function() {
    loadMessageHistory();
    
    // Add search functionality
    document.getElementById('messageSearch').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const messageItems = document.querySelectorAll('.message-item');
        
        messageItems.forEach(item => {
            const content = item.textContent.toLowerCase();
            if (content.includes(searchTerm)) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    });
});
</script>
{% endblock %}


