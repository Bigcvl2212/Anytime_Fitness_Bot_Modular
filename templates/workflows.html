{% extends "base.html" %}

{% block title %}Workflows - Gym Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Workflow Management</h1>
        <p class="text-muted">Execute and monitor gym bot workflows</p>
    </div>
</div>

<div class="row">
    {% for workflow_id, workflow in workflows.items() %}
    <div class="col-md-6 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">{{ workflow.name }}</h5>
                <span class="badge bg-success">{{ workflow.status.title() }}</span>
            </div>
            <div class="card-body">
                <p class="card-text">{{ workflow.description }}</p>
                
                <div class="mb-3">
                    <label for="migration-mode-{{ workflow_id }}" class="form-label">Migration Mode:</label>
                    <select class="form-select form-select-sm" id="migration-mode-{{ workflow_id }}">
                        <option value="hybrid">Hybrid (API + Selenium)</option>
                        <option value="api_only">API Only</option>
                        <option value="selenium_only">Selenium Only</option>
                        <option value="testing">Testing Mode</option>
                    </select>
                </div>
                
                <div class="d-grid">
                    <button class="btn btn-primary" onclick="runWorkflow('{{ workflow_id }}')">
                        <i class="fas fa-play"></i> Run Workflow
                    </button>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5><i class="fas fa-terminal"></i> Workflow Output</h5>
            </div>
            <div class="card-body">
                <div id="workflow-output" class="bg-dark text-light p-3 rounded" style="min-height: 200px; font-family: monospace;">
                    <div class="text-muted">No workflow running. Select a workflow to see output.</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function runWorkflow(workflowId) {
    const migrationMode = document.getElementById(`migration-mode-${workflowId}`).value;
    const outputDiv = document.getElementById('workflow-output');
    
    // Clear output and show loading
    outputDiv.innerHTML = `<div class="text-info">Starting workflow: ${workflowId}...</div>`;
    
    // Disable all run buttons
    const buttons = document.querySelectorAll('button[onclick^="runWorkflow"]');
    buttons.forEach(btn => {
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Running...';
    });
    
    // Make API call
    fetch('/api/run-workflow', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            workflow: workflowId,
            migration_mode: migrationMode
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            outputDiv.innerHTML += `<div class="text-success">✓ ${data.message}</div>`;
            outputDiv.innerHTML += `<div class="text-muted">Check the logs page for detailed output...</div>`;
        } else {
            outputDiv.innerHTML += `<div class="text-danger">✗ Error: ${data.error}</div>`;
        }
    })
    .catch(error => {
        outputDiv.innerHTML += `<div class="text-danger">✗ Request failed: ${error}</div>`;
    })
    .finally(() => {
        // Re-enable buttons after 5 seconds
        setTimeout(() => {
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-play"></i> Run Workflow';
            });
        }, 5000);
    });
}

// Auto-scroll output
function scrollOutputToBottom() {
    const outputDiv = document.getElementById('workflow-output');
    outputDiv.scrollTop = outputDiv.scrollHeight;
}

// Poll for new logs when workflow is running
let logPolling = false;

function startLogPolling() {
    if (logPolling) return;
    logPolling = true;
    
    const pollLogs = () => {
        fetch('/api/logs')
            .then(response => response.json())
            .then(data => {
                // Update output with recent logs
                const outputDiv = document.getElementById('workflow-output');
                const recentLogs = data.logs.slice(0, 10);
                
                let logHtml = '';
                recentLogs.forEach(log => {
                    const timestamp = new Date(log.timestamp).toLocaleTimeString();
                    const levelClass = log.level === 'ERROR' ? 'text-danger' : 
                                      log.level === 'WARNING' ? 'text-warning' : 'text-info';
                    logHtml += `<div class="${levelClass}">[${timestamp}] ${log.component}: ${log.message}</div>`;
                });
                
                if (logHtml !== outputDiv.dataset.lastLogs) {
                    outputDiv.innerHTML = logHtml;
                    outputDiv.dataset.lastLogs = logHtml;
                    scrollOutputToBottom();
                }
            })
            .catch(error => console.log('Log polling error:', error));
        
        if (logPolling) {
            setTimeout(pollLogs, 2000);
        }
    };
    
    pollLogs();
}

// Start log polling when page loads
document.addEventListener('DOMContentLoaded', startLogPolling);
</script>
{% endblock %}