{% extends "base.html" %}

{% block title %}System Logs - Gym Bot{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>System Logs</h1>
        <p class="text-muted">Monitor real-time system activity and debug information</p>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-filter"></i></span>
            <select class="form-select" id="log-level-filter">
                <option value="">All Levels</option>
                <option value="INFO">Info</option>
                <option value="WARNING">Warning</option>
                <option value="ERROR">Error</option>
            </select>
        </div>
    </div>
    <div class="col-md-6">
        <div class="input-group">
            <span class="input-group-text"><i class="fas fa-search"></i></span>
            <input type="text" class="form-control" id="log-search" placeholder="Search logs...">
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-12">
        <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm" onclick="refreshLogs()">
                <i class="fas fa-refresh"></i> Refresh
            </button>
            <button class="btn btn-secondary btn-sm" onclick="clearLogs()">
                <i class="fas fa-trash"></i> Clear
            </button>
            <button class="btn btn-outline-primary btn-sm" onclick="toggleAutoRefresh()">
                <i class="fas fa-play" id="auto-refresh-icon"></i>
                <span id="auto-refresh-text">Start Auto-refresh</span>
            </button>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="fas fa-list"></i> Log Entries</h5>
                <small class="text-muted">Total: <span id="log-count">{{ logs|length }}</span></small>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive" style="max-height: 600px; overflow-y: auto;">
                    <table class="table table-sm table-striped mb-0" id="logs-table">
                        <thead class="table-dark sticky-top">
                            <tr>
                                <th style="width: 180px;">Timestamp</th>
                                <th style="width: 80px;">Level</th>
                                <th style="width: 120px;">Component</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody id="logs-tbody">
                            {% for log in logs %}
                            <tr class="log-row" 
                                data-level="{{ log.level }}" 
                                data-component="{{ log.component }}"
                                data-message="{{ log.message|lower }}">
                                <td class="font-monospace small">
                                    {{ log.timestamp }}
                                </td>
                                <td>
                                    <span class="badge bg-{% if log.level == 'ERROR' %}danger{% elif log.level == 'WARNING' %}warning{% else %}info{% endif %} log-level">
                                        {{ log.level }}
                                    </span>
                                </td>
                                <td class="fw-bold">{{ log.component }}</td>
                                <td class="log-message">{{ log.message }}</td>
                            </tr>
                            {% else %}
                            <tr id="no-logs-row">
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                                    No logs available
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let autoRefreshEnabled = false;
let autoRefreshInterval;

function refreshLogs() {
    fetch('/api/logs')
        .then(response => response.json())
        .then(data => {
            updateLogsTable(data.logs);
            document.getElementById('log-count').textContent = data.logs.length;
        })
        .catch(error => {
            console.error('Error fetching logs:', error);
            alert('Failed to refresh logs');
        });
}

function updateLogsTable(logs) {
    const tbody = document.getElementById('logs-tbody');
    const noLogsRow = document.getElementById('no-logs-row');
    
    if (logs.length === 0) {
        tbody.innerHTML = `
            <tr id="no-logs-row">
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    No logs available
                </td>
            </tr>
        `;
        return;
    }
    
    // Remove no-logs row if it exists
    if (noLogsRow) {
        noLogsRow.remove();
    }
    
    let html = '';
    logs.forEach(log => {
        const levelClass = log.level === 'ERROR' ? 'danger' : 
                          log.level === 'WARNING' ? 'warning' : 'info';
        
        html += `
            <tr class="log-row" 
                data-level="${log.level}" 
                data-component="${log.component}"
                data-message="${log.message.toLowerCase()}">
                <td class="font-monospace small">${log.timestamp}</td>
                <td>
                    <span class="badge bg-${levelClass} log-level">${log.level}</span>
                </td>
                <td class="fw-bold">${log.component}</td>
                <td class="log-message">${log.message}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Apply current filters
    applyFilters();
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs?')) {
        // This would need a backend endpoint to actually clear logs
        // For now, just clear the display
        const tbody = document.getElementById('logs-tbody');
        tbody.innerHTML = `
            <tr id="no-logs-row">
                <td colspan="4" class="text-center text-muted py-4">
                    <i class="fas fa-inbox fa-2x mb-2"></i><br>
                    Logs cleared
                </td>
            </tr>
        `;
        document.getElementById('log-count').textContent = '0';
    }
}

function toggleAutoRefresh() {
    const icon = document.getElementById('auto-refresh-icon');
    const text = document.getElementById('auto-refresh-text');
    
    if (autoRefreshEnabled) {
        // Stop auto-refresh
        clearInterval(autoRefreshInterval);
        autoRefreshEnabled = false;
        icon.className = 'fas fa-play';
        text.textContent = 'Start Auto-refresh';
    } else {
        // Start auto-refresh
        autoRefreshInterval = setInterval(refreshLogs, 5000); // Every 5 seconds
        autoRefreshEnabled = true;
        icon.className = 'fas fa-pause';
        text.textContent = 'Stop Auto-refresh';
    }
}

function applyFilters() {
    const levelFilter = document.getElementById('log-level-filter').value;
    const searchFilter = document.getElementById('log-search').value.toLowerCase();
    const rows = document.querySelectorAll('.log-row');
    let visibleCount = 0;
    
    rows.forEach(row => {
        const level = row.dataset.level;
        const message = row.dataset.message;
        const component = row.dataset.component.toLowerCase();
        
        let showRow = true;
        
        // Apply level filter
        if (levelFilter && level !== levelFilter) {
            showRow = false;
        }
        
        // Apply search filter
        if (searchFilter && !message.includes(searchFilter) && !component.includes(searchFilter)) {
            showRow = false;
        }
        
        row.style.display = showRow ? '' : 'none';
        if (showRow) visibleCount++;
    });
    
    // Update count
    document.getElementById('log-count').textContent = visibleCount;
}

// Set up event listeners
document.getElementById('log-level-filter').addEventListener('change', applyFilters);
document.getElementById('log-search').addEventListener('input', applyFilters);

// Auto-scroll to bottom when new logs arrive
function scrollToBottom() {
    const tableContainer = document.querySelector('.table-responsive');
    tableContainer.scrollTop = tableContainer.scrollHeight;
}

// Scroll to bottom on page load
document.addEventListener('DOMContentLoaded', () => {
    scrollToBottom();
});
</script>
{% endblock %}