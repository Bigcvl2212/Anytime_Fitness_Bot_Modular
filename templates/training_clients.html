{% extends "base.html" %}
{% block title %}Personal Training - Anytime FitnessÂ®{% endblock %}
{% block page_title %}Personal Training Management{% endblock %}
{% block page_subtitle %}Maximize your personal training revenue and client satisfaction{% endblock %}
{% block content %}
<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h5><i class="fas fa-user-friends me-2"></i>Personal Training Clients <span id="client-count-badge" class="badge bg-primary">Loading...</span></h5>
        <div class="d-flex gap-2">
            <!-- Search Form -->
            <form method="GET" class="d-flex gap-2" id="searchForm">
                <input type="text" 
                       name="search" 
                       id="searchInput"
                       placeholder="Search clients or trainers..." 
                       class="form-control form-control-sm" 
                       style="width: 200px;">
                
                <button type="button" class="btn btn-primary btn-sm" onclick="filterClients()">
                    <i class="fas fa-search"></i> Search
                </button>
                
                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="clearSearch()">
                    <i class="fas fa-times"></i> Clear
                </button>
            </form>
            
            <!-- Refresh Button -->
            <button type="button" class="btn btn-success btn-sm" onclick="refreshTrainingClients()">
                <i class="fas fa-sync-alt"></i> Refresh
            </button>
        </div>
    </div>
    <div class="card-body">
        <!-- Loading State -->
        <div id="training-clients-loading" class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading training clients from ClubOS...</p>
        </div>

        <!-- Training Clients Container -->
        <div id="training-clients-container" style="display: none;">
            <div class="table-container">
                <table class="table table-striped">
                    <thead>
                        <tr>
                            <th>Client</th>
                            <th>Trainer</th>
                            <th>Session Type</th>
                            <th>Sessions Left</th>
                            <th>Last Session</th>
                            <th>Funding Status</th>
                            <th>Agreement</th>
                        </tr>
                    </thead>
                    <tbody id="training-clients-tbody">
                        <!-- Training clients will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- No Training Clients Found -->
        <div id="no-training-clients" style="display: none;">
            <div class="text-center py-4">
                <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No training clients found</h5>
                <p class="text-muted">No personal training clients available from ClubOS.</p>
                <button class="btn btn-primary" onclick="refreshTrainingClients()">
                    <i class="fas fa-sync-alt me-2"></i>Try Again
                </button>
            </div>
        </div>

        <!-- Error State -->
        <div id="training-clients-error" style="display: none;">
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <span id="error-message">Error loading training clients</span>
                <button class="btn btn-sm btn-outline-danger ms-2" onclick="refreshTrainingClients()">
                    <i class="fas fa-retry me-1"></i>Retry
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Load training clients asynchronously
let allTrainingClients = [];
let filteredClients = [];

async function loadTrainingClients() {
    console.log('ðŸ‹ï¸ Loading training clients from ClubOS API...');
    
    const loadingElement = document.getElementById('training-clients-loading');
    const containerElement = document.getElementById('training-clients-container');
    const noClientsElement = document.getElementById('no-training-clients');
    const errorElement = document.getElementById('training-clients-error');
    
    // Show loading state
    loadingElement.style.display = 'block';
    containerElement.style.display = 'none';
    noClientsElement.style.display = 'none';
    errorElement.style.display = 'none';
    
    try {
        const response = await fetch('/api/training-clients/all');
        const data = await response.json();
        
        // Hide loading state
        loadingElement.style.display = 'none';
        
        if (data.success && data.training_clients && data.training_clients.length > 0) {
            console.log(`âœ… Loaded ${data.training_clients.length} training clients from ClubOS`);
            
            allTrainingClients = data.training_clients;
            filteredClients = [...allTrainingClients];
            
            displayTrainingClients(filteredClients);
            updateClientCount(filteredClients.length, data.data_source || 'clubos');
            
            containerElement.style.display = 'block';
        } else {
            console.log('â„¹ï¸ No training clients found or API returned empty result');
            noClientsElement.style.display = 'block';
            updateClientCount(0, data.data_source || 'unknown');
        }
    } catch (error) {
        console.error('âŒ Error loading training clients:', error);
        
        // Hide loading state
        loadingElement.style.display = 'none';
        
        // Show error message
        document.getElementById('error-message').textContent = `Error loading training clients: ${error.message}`;
        errorElement.style.display = 'block';
        updateClientCount(0, 'error');
    }
}

function displayTrainingClients(clients) {
    const tbody = document.getElementById('training-clients-tbody');
    
    let html = '';
    clients.forEach(client => {
        const sessionsRemaining = client.sessions_remaining || 0;
        const sessionsBadgeClass = sessionsRemaining > 5 ? 'bg-success' : 
                                   sessionsRemaining > 2 ? 'bg-warning' : 'bg-danger';
        
        html += `
            <tr>
                <td>
                    <strong>${client.member_name || 'Unknown Member'}</strong>
                    <br>
                    <small class="text-muted">ID: ${client.id || 'N/A'}</small>
                    ${client.clubos_member_id ? `<br><small class="text-muted">ClubOS: ${client.clubos_member_id}</small>` : ''}
                </td>
                <td>${client.trainer_name || 'Not Assigned'}</td>
                <td>
                    ${client.session_type ? 
                        `<span class="badge badge-purple">${client.session_type}</span>` : 
                        `<span class="badge bg-secondary">Not Specified</span>`
                    }
                </td>
                <td>
                    <span class="badge ${sessionsBadgeClass}">
                        ${sessionsRemaining}
                    </span>
                </td>
                <td>${client.last_session || 'Never'}</td>
                <td>
                    <span class="badge bg-${client.funding_status_class || 'secondary'}">
                        <i class="${client.funding_status_icon || 'fas fa-question-circle'} me-1"></i>
                        ${client.funding_status || 'Unknown'}
                    </span>
                </td>
                <td>
                    ${client.agreement_name ? `
                        <div>
                            <strong>${client.agreement_name}</strong>
                            ${client.agreement_expiration_date ? `<br><small class="text-muted">Expires: ${client.agreement_expiration_date}</small>` : ''}
                        </div>
                    ` : '<span class="text-muted">No Agreement</span>'}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

function updateClientCount(count, source) {
    const badge = document.getElementById('client-count-badge');
    let sourceText = '';
    
    switch(source) {
        case 'clubos_live_api':
            sourceText = ' (Live)';
            badge.className = 'badge bg-success';
            break;
        case 'database_fallback':
            sourceText = ' (Cached)';
            badge.className = 'badge bg-warning';
            break;
        case 'error':
            sourceText = ' (Error)';
            badge.className = 'badge bg-danger';
            break;
        default:
            badge.className = 'badge bg-primary';
    }
    
    badge.textContent = `${count} total${sourceText}`;
}

function filterClients() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    
    if (searchTerm === '') {
        filteredClients = [...allTrainingClients];
    } else {
        filteredClients = allTrainingClients.filter(client => {
            const memberName = (client.member_name || '').toLowerCase();
            const trainerName = (client.trainer_name || '').toLowerCase();
            const sessionType = (client.session_type || '').toLowerCase();
            
            return memberName.includes(searchTerm) || 
                   trainerName.includes(searchTerm) || 
                   sessionType.includes(searchTerm);
        });
    }
    
    displayTrainingClients(filteredClients);
    updateClientCount(filteredClients.length, 'filtered');
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    filteredClients = [...allTrainingClients];
    displayTrainingClients(filteredClients);
    updateClientCount(filteredClients.length, 'all');
}

async function refreshTrainingClients() {
    console.log('ðŸ”„ Refreshing training clients data...');
    await loadTrainingClients();
}

// Load training clients when page loads
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Training clients page loaded - starting async data load');
    loadTrainingClients();
    
    // Add enter key support for search
    document.getElementById('searchInput').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            filterClients();
        }
    });
});
</script>
{% endblock %}