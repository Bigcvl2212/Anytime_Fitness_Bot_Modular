{% extends "base.html" %}

{% block title %}Members - Anytime Fitness Club Management{% endblock %}

{% block extra_css %}
<style>
    .nav-tabs .nav-link.active {
        font-weight: 600;
        color: #0d6efd !important;
        border-bottom: 2px solid #0d6efd;
        background-color: transparent;
    }
    
    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-radius: 0;
        padding: 1rem 1.5rem;
    }
    
    .nav-tabs .nav-link:hover {
        color: #0d6efd;
        border-color: transparent;
    }
    
    .tab-content {
        padding: 0.25rem 0;
    }
    
    .member-card {
        transition: transform 0.2s ease-in-out;
        cursor: pointer;
    }
    
    .member-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .stats-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
    }
    
    .count-display {
        font-size: 2.5rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    
    .loading-spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    .empty-state {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }
    
    .empty-state i {
        font-size: 4rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }
    
    .search-section {
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        padding: 0.5rem;
        margin-bottom: 0.25rem;
    }
    
    .search-input {
        border-radius: 25px;
        border: 1px solid #dee2e6;
        padding: 0.75rem 1.5rem;
    }
    
    .search-input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }
    
    .member-detail-value {
        font-weight: 600;
        color: #212529;
    }
    
    /* Conversation Styles */
    .conversation-container {
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
    }
    
    .conversation-message {
        margin-bottom: 1rem;
    }
    
    .message-bubble {
        max-width: 80%;
        padding: 0.75rem;
        border-radius: 1rem;
        position: relative;
    }
    
    .member-message .message-bubble {
        background: #e3f2fd;
        border: 1px solid #bbdefb;
        margin-right: auto;
    }
    
    .user-message .message-bubble {
        background: #0d6efd;
        color: white;
        margin-left: auto;
    }
    
    .message-content {
        word-wrap: break-word;
    }
    
    .message-content p {
        margin-bottom: 0.25rem;
    }
    
    .message-content small {
        opacity: 0.8;
    }
    
    .message-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 0.5rem;
    }
    
    .message-action-btn {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
        border-radius: 0.25rem;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .message-action-btn:hover {
        transform: scale(1.05);
    }
    
    .form-label-muted {
        color: #6c757d;
        font-weight: 500;
        font-size: 0.875rem;
        margin-bottom: 0.25rem;
    }
    
    .outlook-badge {
        display: inline-block;
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1;
        text-align: center;
        white-space: nowrap;
        vertical-align: baseline;
        border-radius: 0.375rem;
    }
    
    .outlook-badge-success {
        color: #ffffff;
        background-color: #198754;
    }
    
    .outlook-badge-warning {
        color: #000000;
        background-color: #ffc107;
    }
    
    .outlook-badge-danger {
        color: #ffffff;
        background-color: #dc3545;
    }
    
    .outlook-badge-info {
        color: #ffffff;
        background-color: #0dcaf0;
    }
    
    .outlook-badge-secondary {
        color: #ffffff;
        background-color: #6c757d;
    }
    
    .prospect-card {
        border: 2px solid #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #f8fff9 100%);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Member Management
                    </h1>
                    <p class="text-muted mb-0">Manage and view all club members</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn btn-info" onclick="refreshBillingData()" title="Refresh real billing data from ClubHub">
                        <i class="fas fa-dollar-sign me-1"></i>
                        Refresh Billing
                    </button>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                    <button class="btn btn-success" onclick="loadActualMemberCounts()" title="Refresh member counts">
                        <i class="fas fa-users me-1"></i>
                        Refresh Counts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agreement Summary Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><strong>ðŸ“Š Agreement Summary</strong></h5>
                </div>
                <div class="card-body">
                    <div class="row text-center" id="agreement-summary">
                        <div class="col-md-3">
                            <div class="h4 text-primary" id="active-agreements-count">-</div>
                            <small class="text-muted">Green Members</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-success" id="total-monthly-revenue">-</div>
                            <small class="text-muted">Monthly Revenue</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-warning" id="past-due-count">-</div>
                            <small class="text-muted">Past Due (Y+R)</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-danger" id="total-past-due">-</div>
                            <small class="text-muted">Total Past Due $</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="membersTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="green-members-tab" data-bs-toggle="tab" data-bs-target="#green-members" type="button" role="tab" aria-controls="green-members" aria-selected="true" onclick="loadMembersByCategory('green')">
                        Green Members
                        <span class="badge bg-success ms-2" id="green-count-badge">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comp-members-tab" data-bs-toggle="tab" data-bs-target="#comp-members" type="button" role="tab" aria-controls="comp-members" aria-selected="false" onclick="loadMembersByCategory('comp')">
                        Comp Members
                        <span id="comp-count-badge" class="badge bg-info ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ppv-members-tab" data-bs-toggle="tab" data-bs-target="#ppv-members" type="button" role="tab" aria-controls="ppv-members" aria-selected="false" onclick="loadMembersByCategory('ppv')">
                        Pay Per Visit
                        <span id="ppv-count-badge" class="badge bg-secondary ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="staff-members-tab" data-bs-toggle="tab" data-bs-target="#staff-members" type="button" role="tab" aria-controls="staff-members" aria-selected="false" onclick="loadMembersByCategory('staff')">
                        Staff Members
                        <span id="staff-count-badge" class="badge bg-warning text-dark ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="past-due-tab" data-bs-toggle="tab" data-bs-target="#past-due" type="button" role="tab" aria-controls="past-due" aria-selected="false" onclick="loadPastDueMembers()">
                        Past Due
                        <span id="past-due-count-badge" class="badge bg-danger ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inactive-members-tab" data-bs-toggle="tab" data-bs-target="#inactive-members" type="button" role="tab" aria-controls="inactive-members" aria-selected="false" onclick="loadMembersByCategory('inactive')">
                        Inactive
                        <span id="inactive-count-badge" class="badge bg-dark ms-2">-</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="membersTabContent">
        <!-- Green Members Tab -->
        <div class="tab-pane fade show active" id="green-members" role="tabpanel" aria-labelledby="green-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search green members..." id="greenMemberSearch">
                </div>
            </div>
            <div class="row" id="green-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading green members...</p>
                    </div>
                </div>
        </div>

        <!-- Past Due Tab -->
        <div class="tab-pane fade" id="past-due" role="tabpanel" aria-labelledby="past-due-tab">
            <!-- Loading State -->
            <div id="past-due-loading" class="text-center py-3">
                <div class="loading-spinner"></div>
                <p class="text-muted mt-3">Loading past due members...</p>
            </div>

            <!-- No Past Due Members -->
            <div id="no-past-due" class="empty-state" style="display: none;">
                <i class="fas fa-check-circle text-success"></i>
                <h4>No Past Due Members</h4>
                <p>All members are current with their payments.</p>
            </div>

            <!-- Past Due Content -->
            <div id="past-due-content" style="display: none;">
                <!-- Compact Stats and Action Row -->
                <div class="row mb-3">
                    <div class="col-md-3">
                        <div class="card text-white bg-danger">
                            <div class="card-body text-center py-2">
                                <h6 class="card-title mb-1">Critical</h6>
                                <h4 id="red-count-display" class="mb-1">-</h4>
                                <small class="card-text">Immediate attention</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card text-dark bg-warning">
                            <div class="card-body text-center py-2">
                                <h6 class="card-title mb-1">Attention</h6>
                                <h4 id="yellow-count-display" class="mb-1">-</h4>
                                <small class="card-text">Payment issues</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 d-flex align-items-center justify-content-end">
                        <button class="btn btn-primary btn-sm" onclick="showBatchInvoiceModal()">
                            <i class="fas fa-file-invoice-dollar me-1"></i>
                            Batch Invoicing
                        </button>
                    </div>
                </div>

                <div class="row" id="past-due-members-container">
                    <!-- Past due members will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Comp Members Tab -->
        <div class="tab-pane fade" id="comp-members" role="tabpanel" aria-labelledby="comp-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search comp members..." id="compMemberSearch">
                </div>
            </div>
            <div class="row" id="comp-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading comp members...</p>
                </div>
            </div>
        </div>

        <!-- Pay Per Visit Members Tab -->
        <div class="tab-pane fade" id="ppv-members" role="tabpanel" aria-labelledby="ppv-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search pay-per-visit members..." id="ppvMemberSearch">
                </div>
            </div>
            <div class="row" id="ppv-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading pay-per-visit members...</p>
                </div>
            </div>
        </div>

        <!-- Staff Members Tab -->
        <div class="tab-pane fade" id="staff-members" role="tabpanel" aria-labelledby="staff-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search staff members..." id="staffMemberSearch">
                </div>
            </div>
            <div class="row" id="staff-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading staff members...</p>
                </div>
            </div>
        </div>

        <!-- Inactive Members Tab -->
        <div class="tab-pane fade" id="inactive-members" role="tabpanel" aria-labelledby="inactive-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search inactive members..." id="inactiveMemberSearch">
                </div>
            </div>
            <div class="row" id="inactive-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading inactive members...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoicePreviewModalLabel">Invoice Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Member:</strong> <span id="invoice-member-name"></span></p>
                <div class="mb-3">
                    <label for="invoice-amount" class="form-label">Amount ($)</label>
                    <input type="number" class="form-control" id="invoice-amount" placeholder="e.g., 50.00">
                </div>
                <div class="mb-3">
                    <label for="invoice-description" class="form-label">Description</label>
                    <textarea class="form-control" id="invoice-description" rows="3" placeholder="e.g., August Membership Dues + Late Fee"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendFinalInvoice()">Send Invoice</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Invoice Modal -->
<div class="modal fade" id="batchInvoiceModal" tabindex="-1" aria-labelledby="batchInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchInvoiceModalLabel">Batch Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The following members will be sent an invoice:</p>
                <ul id="batch-invoice-member-list">
                    <!-- Selected members will be listed here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendBatchInvoices()">Send Invoices</button>
            </div>
        </div>
    </div>
</div>

<!-- Member Profile Modal -->
<div class="modal fade" id="memberProfileModal" tabindex="-1" aria-labelledby="memberProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberProfileModalLabel">
                    <i class="fas fa-user me-2"></i>
                    <span id="modal-member-name">Member Profile</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="member-profile-loading" class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading member profile...</p>
                </div>

                <!-- Profile Content -->
                <div id="member-profile-content" style="display: none;">
                    <div class="row">
                        <!-- Personal Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user me-2"></i>
                                        Personal Information
                                    </h6>
                                </div>
                                <div class="card-body" id="personal-info-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-address-book me-2"></i>
                                        Contact Information
                                    </h6>
                                </div>
                                <div class="card-body" id="contact-info-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Agreements -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-contract me-2"></i>
                                        Agreements
                                    </h6>
                                </div>
                                <div class="card-body" id="agreements-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Training Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-dumbbell me-2"></i>
                                        Training Information
                                    </h6>
                                </div>
                                <div class="card-body" id="training-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Payment History -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Payment History
                                    </h6>
                                </div>
                                <div class="card-body" id="payments-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Invoice History -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        Invoice History
                                    </h6>
                                </div>
                                <div class="card-body" id="invoice-history-content">
                                    <p class="text-muted">Invoice history will be displayed here.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Member Inbox and Conversation History -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <ul class="nav nav-tabs card-header-tabs" id="memberInboxTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active text-white" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button" role="tab">
                                                <i class="fas fa-inbox me-2"></i>
                                                Inbox
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link text-white" id="conversation-tab" data-bs-toggle="tab" data-bs-target="#conversation" type="button" role="tab">
                                                <i class="fas fa-comments me-2"></i>
                                                Conversation History
                                            </button>
                                        </li>
                                        <li class="nav-item ms-auto">
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-light" onclick="loadMemberMessages()">
                                                    <i class="fas fa-sync-alt me-1"></i>
                                                    Refresh
                                                </button>
                                                <button class="btn btn-sm btn-light" onclick="sendMessageToMember()">
                                                    <i class="fas fa-paper-plane me-1"></i>
                                                    Send Message
                                                </button>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="memberInboxTabContent">
                                        <!-- Inbox Tab -->
                                        <div class="tab-pane fade show active" id="inbox" role="tabpanel">
                                            <div class="mb-3">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="memberMessageSearch" placeholder="Search messages...">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="searchMemberMessages()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="member-inbox-container" style="max-height: 400px; overflow-y: auto;">
                                                <div class="text-center py-4">
                                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                    <h5 class="text-muted">No messages in inbox</h5>
                                                    <p class="text-muted">Messages will appear here when received</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Conversation History Tab -->
                                        <div class="tab-pane fade" id="conversation" role="tabpanel">
                                            <div id="conversation-container" style="max-height: 400px; overflow-y: auto;">
                                                <div class="text-center py-4">
                                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                                    <h5 class="text-muted">No conversation history</h5>
                                                    <p class="text-muted">Click "Send Message" to start a conversation</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="showInvoicePreview()">
                    <i class="fas fa-file-invoice-dollar me-1"></i>
                    Send Invoice
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function refreshData() {
    const refreshButton = document.querySelector('button[onclick="refreshData()"]');
    if (refreshButton) {
        refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
        refreshButton.disabled = true;
    }
    
    fetch('/api/refresh-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Data refreshed successfully!\nMembers: ${data.counts.members}\nProspects: ${data.counts.prospects}`);
            window.location.reload();
        } else {
            alert('Error refreshing data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error refreshing data. Please try again.');
    })
    .finally(() => {
        if (refreshButton) {
            refreshButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Now';
            refreshButton.disabled = false;
        }
    });
}

function refreshBillingData() {
    const billingButton = document.querySelector('button[onclick="refreshBillingData()"]');
    if (billingButton) {
        billingButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing Billing...';
        billingButton.disabled = true;
    }
    
    fetch('/api/refresh-billing-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Billing data refreshed successfully from ClubHub!\nUpdated Members: ${data.updated_members}\nPast Due Members: ${data.past_due_members}\nTotal Past Due: $${data.total_past_due_amount}\nTotal Late Fees: $${data.total_late_fees}`);
            // Refresh the current tab to show updated billing info
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                if (activeTab.id === 'past-due-tab') {
                    loadPastDueMembers();
                } else {
                    const category = activeTab.id.replace('-tab', '').replace('-members', '');
                    loadMembersByCategory(category);
                }
            }
        } else {
            alert('Error refreshing billing data: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error refreshing billing data. Please try again.');
    })
    .finally(() => {
        if (billingButton) {
            billingButton.innerHTML = '<i class="fas fa-dollar-sign me-1"></i>Refresh Billing';
            billingButton.disabled = false;
        }
    });
}

// Auto-check data status every 5 minutes
setInterval(function() {
    fetch('/api/data-status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.needs_refresh) {
                console.log('Data is stale, consider refreshing');
            }
        })
        .catch(error => console.error('Error checking data status:', error));
}, 300000);

// Member Profile Modal Functions
function openMemberProfile(memberId, memberName, memberEmail) {
    console.log(`Opening profile for member: ${memberName} (ID: ${memberId})`);
    
    document.getElementById('modal-member-name').textContent = memberName;
    document.getElementById('member-profile-loading').style.display = 'block';
    document.getElementById('member-profile-content').style.display = 'none';
    
    const modalElement = document.getElementById('memberProfileModal');
    const modal = new bootstrap.Modal(modalElement);
    
    modalElement.addEventListener('shown.bs.modal', function() {
        const closeButton = modalElement.querySelector('.btn-close');
        if (closeButton) {
            closeButton.focus();
        }
    }, { once: true });
    
    modal.show();
    fetchMemberDetails(memberId, memberName, memberEmail);
}

function fetchMemberDetails(memberId, memberName, memberEmail) {
    // Store the current member ID for invoice creation
    window.currentMemberId = memberId;
    window.currentMemberName = memberName;
    window.currentMemberEmail = memberEmail;
    
    fetch(`/api/member/${memberId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('member-profile-loading').style.display = 'none';
                document.getElementById('member-profile-content').style.display = 'block';
                
                populatePersonalInfo(data.member, data.payment_status);
                populateContactInfo(data.member);
                populateAgreements(data.agreements);
                populatePayments(data.payments);
                populateTrainingInfo(data.training_info);
            } else {
                document.getElementById('member-profile-loading').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger">Error loading member profile: ${data.error}</p>
                        <button class="btn btn-outline-secondary" onclick="fetchMemberDetails(${memberId}, '${memberName}', '${memberEmail}')">
                            <i class="fas fa-redo me-1"></i>Try Again
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            console.error('Error fetching member details:', error);
            document.getElementById('member-profile-loading').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Network error loading member profile</p>
                    <button class="btn btn-outline-secondary" onclick="fetchMemberDetails(${memberId}, '${memberName}', '${memberEmail}')">
                        <i class="fas fa-redo me-1"></i>Try Again
                    </button>
                </div>
            `;
        });
}

function populatePersonalInfo(member, paymentStatus) {
    const personalInfoContent = document.getElementById('personal-info-content');
    
    // Format member since date
    let memberSince = 'Unknown';
    if (member.membership_start || member.membershipStart) {
        try {
            const startDate = new Date(member.membership_start || member.membershipStart);
            memberSince = startDate.toLocaleDateString();
        } catch (e) {
            memberSince = member.membership_start || member.membershipStart;
        }
    } else if (member.created_at) {
        try {
            const createdDate = new Date(member.created_at);
            memberSince = createdDate.toLocaleDateString();
        } catch (e) {
            memberSince = member.created_at;
        }
    }
    
    // Format last visit date
    let lastVisit = 'Never';
    if (member.last_visit || member.lastVisit) {
        try {
            const visitDate = new Date(member.last_visit || member.lastVisit);
            lastVisit = visitDate.toLocaleDateString();
        } catch (e) {
            lastVisit = member.last_visit || member.lastVisit;
        }
    }
    
    // Format membership end date if available
    let membershipEnd = 'N/A';
    if (member.membership_end || member.membershipEnd) {
        try {
            const endDate = new Date(member.membership_end || member.membershipEnd);
            membershipEnd = endDate.toLocaleDateString();
        } catch (e) {
            membershipEnd = member.membership_end || member.membershipEnd;
        }
    }
    
    // Format next payment date
    let nextPaymentDate = 'N/A';
    let nextPaymentAmount = 'N/A';
    if (paymentStatus && paymentStatus.next_payment_date) {
        try {
            const payDate = new Date(paymentStatus.next_payment_date);
            nextPaymentDate = payDate.toLocaleDateString();
            nextPaymentAmount = paymentStatus.next_payment_amount ? 
                `$${parseFloat(paymentStatus.next_payment_amount).toFixed(2)}` : 'N/A';
        } catch (e) {
            nextPaymentDate = paymentStatus.next_payment_date;
            nextPaymentAmount = paymentStatus.next_payment_amount || 'N/A';
        }
    }
    
    // Add payment status badge
    const statusBadge = `<span class="outlook-badge outlook-badge-${paymentStatus.class}">${paymentStatus.text}</span>`;
    
    // Create data source badges
    let dataSourceBadge;
    if (member.fresh_data_error) {
        dataSourceBadge = '<span class="badge bg-warning ms-2" title="' + member.fresh_data_error + '">API Error</span>';
    } else if (member.fresh_data) {
        dataSourceBadge = '<span class="badge bg-success ms-2">Live Data</span>';
    } else {
        dataSourceBadge = '<span class="badge bg-secondary ms-2">Database Data</span>';
    }
    
    personalInfoContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Full Name</label>
            <div class="member-detail-value">${member.full_name || 
                ((member.first_name || '') + ' ' + (member.last_name || '')).trim() || 
                ((member.firstName || '') + ' ' + (member.lastName || '')).trim() || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Email</label>
            <div class="member-detail-value">${member.email || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Phone</label>
            <div class="member-detail-value">${member.mobile_phone || member.mobilePhone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member ID</label>
            <div class="member-detail-value">${member.id} ${dataSourceBadge}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">ClubOS ID</label>
            <div class="member-detail-value">${member.clubos_member_id || member.prospectId || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member Status</label>
            <div>${member.status ? '<span class="outlook-badge outlook-badge-info">' + member.status + '</span>' : 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Payment Status</label>
            <div>${statusBadge}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Next Payment</label>
            <div class="member-detail-value">
                ${nextPaymentDate !== 'N/A' ? `${nextPaymentDate} (${nextPaymentAmount})` : 'N/A'}
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member Since</label>
            <div class="member-detail-value">${memberSince}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Last Visit</label>
            <div class="member-detail-value">${lastVisit}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Membership End</label>
            <div class="member-detail-value">${membershipEnd}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">User Type</label>
            <div class="member-detail-value">${member.user_type || member.memberType || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Contract Types</label>
            <div class="member-detail-value">${member.contract_types || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Trial Status</label>
            <div class="member-detail-value">${member.trial ? 'Trial Member' : 'Regular Member'}</div>
        </div>
    `;
}

function populateContactInfo(member) {
    const contactInfoContent = document.getElementById('contact-info-content');
    contactInfoContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Mobile Phone</label>
            <div class="member-detail-value">${member.mobile_phone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Home Phone</label>
            <div class="member-detail-value">${member.home_phone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Address</label>
            <div class="member-detail-value">${member.address || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Emergency Contact</label>
            <div class="member-detail-value">${member.emergency_contact || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Date of Birth</label>
            <div class="member-detail-value">${member.date_of_birth || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Gender</label>
            <div class="member-detail-value">${member.gender || 'N/A'}</div>
        </div>
    `;
}

function populateAgreements(agreements) {
    const agreementsContent = document.getElementById('agreements-content');
    
    if (!agreements || agreements.length === 0) {
        agreementsContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                <p class="text-muted">No agreements found</p>
            </div>
        `;
        return;
    }
    
    let agreementsHtml = '<div class="row">';
    agreements.forEach(agreement => {
        agreementsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${agreement.agreement_type || 'Agreement'}</h6>
                        <p class="card-text">
                            <small class="text-muted">Start: ${agreement.start_date || 'N/A'}</small><br>
                            <small class="text-muted">End: ${agreement.end_date || 'N/A'}</small><br>
                            <small class="text-muted">Rate: $${agreement.rate || '0.00'}</small>
                        </p>
                        ${agreement.status ? '<span class="outlook-badge outlook-badge-info">' + agreement.status + '</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    });
    agreementsHtml += '</div>';
    
    agreementsContent.innerHTML = agreementsHtml;
}

function populatePayments(payments) {
    const paymentsContent = document.getElementById('payments-content');
    
    if (!payments || payments.length === 0) {
        paymentsContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                <p class="text-muted">No payment history found</p>
            </div>
        `;
        return;
    }
    
    let paymentsHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    payments.forEach(payment => {
        const paymentDate = payment.payment_date ? new Date(payment.payment_date).toLocaleDateString() : 'N/A';
        const amount = payment.amount ? `$${parseFloat(payment.amount).toFixed(2)}` : 'N/A';
        
        paymentsHtml += `
            <tr>
                <td>${paymentDate}</td>
                <td>${amount}</td>
                <td>${payment.payment_type || 'N/A'}</td>
                <td>
                    ${payment.status ? '<span class="outlook-badge outlook-badge-' + (payment.status === 'completed' ? 'success' : 'warning') + '">' + payment.status + '</span>' : 'N/A'}
                </td>
            </tr>
        `;
    });
    
    paymentsHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    paymentsContent.innerHTML = paymentsHtml;
}

function populateTrainingInfo(trainingInfo) {
    const trainingContent = document.getElementById('training-content');
    
    if (!trainingInfo) {
        trainingContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-dumbbell fa-3x text-muted mb-3"></i>
                <p class="text-muted">No training information found</p>
                <small class="text-muted">This member is not currently enrolled in personal training</small>
            </div>
        `;
        return;
    }
    
    trainingContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Trainer</label>
            <div class="member-detail-value">${trainingInfo.trainer_name || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Session Type</label>
            <div class="member-detail-value">${trainingInfo.session_type || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Sessions Remaining</label>
            <div class="member-detail-value">
                <span class="badge ${trainingInfo.sessions_remaining > 0 ? 'bg-success' : 'bg-warning'}">
                    ${trainingInfo.sessions_remaining || 0} sessions
                </span>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Last Session</label>
            <div class="member-detail-value">${trainingInfo.last_session || 'No sessions recorded'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Payment Status</label>
            <div class="member-detail-value">
                <span class="badge ${trainingInfo.payment_status === 'Current' ? 'bg-success' : 'bg-warning'}">
                    ${trainingInfo.payment_status || 'Unknown'}
                </span>
            </div>
        </div>
    `;
}

function populateInvoices(invoices) {
    const invoiceHistoryContent = document.getElementById('invoice-history-content');
    
    if (!invoices || invoices.length === 0) {
        invoiceHistoryContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                <p class="text-muted">No invoice history found</p>
            </div>
        `;
        return;
    }
    
    let invoicesHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Invoice ID</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    invoices.forEach(invoice => {
        const invoiceDate = invoice.date ? new Date(invoice.date).toLocaleDateString() : 'N/A';
        const amount = invoice.amount ? `$${parseFloat(invoice.amount).toFixed(2)}` : 'N/A';
        
        invoicesHtml += `
            <tr>
                <td>${invoiceDate}</td>
                <td>${invoice.id || 'N/A'}</td>
                <td>${amount}</td>
                <td>
                    ${invoice.status ? '<span class="outlook-badge outlook-badge-' + (invoice.status === 'paid' ? 'success' : 'warning') + '">' + invoice.status + '</span>' : 'N/A'}
                </td>
            </tr>
        `;
    });
    
    invoicesHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    invoiceHistoryContent.innerHTML = invoicesHtml;
}

// TEST FUNCTION - Call this from browser console to test API
function testPastDueAPI() {
    console.log('ðŸ§ª TESTING Past Due API directly...');
    loadPastDueMembers();
}

// Past Due Members Loading - SIMPLIFIED AND MORE RELIABLE
// pastDueMembersLoaded is declared at the top with allMembersLoaded

// Add immediate test
console.log('ðŸš€ SCRIPT LOADED - Testing past due members functionality');

document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ DOM LOADED - Setting up past due members');
    const pastDueTab = document.getElementById('past-due-tab');
    
    if (pastDueTab) {
        // Listen for Bootstrap tab show event (when tab becomes active)
        pastDueTab.addEventListener('shown.bs.tab', function() {
            console.log('ï¿½ Past Due tab SHOWN - Bootstrap event triggered');
            pastDueMembersLoaded = false;
            loadPastDueMembers();
        });
        
        // Also listen for regular click as backup
        pastDueTab.addEventListener('click', function(e) {
            console.log('ðŸ“‹ Past Due tab CLICKED - Click event triggered', e);
            pastDueMembersLoaded = false;
            loadPastDueMembers();
        });
        
        // Test with mousedown event too
        pastDueTab.addEventListener('mousedown', function(e) {
            console.log('ðŸ“‹ Past Due tab MOUSEDOWN - Mousedown event triggered', e);
            pastDueMembersLoaded = false;
            setTimeout(() => loadPastDueMembers(), 100);
        });
        
        console.log('âœ… Past due tab event listeners added successfully');
    } else {
         console.error('âŒ CRITICAL: Could not find the past-due-tab element.');
    }
    
    // Load past due members immediately on page load as backup
    console.log('ðŸ”„ Page loaded, automatically loading past due members...');
    setTimeout(() => {
        console.log('â° Timeout triggered, calling loadPastDueMembers');
        loadPastDueMembers();
    }, 1000); // Reduce delay for testing
});

// IMMEDIATE TEST - Call API directly when script loads
console.log('ðŸ”¥ IMMEDIATE CALL - Testing loadPastDueMembers directly');
setTimeout(() => {
    console.log('ðŸ”¥ CALLING loadPastDueMembers() NOW');
    if (typeof loadPastDueMembers === 'function') {
        loadPastDueMembers();
    } else {
        console.error('âŒ loadPastDueMembers function not found!');
    }
}, 500);

function loadPastDueMembers() {
    console.log('ðŸ”¥ loadPastDueMembers() CALLED - Starting to load past due members...');
    
    // Reset the loaded flag and always fetch fresh data
    pastDueMembersLoaded = false;
    
    // Show loading state
    const loadingElement = document.getElementById('past-due-loading');
    const contentElement = document.getElementById('past-due-content');
    const noPastDueElement = document.getElementById('no-past-due');
    
    console.log('ðŸ” Element check:', {
        loading: !!loadingElement,
        content: !!contentElement,
        noPastDue: !!noPastDueElement
    });
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (contentElement) contentElement.style.display = 'none';
    if (noPastDueElement) noPastDueElement.style.display = 'none';
    
    console.log('ðŸ“¡ Fetching past due members from API...');
    
    // Force fresh data by adding timestamp to prevent caching
    fetch('/api/members/by-category/past_due?t=' + Date.now())
        .then(response => {
            console.log('ðŸ“¡ API response received:', response.status);
            if (!response.ok) {
                console.error('API returned error status:', response.status);
                return response.json().then(errorData => {
                    console.error('API error details:', errorData);
                    throw new Error(`API error: ${errorData.error || 'Unknown error'}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Past due data received:', data);
            if (!data || !data.success || !Array.isArray(data.members)) {
                console.error('Invalid data format received:', data);
                throw new Error('Invalid data format received from server');
            }
            pastDueMembersLoaded = true;

            // Use the members array from the database response
            let members = data.members || [];
            
            // Debug: Log first member to see what fields are available
            if (members.length > 0) {
                console.log('ðŸ” First member data sample:', members[0]);
                console.log('ðŸ” Available fields:', Object.keys(members[0]));
                console.log('ðŸ” Agreement fields:', Object.keys(members[0]).filter(k => k.includes('agreement')));
                console.log('ðŸ” Past due fields:', Object.keys(members[0]).filter(k => k.includes('past_due') || k.includes('late')));
            }
            
            let redCount = members.filter(m => m.status_message && m.status_message.includes('Past Due more than 30')).length;
            let yellowCount = members.filter(m => m.status_message && m.status_message.includes('Past Due 6-30')).length;

            // Update badges in nav tabs
            document.getElementById('past-due-count-badge').textContent = members.length;
            const redDisplay = document.getElementById('red-count-display');
            const yellowDisplay = document.getElementById('yellow-count-display');
            if (redDisplay) redDisplay.textContent = redCount;
            if (yellowDisplay) yellowDisplay.textContent = yellowCount;

            if (members.length > 0) {
                console.log(`Displaying ${members.length} past due members`);
                displayPastDueMembers(members);
                document.getElementById('past-due-loading').style.display = 'none';
                document.getElementById('past-due-content').style.display = 'block';
            } else {
                console.log('No past due members found');
                document.getElementById('past-due-loading').style.display = 'none';
                document.getElementById('no-past-due').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('Error loading past due members:', error);
            document.getElementById('past-due-loading').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Error loading past due members: ${error.message}</p>
                    <p class="text-muted mb-3">This may be due to expired credentials or API changes.</p>
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="retryLoadPastDue()">Try Again</button>
                        <button class="btn btn-outline-secondary ms-2" onclick="contactSupport()">Contact Support</button>
                    </div>
                </div>
            `;
        });
}

function displayPastDueMembers(members) {
    const container = document.getElementById('past-due-members-container');
    let html = '';
    
    members.forEach(member => {
        // Skip rendering a card if we have no navigation id and no name/email
        const navId = member.guid || member.prospect_id || member.id;
        if (!navId || (!member.full_name && !member.first_name && !member.last_name && !member.email)) {
            console.warn('Skipping member with insufficient data:', member);
            return; // Skip this iteration
        }

        // Determine card styling based on status message
        let cardClass = 'border-warning';
        let badgeClass = 'bg-warning';
        let statusText = 'Past Due';
        
        if (member.status_message && member.status_message.includes('Past Due more than 30')) {
            cardClass = 'border-danger';
            badgeClass = 'bg-danger';
            statusText = 'Critical';
        }
        
        // Generate a better display name
        let displayName = 'Unknown Name';
        
        // Try full name first
        if (member.full_name && member.full_name.trim()) {
            displayName = member.full_name;
        } 
        // Then try first + last name
        else if (member.first_name && member.last_name) {
            displayName = `${member.first_name} ${member.last_name}`;
        }
        // Then try just first or last name
        else if (member.first_name) {
            displayName = member.first_name;
        }
        else if (member.last_name) {
            displayName = member.last_name;
        }
        // Try to extract from email as last resort
        else if (member.email && member.email.includes('@')) {
            const emailName = member.email.split('@')[0];
            const cleanedName = emailName.replace(/[0-9_\.]/g, ' ').replace(/\s+/g, ' ').trim();
            if (cleanedName) {
                displayName = cleanedName.split(' ')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                    .join(' ') + ' (from email)';
            }
        }
        
                                // Format dates for display (same as other categories)
                        let memberSince = 'Unknown';
                        if (member.membership_start) {
                            try {
                                const startDate = new Date(member.membership_start);
                                memberSince = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            } catch (e) {
                                memberSince = member.membership_start.substring(0, 10);
                            }
                        }

                        let lastVisit = 'Never';
                        if (member.last_visit && member.last_visit !== '') {
                            try {
                                const visitDate = new Date(member.last_visit);
                                lastVisit = visitDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                            } catch (e) {
                                lastVisit = member.last_visit.substring(0, 10);
                            }
                        }

                        let nextPayment = '';
                        if (member.date_of_next_payment) {
                            try {
                                const payDate = new Date(member.date_of_next_payment);
                                const amount = member.amount_of_next_payment ? `$${parseFloat(member.amount_of_next_payment).toFixed(2)}` : '';
                                nextPayment = `${payDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} ${amount}`;
                            } catch (e) {
                                nextPayment = member.date_of_next_payment.substring(0, 10);
            }
        }
        
        html += `
                            <div class="col-md-6 col-lg-4 mb-3">
                                <div class="card ${cardClass} h-100 member-card" style="cursor: pointer;" onclick="window.location.href='/member/${member.guid || member.prospect_id || member.id}'">>
                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="card-title mb-0">
                                                <span class="text-decoration-none text-dark">${displayName}</span>
                                            </h6>
                                            <input type="checkbox" class="form-check-input batch-invoice-checkbox" data-member-id="${member.guid || member.prospect_id || member.id}" data-member-name="${displayName.replace(/'/g, "\\'")}" data-amount="${member.amount_past_due || 0}" onclick="event.stopPropagation();">
                        </div>
                                        <div class="mb-2">
                            <span class="badge ${badgeClass}">${statusText}</span>
                                            ${member.user_type ? `<span class="badge bg-outline-secondary ms-1">${member.user_type}</span>` : ''}
                                            ${member.status ? `<span class="badge bg-secondary ms-1">${member.status}</span>` : ''}
                    </div>
                                        <div class="small text-muted mb-2">
                                            ${member.email ? `<div><i class="fas fa-envelope me-1"></i><span class="text-truncate" title="${member.email}">${member.email}</span></div>` : '<div class="text-warning"><i class="fas fa-envelope me-1"></i>No email</div>'}
                                            ${member.mobile_phone ? `<div><i class="fas fa-phone me-1"></i>${member.mobile_phone}</div>` : '<div class="text-warning"><i class="fas fa-phone me-1"></i>No phone</div>'}
                                            <div><i class="fas fa-calendar me-1"></i>Since: ${memberSince}</div>
                                            <div><i class="fas fa-clock me-1"></i>Last visit: ${lastVisit}</div>
                                            ${nextPayment ? `<div><i class="fas fa-credit-card me-1"></i>Next: ${nextPayment}</div>` : ''}
                                        </div>
                                        <!-- Payment Summary - Always visible -->
                                        <div class="alert alert-info py-2 px-2 mb-2 small">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong><i class="fas fa-credit-card me-1"></i>Payment Summary</strong>
                                            </div>
                                            <div class="row text-center">
                                                <div class="col-3">
                                                    <div class="fw-bold text-dark">$${(parseFloat(member.base_amount_past_due || 0)).toFixed(2)}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Base Amount</div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="fw-bold text-dark">${member.missed_payments || 0}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Missed Payments</div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="fw-bold text-dark">$${(parseFloat(member.late_fees || 0)).toFixed(2)}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Late Fees</div>
                                                </div>
                                                <div class="col-3">
                                                    <div class="fw-bold text-dark">$${parseFloat(member.amount_past_due || 0).toFixed(2)}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Total Owed</div>
                                                </div>
                                            </div>

                                        </div>
                                                ${member.status_message ? `
                                                    <div class="mb-2 pb-1 border-bottom border-light">
                                                        <small class="text-dark"><i class="fas fa-info-circle me-1"></i>${member.status_message}</small>
                                                    </div>
                                                ` : ''}
                                        
                                        <!-- Agreement Details Section -->
                                        <div class="mt-3 p-2 bg-light rounded">
                                            <h6 class="text-dark mb-2"><strong>ðŸ“‹ Agreement Details</strong></h6>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <small class="text-muted">Status:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_status || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Type:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_type || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Recurring Cost:</small>
                                                    <div class="fw-bold text-dark">$${(parseFloat(member.agreement_recurring_cost || 0)).toFixed(2)}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Billing:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_billing_frequency || 'Unknown'}</div>
                                                </div>
                                                <div class="col-12">
                                                    <small class="text-muted">Agreement:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_name || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Start Date:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_start_date || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">End Date:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_end_date || 'Unknown'}</div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-auto d-flex gap-1">
                                            <button class="btn btn-sm btn-primary" onclick="event.stopPropagation(); window.location.href='/member/${member.guid || member.prospect_id || member.id}'" title="View Profile">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showQuickInvoiceModal('${member.id || member.guid}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}')" title="Create Invoice">
                                                <i class="fas fa-file-invoice-dollar"></i>
                                            </button>
                                            ${member.amount_past_due > 0 ? `
                                                <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); showInvoicePreviewForMember('${member.id || member.guid}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}', ${member.amount_past_due})" title="Send Past Due Invoice">
                                                    <i class="fas fa-exclamation-circle"></i>
                                                </button>
                                            ` : ''}
                                        </div>
                                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
    console.log('Past due members displayed successfully');
}

function retryLoadPastDue() {
    console.log('Retrying past due members loading...');
    pastDueMembersLoaded = false;
    document.getElementById('past-due-loading').innerHTML = `
        <div class="loading-spinner"></div>
        <p class="text-muted mt-3">Loading past due members...</p>
    `;
    loadPastDueMembers();
}

function sendSquareInvoice() {
    const memberName = document.getElementById('modal-member-name').textContent;
    const amount = 100.00; // Placeholder amount
    const description = 'Membership Dues'; // Placeholder description

    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_name: memberName,
            amount: amount,
            description: description,
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully!');
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while creating the invoice.');
    });
}

function createSquareInvoice() {
    alert('Square invoice creation will be implemented here');
}

function contactSupport() {
    // Open email client with pre-populated email
    const subject = encodeURIComponent('Gym Bot Support - Past Due Members Not Loading');
    const body = encodeURIComponent('I am experiencing an issue with the Past Due members tab not loading in the Gym Bot application. Please assist.');
    window.location.href = `mailto:support@example.com?subject=${subject}&body=${body}`;
}

function sendBatchInvoices() {
    const selectedMembers = [];
    document.querySelectorAll('.batch-invoice-checkbox:checked').forEach(checkbox => {
        selectedMembers.push(checkbox.dataset.memberId);
    });

    if (selectedMembers.length === 0) {
        alert('Please select at least one member to invoice.');
        return;
    }

    if (!confirm(`Create Square invoices for ${selectedMembers.length} members?`)) {
        return;
    }

    // Call the batch invoice API
    fetch('/api/invoices/batch', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            type: 'members',
            filter: 'past_due',
            selected_clients: selectedMembers
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Batch invoicing completed!\n\nTotal processed: ${data.summary.total_processed}\nSuccessful: ${data.summary.successful}\nFailed: ${data.summary.failed}`);
            
            // Show details if there were failures
            if (data.failed_invoices && data.failed_invoices.length > 0) {
                console.log('Failed invoices:', data.failed_invoices);
            }
            
            // Close modal and refresh
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchInvoiceModal'));
            modal.hide();
            
            // Refresh the page to update statuses
            location.reload();
        } else {
            alert('Error creating batch invoices: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating batch invoices:', error);
        alert('Network error: ' + error.message);
    });
}

function showBatchInvoiceModal() {
    // Auto-select ALL past due members first
    document.querySelectorAll('.batch-invoice-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    
    const selectedMembers = [];
    document.querySelectorAll('.batch-invoice-checkbox:checked').forEach(checkbox => {
        selectedMembers.push({
            id: checkbox.dataset.memberId,
            name: checkbox.dataset.memberName
        });
    });

    if (selectedMembers.length === 0) {
        alert('Please select at least one member to invoice.');
        return;
    }

    const memberList = document.getElementById('batch-invoice-member-list');
    memberList.innerHTML = '';
    selectedMembers.forEach(member => {
        const li = document.createElement('li');
        li.textContent = member.name;
        memberList.appendChild(li);
    });

    const modal = new bootstrap.Modal(document.getElementById('batchInvoiceModal'));
    modal.show();
}

function showInvoicePreview() {
    const memberId = window.currentMemberId; // Use global variable set in fetchMemberDetails
    const memberName = document.getElementById('modal-member-name').textContent;
    
    if (!memberId) {
        alert('No member selected. Please open a member profile first.');
        return;
    }
    
    // Show loading state
    document.getElementById('invoice-member-name').textContent = memberName;
    document.getElementById('invoice-amount').value = 'Calculating...';
    document.getElementById('invoice-description').value = 'Loading...';
    
    // Auto-calculate the correct amount with late fees
    fetch('/api/calculate-invoice-amount', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_id: memberId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('invoice-amount').value = data.total_amount.toFixed(2);
            document.getElementById('invoice-description').value = data.description;
            
            // Store the calculated data for sending
            window.invoiceData = {
                member_name: data.member_name,
                amount: data.total_amount,
                description: data.description,
                past_due_amount: data.past_due_amount,
                late_fee: data.late_fee
            };
        } else {
            alert('Error calculating invoice amount: ' + data.error);
            // Set defaults
            document.getElementById('invoice-amount').value = '50.00';
            document.getElementById('invoice-description').value = 'Membership Payment';
        }
    })
    .catch(error => {
        console.error('Error calculating invoice:', error);
        alert('Error calculating invoice amount');
        // Set defaults
        document.getElementById('invoice-amount').value = '50.00';
        document.getElementById('invoice-description').value = 'Membership Payment';
    });

    const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'));
    modal.show();
}

function sendFinalInvoice() {
    const memberName = document.getElementById('invoice-member-name').textContent;
    const amount = parseFloat(document.getElementById('invoice-amount').value);
    const description = document.getElementById('invoice-description').value;
    
    if (!memberName || !amount || amount <= 0) {
        alert('Please provide valid invoice details');
        return;
    }
    
    // Show loading state
    const button = event.target;
    const originalText = button.textContent;
    button.textContent = 'Creating Invoice...';
    button.disabled = true;
    
    // Create the invoice
    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            member_name: memberName,
            amount: amount,
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully! URL: ' + data.invoice_url);
            
            // Close the modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('invoicePreviewModal'));
            modal.hide();
            
            // Add to invoice history (future enhancement)
            // TODO: Save invoice to member's history
            
        } else {
            alert('Failed to create invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error creating invoice:', error);
        alert('Error creating invoice: ' + error.message);
    })
    .finally(() => {
        // Reset button state
        button.textContent = originalText;
        button.disabled = false;
    });
}

function showQuickInvoiceModal(memberId, memberName, memberEmail) {
    const amount = prompt(`Enter invoice amount for ${memberName}:`, '50.00');
    if (!amount || isNaN(amount)) return;
    
    const description = prompt('Enter invoice description:', 'Monthly Membership Dues');
    if (!description) return;
    
    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            member_name: memberName,
            member_email: memberEmail,
            amount: parseFloat(amount),
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully! URL: ' + data.invoice_url);
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating invoice');
    });
}

function showInvoicePreviewForMember(memberId, memberName, memberEmail, pastDueAmount) {
    if (!confirm(`Create past due invoice for ${memberName} - $${pastDueAmount.toFixed(2)}?`)) {
        return;
    }
    
    // Use the backend-calculated amount (already includes proper late fees)
    const totalAmount = parseFloat(pastDueAmount);
    const description = `Total Amount Owed: $${totalAmount.toFixed(2)} (includes late fees)`;
    
    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            member_name: memberName,
            member_email: memberEmail,
            amount: totalAmount,
            description: description,
            past_due_amount: baseAmount,
            late_fee: lateFee
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`Past due invoice created successfully!\nAmount: $${totalAmount.toFixed(2)}\nURL: ${data.invoice_url}`);
            // Optionally refresh the members list
            loadMembersByCategory('past_due');
        } else {
            alert('Error creating past due invoice: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error creating past due invoice');
    });
}

// Global variables for async loading
let allMembersLoaded = false;
let pastDueMembersLoaded = false;

// Async function to load all members
async function loadAllMembers(page = 1, search = '', statusFilter = '') {
    if (allMembersLoaded && !search && !statusFilter && page === 1) {
        console.log('âœ… All members already loaded, skipping...');
        return;
    }

    console.log('ðŸ”„ Loading all members asynchronously...');
    
    const membersContainer = document.getElementById('membersContainer');
    const loadingHTML = `
        <div class="col-12 text-center py-5" id="members-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading members...</p>
        </div>
    `;
    
    // Show loading state
    if (page === 1) {
        membersContainer.innerHTML = loadingHTML;
    }
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            search: search,
            status: statusFilter
        });
        
        const response = await fetch(`/api/members/all?${params}`);
        const data = await response.json();
        
        if (data.success) {
            console.log(`âœ… Loaded ${data.members.length} members from API`);
            
            // Clear loading state
            if (page === 1) {
                membersContainer.innerHTML = '';
            }
            
            // Generate member cards HTML
            let html = '';
            data.members.forEach(member => {
                // Generate a proper full name
                let displayName = 'Unknown Name';
                if (member.full_name && member.full_name.trim() !== '') {
                    displayName = member.full_name;
                } else if (member.first_name || member.last_name) {
                    displayName = `${member.first_name || ''} ${member.last_name || ''}`.trim();
                } else if (member.email && member.email.includes('@')) {
                    // Try to extract a name from email
                    const emailName = member.email.split('@')[0];
                    const cleanedName = emailName.replace(/[^a-zA-Z ]/g, ' ').replace(/\s+/g, ' ').trim();
                    if (cleanedName) {
                        displayName = cleanedName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                        displayName += ' (from email)';
                    }
                }
                
                html += `
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4 member-item" 
                         data-name="${(displayName || '').toLowerCase()}" 
                         data-email="${(member.email || '').toLowerCase()}" 
                         data-status="${(member.status || '').toLowerCase()}">
                        <div class="card member-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <a href="/member/${member.id}" class="text-decoration-none text-dark">${displayName}</a>
                                    </h6>
                                    <span class="badge bg-${member.payment_status_class || 'primary'}">${member.status || 'Active'}</span>
                                </div>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-envelope me-1"></i>
                                    ${member.email ? `<a href="mailto:${member.email}" class="text-decoration-none">${member.email}</a>` : 'No email'}
                                </p>
                                ${member.mobile_phone ? `
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-phone me-1"></i>
                                    <a href="tel:${member.mobile_phone}" class="text-decoration-none">${member.mobile_phone}</a>
                                </p>
                                ` : ''}
                                <div class="d-flex justify-content-between align-items-end">
                                    <small class="text-muted">ID: ${member.id}</small>
                                    ${member.membership_start ? `
                                    <small class="text-muted">Since: ${member.membership_start.substring(0, 10)}</small>
                                    ` : ''}
                                </div>
                                
                                <!-- Agreement Details Section -->
                                <div class="mt-3 p-2 bg-light rounded">
                                    <h6 class="text-dark mb-2"><strong>ðŸ“‹ Agreement Details</strong></h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">Status:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_status && member.agreement_status !== 'No Agreement') ? member.agreement_status : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Type:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_type && member.agreement_type !== 'No Agreement') ? member.agreement_type : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Recurring Cost:</small>
                                            <div class="fw-bold text-dark">$${(member.agreement_recurring_cost && member.agreement_recurring_cost > 0) ? parseFloat(member.agreement_recurring_cost).toFixed(2) : '0.00'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Billing:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_billing_frequency && member.agreement_billing_frequency !== 'No Agreement') ? member.agreement_billing_frequency : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-12">
                                            <small class="text-muted">Agreement:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_name && member.agreement_name !== 'No Agreement') ? member.agreement_name : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Start Date:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_start_date && member.agreement_start_date !== 'No Agreement') ? member.agreement_start_date : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">End Date:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_end_date && member.agreement_end_date !== 'No Agreement') ? member.agreement_end_date : 'No Agreement Data'}</div>
                                        </div>
                                                                                    </div>

                                            </div>
                                            
                                            <div class="mt-2 d-flex gap-1">
                                    <a href="/member/${member.id}" class="btn btn-sm btn-primary" title="View Profile">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showQuickInvoiceModal('${member.id}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}')" title="Create Invoice">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (data.members.length === 0 && page === 1) {
                html = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No Members Found</h4>
                            <p>There are currently no members matching your criteria.</p>
                        </div>
                    </div>
                `;
            }
            
            membersContainer.innerHTML = html;
            allMembersLoaded = true;
            
            // Update search and filter dropdowns
            updateStatusFilterOptions(data.statuses || []);
            
            console.log('âœ… All members loaded and displayed successfully');
        } else {
            throw new Error(data.error || 'Failed to load members');
        }
    } catch (error) {
        console.error('âŒ Error loading members:', error);
        membersContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading members: ${error.message}
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadAllMembers()">
                        <i class="fas fa-retry me-1"></i>Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// Function to update status filter options
function updateStatusFilterOptions(statuses) {
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter && statuses.length > 0) {
        const currentValue = statusFilter.value;
        statusFilter.innerHTML = '<option value="">All Status</option>';
        
        statuses.forEach(status => {
            if (status && status.trim()) {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusFilter.appendChild(option);
            }
        });
        
        statusFilter.value = currentValue;
    }
}

// Function to load members by category
async function loadMembersByCategory(category) {
    console.log(`ðŸ”„ Loading ${category} members...`);
    
    // Scroll to top of page to ensure members are visible
    window.scrollTo({ top: 0, behavior: 'smooth' });
    
    const containerMap = {
        'green': 'green-members-container',
        'comp': 'comp-members-container',
        'ppv': 'ppv-members-container', 
        'staff': 'staff-members-container',
        'past_due': 'past-due-members-container',
        'inactive': 'inactive-members-container'
    };
    
    const container = document.getElementById(containerMap[category]);
    if (!container) {
        console.error(`âŒ Container not found for category: ${category}`);
        return;
    }
    
    console.log(`âœ… Found container for ${category}:`, container);
    
    // Show loading state
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading ${category} members...</p>
        </div>
    `;
    
    try {
        let endpoint = `/api/members/by-category/${category}`;
        console.log(`ðŸ“¡ Fetching from: ${endpoint}`);
        
        // Force fresh data by adding timestamp to prevent caching
        const response = await fetch(endpoint + '?t=' + Date.now());
        console.log(`ðŸ“¡ Response status: ${response.status}`);
        
        const data = await response.json();
        console.log(`ðŸ“¡ Response data:`, data);
        
        if (data.success) {
            console.log(`âœ… Loaded ${data.members?.length || 0} ${category} members`);
            
            let html = '';
            const members = data.members || [];
            
            if (members.length === 0) {
                html = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No ${category.charAt(0).toUpperCase() + category.slice(1)} Members</h4>
                            <p>There are currently no members in this category.</p>
                        </div>
                    </div>
                `;
            } else {
                console.log(`ðŸ“ Generating HTML for ${members.length} members`);
                members.forEach((member, index) => {
                    console.log(`ðŸ‘¤ Processing member ${index + 1}:`, member);
                    
                    let displayName = 'Unknown Name';
                    if (member.full_name && member.full_name.trim() !== '') {
                        displayName = member.full_name;
                    } else if (member.first_name || member.last_name) {
                        displayName = `${member.first_name || ''} ${member.last_name || ''}`.trim();
                    }
                    
                    // Color coding based on category
                    let cardClass = 'member-card';
                    let badgeClass = 'bg-primary';
                    let categoryLabel = category;
                    
                    if (category === 'past_due') {
                        cardClass += ' border-danger';
                        badgeClass = member.amount_past_due > 100 ? 'bg-danger' : 'bg-warning text-dark';
                        categoryLabel = member.amount_past_due > 100 ? 'Critical' : 'Past Due';
                    } else if (category === 'comp') {
                        cardClass += ' border-info';
                        badgeClass = 'bg-info';
                        categoryLabel = 'Comp';
                    } else if (category === 'ppv') {
                        cardClass += ' border-secondary';
                        badgeClass = 'bg-secondary';
                        categoryLabel = 'Pay Per Visit';
                    } else if (category === 'frozen') {
                        cardClass += ' border-light';
                        badgeClass = 'bg-light text-dark';
                        categoryLabel = 'Frozen';
                    } else if (category === 'inactive') {
                        cardClass += ' border-dark';
                        badgeClass = 'bg-dark';
                        categoryLabel = 'Inactive';
                    }
                    
                    // Format dates for display
                    let memberSince = 'Unknown';
                    if (member.membership_start) {
                        try {
                            const startDate = new Date(member.membership_start);
                            memberSince = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        } catch (e) {
                            memberSince = member.membership_start.substring(0, 10);
                        }
                    }

                    let lastVisit = 'Never';
                    if (member.last_visit && member.last_visit !== '') {
                        try {
                            const visitDate = new Date(member.last_visit);
                            lastVisit = visitDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                        } catch (e) {
                            lastVisit = member.last_visit.substring(0, 10);
                        }
                    }

                    let nextPayment = '';
                    if (member.date_of_next_payment) {
                        try {
                            const payDate = new Date(member.date_of_next_payment);
                            const amount = member.amount_of_next_payment ? `$${parseFloat(member.amount_of_next_payment).toFixed(2)}` : '';
                            nextPayment = `${payDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} ${amount}`;
                        } catch (e) {
                            nextPayment = member.date_of_next_payment.substring(0, 10);
                        }
                    }
                    
                    html += `
                        <div class="col-md-6 col-lg-4 mb-3">
                            <div class="card ${cardClass} h-100" style="cursor: pointer;" onclick="window.location.href='/member/${member.guid || member.prospect_id || member.id}'">>
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <h6 class="card-title mb-0">
                                        <a href="/member/${member.guid || member.prospect_id || member.id}" class="text-decoration-none text-dark">${displayName}</a>
                                    </h6>
                                        ${category === 'past_due' ? `<input type="checkbox" class="form-check-input batch-invoice-checkbox" data-member-id="${member.guid || member.prospect_id || member.id}" data-member-name="${displayName.replace(/'/g, "\\'")}" data-amount="${member.amount_past_due || 0}">` : ''}
                                    </div>
                                    <div class="mb-2">
                                        <span class="badge ${badgeClass}">${categoryLabel}</span>
                                        ${member.user_type ? `<span class="badge bg-outline-secondary ms-1">${member.user_type}</span>` : ''}
                                        ${member.status ? `<span class="badge bg-secondary ms-1">${member.status}</span>` : ''}
                                    </div>
                                    <div class="small text-muted mb-2">
                                        ${member.email ? `<div><i class="fas fa-envelope me-1"></i><span class="text-truncate" title="${member.email}">${member.email}</span></div>` : '<div class="text-warning"><i class="fas fa-envelope me-1"></i>No email</div>'}
                                        ${member.mobile_phone ? `<div><i class="fas fa-phone me-1"></i>${member.mobile_phone}</div>` : '<div class="text-warning"><i class="fas fa-phone me-1"></i>No phone</div>'}
                                        <div><i class="fas fa-calendar me-1"></i>Since: ${memberSince}</div>
                                        <div><i class="fas fa-clock me-1"></i>Last visit: ${lastVisit}</div>
                                        ${nextPayment ? `<div><i class="fas fa-credit-card me-1"></i>Next: ${nextPayment}</div>` : ''}
                                    </div>
                                    ${member.amount_past_due > 0 ? `
                                        <div class="alert alert-danger py-2 px-2 mb-2 small">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <strong><i class="fas fa-exclamation-triangle me-1"></i>Past Due Details</strong>
                                                <span class="badge bg-danger">OVERDUE</span>
                                            </div>
                                            <div class="row text-center mb-2">
                                                <div class="col-4">
                                                    <div class="fw-bold text-dark">$${parseFloat(member.amount_past_due).toFixed(2)}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Amount Due</div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="fw-bold text-dark">${Math.max(1, Math.ceil(parseFloat(member.amount_past_due) / 50))}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Missed Payments</div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="fw-bold text-dark">$${(parseFloat(member.late_fees || 0)).toFixed(2)}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Late Fees</div>
                                                </div>
                                                <div class="col-4">
                                                    <div class="fw-bold text-dark">$${parseFloat(member.amount_past_due).toFixed(2)}</div>
                                                    <div style="font-size: 0.7rem;" class="text-muted">Total Amount</div>
                                                </div>
                                            </div>
                                            ${member.status_message ? `
                                                <div class="mb-2 pb-1 border-bottom border-light">
                                                    <small class="text-dark"><i class="fas fa-info-circle me-1"></i>${member.status_message}</small>
                                                </div>
                                            ` : ''}
                                            <div class="d-flex justify-content-between align-items-center pt-1 border-top border-light">
                                                <small class="text-dark"><strong>Base Amount:</strong></small>
                                                <small class="text-dark">$${(parseFloat(member.base_amount_past_due || 0)).toFixed(2)}</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center pt-1">
                                                <small class="text-dark"><strong>Late Fees:</strong></small>
                                                <small class="text-dark">$${(parseFloat(member.late_fees || 0)).toFixed(2)}</small>
                                            </div>
                                            <div class="d-flex justify-content-between align-items-center pt-1 border-top border-light">
                                                <small class="text-dark"><strong>Total Amount Owed:</strong></small>
                                                <small class="text-dark"><strong>$${parseFloat(member.amount_past_due).toFixed(2)}</strong></small>
                                            </div>
                                        </div>
                                        
                                        <!-- Agreement Details Section -->
                                        <div class="mt-3 p-2 bg-light rounded">
                                            <h6 class="text-dark mb-2"><strong>ðŸ“‹ Agreement Details</strong></h6>
                                            <div class="row g-2">
                                                <div class="col-6">
                                                    <small class="text-muted">Status:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_status || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Type:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_type || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Recurring Cost:</small>
                                                    <div class="fw-bold text-dark">$${(parseFloat(member.agreement_recurring_cost || 0)).toFixed(2)}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Billing:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_billing_frequency || 'Unknown'}</div>
                                                </div>
                                                <div class="col-12">
                                                    <small class="text-muted">Agreement:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_name || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Start Date:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_start_date || 'Unknown'}</div>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">End Date:</small>
                                                    <div class="fw-bold text-dark">${member.agreement_end_date || 'Unknown'}</div>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                    <div class="mt-auto d-flex gap-1">
                                        <a href="/member/${member.guid || member.prospect_id || member.id}" class="btn btn-sm btn-primary" title="View Profile">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showQuickInvoiceModal('${member.id || member.guid}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}')" title="Create Invoice">
                                            <i class="fas fa-file-invoice-dollar"></i>
                                        </button>
                                        ${member.amount_past_due > 0 ? `
                                            <button class="btn btn-sm btn-danger" onclick="event.stopPropagation(); showInvoicePreviewForMember('${member.id || member.guid}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}', ${member.amount_past_due})" title="Send Past Due Invoice">
                                                <i class="fas fa-exclamation-circle"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                });
            }
            
            console.log(`ðŸ“ Generated HTML length: ${html.length} characters`);
            container.innerHTML = html;
            console.log(`âœ… HTML inserted into container`);
            
            // Update badge counts
            const countBadge = document.getElementById(`${category}-count-badge`);
            if (countBadge) {
                countBadge.textContent = members.length;
                console.log(`ðŸ“Š Updated ${category} count badge to: ${members.length}`);
            }
            
        } else {
            throw new Error(data.error || `Failed to load ${category} members`);
        }
        
    } catch (error) {
        console.error(`âŒ Error loading ${category} members:`, error);
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading ${category} members: ${error.message}
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadMembersByCategory('${category}')">
                        <i class="fas fa-retry me-1"></i>Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// Load category counts for all tabs
async function loadCategoryCounts() {
    console.log('ðŸ”¢ Loading category counts...');
    try {
        const response = await fetch('/api/members/category-counts');
        const data = await response.json();
        
        if (data.success) {
            const counts = data.counts;
            
            // Update tab badges
            document.getElementById('green-count-badge').textContent = counts.green || 0;
            document.getElementById('comp-count-badge').textContent = counts.comp || 0;
            document.getElementById('ppv-count-badge').textContent = counts.ppv || 0;
            document.getElementById('staff-count-badge').textContent = counts.staff || 0;
            document.getElementById('past-due-count-badge').textContent = counts.past_due || 0;
            document.getElementById('inactive-count-badge').textContent = counts.inactive || 0;
            
            console.log('âœ… Category counts updated:', counts);
        } else {
            console.error('âŒ Failed to load category counts:', data.error);
        }
    } catch (error) {
        console.error('âŒ Error loading category counts:', error);
    }
}

// Consolidated DOMContentLoaded listener for all page functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('ðŸš€ Members page DOM loaded - setting up async functionality');
    
    // Load category counts immediately
    console.log('ðŸ“Š Loading category counts...');
    loadCategoryCounts();
    
    // Load green members immediately on page load (default active tab)
    console.log('ðŸƒ Loading green members as default...');
    loadMembersByCategory('green');
    
    // Check for cached data first
    console.log('ðŸ” Checking for cached member data...');
    checkCachedData();
    
    // Member search functionality for individual category search inputs
    const searchInputs = [
        'greenMemberSearch',
        'compMemberSearch', 
        'ppvMemberSearch',
        'staffMemberSearch',
        'inactiveMemberSearch'
    ];
    
    function setupCategorySearch(categoryId) {
        const searchInput = document.getElementById(categoryId);
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterMembersByCategory(categoryId, this.value);
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterMembersByCategory(categoryId, this.value);
                }
            });
        }
    }
    
    function filterMembersByCategory(categoryId, searchTerm) {
        console.log(`ðŸ” Filtering ${categoryId} with: "${searchTerm}"`);
        
        const memberItems = document.querySelectorAll(`#${categoryId.replace('Search', '')} .member-item`);
        const searchLower = searchTerm.toLowerCase();
        
        memberItems.forEach(item => {
            const name = item.dataset.name || '';
            const email = item.dataset.email || '';
            const phone = item.dataset.phone || '';
            
            const matchesSearch = name.toLowerCase().includes(searchLower) || 
                                 email.toLowerCase().includes(searchLower) || 
                                 phone.toLowerCase().includes(searchLower);
            
            if (matchesSearch || !searchTerm) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Set up search for all categories
    searchInputs.forEach(setupCategorySearch);

    // Tab switching functionality
    const allMembersTab = document.getElementById('all-members-tab');
    const pastDueTab = document.getElementById('past-due-tab');
    
    if (allMembersTab) {
        allMembersTab.addEventListener('shown.bs.tab', function() {
            console.log('ðŸ“‹ All Members tab shown');
            loadAllMembers();
        });
    }
    
    if (pastDueTab) {
        pastDueTab.addEventListener('shown.bs.tab', function() {
            console.log('ðŸ“‹ Past Due tab shown');
            loadPastDueMembers();
        });
    }
    
    console.log('âœ… Members page async setup complete');
});

// Function to update agreement summary
function updateAgreementSummary(members) {
    if (!members || !Array.isArray(members)) return;
    
    const activeAgreements = members.filter(m => m.agreement_status && m.agreement_status !== 'No Agreement').length;
    const totalMonthlyRevenue = members.reduce((sum, m) => sum + (parseFloat(m.agreement_recurring_cost || 0)), 0);
    const pastDueCount = members.filter(m => m.amount_past_due > 0).length;
    const totalPastDue = members.reduce((sum, m) => sum + (parseFloat(m.amount_past_due || 0)), 0);
    
    // Update summary display
    const activeCountEl = document.getElementById('active-agreements-count');
    const revenueEl = document.getElementById('total-monthly-revenue');
    const pastDueCountEl = document.getElementById('past-due-count');
    const totalPastDueEl = document.getElementById('total-past-due');
    
    if (activeCountEl) activeCountEl.textContent = activeAgreements;
    if (revenueEl) revenueEl.textContent = `$${totalMonthlyRevenue.toFixed(2)}`;
    if (pastDueCountEl) pastDueCountEl.textContent = pastDueCount;
    if (totalPastDueEl) totalPastDueEl.textContent = `$${totalPastDue.toFixed(2)}`;
}

// Check for cached data and load it if available
async function checkCachedData() {
    console.log('ðŸ” Checking for cached member data...');
    try {
        // Force fresh data by adding timestamp to prevent caching
        const response = await fetch('/api/members/all?t=' + Date.now());
        const data = await response.json();
        
        if (data.success) {
            console.log('ðŸ“Š Using database member data:', data.members.length, 'members');
            // Cache the data locally for faster access
            window.cachedMembers = data.members;
            updateAgreementSummary(data.members);
        } else {
            console.log('âš ï¸ No member data available');
        }
    } catch (error) {
        console.error('âŒ Error checking cached data:', error);
    }
}

// Load category counts for all tabs
async function loadCategoryCounts() {
    // This function will be implemented later
    console.log('ðŸ“Š Category counts loading...');
}

// Function to load actual member counts from API
async function loadActualMemberCounts() {
    try {
        const response = await fetch('/api/members/all');
        const data = await response.json();
        
        if (data.success && data.members) {
            const members = data.members;
            
            // Calculate counts based on status_message logic
            const greenCount = members.filter(m => m.status_message && m.status_message.includes('Active')).length;
            const yellowCount = members.filter(m => m.status_message && m.status_message.includes('Past Due 6-30')).length;
            const redCount = members.filter(m => m.status_message && m.status_message.includes('Past Due more than 30')).length;
            const frozenCount = members.filter(m => m.status_message && m.status_message.includes('Frozen')).length;
            const pendingCount = members.filter(m => m.status_message && m.status_message.includes('Pending')).length;
            const compCount = members.filter(m => m.user_type === 'comp' || m.status === 'comp').length;
            const ppvCount = members.filter(m => m.user_type === 'ppv' || m.status === 'ppv').length;
            const reactivatedCount = members.filter(m => m.status_message && m.status_message.includes('Reactivated')).length;
            const staffCount = members.filter(m => m.user_type === 'staff' || m.status === 'staff').length;
            const employerPaidCount = members.filter(m => m.user_type === 'employer_paid' || m.status === 'employer_paid').length;
            
            // Update the summary banner
            const activeCountEl = document.getElementById('active-agreements-count');
            const revenueEl = document.getElementById('total-monthly-revenue');
            const pastDueCountEl = document.getElementById('past-due-count');
            const totalPastDueEl = document.getElementById('total-past-due');
            
            if (activeCountEl) activeCountEl.textContent = greenCount;
            if (revenueEl) revenueEl.textContent = `$${(members.reduce((sum, m) => sum + (parseFloat(m.agreement_recurring_cost || 0)), 0)).toFixed(2)}`;
            if (pastDueCountEl) pastDueCountEl.textContent = yellowCount + redCount;
            if (totalPastDueEl) totalPastDueEl.textContent = `$${(members.reduce((sum, m) => sum + (parseFloat(m.amount_past_due || 0)), 0)).toFixed(2)}`;
            
            console.log('ðŸ“Š Actual member counts loaded:', {
                green: greenCount,
                yellow: yellowCount,
                red: redCount,
                frozen: frozenCount,
                pending: pendingCount,
                comp: compCount,
                ppv: ppvCount,
                reactivated: reactivatedCount,
                staff: staffCount,
                employerPaid: employerPaidCount
            });
        }
    } catch (error) {
        console.error('âŒ Error loading member counts:', error);
    }
}

// Initialize the page
checkCachedData();
loadActualMemberCounts();

// Check if we should open a member profile from URL parameters
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('search');
    const openProfile = urlParams.get('open_profile');
    const highlightMember = urlParams.get('highlight');
    
    if (searchQuery && openProfile === 'true') {
        // Wait a bit for the page to load, then open the member profile
        setTimeout(() => {
            if (highlightMember) {
                // If we have a specific member ID, use that
                showMemberProfile(searchQuery, highlightMember);
            } else {
                // Otherwise just use the search query
                showMemberProfile(searchQuery);
            }
        }, 1000);
    }
    
    // Add event listener for member message search
    const memberMessageSearch = document.getElementById('memberMessageSearch');
    if (memberMessageSearch) {
        memberMessageSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMemberMessages();
            }
        });
    }
});

// Conversation Functions
let currentMemberName = '';

// Load messages for the current member
function loadMemberMessages() {
    if (!currentMemberName) {
        console.log('âš ï¸ No member selected for messages');
        return;
    }
    
    console.log(`ðŸ’¬ Loading messages for: ${currentMemberName}`);
    
    fetch(`/api/messages/member/${encodeURIComponent(currentMemberName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMemberInbox(data.messages);
                displayMemberConversation(data.messages);
            } else {
                console.error('Error loading member messages:', data.error);
                displayMemberInbox([]);
                displayMemberConversation([]);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            displayMemberInbox([]);
            displayMemberConversation([]);
        });
}

// Display inbox for the member
function displayMemberInbox(messages) {
    const container = document.getElementById('member-inbox-container');
    
    if (!messages || messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No messages in inbox</h5>
                <p class="text-muted">Messages will appear here when received</p>
            </div>
        `;
        return;
    }
    
    // Display messages in inbox format (newest first)
    const inboxHtml = messages.map(message => {
        const isFromMember = message.from_user && message.from_user.toLowerCase().includes(currentMemberName.toLowerCase());
        const messageClass = isFromMember ? 'member-message' : 'user-message';
        
        // Parse message actions
        let messageActions = '';
        try {
            const actions = JSON.parse(message.message_actions || '{}');
            if (actions.is_confirmation) messageActions += '<span class="badge bg-success me-1">âœ“ Confirmed</span>';
            if (actions.is_opt_in) messageActions += '<span class="badge bg-info me-1">ðŸ“± Opt-in</span>';
            if (actions.is_opt_out) messageActions += '<span class="badge bg-warning me-1">ðŸš« Opt-out</span>';
            if (actions.has_emoji) {
                const emojis = actions.emojis || [];
                messageActions += emojis.map(emoji => `<span class="emoji-reaction">${emoji}</span>`).join('');
            }
        } catch (e) {
            // Ignore parsing errors
        }
        
        return `
            <div class="message-item p-3 border-bottom ${messageClass}">
                <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-1">
                            <strong class="me-2">${isFromMember ? currentMemberName : 'You'}</strong>
                            <small class="text-muted">${formatDateTime(message.timestamp)}</small>
                        </div>
                        <div class="message-content">
                            <p class="mb-1">${message.content || 'No content'}</p>
                            ${messageActions ? `<div class="message-actions mt-2">${messageActions}</div>` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = inboxHtml;
}

// Search messages for the current member
function searchMemberMessages() {
    const query = document.getElementById('memberMessageSearch').value;
    if (!query.trim()) {
        loadMemberMessages();
        return;
    }
    
    fetch(`/api/messages/search?q=${encodeURIComponent(query)}&member=${encodeURIComponent(currentMemberName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMemberInbox(data.messages);
            }
        })
        .catch(error => {
            console.error('Error searching member messages:', error);
        });
}

// Display conversation for the member
function displayMemberConversation(messages) {
    const container = document.getElementById('conversation-container');
    
    if (!messages || messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No messages yet</h5>
                <p class="text-muted">Click "Send Message" to start a conversation with ${currentMemberName}</p>
            </div>
        `;
        return;
    }
    
    // Display messages in chronological order (oldest first for conversation view)
    const conversationHtml = messages.map(message => {
        const isFromMember = message.from_user && message.from_user.toLowerCase().includes(currentMemberName.toLowerCase());
        const messageClass = isFromMember ? 'member-message' : 'user-message';
        const messageAlign = isFromMember ? 'text-start' : 'text-end';
        
        // Parse message actions
        let messageActions = '';
        try {
            const actions = JSON.parse(message.message_actions || '{}');
            if (actions.is_confirmation) messageActions += '<span class="badge bg-success me-1">âœ“ Confirmed</span>';
            if (actions.is_opt_in) messageActions += '<span class="badge bg-info me-1">ðŸ“± Opt-in</span>';
            if (actions.is_opt_out) messageActions += '<span class="badge bg-warning me-1">ðŸš« Opt-out</span>';
            if (actions.has_emoji) {
                const emojis = actions.emojis || [];
                messageActions += emojis.map(emoji => `<span class="emoji-reaction">${emoji}</span>`).join('');
            }
        } catch (e) {
            // Ignore parsing errors
        }
        
        return `
            <div class="conversation-message ${messageClass} mb-3">
                <div class="message-bubble ${messageAlign}">
                    <div class="message-content">
                        <p class="mb-1">${message.content || 'No content'}</p>
                        <small class="text-muted">
                            ${formatDateTime(message.timestamp)}
                            ${message.message_type ? ` â€¢ ${message.message_type}` : ''}
                        </small>
                        ${messageActions ? `<div class="message-actions mt-2">${messageActions}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = conversationHtml;
    
    // Scroll to bottom to show latest messages
    container.scrollTop = container.scrollHeight;
}

// Send message to the current member using ClubOS API
function sendMessageToMember() {
    if (!currentMemberName) {
        alert('No member selected');
        return;
    }
    
    // Get member ID from the current member data
    const memberId = getCurrentMemberId();
    if (!memberId) {
        alert('Member ID not found. Please refresh the member list.');
        return;
    }
    
    const message = prompt(`Send SMS to ${currentMemberName}:`);
    if (!message || message.trim() === '') {
        return;
    }
    
    // Show sending indicator
    const originalButtonText = document.querySelector('button[onclick="sendMessageToMember()"]')?.innerText;
    if (originalButtonText) {
        document.querySelector('button[onclick="sendMessageToMember()"]').innerText = 'Sending...';
        document.querySelector('button[onclick="sendMessageToMember()"]').disabled = true;
    }
    
    // Send via ClubOS API
    fetch('/api/send-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            message: message.trim(),
            channel: 'sms'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`âœ… Message sent successfully to ${currentMemberName}!`);
        } else {
            alert(`âŒ Failed to send message: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error sending message:', error);
        alert(`âŒ Error sending message: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        if (originalButtonText) {
            document.querySelector('button[onclick="sendMessageToMember()"]').innerText = originalButtonText;
            document.querySelector('button[onclick="sendMessageToMember()"]').disabled = false;
        }
        
        // Refresh the conversation
        setTimeout(() => {
            loadMemberMessages();
        }, 1000);
    });
}

// Helper function to get current member ID
function getCurrentMemberId() {
    // Look for member ID in various places in the DOM
    const memberCard = document.querySelector('.member-card.selected');
    if (memberCard) {
        return memberCard.dataset.memberId;
    }
    
    // Try to find it in the global member data
    if (window.currentMemberData && window.currentMemberData.member_id) {
        return window.currentMemberData.member_id;
    }
    
    // Last resort: search through loaded members
    if (window.membersData) {
        const member = window.membersData.find(m => 
            (m.first_name + ' ' + m.last_name) === currentMemberName ||
            m.name === currentMemberName
        );
        return member ? member.member_id : null;
    }
    
    return null;
}

// Update the showMemberProfile function to load messages
function showMemberProfile(memberName, memberId = null) {
    console.log(`ðŸ‘¤ Showing profile for: ${memberName}${memberId ? ` (ID: ${memberId})` : ''}`);
    
    // Set current member name for conversation loading
    currentMemberName = memberName;
    
    // Update modal title
    document.getElementById('modal-member-name').textContent = memberName;
    
    // Show loading state
    document.getElementById('member-profile-loading').style.display = 'block';
    document.getElementById('member-profile-content').style.display = 'none';
    
    // Open modal
    const modalElement = document.getElementById('memberProfileModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Load member data and messages
    Promise.all([
        loadMemberData(memberName, memberId),
        loadMemberMessages()
    ]).then(() => {
        // Hide loading, show content
        document.getElementById('member-profile-loading').style.display = 'none';
        document.getElementById('member-profile-content').style.display = 'block';
    }).catch(error => {
        console.error('Error loading member profile:', error);
        document.getElementById('member-profile-loading').style.display = 'none';
        document.getElementById('member-profile-content').style.display = 'block';
    });
}

// Utility function for formatting dates
function formatDateTime(dateString) {
    if (!dateString) return 'Unknown';
    try {
        return new Date(dateString).toLocaleString();
    } catch {
        return dateString;
    }
}
</script>
{% endblock %}
