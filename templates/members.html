{% extends "base.html" %}

{% block title %}Members - Anytime Fitness Club Management{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/members.css') }}">
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1 class="h3 mb-0">
                        <i class="fas fa-users me-2 text-primary"></i>
                        Member Management
                    </h1>
                    <p class="text-muted mb-0">Manage and view all club members</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="/invoices" class="btn btn-outline-primary" title="View and manage all invoices">
                        <i class="fas fa-file-invoice me-1"></i>
                        Invoice Management
                    </a>
                    <button class="btn btn-success" onclick="showBatchInvoiceModal()" title="Create batch invoices for past due members">
                        <i class="fas fa-file-invoice-dollar me-1"></i>
                        Batch Invoice
                    </button>
                    <button class="btn btn-info" onclick="refreshBillingData()" title="Refresh real billing data from ClubHub">
                        <i class="fas fa-dollar-sign me-1"></i>
                        Refresh Billing
                    </button>
                    <button class="btn btn-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Data
                    </button>
                    <button class="btn btn-success" onclick="loadActualMemberCounts()" title="Refresh member counts">
                        <i class="fas fa-users me-1"></i>
                        Refresh Counts
                    </button>
                    <button class="btn btn-warning" onclick="runAutomatedLockCheck()" title="Lock past due members">
                        <i class="fas fa-lock me-1"></i>
                        Auto-Lock Check
                    </button>
                    <button class="btn btn-info" onclick="runAutomatedUnlockCheck()" title="Unlock paid members">
                        <i class="fas fa-unlock me-1"></i>
                        Auto-Unlock Check
                    </button>
                    <button class="btn btn-danger" onclick="openCollectionsModal()" title="Manage collections referrals">
                        <i class="fas fa-gavel me-1"></i>
                        Collections
                    </button>
                    <button class="btn btn-outline-primary" onclick="toggleMonitoringSystem()" id="monitoring-toggle-btn" title="Toggle automated monitoring system">
                        <i class="fas fa-robot me-1"></i>
                        <span id="monitoring-status-text">Monitoring</span>
                    </button>
                    <button class="btn btn-outline-secondary" onclick="refreshAllMemberLockStatuses()" title="Refresh all member lock statuses">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh Status
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agreement Summary Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><strong>üìä Agreement Summary</strong></h5>
                </div>
                <div class="card-body">
                    <div class="row text-center" id="agreement-summary">
                        <div class="col-md-3">
                            <div class="h4 text-primary" id="active-agreements-count">-</div>
                            <small class="text-muted">Green Members</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-success" id="membership-revenue">-</div>
                            <small class="text-muted">Membership Revenue</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-warning" id="past-due-count">-</div>
                            <small class="text-muted">Past Due (Y+R)</small>
                        </div>
                        <div class="col-md-3">
                            <div class="h4 text-danger" id="total-past-due">-</div>
                            <small class="text-muted">Total Past Due $</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Tabs -->
    <div class="row">
        <div class="col-12">
            <ul class="nav nav-tabs" id="membersTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="green-members-tab" data-bs-toggle="tab" data-bs-target="#green-members" type="button" role="tab" aria-controls="green-members" aria-selected="true" onclick="loadMembersByCategory('green')">
                        Green Members
                        <span class="badge bg-success ms-2" id="green-count-badge">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="prospects-tab" data-bs-toggle="tab" data-bs-target="#prospects" type="button" role="tab" aria-controls="prospects" aria-selected="false" onclick="loadMembersByCategory('prospects')">
                        üí∞ Prospects
                        <span id="prospects-count-badge" class="badge bg-primary ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="comp-members-tab" data-bs-toggle="tab" data-bs-target="#comp-members" type="button" role="tab" aria-controls="comp-members" aria-selected="false" onclick="loadMembersByCategory('comp')">
                        Comp Members
                        <span id="comp-count-badge" class="badge bg-info ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="ppv-members-tab" data-bs-toggle="tab" data-bs-target="#ppv-members" type="button" role="tab" aria-controls="ppv-members" aria-selected="false" onclick="loadMembersByCategory('ppv')">
                        Pay Per Visit
                        <span id="ppv-count-badge" class="badge bg-secondary ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="staff-members-tab" data-bs-toggle="tab" data-bs-target="#staff-members" type="button" role="tab" aria-controls="staff-members" aria-selected="false" onclick="loadMembersByCategory('staff')">
                        Staff Members
                        <span id="staff-count-badge" class="badge bg-warning text-dark ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="yellow-members-tab" data-bs-toggle="tab" data-bs-target="#yellow-members" type="button" role="tab" aria-controls="yellow-members" aria-selected="false" onclick="loadMembersByCategory('yellow')">
                        Yellow (Issues)
                        <span id="yellow-count-badge" class="badge bg-warning ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="past-due-tab" data-bs-toggle="tab" data-bs-target="#past-due" type="button" role="tab" aria-controls="past-due" aria-selected="false" onclick="loadMembersByCategory('past_due')">
                        Past Due (Money)
                        <span id="past-due-count-badge" class="badge bg-danger ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="collections-tab" data-bs-toggle="tab" data-bs-target="#collections-members" type="button" role="tab" aria-controls="collections-members" aria-selected="false" onclick="loadMembersByCategory('collections')">
                        Collections
                        <span id="collections-count-badge" class="badge bg-warning text-dark ms-2">-</span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="inactive-members-tab" data-bs-toggle="tab" data-bs-target="#inactive-members" type="button" role="tab" aria-controls="inactive-members" aria-selected="false" onclick="loadMembersByCategory('inactive')">
                        Inactive
                        <span id="inactive-count-badge" class="badge bg-dark ms-2">-</span>
                    </button>
                </li>
            </ul>
        </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content" id="membersTabContent">
        <!-- Green Members Tab -->
        <div class="tab-pane fade show active" id="green-members" role="tabpanel" aria-labelledby="green-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search green members..." id="greenMemberSearch">
                </div>
            </div>
            <div class="row" id="green-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading green members...</p>
                    </div>
                </div>
        </div>

        <!-- Prospects Tab -->
        <div class="tab-pane fade" id="prospects" role="tabpanel" aria-labelledby="prospects-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search prospects..." id="prospectsMemberSearch">
                </div>
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div class="campaign-actions">
                        <button class="btn btn-success btn-sm" onclick="createProspectCampaign()">
                            <i class="fas fa-bullhorn me-1"></i>Create Campaign
                        </button>
                        <button class="btn btn-primary btn-sm" onclick="bulkMessageProspects()">
                            <i class="fas fa-envelope me-1"></i>Bulk Message
                        </button>
                        <button class="btn btn-info btn-sm" onclick="exportProspects()">
                            <i class="fas fa-download me-1"></i>Export List
                        </button>
                    </div>
                    <div class="prospect-stats">
                        <small class="text-muted">
                            <i class="fas fa-users me-1"></i>Total Prospects: <span id="total-prospects-count">-</span>
                        </small>
                    </div>
                </div>
            </div>
            <div class="row" id="prospects-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading prospects...</p>
                </div>
            </div>
        </div>

        <!-- Past Due Tab -->
        <div class="tab-pane fade" id="past-due" role="tabpanel" aria-labelledby="past-due-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search past due members..." id="pastDueMemberSearch">
                </div>
            </div>
            <div class="row" id="past-due-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading past due members...</p>
                </div>
            </div>
        </div>

        <!-- Comp Members Tab -->
        <div class="tab-pane fade" id="comp-members" role="tabpanel" aria-labelledby="comp-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search comp members..." id="compMemberSearch">
                </div>
            </div>
            <div class="row" id="comp-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading comp members...</p>
                </div>
            </div>
        </div>

        <!-- Pay Per Visit Members Tab -->
        <div class="tab-pane fade" id="ppv-members" role="tabpanel" aria-labelledby="ppv-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search pay-per-visit members..." id="ppvMemberSearch">
                </div>
            </div>
            <div class="row" id="ppv-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading pay-per-visit members...</p>
                </div>
            </div>
        </div>

        <!-- Staff Members Tab -->
        <div class="tab-pane fade" id="staff-members" role="tabpanel" aria-labelledby="staff-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search staff members..." id="staffMemberSearch">
                </div>
            </div>
            <div class="row" id="staff-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading staff members...</p>
                </div>
            </div>
        </div>

        <!-- Yellow Members Tab -->
        <div class="tab-pane fade" id="yellow-members" role="tabpanel" aria-labelledby="yellow-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search yellow members..." id="yellowMemberSearch">
                </div>
            </div>
            <div class="row" id="yellow-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading yellow members...</p>
                </div>
            </div>
        </div>

        <!-- Inactive Members Tab -->
        <div class="tab-pane fade" id="inactive-members" role="tabpanel" aria-labelledby="inactive-members-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search inactive members..." id="inactiveMemberSearch">
                </div>
            </div>
            <div class="row" id="inactive-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading inactive members...</p>
                </div>
            </div>
        </div>

        <!-- Collections Members Tab -->
        <div class="tab-pane fade" id="collections-members" role="tabpanel" aria-labelledby="collections-tab">
            <div class="search-section">
                <div class="input-group mb-3">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" class="form-control search-input" placeholder="Search collections members..." id="collectionsMemberSearch">
                </div>
            </div>
            <div class="row" id="collections-members-container">
                <div class="col-12 text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading collections members...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Invoice Preview Modal -->
<div class="modal fade" id="invoicePreviewModal" tabindex="-1" aria-labelledby="invoicePreviewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="invoicePreviewModalLabel">Invoice Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p><strong>Member:</strong> <span id="invoice-member-name"></span></p>
                <div class="mb-3">
                    <label for="invoice-amount" class="form-label">Amount ($)</label>
                    <input type="number" class="form-control" id="invoice-amount" placeholder="e.g., 50.00">
                </div>
                <div class="mb-3">
                    <label for="invoice-description" class="form-label">Description</label>
                    <textarea class="form-control" id="invoice-description" rows="3" placeholder="e.g., August Membership Dues + Late Fee"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendFinalInvoice()">Send Invoice</button>
            </div>
        </div>
    </div>
</div>

<!-- Batch Invoice Modal -->
<div class="modal fade" id="batchInvoiceModal" tabindex="-1" aria-labelledby="batchInvoiceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="batchInvoiceModalLabel">Batch Invoice</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>The following members will be sent an invoice:</p>
                <ul id="batch-invoice-member-list">
                    <!-- Selected members will be listed here -->
                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="sendBatchInvoices()">Send Invoices</button>
            </div>
        </div>
    </div>
</div>

<!-- Member Profile Modal -->
<div class="modal fade" id="memberProfileModal" tabindex="-1" aria-labelledby="memberProfileModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="memberProfileModalLabel">
                    <i class="fas fa-user me-2"></i>
                    <span id="modal-member-name">Member Profile</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Loading State -->
                <div id="member-profile-loading" class="text-center py-5">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-3">Loading member profile...</p>
                </div>

                <!-- Profile Content -->
                <div id="member-profile-content" class="hidden">
                    <div class="row">
                        <!-- Personal Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-user me-2"></i>
                                        Personal Information
                                    </h6>
                                </div>
                                <div class="card-body" id="personal-info-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-info text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-address-book me-2"></i>
                                        Contact Information
                                    </h6>
                                </div>
                                <div class="card-body" id="contact-info-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Agreements -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-file-contract me-2"></i>
                                        Agreements
                                    </h6>
                                </div>
                                <div class="card-body" id="agreements-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Training Information -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-dumbbell me-2"></i>
                                        Training Information
                                    </h6>
                                </div>
                                <div class="card-body" id="training-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Payment History -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Payment History
                                    </h6>
                                </div>
                                <div class="card-body" id="payments-content">
                                    <!-- Content loaded dynamically -->
                                </div>
                            </div>
                        </div>

                        <!-- Invoice History -->
                        <div class="col-md-6 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-secondary text-white">
                                    <h6 class="mb-0">
                                        <i class="fas fa-history me-2"></i>
                                        Invoice History
                                    </h6>
                                </div>
                                <div class="card-body" id="invoice-history-content">
                                    <p class="text-muted">Invoice history will be displayed here.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Member Inbox and Conversation History -->
                    <div class="row">
                        <div class="col-12 mb-4">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <ul class="nav nav-tabs card-header-tabs" id="memberInboxTabs" role="tablist">
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link active text-white" id="inbox-tab" data-bs-toggle="tab" data-bs-target="#inbox" type="button" role="tab">
                                                <i class="fas fa-inbox me-2"></i>
                                                Inbox
                                            </button>
                                        </li>
                                        <li class="nav-item" role="presentation">
                                            <button class="nav-link text-white" id="conversation-tab" data-bs-toggle="tab" data-bs-target="#conversation" type="button" role="tab">
                                                <i class="fas fa-comments me-2"></i>
                                                Conversation History
                                            </button>
                                        </li>
                                        <li class="nav-item ms-auto">
                                            <div class="d-flex gap-2">
                                                <button class="btn btn-sm btn-light" onclick="loadMemberMessages()">
                                                    <i class="fas fa-sync-alt me-1"></i>
                                                    Refresh
                                                </button>
                                                <button class="btn btn-sm btn-light" onclick="sendMessageToMember()">
                                                    <i class="fas fa-paper-plane me-1"></i>
                                                    Send Message
                                                </button>
                                            </div>
                                        </li>
                                    </ul>
                                </div>
                                <div class="card-body">
                                    <div class="tab-content" id="memberInboxTabContent">
                                        <!-- Inbox Tab -->
                                        <div class="tab-pane fade show active" id="inbox" role="tabpanel">
                                            <div class="mb-3">
                                                <div class="input-group">
                                                    <input type="text" class="form-control" id="memberMessageSearch" placeholder="Search messages...">
                                                    <button class="btn btn-outline-secondary" type="button" onclick="searchMemberMessages()">
                                                        <i class="fas fa-search"></i>
                                                    </button>
                                                </div>
                                            </div>
                                            <div id="member-inbox-container" class="member-inbox-container">
                                                <div class="text-center py-4">
                                                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                                                    <h5 class="text-muted">No messages in inbox</h5>
                                                    <p class="text-muted">Messages will appear here when received</p>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Conversation History Tab -->
                                        <div class="tab-pane fade" id="conversation" role="tabpanel">
                                            <div id="conversation-container" class="conversation-container">
                                                <div class="text-center py-4">
                                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                                    <h5 class="text-muted">No conversation history</h5>
                                                    <p class="text-muted">Click "Send Message" to start a conversation</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="showInvoicePreview()">
                    <i class="fas fa-file-invoice-dollar me-1"></i>
                    Send Invoice
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Invoice Tracking Modal -->
<div class="modal fade" id="invoiceTrackingModal" tabindex="-1" aria-labelledby="invoiceTrackingModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="invoiceTrackingModalLabel">
                    <i class="fas fa-receipt me-2"></i>
                    Invoice Tracking - <span id="tracking-member-name">Member Name</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Member Status Overview -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-lock fa-2x mb-2"></i>
                                <h6>Gym Access</h6>
                                <span id="member-access-status" class="badge bg-warning">Checking...</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-dark">
                            <div class="card-body text-center">
                                <i class="fas fa-dollar-sign fa-2x mb-2"></i>
                                <h6>Past Due Amount</h6>
                                <span id="past-due-amount">$0.00</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-info text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-file-invoice fa-2x mb-2"></i>
                                <h6>Total Invoices</h6>
                                <span id="total-invoices">0</span>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body text-center">
                                <i class="fas fa-check-circle fa-2x mb-2"></i>
                                <h6>Paid Invoices</h6>
                                <span id="paid-invoices">0</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Invoice Timeline -->
                <div class="row">
                    <div class="col-12">
                        <h6><i class="fas fa-history me-2"></i>Invoice Timeline</h6>
                        <div id="invoice-timeline" class="timeline">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p>Loading invoice history...</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <button class="btn btn-primary me-2" onclick="createNewInvoice()">
                            <i class="fas fa-plus me-1"></i>Create New Invoice
                        </button>
                        <button class="btn btn-success me-2" onclick="refreshInvoiceStatus()">
                            <i class="fas fa-sync me-1"></i>Refresh Status
                        </button>
                        <button class="btn btn-warning me-2" id="toggle-lock-btn" onclick="toggleMemberLock()">
                            <i class="fas fa-lock me-1"></i>Toggle Lock Status
                        </button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
        // Debug functions are now defined globally in base.html

function refreshData() {
    const refreshButton = document.querySelector('button[onclick="refreshData()"]');
    if (refreshButton) {
        refreshButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
        refreshButton.disabled = true;
    }
    
    // Clear all cached data before refreshing
    clearMemberCache();
    
    fetch('/api/refresh-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Data refreshed successfully!\nMembers: ${data.counts.members}\nProspects: ${data.counts.prospects}\nPast Due: ${data.counts.members_with_past_due} ($${data.counts.total_past_due_amount})`);
            window.location.reload();
        } else {
            alert('‚ùå Error refreshing data: ' + data.error);
        }
    })
    .catch(error => {
        debugError('‚ùå Error refreshing data:', error);
        alert('‚ùå Error refreshing data. Please try again.');
    })
    .finally(() => {
        if (refreshButton) {
            refreshButton.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Refresh Now';
            refreshButton.disabled = false;
        }
    });
}

function refreshBillingData() {
    const billingButton = document.querySelector('button[onclick="refreshBillingData()"]');
    if (billingButton) {
        billingButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing Billing...';
        billingButton.disabled = true;
    }
    
    // Clear cached data for past due and related categories
    clearMemberCache('past_due');
    clearMemberCache('green');
    
    fetch('/api/refresh-billing-data', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Billing data refreshed successfully from ClubHub!\nUpdated Members: ${data.updated_members}\nPast Due Members: ${data.past_due_members}\nTotal Past Due: $${data.total_past_due_amount}\nTotal Late Fees: $${data.total_late_fees}`);
            // Refresh the current tab to show updated billing info
            const activeTab = document.querySelector('.nav-link.active');
            if (activeTab) {
                const category = activeTab.id.replace('-tab', '').replace('-members', '');
                loadMembersByCategory(category);
            }
        } else {
            alert('‚ùå Error refreshing billing data: ' + data.error);
        }
    })
    .catch(error => {
        debugError('‚ùå Error refreshing billing data:', error);
        alert('‚ùå Error refreshing billing data. Please try again.');
    })
    .finally(() => {
        if (billingButton) {
            billingButton.innerHTML = '<i class="fas fa-dollar-sign me-1"></i>Refresh Billing';
            billingButton.disabled = false;
        }
    });
}

// Auto-check data status every 5 minutes
setInterval(function() {
    fetch('/api/data-status')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.needs_refresh) {
                debugLog('Data is stale, consider refreshing');
            }
        })
        .catch(error => debugError('Error checking data status:', error));
}, 300000);

// Member Profile Modal Functions
function openMemberProfile(memberId, memberName, memberEmail) {
    debugLog(`Opening profile for member: ${memberName} (ID: ${memberId})`);
    
    document.getElementById('modal-member-name').textContent = memberName;
    document.getElementById('member-profile-loading').style.display = 'block';
    document.getElementById('member-profile-content').style.display = 'none';
    
    const modalElement = document.getElementById('memberProfileModal');
    const modal = new bootstrap.Modal(modalElement);
    
    modalElement.addEventListener('shown.bs.modal', function() {
        const closeButton = modalElement.querySelector('.btn-close');
        if (closeButton) {
            closeButton.focus();
        }
    }, { once: true });
    
    modal.show();
    fetchMemberDetails(memberId, memberName, memberEmail);
}

function fetchMemberDetails(memberId, memberName, memberEmail) {
    // Store the current member ID for invoice creation
    window.currentMemberId = memberId;
    window.currentMemberName = memberName;
    window.currentMemberEmail = memberEmail;
    
    fetch(`/api/member/${memberId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                document.getElementById('member-profile-loading').style.display = 'none';
                document.getElementById('member-profile-content').style.display = 'block';
                
                populatePersonalInfo(data.member, data.payment_status);
                populateContactInfo(data.member);
                populateAgreements(data.agreements);
                populatePayments(data.payments);
                populateTrainingInfo(data.training_info);
            } else {
                document.getElementById('member-profile-loading').innerHTML = `
                    <div class="text-center py-5">
                        <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                        <p class="text-danger">Error loading member profile: ${data.error}</p>
                        <button class="btn btn-outline-secondary" onclick="fetchMemberDetails(${memberId}, '${memberName}', '${memberEmail}')">
                            <i class="fas fa-redo me-1"></i>Try Again
                        </button>
                    </div>
                `;
            }
        })
        .catch(error => {
            debugError('Error fetching member details:', error);
            document.getElementById('member-profile-loading').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Network error loading member profile</p>
                    <button class="btn btn-outline-secondary" onclick="fetchMemberDetails(${memberId}, '${memberName}', '${memberEmail}')">
                        <i class="fas fa-redo me-1"></i>Try Again
                    </button>
                </div>
            `;
        });
}

function openMemberProfileWithMessages(memberId, memberName, memberEmail) {
    debugLog(`üì¨ Opening member profile with messages focus: ${memberName} (ID: ${memberId})`);
    
    // First open the member profile modal
    openMemberProfile(memberId, memberName, memberEmail);
    
    // After modal opens, switch to conversation history tab and load message history
    setTimeout(() => {
        try {
            // Switch to conversation tab
            const conversationTab = document.getElementById('conversation-tab');
            const conversationPane = document.getElementById('conversation');
            const inboxTab = document.getElementById('inbox-tab');
            const inboxPane = document.getElementById('inbox');
            
            if (conversationTab && conversationPane) {
                // Activate conversation tab
                inboxTab.classList.remove('active');
                inboxPane.classList.remove('show', 'active');
                conversationTab.classList.add('active');
                conversationPane.classList.add('show', 'active');
                
                debugLog('‚úÖ Switched to conversation history tab');
                
                // Load ClubOS message history for this member
                loadMemberMessageHistory(memberId);
            } else {
                debugError('‚ùå Could not find conversation tab elements');
            }
        } catch (error) {
            debugError('‚ùå Error focusing on messages tab:', error);
        }
    }, 2000); // Wait for modal to fully load
}

function loadMemberMessageHistory(memberId) {
    debugLog(`üì¨ Loading ClubOS message history for member: ${memberId}`);
    
    const conversationContent = document.getElementById('conversation-content');
    if (!conversationContent) {
        debugError('‚ùå Conversation content element not found');
        return;
    }
    
    // Show loading state
    conversationContent.innerHTML = `
        <div class="text-center py-4">
            <div class="loading-spinner"></div>
            <p class="text-muted mt-3">Loading ClubOS message history...</p>
        </div>
    `;
    
    // Fetch message history from new API endpoint
    fetch(`/api/messaging/member-history/${memberId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.message_history) {
                displayMemberMessageHistory(data.message_history, memberId);
                debugLog(`‚úÖ Loaded ${data.count} message history items`);
            } else {
                conversationContent.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <p class="text-muted">No message history found</p>
                        <p class="small text-muted">${data.error || 'Unable to load message history'}</p>
                    </div>
                `;
            }
        })
        .catch(error => {
            debugError('‚ùå Error loading message history:', error);
            conversationContent.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Error loading message history</p>
                    <button class="btn btn-outline-secondary btn-sm" onclick="loadMemberMessageHistory('${memberId}')">
                        <i class="fas fa-redo me-1"></i>Try Again
                    </button>
                </div>
            `;
        });
}

function displayMemberMessageHistory(messageHistory, memberId) {
    const conversationContent = document.getElementById('conversation-content');
    
    if (!messageHistory || messageHistory.length === 0) {
        conversationContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                <p class="text-muted">No conversation history found</p>
                <p class="small text-muted">Start a conversation by sending a message</p>
            </div>
        `;
        return;
    }
    
    // Sort messages by date (newest first)
    const sortedMessages = messageHistory.sort((a, b) => {
        const dateA = new Date(a.created_at || a.timestamp);
        const dateB = new Date(b.created_at || b.timestamp);
        return dateB - dateA;
    });
    
    // Group messages by date
    const messagesByDate = {};
    sortedMessages.forEach(message => {
        const messageDate = new Date(message.created_at || message.timestamp);
        const dateKey = messageDate.toDateString();
        
        if (!messagesByDate[dateKey]) {
            messagesByDate[dateKey] = [];
        }
        messagesByDate[dateKey].push(message);
    });
    
    // Build conversation HTML
    let conversationHtml = `
        <div class="conversation-history">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h6 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Conversation History
                </h6>
                <span class="badge bg-primary">${messageHistory.length} messages</span>
            </div>
    `;
    
    // Add messages grouped by date
    Object.keys(messagesByDate).forEach(dateKey => {
        const messages = messagesByDate[dateKey];
        
        conversationHtml += `
            <div class="date-group mb-3">
                <div class="date-header text-center mb-2">
                    <small class="text-muted bg-light px-2 py-1 rounded">${dateKey}</small>
                </div>
        `;
        
        messages.forEach(message => {
            const messageTime = new Date(message.created_at || message.timestamp);
            const timeStr = messageTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            conversationHtml += `
                <div class="message-item mb-2 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="message-meta">
                            <strong class="text-primary">
                                ${message.from_user || 'Member'}
                            </strong>
                            <small class="text-muted ms-2">${timeStr}</small>
                        </div>
                        <span class="badge bg-${message.status === 'sent' ? 'success' : 'info'} badge-sm">
                            ${message.status || 'received'}
                        </span>
                    </div>
                    <div class="message-content">
                        ${message.content || message.message_content || 'No content'}
                    </div>
                    ${message.source ? `
                        <div class="mt-2">
                            <small class="text-muted">
                                <i class="fas fa-tag me-1"></i>
                                Source: ${message.source}
                            </small>
                        </div>
                    ` : ''}
                </div>
            `;
        });
        
        conversationHtml += `</div>`;
    });
    
    conversationHtml += `
        </div>
        <div class="mt-3 text-center">
            <button class="btn btn-outline-primary btn-sm" onclick="loadMemberMessageHistory('${memberId}')">
                <i class="fas fa-sync-alt me-1"></i>
                Refresh History
            </button>
            <button class="btn btn-primary btn-sm ms-2" onclick="sendMessageToMember()">
                <i class="fas fa-paper-plane me-1"></i>
                Send New Message
            </button>
        </div>
    `;
    
    conversationContent.innerHTML = conversationHtml;
}

function populatePersonalInfo(member, paymentStatus) {
    const personalInfoContent = document.getElementById('personal-info-content');
    
    // Format member since date
    let memberSince = 'Unknown';
    if (member.membership_start || member.membershipStart) {
        try {
            const startDate = new Date(member.membership_start || member.membershipStart);
            memberSince = startDate.toLocaleDateString();
        } catch (e) {
            memberSince = member.membership_start || member.membershipStart;
        }
    } else if (member.created_at) {
        try {
            const createdDate = new Date(member.created_at);
            memberSince = createdDate.toLocaleDateString();
        } catch (e) {
            memberSince = member.created_at;
        }
    }
    
    // Format last visit date
    let lastVisit = 'Never';
    if (member.last_visit || member.lastVisit) {
        try {
            const visitDate = new Date(member.last_visit || member.lastVisit);
            lastVisit = visitDate.toLocaleDateString();
        } catch (e) {
            lastVisit = member.last_visit || member.lastVisit;
        }
    }
    
    // Format membership end date if available
    let membershipEnd = 'N/A';
    if (member.membership_end || member.membershipEnd) {
        try {
            const endDate = new Date(member.membership_end || member.membershipEnd);
            membershipEnd = endDate.toLocaleDateString();
        } catch (e) {
            membershipEnd = member.membership_end || member.membershipEnd;
        }
    }
    
    // Format next payment date
    let nextPaymentDate = 'N/A';
    let nextPaymentAmount = 'N/A';
    if (paymentStatus && paymentStatus.next_payment_date) {
        try {
            const payDate = new Date(paymentStatus.next_payment_date);
            nextPaymentDate = payDate.toLocaleDateString();
            nextPaymentAmount = paymentStatus.next_payment_amount ? 
                `$${parseFloat(paymentStatus.next_payment_amount).toFixed(2)}` : 'N/A';
        } catch (e) {
            nextPaymentDate = paymentStatus.next_payment_date;
            nextPaymentAmount = paymentStatus.next_payment_amount || 'N/A';
        }
    }
    
    // Add payment status badge
    const statusBadge = `<span class="outlook-badge outlook-badge-${paymentStatus.class}">${paymentStatus.text}</span>`;
    
    // Create data source badges
    let dataSourceBadge;
    if (member.fresh_data_error) {
        dataSourceBadge = '<span class="badge bg-warning ms-2" title="' + member.fresh_data_error + '">API Error</span>';
    } else if (member.fresh_data) {
        dataSourceBadge = '<span class="badge bg-success ms-2">Live Data</span>';
    } else {
        dataSourceBadge = '<span class="badge bg-secondary ms-2">Database Data</span>';
    }
    
    personalInfoContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Full Name</label>
            <div class="member-detail-value">${member.full_name || 
                ((member.first_name || '') + ' ' + (member.last_name || '')).trim() || 
                ((member.firstName || '') + ' ' + (member.lastName || '')).trim() || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Email</label>
            <div class="member-detail-value">${member.email || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Phone</label>
            <div class="member-detail-value">${member.mobile_phone || member.mobilePhone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member ID</label>
            <div class="member-detail-value">${member.id} ${dataSourceBadge}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">ClubOS ID</label>
            <div class="member-detail-value">${member.clubos_member_id || member.prospectId || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member Status</label>
            <div>${member.status ? '<span class="outlook-badge outlook-badge-info">' + member.status + '</span>' : 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Payment Status</label>
            <div>${statusBadge}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Next Payment</label>
            <div class="member-detail-value">
                ${nextPaymentDate !== 'N/A' ? `${nextPaymentDate} (${nextPaymentAmount})` : 'N/A'}
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Member Since</label>
            <div class="member-detail-value">${memberSince}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Last Visit</label>
            <div class="member-detail-value">${lastVisit}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Membership End</label>
            <div class="member-detail-value">${membershipEnd}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">User Type</label>
            <div class="member-detail-value">${member.user_type || member.memberType || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Contract Types</label>
            <div class="member-detail-value">${member.contract_types || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Trial Status</label>
            <div class="member-detail-value">${member.trial ? 'Trial Member' : 'Regular Member'}</div>
        </div>
    `;
}

function populateContactInfo(member) {
    const contactInfoContent = document.getElementById('contact-info-content');
    contactInfoContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Mobile Phone</label>
            <div class="member-detail-value">${member.mobile_phone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Home Phone</label>
            <div class="member-detail-value">${member.home_phone || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Address</label>
            <div class="member-detail-value">${member.address || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Emergency Contact</label>
            <div class="member-detail-value">${member.emergency_contact || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Date of Birth</label>
            <div class="member-detail-value">${member.date_of_birth || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Gender</label>
            <div class="member-detail-value">${member.gender || 'N/A'}</div>
        </div>
    `;
}

function populateAgreements(agreements) {
    const agreementsContent = document.getElementById('agreements-content');
    
    if (!agreements || agreements.length === 0) {
        agreementsContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-file-contract fa-3x text-muted mb-3"></i>
                <p class="text-muted">No agreements found</p>
            </div>
        `;
        return;
    }
    
    let agreementsHtml = '<div class="row">';
    agreements.forEach(agreement => {
        agreementsHtml += `
            <div class="col-md-6 mb-3">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">${agreement.agreement_type || 'Agreement'}</h6>
                        <p class="card-text">
                            <small class="text-muted">Start: ${agreement.start_date || 'N/A'}</small><br>
                            <small class="text-muted">End: ${agreement.end_date || 'N/A'}</small><br>
                            <small class="text-muted">Rate: $${agreement.rate || '0.00'}</small>
                        </p>
                        ${agreement.status ? '<span class="outlook-badge outlook-badge-info">' + agreement.status + '</span>' : ''}
                    </div>
                </div>
            </div>
        `;
    });
    agreementsHtml += '</div>';
    
    agreementsContent.innerHTML = agreementsHtml;
}

function populatePayments(payments) {
    const paymentsContent = document.getElementById('payments-content');
    
    if (!payments || payments.length === 0) {
        paymentsContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                <p class="text-muted">No payment history found</p>
            </div>
        `;
        return;
    }
    
    let paymentsHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Amount</th>
                        <th>Type</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    payments.forEach(payment => {
        const paymentDate = payment.payment_date ? new Date(payment.payment_date).toLocaleDateString() : 'N/A';
        const amount = payment.amount ? `$${parseFloat(payment.amount).toFixed(2)}` : 'N/A';
        
        paymentsHtml += `
            <tr>
                <td>${paymentDate}</td>
                <td>${amount}</td>
                <td>${payment.payment_type || 'N/A'}</td>
                <td>
                    ${payment.status ? '<span class="outlook-badge outlook-badge-' + (payment.status === 'completed' ? 'success' : 'warning') + '">' + payment.status + '</span>' : 'N/A'}
                </td>
            </tr>
        `;
    });
    
    paymentsHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    paymentsContent.innerHTML = paymentsHtml;
}

function populateTrainingInfo(trainingInfo) {
    const trainingContent = document.getElementById('training-content');
    
    if (!trainingInfo) {
        trainingContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-dumbbell fa-3x text-muted mb-3"></i>
                <p class="text-muted">No training information found</p>
                <small class="text-muted">This member is not currently enrolled in personal training</small>
            </div>
        `;
        return;
    }
    
    trainingContent.innerHTML = `
        <div class="mb-3">
            <label class="form-label-muted">Trainer</label>
            <div class="member-detail-value">${trainingInfo.trainer_name || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Session Type</label>
            <div class="member-detail-value">${trainingInfo.session_type || 'N/A'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Sessions Remaining</label>
            <div class="member-detail-value">
                <span class="badge ${trainingInfo.sessions_remaining > 0 ? 'bg-success' : 'bg-warning'}">
                    ${trainingInfo.sessions_remaining || 0} sessions
                </span>
            </div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Last Session</label>
            <div class="member-detail-value">${trainingInfo.last_session || 'No sessions recorded'}</div>
        </div>
        <div class="mb-3">
            <label class="form-label-muted">Payment Status</label>
            <div class="member-detail-value">
                <span class="badge ${trainingInfo.payment_status === 'Current' ? 'bg-success' : 'bg-warning'}">
                    ${trainingInfo.payment_status || 'Unknown'}
                </span>
            </div>
        </div>
    `;
}

function populateInvoices(invoices) {
    const invoiceHistoryContent = document.getElementById('invoice-history-content');
    
    if (!invoices || invoices.length === 0) {
        invoiceHistoryContent.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-file-invoice fa-3x text-muted mb-3"></i>
                <p class="text-muted">No invoice history found</p>
            </div>
        `;
        return;
    }
    
    let invoicesHtml = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Invoice ID</th>
                        <th>Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    invoices.forEach(invoice => {
        const invoiceDate = invoice.date ? new Date(invoice.date).toLocaleDateString() : 'N/A';
        const amount = invoice.amount ? `$${parseFloat(invoice.amount).toFixed(2)}` : 'N/A';
        
        invoicesHtml += `
            <tr>
                <td>${invoiceDate}</td>
                <td>${invoice.id || 'N/A'}</td>
                <td>${amount}</td>
                <td>
                    ${invoice.status ? '<span class="outlook-badge outlook-badge-' + (invoice.status === 'paid' ? 'success' : 'warning') + '">' + invoice.status + '</span>' : 'N/A'}
                </td>
            </tr>
        `;
    });
    
    invoicesHtml += `
                </tbody>
            </table>
        </div>
    `;
    
    invoiceHistoryContent.innerHTML = invoicesHtml;
}

// TEST FUNCTION - Call this from browser console to test API
function testPastDueAPI() {
// All tabs use the unified loadMembersByCategory() function
    

    
    // Show loading state
    const loadingElement = document.getElementById('past-due-loading');
    const contentElement = document.getElementById('past-due-content');
    const noPastDueElement = document.getElementById('no-past-due');
    
    console.log('üîç Element check:', {
        loading: !!loadingElement,
        content: !!contentElement,
        noPastDue: !!noPastDueElement
    });
    
    if (loadingElement) loadingElement.style.display = 'block';
    if (contentElement) contentElement.style.display = 'none';
    if (noPastDueElement) noPastDueElement.style.display = 'none';
    
    console.log('üì° Fetching past due members from API...');
    
    // Force fresh data by adding timestamp to prevent caching
    fetch('/api/members/by-category/past_due?t=' + Date.now())
        .then(response => {
            console.log('üì° API response received:', response.status, response);
            if (!response.ok) {
                console.error('API returned error status:', response.status);
                return response.json().then(errorData => {
                    console.error('API error details:', errorData);
                    throw new Error(`API error: ${errorData.error || 'Unknown error'}`);
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('üìä FULL DATA RECEIVED:', data);
            console.log('üìä DATA TYPE:', typeof data);
            console.log('üìä DATA KEYS:', Object.keys(data || {}));
            console.log('üìä VALIDATION CHECK:');
            console.log('   - data exists:', !!data);
            console.log('   - data.success:', data ? data.success : 'N/A');
            console.log('   - data.members is array:', data ? Array.isArray(data.members) : 'N/A');
            console.log('   - data.members length:', data && data.members ? data.members.length : 'N/A');
            
            if (!data || !data.success) {
                console.error('‚ùå VALIDATION FAILED: Invalid data format received:', data);
                throw new Error('Invalid data format received from server');
            }
            
            if (!Array.isArray(data.members)) {
                console.error('‚ùå VALIDATION FAILED: data.members is not an array:', data.members);
                throw new Error('Members data is not an array');
            }


            // Use the members array from the database response
            let members = data.members || [];
            
            console.log('‚úÖ MEMBERS VALIDATION PASSED - Processing', members.length, 'members');
            
            // Debug: Log first member to see what fields are available
            if (members.length > 0) {
                console.log('üîç FIRST MEMBER SAMPLE:', members[0]);
                console.log('üîç AVAILABLE FIELDS:', Object.keys(members[0]));
                console.log('üîç AGREEMENT FIELDS:', Object.keys(members[0]).filter(k => k.includes('agreement')));
                console.log('üîç PAST DUE FIELDS:', Object.keys(members[0]).filter(k => k.includes('past_due') || k.includes('late')));
            }
            
            let redCount = members.filter(m => m.status_message && m.status_message.includes('Past Due more than 30')).length;
            let yellowCount = members.filter(m => m.status_message && m.status_message.includes('Past Due 6-30')).length;

            // Update badges in nav tabs
            document.getElementById('past-due-count-badge').textContent = members.length;
            const redDisplay = document.getElementById('red-count-display');
            const yellowDisplay = document.getElementById('yellow-count-display');
            if (redDisplay) redDisplay.textContent = redCount;
            if (yellowDisplay) yellowDisplay.textContent = yellowCount;

            if (members.length > 0) {
                console.log(`‚úÖ CALLING displayPastDueMembers() with ${members.length} members`);
                try {
                    displayPastDueMembers(members);
                    console.log('‚úÖ displayPastDueMembers() completed successfully');
                    
                    // Hide loading and show content
                    const loadingElement = document.getElementById('past-due-loading');
                    const contentElement = document.getElementById('past-due-content');
                    const pastDuePane = document.getElementById('past-due');
                    
                    if (loadingElement) {
                        loadingElement.style.display = 'none';
                    }
                    
                    if (contentElement) {
                        contentElement.style.display = 'block';
                        contentElement.classList.remove('hidden');
                    }
                    
                    // Force the tab pane to be visible
                    if (pastDuePane) {
                        pastDuePane.classList.add('show', 'active');
                        pastDuePane.style.display = 'block';
                    }
                    
                    console.log('‚úÖ UI elements updated - content should now be visible');
                } catch (displayError) {
                    console.error('‚ùå ERROR in displayPastDueMembers():', displayError);
                    console.error('‚ùå STACK TRACE:', displayError.stack);
                    throw displayError;
                }
            } else {
                console.log('‚ÑπÔ∏è No past due members found');
                document.getElementById('past-due-loading').style.display = 'none';
                document.getElementById('no-past-due').style.display = 'block';
            }
        })
        .catch(error => {
            console.error('‚ùå MAJOR ERROR loading past due members:', error);
            console.error('‚ùå ERROR DETAILS:', error.message);
            console.error('‚ùå FULL ERROR:', error);
            document.getElementById('past-due-loading').innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                    <p class="text-danger">Error loading past due members: ${error.message}</p>
                    <p class="text-muted mb-3">This may be due to expired credentials or API changes.</p>
                    <div class="mb-3">
                        <button class="btn btn-primary" onclick="retryLoadPastDue()">Try Again</button>
                        <button class="btn btn-outline-secondary ms-2" onclick="contactSupport()">Contact Support</button>
                    </div>
                </div>
            `;
        });
}


function sendSquareInvoice() {
    const memberName = document.getElementById('modal-member-name').textContent;
    const amount = 100.00; // Placeholder amount
    const description = 'Membership Dues'; // Placeholder description

    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_name: memberName,
            amount: amount,
            description: description,
        }),
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Invoice created successfully!');
        } else {
            alert('Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        debugError('Error:', error);
        alert('An error occurred while creating the invoice.');
    });
}

// Quick Invoice Modal Functions
function showQuickInvoiceModal(memberId, memberName, memberEmail) {
    debugLog(`üí∞ Opening quick invoice modal for ${memberName} (ID: ${memberId})`);
    
    const amount = prompt(`Enter invoice amount for ${memberName}:`, '50.00');
    if (!amount || isNaN(amount)) return;
    
    const description = prompt('Enter invoice description:', 'Monthly Membership Dues');
    if (!description) return;
    
    debugLog(`üí∞ Creating invoice: ${memberName} - $${amount} - ${description}`);
    
    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            member_name: memberName,
            member_email: memberEmail,
            amount: parseFloat(amount),
            description: description
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            debugLog(`‚úÖ Invoice created successfully for ${memberName}`);
            alert(`‚úÖ Invoice created successfully!\nAmount: $${parseFloat(amount).toFixed(2)}\nURL: ${data.invoice_url}`);
        } else {
            debugError(`‚ùå Error creating invoice for ${memberName}:`, data.error);
            alert('‚ùå Error creating invoice: ' + data.error);
        }
    })
    .catch(error => {
        debugError('‚ùå Error creating invoice:', error);
        alert('‚ùå Error creating invoice');
    });
}

function sendInvoiceDirectly(memberId, memberName, memberEmail, memberPhone, pastDueAmount) {
    debugLog(`üì§ Sending invoice directly for ${memberName} (ID: ${memberId}) - $${pastDueAmount}`);

    // Use the backend-calculated amount (already includes proper late fees)
    const totalAmount = parseFloat(pastDueAmount);

    // Show loading indicator
    const button = event.target.closest('button');
    const originalHTML = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
    button.disabled = true;

    const description = `Total Amount Owed: $${totalAmount.toFixed(2)} (includes late fees)`;

    debugLog(`üìã Creating invoice: ${memberName} - $${totalAmount} - ${description}`);

    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            member_name: memberName,
            member_email: memberEmail,
            member_phone: memberPhone,
            amount: totalAmount,
            description: description,
            is_past_due: true
        })
    })
    .then(response => response.json())
    .then(data => {
        button.innerHTML = originalHTML;
        button.disabled = false;

        if (data.success) {
            debugLog(`‚úÖ Invoice sent successfully to ${memberName}`);
            // Show success message with checkmark
            button.innerHTML = '<i class="fas fa-check"></i> Sent!';
            button.classList.remove('btn-warning');
            button.classList.add('btn-success');

            // Reset button after 3 seconds
            setTimeout(() => {
                button.innerHTML = originalHTML;
                button.classList.remove('btn-success');
                button.classList.add('btn-warning');
            }, 3000);

            // Optionally refresh the members list
            // loadMembersByCategory('past_due');
        } else {
            debugError(`‚ùå Error sending invoice to ${memberName}:`, data.error);
            alert('‚ùå Error sending invoice: ' + data.error);
        }
    })
    .catch(error => {
        button.innerHTML = originalHTML;
        button.disabled = false;
        debugError('‚ùå Error sending invoice:', error);
        alert('‚ùå Error sending invoice');
    });
}

function showInvoicePreviewForMember(memberId, memberName, memberEmail, pastDueAmount) {
    debugLog(`üìã Opening invoice preview for ${memberName} (ID: ${memberId}) - $${pastDueAmount}`);

    if (!confirm(`Create past due invoice for ${memberName} - $${parseFloat(pastDueAmount).toFixed(2)}?`)) {
        return;
    }

    // Use the backend-calculated amount (already includes proper late fees)
    const totalAmount = parseFloat(pastDueAmount);
    const description = `Total Amount Owed: $${totalAmount.toFixed(2)} (includes late fees)`;

    debugLog(`üìã Creating past due invoice: ${memberName} - $${totalAmount} - ${description}`);

    fetch('/api/create-invoice', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            member_name: memberName,
            member_email: memberEmail,
            amount: totalAmount,
            description: description,
            is_past_due: true
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            debugLog(`‚úÖ Past due invoice created successfully for ${memberName}`);
            alert(`‚úÖ Past due invoice created successfully!\nAmount: $${totalAmount.toFixed(2)}\nURL: ${data.invoice_url}`);
            // Optionally refresh the members list
            loadMembersByCategory('past_due');
        } else {
            debugError(`‚ùå Error creating past due invoice for ${memberName}:`, data.error);
            alert('‚ùå Error creating past due invoice: ' + data.error);
        }
    })
    .catch(error => {
        debugError('‚ùå Error creating past due invoice:', error);
        alert('‚ùå Error creating past due invoice');
    });
}

// Batch Invoice Functions
function showBatchInvoiceModal() {
    debugLog('üìÑ Opening batch invoice modal...');
    
    // Open modal
    const modalElement = document.getElementById('batchInvoiceModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Load past due members for batch invoicing
    loadPastDueMembersForBatching();
}

async function loadPastDueMembersForBatching() {
    try {
        debugLog('üìä Loading past due members for batch invoicing...');
        
        const response = await fetch('/api/members/by-category/past_due');
        const data = await response.json();
        
        if (data.success && data.members) {
            const pastDueMembers = data.members.filter(m => parseFloat(m.amount_past_due || 0) > 0);
            displayBatchInvoiceMembers(pastDueMembers);
        } else {
            throw new Error(data.error || 'Failed to load past due members');
        }
    } catch (error) {
        debugError('‚ùå Error loading past due members for batching:', error);
        const modalBody = document.querySelector('#batchInvoiceModal .modal-body');
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error loading past due members: ${error.message}
            </div>
        `;
    }
}

function displayBatchInvoiceMembers(members) {
    const modalBody = document.querySelector('#batchInvoiceModal .modal-body');
    
    if (members.length === 0) {
        modalBody.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No past due members found for batch invoicing.
            </div>
        `;
        return;
    }
    
    let html = `
        <div class="mb-3">
            <h6>Past Due Members (${members.length})</h6>
            <div class="form-check">
                <input class="form-check-input" type="checkbox" id="selectAllPastDue" onchange="toggleAllPastDueSelection()">
                <label class="form-check-label" for="selectAllPastDue">
                    Select All
                </label>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-sm">
                <thead>
                    <tr>
                        <th>Select</th>
                        <th>Member</th>
                        <th>Past Due Amount</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    members.forEach(member => {
        const pastDueAmount = parseFloat(member.amount_past_due || 0);
        const memberName = member.full_name || member.name || 'Unknown';
        const memberId = member.guid || member.member_id || member.id;
        
        html += `
            <tr>
                <td>
                    <input class="form-check-input past-due-checkbox" type="checkbox" 
                           data-member-id="${memberId}" 
                           data-member-name="${memberName}" 
                           data-amount="${pastDueAmount}">
                </td>
                <td>${memberName}</td>
                <td>$${pastDueAmount.toFixed(2)}</td>
                <td><span class="badge bg-danger">Past Due</span></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <button class="btn btn-primary" onclick="processBatchInvoices()">
                <i class="fas fa-file-invoice-dollar me-1"></i>
                Create Selected Invoices
            </button>
            <button class="btn btn-secondary" data-bs-dismiss="modal">
                Cancel
            </button>
        </div>
    `;
    
    modalBody.innerHTML = html;
}

function toggleAllPastDueSelection() {
    const selectAll = document.getElementById('selectAllPastDue');
    const checkboxes = document.querySelectorAll('.past-due-checkbox');
    
    checkboxes.forEach(checkbox => {
        checkbox.checked = selectAll.checked;
    });
}

async function processBatchInvoices() {
    const selectedCheckboxes = document.querySelectorAll('.past-due-checkbox:checked');
    
    if (selectedCheckboxes.length === 0) {
        alert('Please select at least one member for batch invoicing.');
        return;
    }
    
    const selectedMembers = Array.from(selectedCheckboxes).map(cb => ({
        member_id: cb.dataset.memberId,
        member_name: cb.dataset.memberName,
        amount: parseFloat(cb.dataset.amount)
    }));
    
    debugLog(`üìÑ Creating batch invoices for ${selectedMembers.length} members...`);
    
    // Show progress
    const button = event.target;
    const originalText = button.innerHTML;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating Invoices...';
    button.disabled = true;
    
    try {
        const response = await fetch('/api/invoices/batch-create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                members: selectedMembers
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ Successfully created ${data.created_count || selectedMembers.length} invoices!`);
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('batchInvoiceModal'));
            modal.hide();
            
            // Refresh the page to show updated data
            setTimeout(() => {
                window.location.reload();
            }, 1000);
        } else {
            throw new Error(data.error || 'Failed to create batch invoices');
        }
    } catch (error) {
        debugError('‚ùå Error creating batch invoices:', error);
        alert(`‚ùå Error creating batch invoices: ${error.message}`);
    } finally {
        button.innerHTML = originalText;
        button.disabled = false;
    }
}



// Global variables for async loading and caching
let allMembersLoaded = false;

let memberCache = new Map(); // Cache for loaded members by category
let cacheTimestamp = new Map(); // Cache timestamps
const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes cache duration

// Cache management functions
function clearMemberCache(category = null) {
    if (category) {
        memberCache.delete(category);
        cacheTimestamp.delete(category);
        debugLog(`üóëÔ∏è Cleared cache for ${category}`);
    } else {
        memberCache.clear();
        cacheTimestamp.clear();
        debugLog(`üóëÔ∏è Cleared all member cache`);
    }
}

function getCacheInfo(category) {
    const cachedData = memberCache.get(category);
    const cacheTime = cacheTimestamp.get(category);
    if (cachedData && cacheTime) {
        const age = Math.round((Date.now() - cacheTime) / 1000);
        return { hasCache: true, age, count: cachedData.members?.length || 0 };
    }
    return { hasCache: false, age: 0, count: 0 };
}

// Async function to load all members
async function loadAllMembers(page = 1, search = '', statusFilter = '') {
    if (allMembersLoaded && !search && !statusFilter && page === 1) {
        debugLog('‚úÖ All members already loaded, skipping...');
        return;
    }

    debugLog('üîÑ Loading all members asynchronously...');
    
    const membersContainer = document.getElementById('membersContainer');
    const loadingHTML = `
        <div class="col-12 text-center py-5" id="members-loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading members...</p>
        </div>
    `;
    
    // Show loading state
    if (page === 1) {
        membersContainer.innerHTML = loadingHTML;
    }
    
    try {
        const params = new URLSearchParams({
            page: page,
            per_page: 50,
            search: search,
            status: statusFilter
        });
        
        const response = await fetch(`/api/members/all?${params}`);
        const data = await response.json();
        
        if (data.success) {
            debugLog(`‚úÖ Loaded ${data.members.length} members from API`);
            
            // Clear loading state
            if (page === 1) {
                membersContainer.innerHTML = '';
            }
            
            // Generate member cards HTML
            let html = '';
            data.members.forEach(member => {
                // Generate a proper full name
                let displayName = 'Unknown Name';
                if (member.full_name && member.full_name.trim() !== '') {
                    displayName = member.full_name;
                } else if (member.first_name || member.last_name) {
                    displayName = `${member.first_name || ''} ${member.last_name || ''}`.trim();
                } else if (member.email && member.email.includes('@')) {
                    // Try to extract a name from email
                    const emailName = member.email.split('@')[0];
                    const cleanedName = emailName.replace(/[^a-zA-Z ]/g, ' ').replace(/\s+/g, ' ').trim();
                    if (cleanedName) {
                        displayName = cleanedName.split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()).join(' ');
                        displayName += ' (from email)';
                    }
                }
                
                html += `
                    <div class="col-xl-3 col-lg-4 col-md-6 mb-4 member-item" 
                         data-name="${(displayName || '').toLowerCase()}" 
                         data-email="${(member.email || '').toLowerCase()}" 
                         data-status="${(member.status || '').toLowerCase()}">
                        <div class="card member-card h-100">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="card-title mb-0">
                                        <a href="/member/${member.id}" class="text-decoration-none text-dark">${displayName}</a>
                                    </h6>
                                    <span class="badge bg-${member.payment_status_class || 'primary'}">${member.status || 'Active'}</span>
                                </div>
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-envelope me-1"></i>
                                    ${member.email ? `<a href="mailto:${member.email}" class="text-decoration-none">${member.email}</a>` : 'No email'}
                                </p>
                                ${member.mobile_phone ? `
                                <p class="card-text text-muted small mb-2">
                                    <i class="fas fa-phone me-1"></i>
                                    <a href="tel:${member.mobile_phone}" class="text-decoration-none">${member.mobile_phone}</a>
                                </p>
                                ` : ''}
                                <div class="d-flex justify-content-between align-items-end">
                                    <small class="text-muted">ID: ${member.id}</small>
                                    ${member.membership_start ? `
                                    <small class="text-muted">Since: ${member.membership_start.substring(0, 10)}</small>
                                    ` : ''}
                                </div>
                                
                                <!-- Agreement Details Section -->
                                <div class="mt-3 p-2 bg-light rounded">
                                    <h6 class="text-dark mb-2"><strong>üìã Agreement Details</strong></h6>
                                    <div class="row g-2">
                                        <div class="col-6">
                                            <small class="text-muted">Status:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_status && member.agreement_status !== 'No Agreement') ? member.agreement_status : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Type:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_type && member.agreement_type !== 'No Agreement') ? member.agreement_type : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Recurring Cost:</small>
                                            <div class="fw-bold text-dark">$${(member.agreement_recurring_cost && member.agreement_recurring_cost > 0) ? parseFloat(member.agreement_recurring_cost).toFixed(2) : '0.00'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Billing:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_billing_frequency && member.agreement_billing_frequency !== 'No Agreement') ? member.agreement_billing_frequency : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-12">
                                            <small class="text-muted">Agreement:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_name && member.agreement_name !== 'No Agreement') ? member.agreement_name : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Start Date:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_start_date && member.agreement_start_date !== 'No Agreement') ? member.agreement_start_date : 'No Agreement Data'}</div>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">End Date:</small>
                                            <div class="fw-bold text-dark">${(member.agreement_end_date && member.agreement_end_date !== 'No Agreement') ? member.agreement_end_date : 'No Agreement Data'}</div>
                                        </div>
                                                                                    </div>

                                            </div>
                                            
                                            <div class="mt-2 d-flex gap-1">
                                    <a href="/member/${member.id}" class="btn btn-sm btn-primary" title="View Profile">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); showQuickInvoiceModal('${member.id}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}')" title="Create Invoice">
                                        <i class="fas fa-file-invoice-dollar"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            if (data.members.length === 0 && page === 1) {
                html = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-users"></i>
                            <h4>No Members Found</h4>
                            <p>There are currently no members matching your criteria.</p>
                        </div>
                    </div>
                `;
            }
            
            membersContainer.innerHTML = html;
            allMembersLoaded = true;
            
            // Update search and filter dropdowns
            updateStatusFilterOptions(data.statuses || []);
            
            debugLog('‚úÖ All members loaded and displayed successfully');
        } else {
            throw new Error(data.error || 'Failed to load members');
        }
    } catch (error) {
        debugError('‚ùå Error loading members:', error);
        membersContainer.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading members: ${error.message}
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadAllMembers()">
                        <i class="fas fa-retry me-1"></i>Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// Function to update status filter options
function updateStatusFilterOptions(statuses) {
    const statusFilter = document.getElementById('statusFilter');
    if (statusFilter && statuses.length > 0) {
        const currentValue = statusFilter.value;
        statusFilter.innerHTML = '<option value="">All Status</option>';
        
        statuses.forEach(status => {
            if (status && status.trim()) {
                const option = document.createElement('option');
                option.value = status;
                option.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                statusFilter.appendChild(option);
            }
        });
        
        statusFilter.value = currentValue;
    }
}

// Function to render members HTML (extracted for caching)
function renderMembersHTML(container, data, category) {
    let html = '';
    const members = data.members || [];
    
    if (members.length === 0) {
        html = `
            <div class="col-12">
                <div class="empty-state">
                    <i class="fas fa-users"></i>
                    <h4>No ${category.charAt(0).toUpperCase() + category.slice(1)} Members</h4>
                    <p>There are currently no members in this category.</p>
                </div>
            </div>
        `;
    } else {
        debugLog(`üìù Generating HTML for ${members.length} members`);
        members.forEach((member, index) => {
            debugLog(`üë§ Processing member ${index + 1}:`, member);
            
            let displayName = 'Unknown Name';
            if (member.full_name && member.full_name.trim() !== '') {
                displayName = member.full_name;
            } else if (member.first_name || member.last_name) {
                displayName = `${member.first_name || ''} ${member.last_name || ''}`.trim();
            }
            
            // Color coding based on category
            let cardClass = 'member-card';
            let badgeClass = 'bg-primary';
            let categoryLabel = category;
            
            if (category === 'past_due') {
                cardClass += ' border-danger';
                badgeClass = member.amount_past_due > 100 ? 'bg-danger' : 'bg-warning text-dark';
                categoryLabel = member.amount_past_due > 100 ? 'Critical' : 'Past Due';
            } else if (category === 'comp') {
                cardClass += ' border-info';
                badgeClass = 'bg-info';
                categoryLabel = 'Comp';
            } else if (category === 'ppv') {
                cardClass += ' border-secondary';
                badgeClass = 'bg-secondary';
                categoryLabel = 'Pay Per Visit';
            } else if (category === 'frozen') {
                cardClass += ' border-light';
                badgeClass = 'bg-light text-dark';
                categoryLabel = 'Frozen';
            } else if (category === 'inactive') {
                cardClass += ' border-dark';
                badgeClass = 'bg-dark';
                categoryLabel = 'Inactive';
            }
            
            // Format dates for display
            let memberSince = 'Unknown';
            if (member.membership_start) {
                try {
                    const startDate = new Date(member.membership_start);
                    memberSince = startDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch (e) {
                    memberSince = member.membership_start.substring(0, 10);
                }
            }

            let lastVisit = 'Never';
            if (member.last_visit && member.last_visit !== '') {
                try {
                    const visitDate = new Date(member.last_visit);
                    lastVisit = visitDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
                } catch (e) {
                    lastVisit = member.last_visit.substring(0, 10);
                }
            }

            let nextPayment = '';
            if (member.date_of_next_payment) {
                try {
                    const payDate = new Date(member.date_of_next_payment);
                    const amount = member.amount_of_next_payment ? `$${parseFloat(member.amount_of_next_payment).toFixed(2)}` : '';
                    nextPayment = `${payDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })} ${amount}`;
                } catch (e) {
                    nextPayment = member.date_of_next_payment.substring(0, 10);
                }
            }
            
            html += `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card ${cardClass} h-100" style="cursor: pointer;" onclick="window.location.href='/member/${member.guid || member.prospect_id || member.id}'">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h6 class="card-title mb-0">
                                <a href="/member/${member.guid || member.prospect_id || member.id}" class="text-decoration-none text-dark">${displayName}</a>
                            </h6>
                                ${category === 'past_due' ? `<input type="checkbox" class="form-check-input batch-invoice-checkbox" data-member-id="${member.guid || member.prospect_id || member.id}" data-member-name="${displayName.replace(/'/g, "\\'")}" data-amount="${member.amount_past_due || 0}">` : ''}
                            </div>
                            <div class="mb-2">
                                <span class="badge ${badgeClass}">${categoryLabel}</span>
                                ${member.user_type ? `<span class="badge bg-outline-secondary ms-1">${member.user_type}</span>` : ''}
                                ${member.status ? `<span class="badge bg-secondary ms-1">${member.status}</span>` : ''}
                                ${parseFloat(member.amount_past_due || 0) > 0 ? `<span class="badge bg-danger ms-1" title="Gym access may be locked due to past due amount"><i class="fas fa-lock me-1"></i>ACCESS LOCKED</span>` : `<span class="badge bg-success ms-1" title="Gym access active"><i class="fas fa-unlock me-1"></i>ACCESS OPEN</span>`}
                            </div>
                            <div class="small text-muted mb-2">
                                ${member.email ? `<div><i class="fas fa-envelope me-1"></i><span class="text-truncate" title="${member.email}">${member.email}</span></div>` : '<div class="text-warning"><i class="fas fa-envelope me-1"></i>No email</div>'}
                                ${member.mobile_phone ? `<div><i class="fas fa-phone me-1"></i>${member.mobile_phone}</div>` : '<div class="text-warning"><i class="fas fa-phone me-1"></i>No phone</div>'}
                                <div><i class="fas fa-calendar me-1"></i>Since: ${memberSince}</div>
                                <div><i class="fas fa-clock me-1"></i>Last visit: ${lastVisit}</div>
                                ${nextPayment ? `<div><i class="fas fa-credit-card me-1"></i>Next: ${nextPayment}</div>` : ''}
                            </div>
                            ${member.amount_past_due > 0 ? `
                                <div class="alert alert-danger py-2 px-2 mb-2 small">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <strong><i class="fas fa-exclamation-triangle me-1"></i>Past Due Details</strong>
                                        <span class="badge bg-danger">OVERDUE</span>
                                    </div>
                                    <div class="row text-center mb-2">
                                        <div class="col-4">
                                            <div class="fw-bold text-dark">$${parseFloat(member.amount_past_due).toFixed(2)}</div>
                                            <div class="payment-summary text-muted">Amount Due</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fw-bold text-dark">${Math.max(1, Math.ceil(parseFloat(member.amount_past_due) / 50))}</div>
                                            <div class="payment-summary text-muted">Missed Payments</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fw-bold text-dark">$${(parseFloat(member.late_fees || 0)).toFixed(2)}</div>
                                            <div class="payment-summary text-muted">Late Fees</div>
                                        </div>
                                        <div class="col-4">
                                            <div class="fw-bold text-dark">$${parseFloat(member.amount_past_due).toFixed(2)}</div>
                                            <div class="payment-summary text-muted">Total Amount</div>
                                        </div>
                                    </div>
                                    ${member.status_message ? `
                                        <div class="mb-2 pb-1 border-bottom border-light">
                                            <small class="text-dark"><i class="fas fa-info-circle me-1"></i>${member.status_message}</small>
                                        </div>
                                    ` : ''}
                                    <div class="d-flex justify-content-between align-items-center pt-1 border-top border-light">
                                        <small class="text-dark"><strong>Base Amount:</strong></small>
                                        <small class="text-dark">$${(parseFloat(member.base_amount_past_due || 0)).toFixed(2)}</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center pt-1">
                                        <small class="text-dark"><strong>Late Fees:</strong></small>
                                        <small class="text-dark">$${(parseFloat(member.late_fees || 0)).toFixed(2)}</small>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center pt-1 border-top border-light">
                                        <small class="text-dark"><strong>Total Amount Owed:</strong></small>
                                        <small class="text-dark"><strong>$${parseFloat(member.amount_past_due).toFixed(2)}</strong></small>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <!-- Member Action Buttons -->
                            <div class="mt-2 pt-2 border-top">
                                <div class="btn-group w-100" role="group">
                                    <button class="btn btn-sm btn-warning" onclick="event.stopPropagation(); sendInvoiceDirectly('${member.guid || member.prospect_id || member.id}', '${displayName.replace(/'/g, "\\'")}', '${member.email || ''}', '${member.mobile_phone || ''}', ${member.amount_past_due || 0})" title="Send Invoice Now">
                                        <i class="fas fa-file-invoice-dollar"></i> Send Invoice
                                    </button>
                                    <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); showInvoiceTracking('${member.guid || member.prospect_id}', '${displayName.replace(/'/g, "\\'")}')" title="Track Invoices & Lock Status">
                                        <i class="fas fa-receipt"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    container.innerHTML = html;
    debugLog(`‚úÖ Rendered ${members.length} ${category} members to container`);
}

// Function to load members by category
async function loadMembersByCategory(category) {
    debugLog(`üîÑ Loading ${category} members...`);
    
    const containerMap = {
        'green': 'green-members-container',
        'prospects': 'prospects-container',
        'comp': 'comp-members-container',
        'ppv': 'ppv-members-container', 
        'staff': 'staff-members-container',
        'yellow': 'yellow-members-container',
        'past_due': 'past-due-members-container',
        'collections': 'collections-members-container',
        'inactive': 'inactive-members-container'
    };
    
    const container = document.getElementById(containerMap[category]);
    if (!container) {
        debugError(`‚ùå Container not found for category: ${category}`);
        return;
    }
    
    debugLog(`‚úÖ Found container for ${category}:`, container);
    
    // Check cache first
    const now = Date.now();
    const cachedData = memberCache.get(category);
    const cacheTime = cacheTimestamp.get(category);
    
    if (cachedData && cacheTime && (now - cacheTime) < CACHE_DURATION) {
        debugLog(`üì¶ Using cached data for ${category} (${Math.round((now - cacheTime) / 1000)}s old)`);
        renderMembersHTML(container, cachedData, category);
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="col-12 text-center py-5">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p class="text-muted mt-3">Loading ${category} members...</p>
        </div>
    `;
    
    try {
        // Use different endpoint for prospects vs members
        let endpoint = category === 'prospects' 
            ? `/api/prospects/all` 
            : `/api/members/by-category/${category}`;
        debugLog(`üì° Fetching from: ${endpoint}`);
        
        // Force fresh data by adding timestamp to prevent caching
        const response = await fetch(endpoint + '?t=' + Date.now());
        debugLog(`üì° Response status: ${response.status}`);
        
        const data = await response.json();
        debugLog(`üì° Response data:`, data);
        
        if (data.success) {
            debugLog(`‚úÖ Loaded ${data.members?.length || 0} ${category} members`);
            
            // Cache the data
            memberCache.set(category, data);
            cacheTimestamp.set(category, now);
            debugLog(`üì¶ Cached ${category} members data`);
            
            // Use the extracted render function
            renderMembersHTML(container, data, category);
            
            // Update badge counts
            const countBadge = document.getElementById(`${category}-count-badge`);
            if (countBadge) {
                countBadge.textContent = data.members?.length || 0;
                debugLog(`üìä Updated ${category} count badge to: ${data.members?.length || 0}`);
            }
            
        } else {
            throw new Error(data.error || `Failed to load ${category} members`);
        }
        
    } catch (error) {
        debugError(`‚ùå Error loading ${category} members:`, error);
        container.innerHTML = `
            <div class="col-12">
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error loading ${category} members: ${error.message}
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="loadMembersByCategory('${category}')">
                        <i class="fas fa-retry me-1"></i>Retry
                    </button>
                </div>
            </div>
        `;
    }
}

// Load category counts for all tabs
async function loadCategoryCounts() {
    debugLog('üî¢ Loading category counts...');
    try {
        const response = await fetch('/api/members/category-counts');
        const data = await response.json();
        
        if (data.success) {
            const counts = data.counts;
            
            // Update tab badges
            document.getElementById('green-count-badge').textContent = counts.green || 0;
            document.getElementById('comp-count-badge').textContent = counts.comp || 0;
            document.getElementById('ppv-count-badge').textContent = counts.ppv || 0;
            document.getElementById('staff-count-badge').textContent = counts.staff || 0;
            document.getElementById('past-due-count-badge').textContent = counts.past_due || 0;
            document.getElementById('collections-count-badge').textContent = counts.collections || 0;
            document.getElementById('inactive-count-badge').textContent = counts.inactive || 0;
            
            debugLog('‚úÖ Category counts updated:', counts);
        } else {
            debugError('‚ùå Failed to load category counts:', data.error);
        }
    } catch (error) {
        debugError('‚ùå Error loading category counts:', error);
    }
}

// Consolidated DOMContentLoaded listener for all page functionality
document.addEventListener('DOMContentLoaded', function() {
    debugLog('üöÄ Members page DOM loaded - setting up async functionality');
    
    // Check for inbox redirect parameters
    const urlParams = new URLSearchParams(window.location.search);
    const focusMessages = urlParams.get('focus_messages');
    const searchMember = urlParams.get('search');
    const memberId = urlParams.get('member_id');
    const openMember = urlParams.get('open_member');
    const memberName = urlParams.get('member_name');
    
    if (focusMessages === 'true' || openMember) {
        debugLog('üì¨ Inbox redirect detected - will focus on member messages');
        
        if (openMember) {
            // Open member modal directly with messages tab focused
            setTimeout(() => {
                openMemberProfileWithMessages(openMember, decodeURIComponent(memberName || 'Member'), '');
            }, 1500);
        } else if (memberId) {
            // Direct member ID provided - focus on that specific member
            setTimeout(() => {
                focusOnMemberMessages(memberId);
            }, 1000);
        } else if (searchMember) {
            // Search for member by name
            setTimeout(() => {
                searchAndFocusOnMember(searchMember);
            }, 1000);
        }
    }
    
    // Load category counts immediately
    debugLog('üìä Loading category counts...');
    loadCategoryCounts();
    
    // Load green members immediately on page load (default active tab)
    debugLog('üçÉ Loading green members as default...');
    loadMembersByCategory('green');
    
    // Check for cached data and update summary
    debugLog('üîç Checking for cached member data...');
    checkCachedData();
    
    // Update agreement summary with enhanced revenue calculation
    debugLog('üìä Loading enhanced agreement summary...');
    updateAgreementSummary();
    
    // Load monitoring system status
    debugLog('üîÑ Loading monitoring system status...');
    loadMonitoringStatus();
    
    // Member search functionality for individual category search inputs
    const searchInputs = [
        'greenMemberSearch',
        'compMemberSearch', 
        'ppvMemberSearch',
        'staffMemberSearch',
        'collectionsMemberSearch',
        'inactiveMemberSearch',
        'prospectSearch'
    ];
    
    function setupCategorySearch(categoryId) {
        const searchInput = document.getElementById(categoryId);
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                filterMembersByCategory(categoryId, this.value);
            });
            
            // Search on Enter key
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    filterMembersByCategory(categoryId, this.value);
                }
            });
        }
    }
    
    function filterMembersByCategory(categoryId, searchTerm) {
        debugLog(`üîç Filtering ${categoryId} with: "${searchTerm}"`);
        
        const memberItems = document.querySelectorAll(`#${categoryId.replace('Search', '')} .member-item`);
        const searchLower = searchTerm.toLowerCase();
        
        memberItems.forEach(item => {
            const name = item.dataset.name || '';
            const email = item.dataset.email || '';
            const phone = item.dataset.phone || '';
            
            const matchesSearch = name.toLowerCase().includes(searchLower) || 
                                 email.toLowerCase().includes(searchLower) || 
                                 phone.toLowerCase().includes(searchLower);
            
            if (matchesSearch || !searchTerm) {
                item.style.display = 'block';
            } else {
                item.style.display = 'none';
            }
        });
    }
    
    // Set up search for all categories
    searchInputs.forEach(setupCategorySearch);

    // Tab switching functionality
    const allMembersTab = document.getElementById('all-members-tab');
    const pastDueTab = document.getElementById('past-due-tab');
    
    if (allMembersTab) {
        allMembersTab.addEventListener('shown.bs.tab', function() {
            debugLog('üìã All Members tab shown');
            loadAllMembers();
        });
    }
    
    if (pastDueTab) {
        pastDueTab.addEventListener('shown.bs.tab', function() {
            debugLog('üìã Past Due tab shown');
            loadMembersByCategory('past_due');
        });
    }
    
    debugLog('‚úÖ Members page async setup complete');
});

// Function to update agreement summary with proper revenue calculation
async function updateAgreementSummary() {
    debugLog('üìä Updating agreement summary with enhanced revenue calculation...');
    
    try {
        // Get membership-only revenue calculation from API
        const response = await fetch('/api/members/membership-revenue');
        const data = await response.json();
        
        if (data.success) {
            const revenue = data.revenue_data;
            
            // Update summary display with proper revenue-generating member data
            const activeCountEl = document.getElementById('active-agreements-count');
            const revenueEl = document.getElementById('membership-revenue');
            const pastDueCountEl = document.getElementById('past-due-count');
            const totalPastDueEl = document.getElementById('total-past-due');
            
            // Green members count (revenue-generating only)
            if (activeCountEl) activeCountEl.textContent = revenue.membership_count || 0;
            
            // Membership revenue only (exclude training)
            if (revenueEl) {
                const membershipRevenue = revenue.membership_revenue || 0;
                revenueEl.textContent = `$${membershipRevenue.toFixed(2)}`;
                revenueEl.title = `Membership Revenue Only`;
            }
            
            debugLog('‚úÖ Membership revenue calculation updated:', {
                membership_count: revenue.membership_count,
                membership_revenue: revenue.membership_revenue
            });
        } else {
            debugError('‚ùå Error fetching revenue data:', data.error);
            
            // Fallback to basic calculation if API fails
            updateAgreementSummaryFallback();
        }
        
        // Also update past due information
        updatePastDueSummary();
        
    } catch (error) {
        debugError('‚ùå Error updating agreement summary:', error);
        updateAgreementSummaryFallback();
    }
}

// Fallback function for agreement summary (original logic)
function updateAgreementSummaryFallback(members) {
    debugLog('‚ö†Ô∏è Using fallback agreement summary calculation...');
    
    if (!members || !Array.isArray(members)) {
        // Try to get members from cache
        try {
            members = window.cachedMembers || [];
        } catch (e) {
            members = [];
        }
    }
    
    if (members.length === 0) return;
    
    // Only count revenue-generating members (exclude comp, staff, ppv, inactive)
    const revenueGeneratingMembers = members.filter(m => {
        const status = (m.status || '').toLowerCase();
        const statusMessage = (m.status_message || '').toLowerCase();
        const memberType = (m.member_type || m.user_type || '').toLowerCase();
        const email = (m.email || '').toLowerCase();
        const pastDue = parseFloat(m.amount_past_due || 0);
        
        // Exclude non-revenue generating types
        return !(
            statusMessage.includes('comp') || memberType.includes('comp') ||
            statusMessage.includes('staff') || memberType.includes('staff') ||
            statusMessage.includes('per visit') || statusMessage.includes('ppv') || memberType.includes('ppv') ||
            email.includes('anytimefitness') ||
            status === 'inactive' || status === 'suspended' || status === 'cancelled'
        );
    });
    
    const activeAgreements = revenueGeneratingMembers.filter(m => m.agreement_status && m.agreement_status !== 'No Agreement').length;
    const totalMonthlyRevenue = revenueGeneratingMembers.reduce((sum, m) => sum + (parseFloat(m.agreement_recurring_cost || 0)), 0);
    const pastDueCount = members.filter(m => parseFloat(m.amount_past_due || 0) > 0).length;
    const totalPastDue = members.reduce((sum, m) => sum + (parseFloat(m.amount_past_due || 0)), 0);
    
    // Update summary display
    const activeCountEl = document.getElementById('active-agreements-count');
    const revenueEl = document.getElementById('membership-revenue');
    const pastDueCountEl = document.getElementById('past-due-count');
    const totalPastDueEl = document.getElementById('total-past-due');
    
    if (activeCountEl) activeCountEl.textContent = revenueGeneratingMembers.length;
    if (revenueEl) revenueEl.textContent = `$${totalMonthlyRevenue.toFixed(2)}`;
    if (pastDueCountEl) pastDueCountEl.textContent = pastDueCount;
    if (totalPastDueEl) totalPastDueEl.textContent = `$${totalPastDue.toFixed(2)}`;
}

// Update past due summary separately
async function updatePastDueSummary() {
    try {
        const response = await fetch('/api/members/by-category/past_due');
        const data = await response.json();
        
        if (data.success) {
            const pastDueMembers = data.members || [];
            const pastDueCount = pastDueMembers.length;
            const totalPastDue = pastDueMembers.reduce((sum, m) => sum + (parseFloat(m.amount_past_due || 0)), 0);
            
            // Update past due information
            const pastDueCountEl = document.getElementById('past-due-count');
            const totalPastDueEl = document.getElementById('total-past-due');
            
            if (pastDueCountEl) pastDueCountEl.textContent = pastDueCount;
            if (totalPastDueEl) totalPastDueEl.textContent = `$${totalPastDue.toFixed(2)}`;
        }
    } catch (error) {
        debugError('‚ùå Error updating past due summary:', error);
    }
}

// Check for cached data and load it if available
async function checkCachedData() {
    debugLog('üîç Checking for cached member data...');
    try {
        // Force fresh data by adding timestamp to prevent caching
        const response = await fetch('/api/members/all?t=' + Date.now());
        const data = await response.json();
        
        if (data.success) {
            debugLog('üìä Using database member data:', data.members.length, 'members');
            // Cache the data locally for faster access
            window.cachedMembers = data.members;
            // Note: updateAgreementSummary() is now called separately with API data
        } else {
            debugLog('‚ö†Ô∏è No member data available');
        }
    } catch (error) {
        debugError('‚ùå Error checking cached data:', error);
    }
}

// Load category counts for all tabs
async function loadCategoryCounts() {
    // This function will be implemented later
    debugLog('üìä Category counts loading...');
}

// Function to load actual member counts from API
async function loadActualMemberCounts() {
    try {
        const response = await fetch('/api/members/all');
        const data = await response.json();
        
        if (data.success && data.members) {
            const members = data.members;
            
            // Calculate counts based on status_message logic
            const greenCount = members.filter(m => m.status_message && m.status_message.includes('Active')).length;
            const yellowCount = members.filter(m => m.status_message && m.status_message.includes('Past Due 6-30')).length;
            const redCount = members.filter(m => m.status_message && m.status_message.includes('Past Due more than 30')).length;
            const frozenCount = members.filter(m => m.status_message && m.status_message.includes('Frozen')).length;
            const pendingCount = members.filter(m => m.status_message && m.status_message.includes('Pending')).length;
            const compCount = members.filter(m => m.user_type === 'comp' || m.status === 'comp').length;
            const ppvCount = members.filter(m => m.user_type === 'ppv' || m.status === 'ppv').length;
            const reactivatedCount = members.filter(m => m.status_message && m.status_message.includes('Reactivated')).length;
            const staffCount = members.filter(m => m.user_type === 'staff' || m.status === 'staff').length;
            const employerPaidCount = members.filter(m => m.user_type === 'employer_paid' || m.status === 'employer_paid').length;
            
            // Use the enhanced agreement summary instead
            updateAgreementSummary();
            
            debugLog('üìä Actual member counts loaded:', {
                green: greenCount,
                yellow: yellowCount,
                red: redCount,
                frozen: frozenCount,
                pending: pendingCount,
                comp: compCount,
                ppv: ppvCount,
                reactivated: reactivatedCount,
                staff: staffCount,
                employerPaid: employerPaidCount
            });
        }
    } catch (error) {
        debugError('‚ùå Error loading member counts:', error);
    }
}

// Initialize the page
checkCachedData();
loadActualMemberCounts();

// Check if we should open a member profile from URL parameters
document.addEventListener('DOMContentLoaded', function() {
    const urlParams = new URLSearchParams(window.location.search);
    const searchQuery = urlParams.get('search');
    const openProfile = urlParams.get('open_profile');
    const highlightMember = urlParams.get('highlight');
    
    if (searchQuery && openProfile === 'true') {
        // Wait a bit for the page to load, then open the member profile
        setTimeout(() => {
            if (highlightMember) {
                // If we have a specific member ID, use that
                showMemberProfile(searchQuery, highlightMember);
            } else {
                // Otherwise just use the search query
                showMemberProfile(searchQuery);
            }
        }, 1000);
    }
    
    // Add event listener for member message search
    const memberMessageSearch = document.getElementById('memberMessageSearch');
    if (memberMessageSearch) {
        memberMessageSearch.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMemberMessages();
            }
        });
    }
});

// Conversation Functions
let currentMemberName = '';

// Load messages for the current member
function loadMemberMessages() {
    if (!currentMemberName) {
        debugLog('‚ö†Ô∏è No member selected for messages');
        return;
    }
    
    debugLog(`üí¨ Loading messages for: ${currentMemberName}`);
    
    fetch(`/api/messages/member/${encodeURIComponent(currentMemberName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayMemberInbox(data.messages);
                displayMemberConversation(data.messages);
            } else {
                debugError('Error loading member messages:', data.error);
                displayMemberInbox([]);
                displayMemberConversation([]);
            }
        })
        .catch(error => {
            debugError('Error:', error);
            displayMemberInbox([]);
            displayMemberConversation([]);
        });
}

// Display inbox for the member
function displayMemberInbox(messages) {
    // Use the enhanced conversation display
    displayEnhancedMemberInbox(messages, currentMemberName);
}

// Focus on specific member messages (called from inbox redirect)
function focusOnMemberMessages(memberId) {
    debugLog('üéØ Focusing on member messages for ID:', memberId);
    
    // First, try to find and display the member
    fetch(`/api/member/${memberId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success && data.member) {
                const member = data.member;
                debugLog('‚úÖ Found member:', member.name);
                
                // Show the member in the appropriate category
                switchToMemberCategory(member);
                
                // Focus on the member card and show messages
                setTimeout(() => {
                    showMemberCard(member);
                    activateMessageTab();
                }, 500);
            } else {
                console.warn('‚ö†Ô∏è Member not found for ID:', memberId);
            }
        })
        .catch(error => {
            console.error('‚ùå Error loading member:', error);
        });
}

// Search for member by name and focus on messages
function searchAndFocusOnMember(memberName) {
    debugLog('üîç Searching for member:', memberName);
    
    // Search across all categories
    const searchQuery = memberName.trim().toLowerCase();
    
    // Try to find member in current members data
    const categories = ['green', 'comp', 'ppv', 'staff', 'collections', 'inactive'];
    
    for (const category of categories) {
        const membersContainer = document.getElementById(`${category}Members`);
        if (membersContainer) {
            const memberCards = membersContainer.querySelectorAll('.member-card');
            
            for (const card of memberCards) {
                const memberNameElement = card.querySelector('.member-name');
                if (memberNameElement && memberNameElement.textContent.toLowerCase().includes(searchQuery)) {
                    debugLog('‚úÖ Found member in category:', category);
                    
                    // Switch to the appropriate category tab
                    const categoryTab = document.querySelector(`[data-bs-target="#${category}"]`);
                    if (categoryTab) {
                        categoryTab.click();
                    }
                    
                    // Focus on member and show messages
                    setTimeout(() => {
                        card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        card.click();
                        activateMessageTab();
                    }, 500);
                    return;
                }
            }
        }
    }
    
    console.warn('‚ö†Ô∏è Member not found:', memberName);
}

// Switch to the appropriate member category tab
function switchToMemberCategory(member) {
    // Determine category based on member properties
    let category = 'green'; // default
    
    if (member.category) {
        category = member.category.toLowerCase();
    } else if (member.status) {
        // Map status to category
        const statusCategory = member.status.toLowerCase();
        if (['comp', 'ppv', 'staff', 'collections', 'inactive'].includes(statusCategory)) {
            category = statusCategory;
        }
    }
    
    debugLog('üéØ Switching to category tab:', category);
    
    const categoryTab = document.querySelector(`[data-bs-target="#${category}"]`);
    if (categoryTab) {
        categoryTab.click();
        
        // Load the category if not already loaded
        setTimeout(() => {
            loadMembersByCategory(category);
        }, 200);
    }
}

// Activate the message tab when showing member details
function activateMessageTab() {
    debugLog('üì® Activating message history tab');
    
    setTimeout(() => {
        const inboxTab = document.querySelector('#inbox-tab');
        if (inboxTab) {
            inboxTab.click();
            debugLog('‚úÖ Message tab activated');
        }
    }, 800);
}

// Enhanced message display with full conversation history
function displayEnhancedMemberInbox(messages, memberName) {
    const container = document.getElementById('member-inbox-container');
    
    if (!messages || messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No conversation history</h5>
                <p class="text-muted">Start a conversation with ${memberName || 'this member'}</p>
                <button class="btn btn-primary btn-sm" onclick="startNewConversation()">
                    <i class="fas fa-plus me-1"></i>Send Message
                </button>
            </div>
        `;
        return;
    }
    
    // Group messages by date for better organization
    const messagesByDate = groupMessagesByDate(messages);
    
    let conversationHtml = '';
    
    for (const [date, dayMessages] of Object.entries(messagesByDate)) {
        conversationHtml += `
            <div class="conversation-date-separator">
                <div class="date-badge">
                    <small class="text-muted fw-bold">${formatConversationDate(date)}</small>
                </div>
            </div>
        `;
        
        dayMessages.forEach(message => {
            const isFromMember = message.from_user && message.from_user.toLowerCase().includes((memberName || '').toLowerCase());
            const messageClass = isFromMember ? 'message-from-member' : 'message-from-staff';
            
            conversationHtml += `
                <div class="conversation-message ${messageClass} mb-3">
                    <div class="d-flex ${isFromMember ? '' : 'justify-content-end'}">
                        <div class="message-bubble ${isFromMember ? 'member-bubble' : 'staff-bubble'}">
                            <div class="message-header d-flex align-items-center justify-content-between mb-1">
                                <small class="sender-name fw-bold">
                                    ${isFromMember ? (memberName || 'Member') : 'You'}
                                </small>
                                <small class="message-time text-muted">
                                    ${formatMessageTime(message.timestamp)}
                                </small>
                            </div>
                            <div class="message-text">
                                ${message.content || 'No content'}
                            </div>
                            ${message.message_actions ? `
                                <div class="message-actions mt-2">
                                    ${parseMessageActions(message.message_actions)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
    }
    
    container.innerHTML = `
        <div class="conversation-history" style="max-height: 400px; overflow-y: auto;">
            ${conversationHtml}
        </div>
        <div class="conversation-actions mt-3 pt-3 border-top">
            <button class="btn btn-primary btn-sm" onclick="startNewConversation()">
                <i class="fas fa-reply me-1"></i>Reply
            </button>
            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="exportConversation('${memberName || 'member'}')">
                <i class="fas fa-download me-1"></i>Export
            </button>
        </div>
    `;
}

// Group messages by date for conversation view
function groupMessagesByDate(messages) {
    const groups = {};
    
    messages.forEach(message => {
        const date = new Date(message.timestamp || message.created_at);
        const dateKey = date.toDateString();
        
        if (!groups[dateKey]) {
            groups[dateKey] = [];
        }
        groups[dateKey].push(message);
    });
    
    // Sort messages within each day
    Object.keys(groups).forEach(date => {
        groups[date].sort((a, b) => 
            new Date(a.timestamp || a.created_at) - new Date(b.timestamp || b.created_at)
        );
    });
    
    return groups;
}

// Format conversation date
function formatConversationDate(dateString) {
    const date = new Date(dateString);
    const today = new Date();
    const yesterday = new Date(today);
    yesterday.setDate(yesterday.getDate() - 1);
    
    if (date.toDateString() === today.toDateString()) {
        return 'Today';
    } else if (date.toDateString() === yesterday.toDateString()) {
        return 'Yesterday';
    } else {
        return date.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
    }
}

// Format message time
function formatMessageTime(timestamp) {
    if (!timestamp) return '';
    
    const date = new Date(timestamp);
    return date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit',
        hour12: true 
    });
}

// Parse message actions for display
function parseMessageActions(actionsJson) {
    try {
        const actions = JSON.parse(actionsJson || '{}');
        let badges = '';
        
        if (actions.is_confirmation) badges += '<span class="badge bg-success me-1">‚úì Confirmed</span>';
        if (actions.is_opt_in) badges += '<span class="badge bg-info me-1">üì± Opt-in</span>';
        if (actions.is_opt_out) badges += '<span class="badge bg-warning me-1">üö´ Opt-out</span>';
        if (actions.has_emoji && actions.emojis) {
            badges += actions.emojis.map(emoji => `<span class="emoji-reaction">${emoji}</span>`).join('');
        }
        
        return badges;
    } catch (e) {
        return '';
    }
}

// Search messages for the current member
function searchMemberMessages() {
    const query = document.getElementById('memberMessageSearch').value;
    if (!query.trim()) {
        loadMemberMessages();
        return;
    }
    
    fetch(`/api/messages/search?q=${encodeURIComponent(query)}&member=${encodeURIComponent(currentMemberName)}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayEnhancedMemberInbox(data.messages, currentMemberName);
            }
        })
        .catch(error => {
            debugError('Error searching member messages:', error);
        });
}

// Display conversation for the member
function displayMemberConversation(messages) {
    const container = document.getElementById('conversation-container');
    
    if (!messages || messages.length === 0) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No messages yet</h5>
                <p class="text-muted">Click "Send Message" to start a conversation with ${currentMemberName}</p>
            </div>
        `;
        return;
    }
    
    // Display messages in chronological order (oldest first for conversation view)
    const conversationHtml = messages.map(message => {
        const isFromMember = message.from_user && message.from_user.toLowerCase().includes(currentMemberName.toLowerCase());
        const messageClass = isFromMember ? 'member-message' : 'user-message';
        const messageAlign = isFromMember ? 'text-start' : 'text-end';
        
        // Parse message actions
        let messageActions = '';
        try {
            const actions = JSON.parse(message.message_actions || '{}');
            if (actions.is_confirmation) messageActions += '<span class="badge bg-success me-1">‚úì Confirmed</span>';
            if (actions.is_opt_in) messageActions += '<span class="badge bg-info me-1">üì± Opt-in</span>';
            if (actions.is_opt_out) messageActions += '<span class="badge bg-warning me-1">üö´ Opt-out</span>';
            if (actions.has_emoji) {
                const emojis = actions.emojis || [];
                messageActions += emojis.map(emoji => `<span class="emoji-reaction">${emoji}</span>`).join('');
            }
        } catch (e) {
            // Ignore parsing errors
        }
        
        return `
            <div class="conversation-message ${messageClass} mb-3">
                <div class="message-bubble ${messageAlign}">
                    <div class="message-content">
                        <p class="mb-1">${message.content || 'No content'}</p>
                        <small class="text-muted">
                            ${formatDateTime(message.timestamp)}
                            ${message.message_type ? ` ‚Ä¢ ${message.message_type}` : ''}
                        </small>
                        ${messageActions ? `<div class="message-actions mt-2">${messageActions}</div>` : ''}
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = conversationHtml;
    
    // Scroll to bottom to show latest messages
    container.scrollTop = container.scrollHeight;
}

// Send message to the current member using ClubOS API
function sendMessageToMember() {
    if (!currentMemberName) {
        alert('No member selected');
        return;
    }
    
    // Get member ID from the current member data
    const memberId = getCurrentMemberId();
    debugLog(`üîç Got member ID for ${currentMemberName}: ${memberId}`);
    
    if (!memberId) {
        alert('Member ID not found. Please refresh the member list.');
        return;
    }

    const message = prompt(`Send SMS to ${currentMemberName}:`);
    if (!message || message.trim() === '') {
        return;
    }
    
    debugLog(`üì® Preparing to send message to member ${memberId}: "${message.trim()}"`)    // Show sending indicator
    const originalButtonText = document.querySelector('button[onclick="sendMessageToMember()"]')?.innerText;
    if (originalButtonText) {
        document.querySelector('button[onclick="sendMessageToMember()"]').innerText = 'Sending...';
        document.querySelector('button[onclick="sendMessageToMember()"]').disabled = true;
    }
    
    // Send via ClubOS API
    fetch('/api/messages/send', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            member_id: memberId,
            message: message.trim(),
            channel: 'sms'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Message sent successfully to ${currentMemberName}!`);
        } else {
            alert(`‚ùå Failed to send message: ${data.error}`);
        }
    })
    .catch(error => {
        debugError('Error sending message:', error);
        alert(`‚ùå Error sending message: ${error.message}`);
    })
    .finally(() => {
        // Restore button
        if (originalButtonText) {
            document.querySelector('button[onclick="sendMessageToMember()"]').innerText = originalButtonText;
            document.querySelector('button[onclick="sendMessageToMember()"]').disabled = false;
        }
        
        // Refresh the conversation
        setTimeout(() => {
            loadMemberMessages();
        }, 1000);
    });
}

// Helper function to get current member ID
function getCurrentMemberId() {
    debugLog(`üîç Looking for member ID for: ${currentMemberName}`);
    
    // First check if we have the current member ID from fetchMemberDetails
    if (window.currentMemberId) {
        debugLog(`‚úÖ Found window.currentMemberId: ${window.currentMemberId}`);
        return window.currentMemberId;
    }
    
    // Look for member ID in various places in the DOM
    const memberCard = document.querySelector('.member-card.selected');
    if (memberCard) {
        debugLog(`‚úÖ Found member card with ID: ${memberCard.dataset.memberId}`);
        return memberCard.dataset.memberId;
    }
    
    // Try to find it in the global member data
    if (window.currentMemberData && window.currentMemberData.member_id) {
        debugLog(`‚úÖ Found window.currentMemberData.member_id: ${window.currentMemberData.member_id}`);
        return window.currentMemberData.member_id;
    }
    
    // Last resort: search through loaded members
    if (window.membersData) {
        debugLog(`üîç Searching through ${window.membersData.length} loaded members`);
        const member = window.membersData.find(m => 
            (m.first_name + ' ' + m.last_name) === currentMemberName ||
            m.name === currentMemberName
        );
        if (member) {
            debugLog(`‚úÖ Found member in loaded data: ${member.member_id}`);
            return member.member_id;
        } else {
            debugLog(`‚ùå Member not found in loaded data`);
        }
    }
    
    debugLog(`‚ùå Could not find member ID for: ${currentMemberName}`);
    debugLog(`üîç Debug info: window.currentMemberId=${window.currentMemberId}, window.currentMemberData=${!!window.currentMemberData}, window.membersData=${!!window.membersData}`);
    return null;
}

// Update the showMemberProfile function to load messages
function showMemberProfile(memberName, memberId = null) {
    debugLog(`üë§ Showing profile for: ${memberName}${memberId ? ` (ID: ${memberId})` : ''}`);
    
    // Set current member name for conversation loading
    currentMemberName = memberName;
    
    // Update modal title
    document.getElementById('modal-member-name').textContent = memberName;
    
    // Show loading state
    document.getElementById('member-profile-loading').style.display = 'block';
    document.getElementById('member-profile-content').style.display = 'none';
    
    // Open modal
    const modalElement = document.getElementById('memberProfileModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Load member data and messages
    Promise.all([
        loadMemberData(memberName, memberId),
        loadMemberMessages()
    ]).then(() => {
        // Hide loading, show content
        document.getElementById('member-profile-loading').style.display = 'none';
        document.getElementById('member-profile-content').style.display = 'block';
    }).catch(error => {
        debugError('Error loading member profile:', error);
        document.getElementById('member-profile-loading').style.display = 'none';
        document.getElementById('member-profile-content').style.display = 'block';
    });
}

// Utility function for formatting dates
function formatDateTime(dateString) {
    if (!dateString) return 'Unknown';
    try {
        return new Date(dateString).toLocaleString();
    } catch {
        return dateString;
    }
}

// Invoice Tracking Functions
let currentTrackingMember = null;

function showInvoiceTracking(memberId, memberName) {
    debugLog(`üìä Opening invoice tracking for ${memberName} (ID: ${memberId})`);
    currentTrackingMember = { id: memberId, name: memberName };
    
    // Update modal title
    document.getElementById('tracking-member-name').textContent = memberName;
    
    // Reset modal content
    document.getElementById('member-access-status').innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    document.getElementById('past-due-amount').textContent = '$0.00';
    document.getElementById('total-invoices').textContent = '0';
    document.getElementById('paid-invoices').textContent = '0';
    
    // Load real-time lock status
    loadMemberLockStatus(memberId);
    document.getElementById('invoice-timeline').innerHTML = `
        <div class="text-center text-muted py-4">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Loading invoice history...</p>
        </div>
    `;
    
    // Open modal
    const modalElement = document.getElementById('invoiceTrackingModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // Load invoice tracking data
    loadInvoiceTrackingData(memberId, memberName);
}

async function loadInvoiceTrackingData(memberId, memberName) {
    try {
        debugLog(`üìä Loading invoice tracking data for ${memberName}`);
        
        // Load member status and invoice data
        const response = await fetch(`/api/member-invoice-status/${memberId}`);
        const data = await response.json();
        
        if (data.success) {
            updateInvoiceTrackingDisplay(data);
        } else {
            debugError('Failed to load invoice tracking data:', data.error);
            showInvoiceTrackingError(data.error);
        }
    } catch (error) {
        debugError('Error loading invoice tracking data:', error);
        showInvoiceTrackingError('Network error loading invoice data');
    }
}

function updateInvoiceTrackingDisplay(data) {
    const { member_status, invoices, access_status } = data;
    
    // Update member access status
    const accessBadge = document.getElementById('member-access-status');
    if (access_status === 'locked') {
        accessBadge.innerHTML = '<i class="fas fa-lock me-1"></i>LOCKED';
        accessBadge.className = 'badge bg-danger';
    } else {
        accessBadge.innerHTML = '<i class="fas fa-unlock me-1"></i>ACTIVE';
        accessBadge.className = 'badge bg-success';
    }
    
    // Update financial info
    document.getElementById('past-due-amount').textContent = `$${(member_status.past_due_amount || 0).toFixed(2)}`;
    document.getElementById('total-invoices').textContent = invoices.length;
    document.getElementById('paid-invoices').textContent = invoices.filter(inv => inv.status === 'paid').length;
    
    // Update timeline
    renderInvoiceTimeline(invoices);
    
    // Update lock button
    const lockBtn = document.getElementById('toggle-lock-btn');
    if (access_status === 'locked') {
        lockBtn.innerHTML = '<i class="fas fa-unlock me-1"></i>Unlock Member';
        lockBtn.className = 'btn btn-success me-2';
    } else {
        lockBtn.innerHTML = '<i class="fas fa-lock me-1"></i>Lock Member';
        lockBtn.className = 'btn btn-warning me-2';
    }
}

function renderInvoiceTimeline(invoices) {
    const timeline = document.getElementById('invoice-timeline');
    
    if (invoices.length === 0) {
        timeline.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-file-invoice fa-2x mb-2"></i>
                <p>No invoices found for this member</p>
            </div>
        `;
        return;
    }
    
    const timelineHtml = invoices.map(invoice => {
        const statusIcon = getInvoiceStatusIcon(invoice.status);
        const statusColor = getInvoiceStatusColor(invoice.status);
        
        return `
            <div class="timeline-item mb-3">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <div class="d-flex align-items-center mb-2">
                                    <span class="badge ${statusColor} me-2">${statusIcon}</span>
                                    <strong>Invoice #${invoice.id}</strong>
                                    <span class="badge ${statusColor} ms-2">${invoice.status.toUpperCase()}</span>
                                </div>
                                <div class="small text-muted">
                                    <div><strong>Amount:</strong> $${parseFloat(invoice.amount).toFixed(2)}</div>
                                    <div><strong>Created:</strong> ${formatDateTime(invoice.created_at)}</div>
                                    ${invoice.due_date ? `<div><strong>Due:</strong> ${formatDateTime(invoice.due_date)}</div>` : ''}
                                    ${invoice.payment_date ? `<div><strong>Paid:</strong> ${formatDateTime(invoice.payment_date)}</div>` : ''}
                                    <div><strong>Delivery:</strong> ${invoice.delivery_method ? invoice.delivery_method.toUpperCase() : 'EMAIL'}</div>
                                    <div><strong>Square ID:</strong> ${invoice.square_invoice_id || 'N/A'}</div>
                                </div>
                            </div>
                            <div class="col-md-4 text-end">
                                <div class="h5 mb-0 text-${statusColor.replace('bg-', 'text-')}">$${parseFloat(invoice.amount).toFixed(2)}</div>
                                <div class="small text-muted">${invoice.status.toUpperCase()}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    timeline.innerHTML = timelineHtml;
}

function getInvoiceStatusIcon(status) {
    switch (status) {
        case 'created': return '<i class="fas fa-file-invoice"></i>';
        case 'sent': return '<i class="fas fa-paper-plane"></i>';
        case 'viewed': return '<i class="fas fa-eye"></i>';
        case 'paid': return '<i class="fas fa-check-circle"></i>';
        case 'failed': return '<i class="fas fa-times-circle"></i>';
        default: return '<i class="fas fa-question-circle"></i>';
    }
}

function getInvoiceStatusColor(status) {
    switch (status) {
        case 'created': return 'bg-secondary';
        case 'sent': return 'bg-info';
        case 'viewed': return 'bg-warning';
        case 'paid': return 'bg-success';
        case 'failed': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function showInvoiceTrackingError(error) {
    document.getElementById('invoice-timeline').innerHTML = `
        <div class="text-center text-danger py-4">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p>Error loading invoice data: ${error}</p>
            <button class="btn btn-outline-primary" onclick="loadInvoiceTrackingData('${currentTrackingMember.id}', '${currentTrackingMember.name}')">
                <i class="fas fa-redo me-1"></i>Try Again
            </button>
        </div>
    `;
}

async function refreshInvoiceStatus() {
    if (!currentTrackingMember) return;
    
    const refreshBtn = event.target;
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    refreshBtn.disabled = true;
    
    try {
        await loadInvoiceTrackingData(currentTrackingMember.id, currentTrackingMember.name);
    } finally {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    }
}

async function toggleMemberLock() {
    if (!currentTrackingMember) return;
    
    const lockBtn = document.getElementById('toggle-lock-btn');
    const isCurrentlyLocked = lockBtn.innerHTML.includes('Unlock');
    
    if (!confirm(`${isCurrentlyLocked ? 'Unlock' : 'Lock'} gym access for ${currentTrackingMember.name}?`)) {
        return;
    }
    
    const originalText = lockBtn.innerHTML;
    lockBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Processing...';
    lockBtn.disabled = true;
    
    try {
        const response = await fetch('/api/toggle-member-lock', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                member_id: currentTrackingMember.id,
                action: isCurrentlyLocked ? 'unlock' : 'lock'
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            alert(`‚úÖ Member ${isCurrentlyLocked ? 'unlocked' : 'locked'} successfully!`);
            await loadInvoiceTrackingData(currentTrackingMember.id, currentTrackingMember.name);
        } else {
            alert(`‚ùå Error: ${data.error}`);
        }
    } catch (error) {
        debugError('Error toggling member lock:', error);
        alert('‚ùå Network error updating member lock status');
    } finally {
        lockBtn.innerHTML = originalText;
        lockBtn.disabled = false;
    }
}

function createNewInvoice() {
    if (!currentTrackingMember) return;
    
    // Close tracking modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceTrackingModal'));
    modal.hide();
    
    // Open invoice creation modal
    showQuickInvoiceModal(currentTrackingMember.id, currentTrackingMember.name, '');
}

// Automated Lock/Unlock Functions
async function runAutomatedLockCheck() {
    const lockBtn = event.target;
    const originalText = lockBtn.innerHTML;
    lockBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    lockBtn.disabled = true;
    
    try {
        const response = await fetch('/api/automated-lock-check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const results = data.results;
            alert(`‚úÖ Automated Lock Check Complete!\n\nüìä Results:\n‚Ä¢ New Locks: ${results.locked_count}\n‚Ä¢ Already Locked: ${results.already_locked_count}\n‚Ä¢ Total Processed: ${results.total_processed}\n‚Ä¢ Errors: ${results.errors.length}`);
            
            if (results.locked_count > 0) {
                // Refresh the past due members tab to show updated status
                loadMembersByCategory('past_due');
            }
        } else {
            alert(`‚ùå Error running automated lock check:\n\n${data.error}`);
        }
    } catch (error) {
        debugError('Error running automated lock check:', error);
        alert('‚ùå Network error running automated lock check');
    } finally {
        lockBtn.innerHTML = originalText;
        lockBtn.disabled = false;
    }
}

async function runAutomatedUnlockCheck() {
    const unlockBtn = event.target;
    const originalText = unlockBtn.innerHTML;
    unlockBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Checking...';
    unlockBtn.disabled = true;
    
    try {
        const response = await fetch('/api/automated-unlock-check', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const data = await response.json();
        
        if (data.success) {
            const results = data.results;
            alert(`‚úÖ Automated Unlock Check Complete!\n\nüìä Results:\n‚Ä¢ New Unlocks: ${results.unlocked_count}\n‚Ä¢ Still Locked: ${results.still_locked_count}\n‚Ä¢ Total Processed: ${results.total_processed}\n‚Ä¢ Errors: ${results.errors.length}`);
            
            if (results.unlocked_count > 0) {
                // Refresh the past due members tab to show updated status
                loadMembersByCategory('past_due');
            }
        } else {
            alert(`‚ùå Error running automated unlock check:\n\n${data.error}`);
        }
    } catch (error) {
        debugError('Error running automated unlock check:', error);
        alert('‚ùå Network error running automated unlock check');
    } finally {
        unlockBtn.innerHTML = originalText;
        unlockBtn.disabled = false;
    }
}

// Member Lock Status Functions
async function checkMemberLockStatus(memberId) {
    try {
        const response = await fetch(`/api/member-access-status/${memberId}`);
        const data = await response.json();
        
        if (data.success) {
            return {
                is_locked: data.is_locked,
                past_due_amount: data.past_due_amount,
                should_be_locked: data.should_be_locked,
                access_status: data.access_status
            };
        }
    } catch (error) {
        debugError('‚ùå Error checking member lock status:', error);
    }
    
    return null;
}

async function loadMemberLockStatus(memberId) {
    try {
        debugLog(`üîê Loading lock status for member ID: ${memberId}`);
        
        const lockStatus = await checkMemberLockStatus(memberId);
        if (lockStatus) {
            // Update access status badge
            const accessStatusElement = document.getElementById('member-access-status');
            const pastDueElement = document.getElementById('past-due-amount');
            
            if (lockStatus.is_locked) {
                accessStatusElement.innerHTML = '<i class="fas fa-lock me-1"></i>LOCKED';
                accessStatusElement.className = 'badge bg-danger';
            } else {
                accessStatusElement.innerHTML = '<i class="fas fa-unlock me-1"></i>ACTIVE';
                accessStatusElement.className = 'badge bg-success';
            }
            
            // Update past due amount
            const pastDue = parseFloat(lockStatus.past_due_amount) || 0;
            pastDueElement.textContent = `$${pastDue.toFixed(2)}`;
            
            // Update parent card styling based on status
            const parentCard = accessStatusElement.closest('.card');
            if (lockStatus.is_locked) {
                parentCard.className = 'card bg-danger text-white';
            } else {
                parentCard.className = 'card bg-success text-white';
            }
            
            debugLog(`üîê Lock status updated - Locked: ${lockStatus.is_locked}, Past Due: $${pastDue.toFixed(2)}`);
        } else {
            debugError('‚ùå Failed to load lock status');
            const accessStatusElement = document.getElementById('member-access-status');
            accessStatusElement.innerHTML = '<i class="fas fa-exclamation-triangle me-1"></i>ERROR';
            accessStatusElement.className = 'badge bg-warning';
        }
    } catch (error) {
        debugError('‚ùå Error loading member lock status:', error);
    }
}

async function updateMemberCardLockStatus(memberCard, memberId) {
    try {
        const lockStatus = await checkMemberLockStatus(memberId);
        if (lockStatus) {
            const lockBadge = memberCard.querySelector('.lock-status-badge');
            if (lockBadge) {
                if (lockStatus.is_locked) {
                    lockBadge.className = 'badge bg-danger ms-1 lock-status-badge';
                    lockBadge.innerHTML = '<i class="fas fa-lock me-1"></i>LOCKED';
                    lockBadge.title = `Gym access is LOCKED - Past Due: $${lockStatus.past_due_amount.toFixed(2)}`;
                } else {
                    lockBadge.className = 'badge bg-success ms-1 lock-status-badge';
                    lockBadge.innerHTML = '<i class="fas fa-unlock me-1"></i>ACTIVE';
                    lockBadge.title = 'Gym access is ACTIVE - No outstanding balance';
                }
            }
        }
    } catch (error) {
        debugError('‚ùå Error updating member card lock status:', error);
    }
}

// Refresh all member card lock statuses
async function refreshAllMemberLockStatuses() {
    try {
        debugLog('üîÑ Refreshing all member lock statuses...');
        
        const memberCards = document.querySelectorAll('[data-member-id]');
        const promises = [];
        
        memberCards.forEach(card => {
            const memberId = card.getAttribute('data-member-id');
            if (memberId) {
                promises.push(updateMemberCardLockStatus(card, memberId));
            }
        });
        
        await Promise.all(promises);
        debugLog(`‚úÖ Refreshed lock status for ${promises.length} members`);
        
    } catch (error) {
        debugError('‚ùå Error refreshing member lock statuses:', error);
    }
}

// Monitoring System Control Functions
async function toggleMonitoringSystem() {
    const toggleBtn = document.getElementById('monitoring-toggle-btn');
    const statusText = document.getElementById('monitoring-status-text');
    
    const originalText = toggleBtn.innerHTML;
    toggleBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
    toggleBtn.disabled = true;
    
    try {
        // First get current status
        const statusResponse = await fetch('/api/monitoring/status');
        const statusData = await statusResponse.json();
        
        if (!statusData.success) {
            alert('‚ùå Could not get monitoring status');
            return;
        }
        
        const currentlyEnabled = statusData.enabled;
        const newAction = currentlyEnabled ? 'stop' : 'start';
        
        // Toggle the monitoring system
        const toggleResponse = await fetch(`/api/monitoring/${newAction}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const toggleData = await toggleResponse.json();
        
        if (toggleData.success) {
            const isNowEnabled = !currentlyEnabled;
            
            // Update button appearance
            if (isNowEnabled) {
                toggleBtn.className = 'btn btn-success';
                statusText.textContent = 'Monitoring Active';
                debugLog('‚úÖ Monitoring system started');
                alert('‚úÖ Automated monitoring system is now ACTIVE\n\nüîí Will automatically lock past due members\nüîì Will automatically unlock when payments received');
            } else {
                toggleBtn.className = 'btn btn-outline-primary';
                statusText.textContent = 'Monitoring Stopped';
                debugLog('‚èπÔ∏è Monitoring system stopped');
                alert('‚èπÔ∏è Automated monitoring system is now STOPPED\n\n‚ö†Ô∏è Manual lock/unlock only');
            }
        } else {
            alert('‚ùå Error toggling monitoring system: ' + toggleData.error);
        }
    } catch (error) {
        debugError('‚ùå Error toggling monitoring system:', error);
        alert('‚ùå Network error toggling monitoring system');
    } finally {
        toggleBtn.innerHTML = originalText;
        toggleBtn.disabled = false;
    }
}

async function loadMonitoringStatus() {
    try {
        const response = await fetch('/api/monitoring/status');
        const data = await response.json();
        
        if (data.success) {
            const toggleBtn = document.getElementById('monitoring-toggle-btn');
            const statusText = document.getElementById('monitoring-status-text');
            
            if (data.enabled) {
                toggleBtn.className = 'btn btn-success';
                statusText.textContent = 'Monitoring Active';
            } else {
                toggleBtn.className = 'btn btn-outline-primary';
                statusText.textContent = 'Monitoring Stopped';
            }
            
            debugLog(`üìä Monitoring status loaded: ${data.enabled ? 'ACTIVE' : 'STOPPED'}`);
        }
    } catch (error) {
        debugError('‚ùå Error loading monitoring status:', error);
    }
}

// Prospect Campaign Management Functions
function createProspectCampaign() {
    debugLog('üéØ Creating new prospect campaign...');
    
    const selectedProspects = getSelectedProspects();
    if (selectedProspects.length === 0) {
        alert('Please select at least one prospect to create a campaign.');
        return;
    }
    
    // For now, redirect to messaging page with prospects selected
    const prospectIds = selectedProspects.map(p => p.prospect_id).join(',');
    window.location.href = `/messaging?type=campaign&targets=prospects&ids=${prospectIds}`;
}

function bulkMessageProspects() {
    debugLog('üí¨ Starting bulk message to prospects...');
    
    const selectedProspects = getSelectedProspects();
    if (selectedProspects.length === 0) {
        alert('Please select at least one prospect to send messages.');
        return;
    }
    
    const message = prompt(`Send message to ${selectedProspects.length} prospects:`);
    if (!message || message.trim() === '') {
        return;
    }
    
    // Send bulk message
    fetch('/api/send-bulk-message', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            targets: selectedProspects.map(p => ({
                id: p.prospect_id,
                name: p.full_name || p.first_name + ' ' + p.last_name,
                phone: p.phone || p.mobile_phone,
                email: p.email
            })),
            message: message,
            campaign_type: 'prospect_outreach'
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ Message sent successfully to ${selectedProspects.length} prospects!`);
        } else {
            alert(`‚ùå Error sending messages: ${data.error}`);
        }
    })
    .catch(error => {
        debugError('Error sending bulk message:', error);
        alert(`‚ùå Error sending messages: ${error.message}`);
    });
}

function exportProspects() {
    debugLog('üìã Exporting prospects list...');
    
    const selectedProspects = getSelectedProspects();
    const prospects = selectedProspects.length > 0 ? selectedProspects : getAllLoadedProspects();
    
    if (prospects.length === 0) {
        alert('No prospects to export. Please load prospects first.');
        return;
    }
    
    // Create CSV content
    const csvHeaders = ['Name', 'Email', 'Phone', 'Status', 'Source', 'Created Date'];
    const csvRows = prospects.map(p => [
        (p.full_name || `${p.first_name || ''} ${p.last_name || ''}`).trim(),
        p.email || '',
        p.phone || p.mobile_phone || '',
        p.status || '',
        p.source || '',
        p.created_at || ''
    ]);
    
    const csvContent = [csvHeaders, ...csvRows]
        .map(row => row.map(field => `"${(field || '').toString().replace(/"/g, '""')}"`).join(','))
        .join('\\n');
    
    // Download CSV
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', `prospects_export_${new Date().toISOString().split('T')[0]}.csv`);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    debugLog(`‚úÖ Exported ${prospects.length} prospects to CSV`);
}

function getSelectedProspects() {
    // Get prospects with checked checkboxes (if we add selection UI)
    const checkboxes = document.querySelectorAll('#prospects-container .prospect-checkbox:checked');
    return Array.from(checkboxes).map(cb => JSON.parse(cb.dataset.prospect));
}

function getAllLoadedProspects() {
    // Get all currently loaded prospects from cache or DOM
    const cachedData = memberCache.get('prospects');
    return cachedData?.members || [];
}

// Collections Management Functions
function openCollectionsModal() {
    // Show loading state
    const modal = document.getElementById('collectionsModal');
    const modalBody = document.getElementById('collectionsModalBody');
    modalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Loading past due accounts...</div>';
    
    // Show modal
    const bootstrapModal = new bootstrap.Modal(modal);
    bootstrapModal.show();
    
    // Load past due data
    loadPastDueCollectionsData();
}

function loadPastDueCollectionsData() {
    fetch('/api/collections/past-due')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayCollectionsData(data.past_due_data, data.already_sent_count, data.already_sent_amount);
            } else {
                document.getElementById('collectionsModalBody').innerHTML = 
                    `<div class="alert alert-danger">Error loading data: ${data.error}</div>`;
            }
        })
        .catch(error => {
            console.error('Error loading collections data:', error);
            document.getElementById('collectionsModalBody').innerHTML = 
                `<div class="alert alert-danger">Network error loading data</div>`;
        });
}

function displayCollectionsData(pastDueData, alreadySentCount = 0, alreadySentAmount = 0) {
    const modalBody = document.getElementById('collectionsModalBody');
    
    if (pastDueData.length === 0) {
        modalBody.innerHTML = '<div class="alert alert-info">No active past due accounts found.</div>';
        return;
    }
    
    let html = `
        <div class="row mb-3">
            <div class="col-8">
                <h5>Active Past Due Accounts (${pastDueData.length})</h5>
                <small class="text-muted">Members with current agreements eligible for collections</small>
            </div>
            <div class="col-4 text-end">
                <button class="btn btn-sm btn-outline-primary" onclick="selectAllAccounts()">Select All</button>
                <button class="btn btn-sm btn-outline-secondary" onclick="deselectAllAccounts()">Deselect All</button>
            </div>
        </div>
        
        <!-- Collections Status Summary -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info py-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <strong class="text-success">${pastDueData.length}</strong><br>
                            <small>Active Accounts</small>
                        </div>
                        <div class="col-4">
                            <strong class="text-warning">${alreadySentCount}</strong><br>
                            <small>Already in Collections ($${parseFloat(alreadySentAmount).toFixed(2)})</small>
                        </div>
                        <div class="col-4">
                            <strong class="text-primary">$${pastDueData.reduce((sum, acc) => sum + parseFloat(acc.past_due_amount), 0).toFixed(2)}</strong><br>
                            <small>Total Amount</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-sm table-hover">
                <thead class="table-dark sticky-top">
                    <tr>
                        <th width="50">Select</th>
                        <th>Name</th>
                        <th>Type</th>
                        <th>Amount</th>
                        <th>Agreement ID</th>
                        <th>Contact</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    pastDueData.forEach((account, index) => {
        const isSelected = false;
        const contact = account.email || account.phone || 'No contact';
        const agreementId = account.agreement_id || 'N/A';
        const agreementType = account.agreement_type || 'N/A';
        
        html += `
            <tr>
                <td>
                    <input type="checkbox" class="form-check-input account-checkbox" 
                           value="${index}" data-account='${JSON.stringify(account)}'>
                </td>
                <td><strong>${account.name}</strong></td>
                <td>
                    <span class="badge ${account.type === 'member' ? 'bg-primary' : 'bg-success'}">
                        ${account.type === 'member' ? 'Member' : 'Training'}
                    </span>
                </td>
                <td><strong>$${parseFloat(account.past_due_amount).toFixed(2)}</strong></td>
                <td>
                    <small>
                        ${agreementId}<br>
                        <span class="text-muted">${agreementType}</span>
                    </small>
                </td>
                <td>
                    <small>
                        ${account.email || 'No email'}<br>
                        ${account.mobile_phone || account.phone || 'No phone'}<br>
                        ${account.address || 'No address'}<br>
                        ${account.city || ''} ${account.state || ''} ${account.zip_code || ''}
                    </small>
                </td>
                <td>
                    <span class="badge bg-warning">${account.status}</span>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        
        <div class="row mt-3">
            <div class="col-6">
                <div class="alert alert-info">
                    <strong>Selected:</strong> <span id="selectedCount">0</span> accounts
                    <br>
                    <strong>Total Amount:</strong> $<span id="selectedAmount">0.00</span>
                </div>
            </div>
            <div class="col-6 text-end">
                <button class="btn btn-success" onclick="sendCollectionsEmail()" id="sendEmailBtn">
                    <i class="fas fa-envelope me-1"></i>
                    Send to Collections
                </button>
            </div>
        </div>
    `;
    
    modalBody.innerHTML = html;
    
    // Add event listeners for checkboxes
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateSelectedSummary);
    });
}

function selectAllAccounts() {
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.checked = true;
    });
    updateSelectedSummary();
}

function deselectAllAccounts() {
    document.querySelectorAll('.account-checkbox').forEach(checkbox => {
        checkbox.checked = false;
    });
    updateSelectedSummary();
}

function updateSelectedSummary() {
    const checkboxes = document.querySelectorAll('.account-checkbox:checked');
    const selectedCount = checkboxes.length;
    
    let totalAmount = 0;
    checkboxes.forEach(checkbox => {
        const account = JSON.parse(checkbox.dataset.account);
        totalAmount += parseFloat(account.past_due_amount);
    });
    
    document.getElementById('selectedCount').textContent = selectedCount;
    document.getElementById('selectedAmount').textContent = totalAmount.toFixed(2);
}

function sendCollectionsEmail() {
    const checkboxes = document.querySelectorAll('.account-checkbox:checked');
    
    if (checkboxes.length === 0) {
        alert('Please select at least one account to send to collections.');
        return;
    }
    
    const selectedAccounts = Array.from(checkboxes).map(checkbox => 
        JSON.parse(checkbox.dataset.account)
    );
    
    const sendBtn = document.getElementById('sendEmailBtn');
    const originalText = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Sending...';
    sendBtn.disabled = true;
    
    fetch('/api/collections/send-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            selected_accounts: selectedAccounts
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert(`‚úÖ ${data.message}`);
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('collectionsModal'));
            modal.hide();
        } else {
            alert(`‚ùå Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error sending collections email:', error);
        alert('‚ùå Network error sending email');
    })
    .finally(() => {
        sendBtn.innerHTML = originalText;
        sendBtn.disabled = false;
    });
}
</script>

<!-- Collections Modal -->
<div class="modal fade" id="collectionsModal" tabindex="-1" aria-labelledby="collectionsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="collectionsModalLabel">
                    <i class="fas fa-gavel me-2"></i>
                    Collections Management
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="collectionsModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>

<script>
// Helper function to start new conversation
function startNewConversation() {
    debugLog('üí¨ Starting new conversation with member:', currentMemberName);
    // This could open a compose message modal
    alert(`Starting new conversation with ${currentMemberName || 'this member'}\n\nThis feature will open a compose window in a future update.`);
}

// Export conversation function
function exportConversation(memberName) {
    debugLog('üì• Exporting conversation for:', memberName);
    alert(`Exporting conversation with ${memberName}\n\nThis feature will generate a downloadable conversation history in a future update.`);
}
</script>

{% endblock %}
