{% extends "base.html" %}

{% block title %}ClubOS Messaging Center - Anytime Fitness Dashboard{% endblock %}

{% block extra_css %}
<style>
    .message-item {
        transition: background-color 0.15s ease, border-left-color 0.15s ease;
        border-left: 4px solid transparent;
        background: white;
        border-radius: var(--border-radius-medium);
        margin-bottom: 0.5rem;
        box-shadow: var(--shadow-2);
    }
    .message-item:hover {
        background-color: var(--af-gray-50);
        border-left-color: var(--af-purple-primary);
        cursor: pointer;
        box-shadow: var(--shadow-4);
    }
    .message-item.unread {
        background-color: #e3f2fd;
        border-left-color: var(--af-purple-primary);
    }
    .message-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--border-radius-small);
    }
    .campaign-card {
        transition: box-shadow 0.15s ease;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-2);
    }
    .campaign-card:hover {
        box-shadow: var(--shadow-4);
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--af-purple-primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .message-content {
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .message-actions {
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .message-item:hover .message-actions {
        opacity: 1;
    }
    .fluent-card {
        background: white;
        border-radius: var(--border-radius-large);
        box-shadow: var(--shadow-4);
        border: none;
    }
    .fluent-header {
        background: linear-gradient(135deg, var(--af-purple-primary), var(--af-purple-dark));
        color: white;
        border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        padding: 1rem 1.5rem;
    }
    .btn-fluent-primary {
        background: var(--af-purple-primary);
        border: none;
        color: white;
        border-radius: var(--border-radius-medium);
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    .btn-fluent-primary:hover {
        background: var(--af-purple-dark);
        color: white;
        box-shadow: var(--shadow-4);
    }
    .btn-fluent-outline {
        border: 1px solid var(--af-purple-primary);
        color: var(--af-purple-primary);
        background: transparent;
        border-radius: var(--border-radius-medium);
        padding: 0.5rem 1rem;
        transition: background 0.15s ease, color 0.15s ease;
    }
    .btn-fluent-outline:hover {
        background: var(--af-purple-primary);
        color: white;
        box-shadow: var(--shadow-4);
    }
    
    .campaign-template-card .campaign-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        cursor: pointer;
    }
    
    .campaign-template-card .campaign-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    
    .border-dashed {
        border: 2px dashed #dee2e6 !important;
        border-style: dashed !important;
    }
    
    .border-dashed:hover {
        border-color: var(--af-purple-primary) !important;
    }
    
    /* Status Tabs Styling */
    .nav-tabs .nav-link {
        border: none !important;
        transition: all 0.3s ease;
        background: transparent !important;
    }
    .nav-tabs .nav-link:hover {
        background: rgba(111, 66, 193, 0.1) !important;
        border: none !important;
    }
    .nav-tabs .nav-link.active {
        background: white !important;
        border-bottom: 3px solid var(--af-purple-primary) !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .nav-tabs .nav-link.active i {
        color: var(--af-purple-primary) !important;
    }
    .nav-tabs .nav-link.active span.fw-bold {
        color: var(--af-purple-primary) !important;
    }
    
    /* Campaign Action Panel */
    .campaign-action-panel {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: var(--border-radius-medium);
        border: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }
    .campaign-controls {
        background: white;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-2);
        padding: 1.5rem;
    }
    .member-preview {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius-small);
        background: white;
    }
    .member-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s ease;
    }
    .member-item:hover {
        background-color: #f8f9fa;
    }
    .member-item:last-child {
        border-bottom: none;
    }
    
    /* Fix scrolling issues - Remove problematic scroll overrides */
    .messaging-page {
        position: relative;
    }
    
    /* Fix tab positioning - prevent detaching */
    .nav-tabs {
        position: relative;
        z-index: 5;
        background: #f8f9fa;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    /* Ensure proper scrolling */
    .tab-content {
        position: relative;
    }
    
    .tab-pane {
        position: relative;
    }
    
    /* Member preview scrolling */
    .member-preview {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius-small);
        background: white;
    }
    
    /* Simple Modal Fix - Remove conflicts */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }
    
    .modal-dialog {
        position: relative;
        width: auto;
        margin: 0.5rem;
        pointer-events: none;
    }
    
    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0,0,0,.2);
        border-radius: 0.3rem;
        outline: 0;
    }
    
    .modal input,
    .modal textarea,
    .modal select {
        pointer-events: auto !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
    
    /* Messaging Inbox Styles */
    .inbox-conversation-item {
        transition: all 0.15s ease;
        border-radius: 8px;
        margin: 2px 0;
        cursor: pointer;
    }
    
    .inbox-conversation-item:hover {
        background-color: #f8f9fa !important;
        transform: translateX(3px);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .unread-conversation {
        background-color: #e3f2fd !important;
        border-left: 4px solid var(--af-purple-primary);
    }
    
    .conversation-avatar {
        font-weight: 600;
        background: linear-gradient(135deg, var(--af-purple-primary), var(--af-purple-dark)) !important;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .inbox-conversations {
        border-radius: 8px;
    }
    
    .inbox-conversations::-webkit-scrollbar {
        width: 6px;
    }
    
    .inbox-conversations::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 3px;
    }
    
    .inbox-conversations::-webkit-scrollbar-thumb {
        background: var(--af-purple-primary);
        border-radius: 3px;
    }
    
    .inbox-footer {
        background: linear-gradient(135deg, #f8f9fa, #e9ecef) !important;
        border-radius: 0 0 8px 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="messaging-page">
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1 fw-bold" style="color: var(--af-black-primary);">
            <i class="fas fa-comments me-2" style="color: var(--af-purple-primary);"></i>
            ClubOS Messaging Center
        </h1>
        <p class="text-muted mb-0">Marketing campaigns and message management</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-fluent-outline" onclick="syncMessages()">
            <i class="fas fa-sync-alt me-1"></i>
            Sync Messages
        </button>
        <button class="btn btn-fluent-primary" onclick="loadStatusCampaigns()">
            <i class="fas fa-refresh me-1"></i>
            Refresh Categories
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="row g-4">
    <!-- Inbox Section -->
    <div class="col-12">
        <div class="fluent-card mb-4">
            <div class="fluent-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0 fw-semibold">
                            <i class="fas fa-inbox me-2"></i>
                            Message Inbox
                        </h5>
                        <p class="mb-0 small opacity-75">Recent conversations with members</p>
                    </div>
                    <button class="btn btn-light btn-sm" onclick="refreshMessagingInbox()" title="Refresh Inbox">
                        <i class="fas fa-sync-alt me-1"></i>
                        Refresh
                    </button>
                </div>
            </div>
            <div class="card-body p-3">
                <div id="messaging-inbox-container">
                    <div class="text-center py-4">
                        <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                        <p class="text-muted">Loading conversations...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Status-Based Campaign Cards -->
    <div class="col-12">
        <div class="fluent-card">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-bullhorn me-2"></i>
                    Campaign Management by Status Category
                </h5>
                <p class="mb-0 small opacity-75">Create and run targeted campaigns for each member status group</p>
            </div>
            <div class="card-body p-0">
                <!-- Status Tabs Navigation -->
                <ul class="nav nav-tabs nav-fill border-0" id="statusTabs" role="tablist" style="background: #f8f9fa;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active position-relative text-center fw-bold border-0" 
                                id="good-standing-tab" data-bs-toggle="tab" data-bs-target="#good-standing-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-check-circle text-success mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Good Standing</span>
                                <span class="badge bg-success rounded-pill mt-1" id="good-standing-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="pay-per-visit-tab" data-bs-toggle="tab" data-bs-target="#pay-per-visit-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-credit-card text-info mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Pay Per Visit</span>
                                <span class="badge bg-info rounded-pill mt-1" id="pay-per-visit-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="past-due-6-30-tab" data-bs-toggle="tab" data-bs-target="#past-due-6-30-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-exclamation-triangle text-warning mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Past Due 6-30</span>
                                <span class="badge bg-warning text-dark rounded-pill mt-1" id="past-due-6-30-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="past-due-30-tab" data-bs-toggle="tab" data-bs-target="#past-due-30-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-times-circle text-danger mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Past Due 30+</span>
                                <span class="badge bg-danger rounded-pill mt-1" id="past-due-30-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="past-due-training-tab" data-bs-toggle="tab" data-bs-target="#past-due-training-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-dumbbell text-danger mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">PT Past Due</span>
                                <span class="badge bg-danger rounded-pill mt-1" id="past-due-training-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="expiring-soon-tab" data-bs-toggle="tab" data-bs-target="#expiring-soon-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-clock text-warning mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Expiring Soon</span>
                                <span class="badge bg-warning text-dark rounded-pill mt-1" id="expiring-soon-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="prospects-tab" data-bs-toggle="tab" data-bs-target="#prospects-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-users text-primary mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Prospects</span>
                                <span class="badge bg-primary rounded-pill mt-1" id="prospects-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="other-statuses-tab" data-bs-toggle="tab" data-bs-target="#other-statuses-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-ellipsis-h text-secondary mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Other</span>
                                <span class="badge bg-secondary rounded-pill mt-1" id="other-statuses-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="campaign-templates-tab" data-bs-toggle="tab" data-bs-target="#campaign-templates-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-rocket text-purple mb-1" style="font-size: 1.5rem; color: var(--af-purple-primary);"></i>
                                <span class="fw-bold text-dark small">Templates</span>
                                <span class="badge rounded-pill mt-1" style="background: var(--af-purple-primary); color: white;" id="templates-count">6</span>
                            </div>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content Panels -->
                <div class="tab-content border-0" id="statusTabContent" style="min-height: 500px;">
                    <!-- Good Standing Panel -->
                    <div class="tab-pane fade show active" id="good-standing-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="good_standing">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-success text-white text-center">
                                        <i class="fas fa-check-circle mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Good Standing Campaign</h5>
                                        <small class="opacity-75">Members with active, current memberships</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="good-standing-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="good-standing-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-success" id="good-standing-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="good-standing-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-success" onclick="openCampaignModal('good_standing')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Pay Per Visit Panel -->
                    <div class="tab-pane fade" id="pay-per-visit-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="pay_per_visit">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-info text-white text-center">
                                        <i class="fas fa-credit-card mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Pay Per Visit Campaign</h5>
                                        <small class="opacity-75">Members on pay-per-visit plans</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="pay-per-visit-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="pay-per-visit-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-info" id="pay-per-visit-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="pay-per-visit-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-info" onclick="openCampaignModal('pay_per_visit')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Past Due 6-30 Days Panel -->
                    <div class="tab-pane fade" id="past-due-6-30-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="past_due_6_30">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-warning text-dark text-center">
                                        <i class="fas fa-exclamation-triangle mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Past Due 6-30 Days Campaign</h5>
                                        <small class="opacity-75">Members with payments 6-30 days overdue</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="past-due-6-30-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="past-due-6-30-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-warning" id="past-due-6-30-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="past-due-6-30-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-warning text-dark" onclick="openCampaignModal('past_due_6_30')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Past Due 30+ Days Panel -->
                    <div class="tab-pane fade" id="past-due-30-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="past_due_30_plus">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-danger text-white text-center">
                                        <i class="fas fa-times-circle mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Past Due 30+ Days Campaign</h5>
                                        <small class="opacity-75">Members with payments over 30 days overdue</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="past-due-30-plus-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="past-due-30-plus-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-danger" id="past-due-30-plus-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="past-due-30-plus-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-danger" onclick="openCampaignModal('past_due_30_plus')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Past Due Training Clients Panel -->
                    <div class="tab-pane fade" id="past-due-training-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="past_due_training">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-danger text-white text-center">
                                        <i class="fas fa-dumbbell mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">PT Past Due Campaign</h5>
                                        <small class="opacity-75">Personal training accounts past due</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="past-due-training-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="past-due-training-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-danger" id="past-due-training-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="past-due-training-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-danger" onclick="openCampaignModal('past_due_training')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Expiring Soon Panel -->
                    <div class="tab-pane fade" id="expiring-soon-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="expiring_soon">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-warning text-dark text-center">
                                        <i class="fas fa-clock mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Expiring Soon Campaign</h5>
                                        <small class="opacity-75">Memberships expiring within 30 days</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="expiring-soon-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="expiring-soon-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-warning" id="expiring-soon-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="expiring-soon-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-warning text-dark" onclick="openCampaignModal('expiring_soon')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Prospects Panel -->
                    <div class="tab-pane fade" id="prospects-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="prospects">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-primary text-white text-center">
                                        <i class="fas fa-users mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Prospects Campaign</h5>
                                        <small class="opacity-75">Potential new members and leads</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="prospects-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="prospects-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-primary" id="prospects-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="prospects-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-primary" onclick="openCampaignModal('prospects')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Other Statuses Panel -->
                    <div class="tab-pane fade" id="other-statuses-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="campaign-category-card" data-category="other_statuses">
                                <div class="card campaign-card h-100">
                                    <div class="card-header bg-secondary text-white text-center">
                                        <i class="fas fa-ellipsis-h mb-2 d-block" style="font-size: 2.5rem;"></i>
                                        <h5 class="mb-0">Other Status Campaign</h5>
                                        <small class="opacity-75">Members with other status types</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="campaign-status mb-3" id="other-statuses-status">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span class="fw-medium">Campaign Progress:</span>
                                                <span class="badge bg-secondary" id="other-statuses-progress-badge">Not Started</span>
                                            </div>
                                            <div class="progress mb-2" style="height: 8px;">
                                                <div class="progress-bar bg-secondary" id="other-statuses-progress-bar" style="width: 0%"></div>
                                            </div>
                                            <small class="text-muted" id="other-statuses-progress-text">Ready to start campaign</small>
                                        </div>
                                        <div class="d-grid gap-2">
                                            <button class="btn btn-secondary" onclick="openCampaignModal('other_statuses')">
                                                <i class="fas fa-rocket me-2"></i>Manage Campaign
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Campaign Templates Panel -->
                    <div class="tab-pane fade" id="campaign-templates-panel" role="tabpanel">
                        <div class="p-4">
                            <div class="row">
                                <!-- Campaign Templates -->
                                <div class="col-lg-8 col-md-12">
                                    <div class="d-flex justify-content-between align-items-center mb-4">
                                        <div>
                                            <h6 class="fw-bold mb-1">
                                                <i class="fas fa-rocket me-2" style="color: var(--af-purple-primary);"></i>
                                                Reusable Campaign Templates
                                            </h6>
                                            <p class="text-muted small mb-0">Pre-built campaign templates for common messaging needs</p>
                                        </div>
                                        <button class="btn btn-sm btn-outline-primary" onclick="loadSavedCampaigns()">
                                            <i class="fas fa-sync-alt"></i> Refresh
                                        </button>
                                    </div>
                                    <div class="row g-3" id="campaignTemplatesContainer">
                                        <!-- Welcome Campaign Card -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="campaign-template-card" data-category="welcome">
                                                <div class="card border-0 shadow-sm h-100 campaign-card">
                                                    <div class="card-header bg-primary text-white text-center">
                                                        <i class="fas fa-handshake mb-2 d-block" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">Welcome New Members</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <p class="card-text small text-muted mb-3">Send personalized welcome messages to new members</p>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-primary flex-fill" onclick="useCampaignTemplate('welcome')">
                                                                <i class="fas fa-play me-1"></i>Use
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="editCampaignTemplate('welcome')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Check-in Reminder Card -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="campaign-template-card" data-category="check_in">
                                                <div class="card border-0 shadow-sm h-100 campaign-card">
                                                    <div class="card-header bg-info text-white text-center">
                                                        <i class="fas fa-dumbbell mb-2 d-block" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">Check-in Reminder</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <p class="card-text small text-muted mb-3">Motivate inactive members to return to the gym</p>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-info flex-fill" onclick="useCampaignTemplate('check_in')">
                                                                <i class="fas fa-play me-1"></i>Use
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="editCampaignTemplate('check_in')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Payment Reminder Card -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="campaign-template-card" data-category="payment_due">
                                                <div class="card border-0 shadow-sm h-100 campaign-card">
                                                    <div class="card-header bg-warning text-dark text-center">
                                                        <i class="fas fa-credit-card mb-2 d-block" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">Payment Reminder</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <p class="card-text small text-muted mb-3">Gentle reminders for overdue payments</p>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-warning flex-fill" onclick="useCampaignTemplate('payment_due')">
                                                                <i class="fas fa-play me-1"></i>Use
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="editCampaignTemplate('payment_due')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Promotion Card -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="campaign-template-card" data-category="promotion">
                                                <div class="card border-0 shadow-sm h-100 campaign-card">
                                                    <div class="card-header bg-success text-white text-center">
                                                        <i class="fas fa-percentage mb-2 d-block" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">Special Promotion</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <p class="card-text small text-muted mb-3">Share special offers and promotions</p>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-success flex-fill" onclick="useCampaignTemplate('promotion')">
                                                                <i class="fas fa-play me-1"></i>Use
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="editCampaignTemplate('promotion')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Follow-up Card -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="campaign-template-card" data-category="followup">
                                                <div class="card border-0 shadow-sm h-100 campaign-card">
                                                    <div class="card-header bg-secondary text-white text-center">
                                                        <i class="fas fa-phone mb-2 d-block" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">Member Follow-up</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <p class="card-text small text-muted mb-3">Check-in with members about their experience</p>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-secondary flex-fill" onclick="useCampaignTemplate('followup')">
                                                                <i class="fas fa-play me-1"></i>Use
                                                            </button>
                                                            <button class="btn btn-sm btn-outline-secondary" onclick="editCampaignTemplate('followup')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Custom Campaign Card -->
                                        <div class="col-lg-4 col-md-6">
                                            <div class="campaign-template-card" data-category="custom">
                                                <div class="card border-0 shadow-sm h-100 campaign-card border-dashed">
                                                    <div class="card-header bg-light text-dark text-center">
                                                        <i class="fas fa-plus mb-2 d-block" style="font-size: 2rem;"></i>
                                                        <h6 class="mb-0">Create Custom</h6>
                                                    </div>
                                                    <div class="card-body p-3">
                                                        <p class="card-text small text-muted mb-3">Build a new campaign from scratch</p>
                                                        <div class="d-flex gap-2">
                                                            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="createCustomCampaign()">
                                                                <i class="fas fa-plus me-1"></i>Create
                                                            </button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Campaign Editor -->
                                <div class="col-lg-4 col-md-12">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">
                                            <h6 class="mb-0 fw-semibold">
                                                <i class="fas fa-cogs me-2"></i>
                                                Campaign Editor
                                            </h6>
                                        </div>
                                        <div class="card-body">
                                            <form id="templateCampaignForm">
                                                <div class="row g-3">
                                                    <div class="col-12">
                                                        <label for="templateCampaignName" class="form-label fw-medium">Campaign Name</label>
                                                        <input type="text" class="form-control" id="templateCampaignName" placeholder="Enter campaign name">
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="templateCampaignMessage" class="form-label fw-medium">Message Template</label>
                                                        <textarea class="form-control" id="templateCampaignMessage" rows="4" placeholder="Enter your message..."></textarea>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="templateTargetGroup" class="form-label fw-medium">Target Group</label>
                                                        <select class="form-select" id="templateTargetGroup">
                                                            <option value="all">All Members</option>
                                                            <option value="new">New Members (< 30 days)</option>
                                                            <option value="inactive">Inactive Members (no recent check-ins)</option>
                                                            <option value="past_due">Past Due Members</option>
                                                            <option value="good_standing">Members in Good Standing</option>
                                                            <option value="expiring_soon">Memberships Expiring Soon</option>
                                                        </select>
                                                    </div>
                                                    <div class="col-12">
                                                        <label for="templateMaxRecipients" class="form-label fw-medium">Max Recipients (Unlimited)</label>
                                                        <input type="number" class="form-control" id="templateMaxRecipients" value="999999" min="1" max="999999" placeholder="Unlimited" disabled>
                                                    </div>
                                                    <div class="col-12">
                                                        <div class="form-check">
                                                            <input class="form-check-input" type="checkbox" id="saveAsNewTemplate">
                                                            <label class="form-check-label" for="saveAsNewTemplate">
                                                                Save as new template
                                                            </label>
                                                        </div>
                                                    </div>
                                                    <div class="col-12">
                                                        <button type="button" class="btn btn-primary w-100 mb-2" onclick="launchTemplateCampaign()" style="background: var(--af-purple-primary); border: none;">
                                                            <i class="fas fa-paper-plane me-2"></i>Launch Campaign
                                                        </button>
                                                        <button type="button" class="btn btn-outline-secondary w-100" onclick="previewTemplateCampaign()">
                                                            <i class="fas fa-eye me-2"></i>Preview Message
                                                        </button>
                                                    </div>
                                                </div>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Row for Message Inbox and Progress -->
<div class="row g-4 mt-2">
    <!-- Message Inbox -->
    <div class="col-md-6">
        <div class="fluent-card">
            <div class="fluent-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-inbox me-2"></i>
                    ClubOS Messages
                </h5>
                <button class="btn btn-sm btn-fluent-outline" onclick="syncMessages()">
                    <i class="fas fa-sync-alt"></i> Sync
                </button>
            </div>
            <div class="card-body p-3">
                <div class="mb-3">
                    <label for="messageSearch" class="form-label visually-hidden">Search Messages</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageSearch" placeholder="Search messages..." style="border-radius: var(--border-radius-medium);">
                        <button class="btn btn-fluent-outline" type="button" onclick="searchMessages()" title="Search Messages" aria-label="Search Messages">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="messagesContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading ClubOS messages...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <!-- Campaign History & Reuse -->
    <div class="col-md-6">
        <div class="fluent-card">
            <div class="fluent-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-history me-2"></i>
                    Campaign History
                </h5>
                <button class="btn btn-sm btn-fluent-outline" onclick="loadCampaignHistory()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body p-3">
                <div id="campaignHistoryContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading campaign history...</p>
                    </div>
                </div>
                <div class="mt-3 d-flex gap-2">
                    <button class="btn btn-sm btn-outline-warning" onclick="resetAllProgress()">
                        <i class="fas fa-redo"></i> Reset Progress
                    </button>
                    <button class="btn btn-sm btn-outline-info" onclick="viewCampaignStats()">
                        <i class="fas fa-chart-bar"></i> View Stats
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Enhanced Category Campaign Modal -->
<div class="modal fade" id="categoryCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content" style="border-radius: var(--border-radius-large);">
            <div class="modal-header" style="background: var(--af-purple-primary); color: white; border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-bullhorn me-2"></i>
                    <span id="modalCategoryTitle">Campaign Manager</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close Modal"></button>
            </div>
            <div class="modal-body">
                <div class="row g-4">
                    <!-- Campaign Controls -->
                    <div class="col-lg-8">
                        <!-- Campaign Status Section -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="fas fa-chart-line me-2"></i>
                                    Current Campaign Status
                                </h6>
                            </div>
                            <div class="card-body">
                                <div id="campaignStatusSection">
                                    <!-- Dynamic status will be loaded here -->
                                    <div class="alert alert-info">
                                        <i class="fas fa-info-circle me-2"></i>
                                        <strong>Ready to start:</strong> No active campaign for this category
                                    </div>
                                </div>
                                
                                <!-- Progress Tracking -->
                                <div id="campaignProgressSection" style="display: none;">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <span class="fw-medium">Sending Progress:</span>
                                        <span class="badge bg-primary" id="campaignProgressBadge">In Progress</span>
                                    </div>
                                    <div class="progress mb-2" style="height: 12px;">
                                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                                             id="campaignProgressBar" style="width: 0%"></div>
                                    </div>
                                    <div class="d-flex justify-content-between">
                                        <small class="text-muted" id="campaignProgressText">Starting campaign...</small>
                                        <small class="text-muted" id="campaignProgressCount">0 / 0 sent</small>
                                    </div>
                                    <div class="d-flex gap-2 mt-3">
                                        <button class="btn btn-sm btn-warning" id="pauseCampaignBtn" onclick="pauseCampaign()">
                                            <i class="fas fa-pause"></i> Pause
                                        </button>
                                        <button class="btn btn-sm btn-success" id="resumeCampaignBtn" onclick="resumeCampaign()" style="display: none;">
                                            <i class="fas fa-play"></i> Resume
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="stopCampaign()">
                                            <i class="fas fa-stop"></i> Stop
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Campaign Options -->
                        <div class="card">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="fas fa-cogs me-2"></i>
                                    Campaign Options
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="d-grid gap-2 d-md-block mb-3" id="campaignActionButtons">
                                    <button class="btn btn-success me-2" id="continueCampaignBtn" onclick="continueCampaign()" style="display: none;">
                                        <i class="fas fa-play me-2"></i>Continue from Where Left Off
                                    </button>
                                    <button class="btn btn-primary me-2" onclick="showCampaignEditor('template')">
                                        <i class="fas fa-edit me-2"></i>Edit with Template
                                    </button>
                                    <button class="btn btn-outline-primary" onclick="showCampaignEditor('fresh')">
                                        <i class="fas fa-plus me-2"></i>Create Fresh Campaign
                                    </button>
                                </div>
                                
                                <!-- Campaign Editor (Hidden by default) -->
                                <div id="campaignEditor" style="display: none;">
                                    <hr class="mb-3">
                                    <form id="categoryCampaignForm">
                                        <input type="hidden" id="modalCategoryValue" value="">
                                        <input type="hidden" id="editorMode" value="">
                                        
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="campaignName" class="form-label fw-medium">Campaign Name</label>
                                                <input type="text" class="form-control" id="campaignName" required placeholder="Enter campaign name">
                                            </div>
                                            <div class="col-md-6">
                                                <label for="campaignTemplate" class="form-label fw-medium">Use Template</label>
                                                <select class="form-select" id="campaignTemplate" onchange="loadCampaignTemplate()">
                                                    <option value="">Select a template...</option>
                                                    <option value="welcome">Welcome New Members</option>
                                                    <option value="payment_reminder">Payment Reminder</option>
                                                    <option value="check_in">Check-in Reminder</option>
                                                    <option value="promotion">Special Promotion</option>
                                                    <option value="followup">Member Follow-up</option>
                                                </select>
                                            </div>
                                            <div class="col-12">
                                                <label for="campaignMessage" class="form-label fw-medium">Message Content</label>
                                                <textarea class="form-control" id="campaignMessage" rows="4" required placeholder="Enter your message here..."></textarea>
                                                <div class="form-text">
                                                    <small class="text-muted">You can use variables: {name}, {first_name}, {email}, {phone}</small>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="messageType" class="form-label fw-medium">Message Type</label>
                                                <select class="form-select" id="messageType" required>
                                                    <option value="sms">SMS Text Message</option>
                                                    <option value="email">Email Message</option>
                                                </select>
                                            </div>
                                            <div class="col-md-6">
                                                <label for="maxRecipients" class="form-label fw-medium">Max Recipients (Unlimited)</label>
                                                <input type="number" class="form-control" id="maxRecipients" value="999999" min="1" max="999999" placeholder="Unlimited" disabled>
                                            </div>
                                            <div class="col-12" id="emailSubjectDiv" style="display: none;">
                                                <label for="emailSubject" class="form-label fw-medium">Email Subject</label>
                                                <input type="text" class="form-control" id="emailSubject">
                                            </div>
                                            <div class="col-12">
                                                <label for="campaignNotes" class="form-label fw-medium">Campaign Notes (Optional)</label>
                                                <textarea class="form-control" id="campaignNotes" rows="2" placeholder="Add notes about this campaign..."></textarea>
                                            </div>
                                            <div class="col-12">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" id="saveAsTemplate">
                                                    <label class="form-check-label" for="saveAsTemplate">
                                                        Save as reusable template
                                                    </label>
                                                </div>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Member Preview & Stats -->
                    <div class="col-lg-4">
                        <div class="card h-100">
                            <div class="card-header bg-light">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="fas fa-users me-2"></i>
                                    Target Members
                                </h6>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3" id="memberCountAlert">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span class="fw-medium">Total Members:</span>
                                        <span class="badge bg-primary" id="totalMemberCount">0</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <span>Remaining to Contact:</span>
                                        <span class="badge bg-warning" id="remainingMemberCount">0</span>
                                    </div>
                                </div>
                                
                                <div class="member-preview" style="max-height: 400px; overflow-y: auto;">
                                    <div id="memberPreviewList">
                                        <!-- Member list will be loaded here -->
                                        <div class="text-center py-4">
                                            <div class="loading-spinner"></div>
                                            <p class="text-muted mt-2">Loading members...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-outline-info me-2" onclick="previewCampaign()">
                    <i class="fas fa-eye me-1"></i>Preview
                </button>
                <button type="button" class="btn btn-success" id="launchCampaignBtn" onclick="launchCampaign()">
                    <i class="fas fa-rocket me-1"></i>Launch Campaign
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Member Profile Modal -->
<div class="modal fade" id="memberProfileModal" tabindex="-1" aria-labelledby="memberProfileModalLabel">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="memberProfileModalLabel">
                    <i class="fas fa-user me-2"></i>Member Profile
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <!-- Nav tabs -->
                <ul class="nav nav-tabs" id="memberProfileTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile" type="button" role="tab">
                            <i class="fas fa-user"></i> Profile
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="messages-tab" data-bs-toggle="tab" data-bs-target="#messages" type="button" role="tab">
                            <i class="fas fa-comments"></i> Messages <span id="messages-badge" class="badge bg-primary ms-1">0</span>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="payments-tab" data-bs-toggle="tab" data-bs-target="#payments" type="button" role="tab">
                            <i class="fas fa-credit-card"></i> Payments
                        </button>
                    </li>
                </ul>
                
                <!-- Tab content -->
                <div class="tab-content p-4" id="memberProfileTabContent">
                    <!-- Profile Tab -->
                    <div class="tab-pane fade show active" id="profile" role="tabpanel">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Member Information</h6>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Full Name</label>
                                    <div id="member-full-name" class="form-control-plaintext">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Phone</label>
                                    <div id="member-phone" class="form-control-plaintext">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Email</label>
                                    <div id="member-email" class="form-control-plaintext">-</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h6 class="fw-bold mb-3">Membership Details</h6>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Status</label>
                                    <div id="member-status" class="form-control-plaintext">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Member Since</label>
                                    <div id="member-since" class="form-control-plaintext">-</div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label small text-muted">Last Check-in</label>
                                    <div id="member-last-checkin" class="form-control-plaintext">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Messages Tab -->
                    <div class="tab-pane fade" id="messages" role="tabpanel">
                        <div id="member-messages-loading" class="text-center py-4">
                            <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                            <p class="text-muted">Loading message history...</p>
                        </div>
                        <div id="member-messages-content" class="d-none">
                            <div class="message-history" style="max-height: 400px; overflow-y: auto;">
                                <!-- Messages will be loaded here -->
                            </div>
                        </div>
                        <div id="member-messages-empty" class="text-center py-4 d-none">
                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No messages found</p>
                        </div>
                    </div>
                    
                    <!-- Payments Tab -->
                    <div class="tab-pane fade" id="payments" role="tabpanel">
                        <div id="member-payments-content">
                            <div class="text-center py-4">
                                <i class="fas fa-credit-card fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Payment information will be displayed here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="window.open(`/members?search=${encodeURIComponent(document.getElementById('member-full-name').textContent)}`, '_blank')">
                    <i class="fas fa-external-link-alt me-1"></i>Open in Members Page
                </button>
            </div>
        </div>
    </div>
</div>
</div> <!-- End messaging-page wrapper -->
{% endblock %}

{% block extra_js %}
<script>
        // Messaging Inbox Functions
        function loadMessagingInbox() {
            debugLog('📬 Loading messaging inbox...');
            
            fetch('/api/messaging/inbox/recent?limit=15', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.messages) {
                    displayMessagingInbox(data.messages);
                } else {
                    displayEmptyMessagingInbox();
                }
            })
            .catch(error => {
                console.error('❌ Error loading messaging inbox:', error);
                displayEmptyMessagingInbox();
            });
        }
        
        function displayMessagingInbox(messages) {
            const container = document.getElementById('messaging-inbox-container');

            if (!messages || messages.length === 0) {
                displayEmptyMessagingInbox();
                return;
            }

            const inboxHtml = messages.map((message, index) => {
                const timeAgo = formatTimeAgo(message.created_at);
                const memberName = message.member_name || 'Unknown Member';
                const messagePreview = truncateText(message.message_content || 'No content', 60);
                const isUnread = message.status !== 'read';
                const memberId = message.member_id || message.owner_id || '';

                // Skip messages without valid member ID
                if (!memberId) {
                    console.warn('⚠️ Skipping message without valid member ID:', message);
                    return '';
                }
                
                return `
                    <div class="inbox-conversation-item d-flex align-items-center p-3 border-bottom cursor-pointer ${isUnread ? 'unread-conversation' : ''}" 
                         onclick="openConversationWithMember('${memberId}', '${encodeURIComponent(memberName)}')"
                         title="Click to view full conversation with ${memberName}">
                        <div class="flex-shrink-0 me-3">
                            <div class="conversation-avatar bg-primary text-white d-flex align-items-center justify-content-center rounded-circle" 
                                 style="width: 48px; height: 48px; font-size: 1.1rem;">
                                ${memberName.charAt(0).toUpperCase()}
                            </div>
                        </div>
                        <div class="flex-grow-1 min-w-0">
                            <div class="d-flex justify-content-between align-items-start mb-1">
                                <h6 class="mb-0 text-truncate fw-bold" style="color: var(--af-purple-primary);">
                                    ${memberName}
                                    ${isUnread ? '<span class="badge bg-danger ms-1 rounded-pill" style="font-size: 0.6rem;">New</span>' : ''}
                                </h6>
                                <small class="text-muted" style="font-size: 0.8rem;">${timeAgo}</small>
                            </div>
                            <p class="mb-0 text-muted text-truncate" style="font-size: 0.9rem;">
                                ${messagePreview}
                            </p>
                            <div class="d-flex align-items-center mt-1">
                                <small class="text-info">
                                    <i class="fas fa-${thread.thread_type || 'sms'} me-1"></i>
                                    ${(thread.thread_type || 'SMS').toUpperCase()}
                                </small>
                            </div>
                        </div>
                    </div>
                `;
            }).filter(html => html.trim() !== '').join('');
            
            container.innerHTML = `
                <div class="inbox-conversations" style="max-height: 500px; overflow-y: auto;">
                    ${inboxHtml}
                </div>
                <div class="inbox-footer pt-3 border-top bg-light">
                    <div class="row g-2">
                        <div class="col-6">
                            <button class="btn btn-outline-secondary btn-sm w-100" onclick="clearMessagingInbox()">
                                <i class="fas fa-trash me-1"></i>Clear
                            </button>
                        </div>
                        <div class="col-6">
                            <button class="btn btn-primary btn-sm w-100" onclick="viewAllConversations()">
                                <i class="fas fa-comments me-1"></i>View All
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function displayEmptyMessagingInbox() {
            const container = document.getElementById('messaging-inbox-container');
            container.innerHTML = `
                <div class="text-center py-5">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No conversations yet</h5>
                    <p class="text-muted">New messages will appear here</p>
                    <button class="btn btn-primary btn-sm" onclick="refreshMessagingInbox()">
                        <i class="fas fa-sync-alt me-1"></i>Check for Messages
                    </button>
                </div>
            `;
        }
        
        async function refreshMessagingInbox() {
            debugLog('🔄 Refreshing messaging inbox - syncing from ClubOS first...');
            const container = document.getElementById('messaging-inbox-container');
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-spinner fa-spin fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Syncing messages from ClubOS...</p>
                </div>
            `;
            
            // CRITICAL FIX: Sync from ClubOS FIRST, then load from database
            try {
                const response = await fetch('/api/messages/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        owner_id: window.currentOwnerId || '187032782'
                    })
                });
                
                const data = await response.json();
                debugLog('✅ ClubOS sync complete:', data);
                
                // Now load the fresh messages from database
                loadMessagingInbox();
            } catch (error) {
                console.error('❌ Error syncing messages:', error);
                // Still try to load from database even if sync fails
                loadMessagingInbox();
            }
        }

        function clearMessagingInbox() {
            debugLog('🗑️ Clearing messaging inbox...');
            const container = document.getElementById('messaging-inbox-container');
            container.innerHTML = `
                <div class="text-center py-4">
                    <i class="fas fa-trash fa-2x text-muted mb-3"></i>
                    <p class="text-muted">Inbox cleared</p>
                    <button class="btn btn-primary btn-sm mt-2" onclick="refreshMessagingInbox()">
                        <i class="fas fa-sync-alt me-1"></i>Reload Messages
                    </button>
                </div>
            `;
        }

        // Search for a person across prospects, members, then show error if not found
        function searchForPersonProfile(personName) {
            debugLog(`🔍 Searching for person profile: ${personName}`);

            // First, try to find them as a prospect
            fetch(`/api/prospects/search?name=${encodeURIComponent(personName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.prospects && data.prospects.length > 0) {
                        // Found as prospect - redirect to prospect profile
                        const prospect = data.prospects[0];
                        const prospectId = prospect.prospect_id || prospect.id;
                        debugLog(`👤 Found as prospect: ${prospectId}`);
                        window.location.href = `/prospect/${prospectId}`;
                        return;
                    }

                    // Not found as prospect, try as member
                    return fetch(`/api/members/search?name=${encodeURIComponent(personName)}`);
                })
                .then(response => {
                    if (!response) return null; // Already handled as prospect
                    return response.json();
                })
                .then(data => {
                    if (data && data.success && data.members && data.members.length > 0) {
                        // Found as member - redirect to member profile
                        const member = data.members[0];
                        const memberId = member.prospect_id || member.guid || member.id;
                        debugLog(`👥 Found as member: ${memberId}`);
                        window.location.href = `/member/${memberId}`;
                        return;
                    }

                    // Not found as prospect or member - show error
                    alert(`Unable to find profile for ${personName}. Person not found in prospects or members.`);
                })
                .catch(error => {
                    console.error('❌ Error searching for person:', error);
                    alert(`Error searching for ${personName}. Please try again.`);
                });
        }
        
        function openConversationWithMember(memberId, memberName) {
            debugLog('💬 Redirecting to specific person page:', memberId, memberName);

            // Handle prospect case - direct navigation to prospect profile
            if (memberId && memberId.startsWith('prospect:')) {
                const prospectId = memberId.replace('prospect:', '');
                debugLog(`🎯 Direct navigation to prospect profile: ${prospectId}`);
                window.location.href = `/prospect/${prospectId}`;
                return;
            }

            // If we have a real member ID, go to their member profile
            if (memberId && !memberId.startsWith('search:') && memberId !== 'null' && memberId !== '') {
                window.location.href = `/member/${memberId}`;
                return;
            }

            // If no real member ID, search for them as prospect first, then member
            const personName = memberName ? decodeURIComponent(memberName) : (memberId.startsWith('search:') ? memberId.replace('search:', '').replace(/_/g, ' ') : '');

            if (!personName) {
                alert('Unable to identify person');
                return;
            }

            // Search prospects first
            fetch(`/api/prospects/search?name=${encodeURIComponent(personName)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.prospects && data.prospects.length > 0) {
                        const prospect = data.prospects[0];
                        const prospectId = prospect.prospect_id || prospect.id;
                        window.location.href = `/prospect/${prospectId}`;
                        return;
                    }

                    // Not found as prospect, try as member
                    return fetch(`/api/members/search?name=${encodeURIComponent(personName)}`);
                })
                .then(response => {
                    if (!response) return null;
                    return response.json();
                })
                .then(data => {
                    if (data && data.success && data.members && data.members.length > 0) {
                        const member = data.members[0];
                        const realMemberId = member.prospect_id || member.guid || member.id;
                        window.location.href = `/member/${realMemberId}`;
                        return;
                    }

                    // This should never happen - if they sent a message, they must exist
                    console.error(`CRITICAL: Person ${personName} sent message but not found in database!`);
                    alert(`Error: ${personName} sent a message but was not found in the system. This is a database issue.`);
                })
                .catch(error => {
                    console.error('CRITICAL: Search API completely failed:', error);
                    alert(`System error: Unable to search for ${personName}. Please check your connection.`);
                });
        }
        
        // REMOVED: openMemberProfileModal function - now redirecting directly to member account pages
        
        // REMOVED: openMemberProfileModal function - now redirecting directly to member account pages
        
        function viewAllConversations() {
            debugLog('📋 Viewing all conversations...');
            // Could implement a dedicated conversations page in the future
            alert('All conversations view - Coming soon!\nFor now, click on individual conversations to view them on the member page.');
        }
        
        // Load member profile data for modal
        function loadMemberProfile(memberId, memberName) {
            debugLog('👤 Loading member profile data for:', memberId, memberName);
            
            // Clear previous data
            document.getElementById('member-full-name').textContent = memberName;
            document.getElementById('member-phone').textContent = '-';
            document.getElementById('member-email').textContent = '-';
            document.getElementById('member-status').textContent = '-';
            document.getElementById('member-since').textContent = '-';
            document.getElementById('member-last-checkin').textContent = '-';
            
            // Reset messages tab
            document.getElementById('member-messages-loading').classList.remove('d-none');
            document.getElementById('member-messages-content').classList.add('d-none');
            document.getElementById('member-messages-empty').classList.add('d-none');
            
            // Load member details
            fetch(`/api/members/${memberId}`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.member) {
                    const member = data.member;
                    document.getElementById('member-full-name').textContent = member.full_name || memberName;
                    document.getElementById('member-phone').textContent = member.phone || '-';
                    document.getElementById('member-email').textContent = member.email || '-';
                    document.getElementById('member-status').textContent = member.status || '-';
                    document.getElementById('member-since').textContent = member.member_since || '-';
                    document.getElementById('member-last-checkin').textContent = member.last_checkin || '-';
                }
            })
            .catch(error => {
                debugLog('⚠️ Could not load member details:', error);
            });
            
            // Load message history
            loadMemberMessages(memberId);
        }

        // Load message history for member
        function loadMemberMessages(memberId) {
            debugLog('💬 Loading message history for member:', memberId);
            
            fetch(`/api/messaging/member/${memberId}/history`)
            .then(response => response.json())
            .then(data => {
                document.getElementById('member-messages-loading').classList.add('d-none');
                
                if (data.success && data.messages && data.messages.length > 0) {
                    displayMemberMessages(data.messages);
                    document.getElementById('messages-badge').textContent = data.messages.length;
                } else {
                    document.getElementById('member-messages-empty').classList.remove('d-none');
                    document.getElementById('messages-badge').textContent = '0';
                }
            })
            .catch(error => {
                debugLog('❌ Error loading message history:', error);
                document.getElementById('member-messages-loading').classList.add('d-none');
                document.getElementById('member-messages-empty').classList.remove('d-none');
                document.getElementById('messages-badge').textContent = '0';
            });
        }

        // Display member messages in modal
        function displayMemberMessages(messages) {
            const container = document.querySelector('#member-messages-content .message-history');
            
            const messagesHtml = messages.map(msg => {
                const timestamp = new Date(msg.created_at).toLocaleString();
                const isIncoming = msg.direction === 'incoming';
                
                return `
                    <div class="message-item mb-3 ${isIncoming ? 'incoming' : 'outgoing'}">
                        <div class="d-flex ${isIncoming ? 'justify-content-start' : 'justify-content-end'}">
                            <div class="message-bubble ${isIncoming ? 'bg-light' : 'bg-primary text-white'}" style="max-width: 75%; padding: 8px 12px; border-radius: 12px;">
                                <div class="message-content">${msg.message_content || 'No content'}</div>
                                <div class="message-time small text-muted mt-1" style="font-size: 0.7rem;">
                                    ${timestamp}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = messagesHtml;
            document.getElementById('member-messages-content').classList.remove('d-none');
            
            // Scroll to bottom
            container.scrollTop = container.scrollHeight;
        }
        
        // Utility functions for messaging inbox
        function formatTimeAgo(dateString) {
            if (!dateString) return 'Unknown';
            
            const now = new Date();
            const date = new Date(dateString);
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins}m ago`;
            if (diffHours < 24) return `${diffHours}h ago`;
            if (diffDays < 7) return `${diffDays}d ago`;
            return date.toLocaleDateString();
        }
        
        function truncateText(text, maxLength) {
            if (!text) return '';
            if (text.length <= maxLength) return text;
            return text.substring(0, maxLength) + '...';
        }
        
        function debugLog(...args) {
            console.log('🔍 [Messaging]', ...args);
        }

        // Bootstrap tabs initialization (moved to main DOMContentLoaded)
        function initializeBootstrapTabs() {
            var triggerTabList = [].slice.call(document.querySelectorAll('#statusTabs button'));
            triggerTabList.forEach(function (triggerEl) {
                var tabTrigger = new bootstrap.Tab(triggerEl);
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault();
                    tabTrigger.show();
                });
            });
        }

        function loadStatusCampaigns() {
            debugLog('🔄 Loading status campaigns...');
            
            // Load data for all status categories including training clients using correct endpoints
            Promise.all([
                fetch('/api/prospects/all')
                    .then(r => {
                        debugLog('📞 Prospects API response status:', r.status);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .catch(e => {
                        debugError('❌ Prospects API error:', e.message);
                        return { success: false, error: e.message, source: 'prospects' };
                    }),
                fetch('/api/members/all')
                    .then(r => {
                        debugLog('📞 Members API response status:', r.status);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .catch(e => {
                        debugError('❌ Members API error:', e.message);
                        return { success: false, error: e.message, source: 'members' };
                    }),
                fetch('/api/training/clients')
                    .then(r => {
                        debugLog('📞 Training API response status:', r.status);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .catch(e => {
                        debugError('❌ Training API error:', e.message);
                        return { success: false, error: e.message, source: 'training' };
                    })
            ])
            .then(([prospectsData, membersData, trainingData]) => {
                debugLog('📊 API Responses received:', { 
                    prospects: prospectsData.success ? 'SUCCESS' : `FAILED: ${prospectsData.error}`,
                    members: membersData.success ? 'SUCCESS' : `FAILED: ${membersData.error}`,
                    training: trainingData.success ? 'SUCCESS' : `FAILED: ${trainingData.error}`
                });
                
                // Extract data with better error handling
                const prospects = prospectsData.success ? (prospectsData.prospects || prospectsData.data || []) : [];
                const allMembers = membersData.success ? (membersData.members || membersData.data || []) : [];
                const trainingClients = trainingData.success ? (trainingData.training_clients || trainingData.clients || trainingData.data || []) : [];
                
                debugLog('📈 Processed data counts:', { 
                    prospects: prospects.length, 
                    members: allMembers.length, 
                    trainingClients: trainingClients.length 
                });
                
                // Log sample data for debugging
                if (allMembers.length > 0) {
                    debugLog('👤 Sample member data:', {
                        first: allMembers[0],
                        status_messages: allMembers.slice(0, 5).map(m => m.status_message).filter(Boolean)
                    });
                }
                
                // Categorize members by status_message patterns
                categorizeSpecificMembers(allMembers, trainingClients, prospects);
                
                debugLog('✅ Status campaigns loaded and categorized successfully');
            })
            .catch(error => {
                debugError('❌ Critical error in loadStatusCampaigns:', error);
                showStatusError('Failed to load campaign data. Please try refreshing the page.');
            });
        }

        function categorizeSpecificMembers(allMembers, trainingClients, prospects) {
            debugLog('🏷️ Starting member categorization...');
            
            // Initialize all categories
            const categories = {
                'good-standing': [],
                'pay-per-visit': [],
                'past-due-6-30': [],
                'past-due-30': [],
                'past-due-training': [],
                'expiring-soon': [],
                'prospects': [],
                'other-statuses': []
            };
            
            // Process regular members by status_message
            allMembers.forEach(member => {
                const statusMsg = (member.status_message || '').toLowerCase();
                
                if (statusMsg.includes('good standing') || statusMsg.includes('active')) {
                    categories['good-standing'].push(member);
                } else if (statusMsg.includes('pay per visit')) {
                    categories['pay-per-visit'].push(member);
                } else if (statusMsg.includes('past due 6-30') || statusMsg.includes('past due 6 to 30')) {
                    categories['past-due-6-30'].push(member);
                } else if (statusMsg.includes('past due more than 30') || statusMsg.includes('past due 30+')) {
                    categories['past-due-30'].push(member);
                } else if (statusMsg.includes('expire') || statusMsg.includes('expiring') || statusMsg.includes('expires')) {
                    categories['expiring-soon'].push(member);
                } else if (statusMsg && statusMsg !== 'null' && statusMsg !== '') {
                    categories['other-statuses'].push(member);
                }
            });
            
            // Add past due training clients to their special category
            if (trainingClients && trainingClients.length > 0) {
                const pastDueTrainingClients = trainingClients.filter(client => {
                    const amountPastDue = parseFloat(client.past_due_amount || 0);
                    const paymentStatus = (client.payment_status || '').toLowerCase();
                    const statusMsg = (client.status_message || '').toLowerCase();
                    return amountPastDue > 0 || paymentStatus.includes('past due') || statusMsg.includes('past due');
                });
                categories['past-due-training'] = pastDueTrainingClients;
            }
            
            // Add prospects to their category
            if (prospects && prospects.length > 0) {
                categories['prospects'] = prospects;
                debugLog('💰 Added prospects to categories:', prospects.length);
            }
            
            debugLog('📋 Categorization results:', {
                'good-standing': categories['good-standing'].length,
                'pay-per-visit': categories['pay-per-visit'].length,
                'past-due-6-30': categories['past-due-6-30'].length,
                'past-due-30': categories['past-due-30'].length,
                'past-due-training': categories['past-due-training'].length,
                'expiring-soon': categories['expiring-soon'].length,
                'prospects': categories['prospects'].length,
                'other-statuses': categories['other-statuses'].length
            });
            
            // Update tab badges with counts
            Object.keys(categories).forEach(categoryKey => {
                const count = categories[categoryKey].length;
                const badge = document.getElementById(`${categoryKey}-count`);
                if (badge) {
                    badge.textContent = count;
                    badge.className = `badge rounded-pill mt-1 ${getBadgeClass(categoryKey, count)}`;
                }
            });
            
            // Generate content for each category
            Object.keys(categories).forEach(categoryKey => {
                generateCategoryContent(categoryKey, categories[categoryKey]);
            });
        }

        function getBadgeClass(category, count) {
            if (count === 0) return 'bg-secondary';
            
            switch(category) {
                case 'good-standing': return 'bg-success';
                case 'pay-per-visit': return 'bg-info';
                case 'past-due-6-30': return 'bg-warning text-dark';
                case 'past-due-30': case 'past-due-training': return 'bg-danger';
                case 'expiring-soon': return 'bg-warning text-dark';
                case 'prospects': return 'bg-primary';
                default: return 'bg-secondary';
            }
        }

        function generateCategoryContent(categoryKey, members) {
            const contentDiv = document.getElementById(`${categoryKey}-content`);
            if (!contentDiv) return;
            
            if (members.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">No members in this category</h6>
                        <p class="text-muted small">This category will populate when members match the criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Generate campaign interface for this category
            const categoryTitle = getCategoryTitle(categoryKey);
            const memberPreview = members.slice(0, 10).map(member => `
                <div class="member-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${member.full_name || `${member.firstName || ''} ${member.lastName || ''}`.trim()}</strong>
                            <div class="small text-muted">${member.email || member.mobile_phone || 'No contact info'}</div>
                            ${member.status_message ? `<div class="small text-info">${member.status_message}</div>` : ''}
                            ${member.past_due_amount && parseFloat(member.past_due_amount) > 0 ? 
                                `<div class="small text-danger">Past Due: $${parseFloat(member.past_due_amount).toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            contentDiv.innerHTML = `
                <div class="campaign-action-panel">
                    <div class="campaign-controls">
                        <div class="row g-4">
                            <div class="col-md-7">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-bullhorn me-2 text-primary"></i>
                                    ${categoryTitle} Campaign
                                </h6>
                                <p class="text-muted mb-3">
                                    Create a targeted campaign for ${members.length} member${members.length !== 1 ? 's' : ''} in this category.
                                </p>
                                <button class="btn btn-fluent-primary" onclick="openStatusCampaignModal('${categoryKey}', '${categoryTitle}', ${members.length})">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Create Campaign (${members.length} recipients)
                                </button>
                            </div>
                            <div class="col-md-5">
                                <h6 class="fw-bold mb-3">Member Preview</h6>
                                <div class="member-preview">
                                    ${memberPreview}
                                    ${members.length > 10 ? `
                                        <div class="text-center py-2 border-top">
                                            <small class="text-muted">... and ${members.length - 10} more members</small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryTitle(categoryKey) {
            const titles = {
                'good-standing': 'Good Standing Members',
                'pay-per-visit': 'Pay Per Visit Members',
                'past-due-6-30': 'Past Due 6-30 Days',
                'past-due-30': 'Past Due 30+ Days',
                'past-due-training': 'Past Due Training Clients',
                'expiring-soon': 'Expiring Soon',
                'prospects': 'Prospects',
                'other-statuses': 'Other Status Members'
            };
            return titles[categoryKey] || categoryKey;
        }

        // Global variables for campaign management
        let currentCampaignData = null;
        let campaignProgressInterval = null;
        let currentCategory = null;

        function openCampaignModal(categoryKey) {
            debugLog('📝 Opening enhanced campaign modal for:', categoryKey);
            currentCategory = categoryKey;
            
            // Set modal title
            const categoryTitles = {
                'good_standing': 'Good Standing Members',
                'pay_per_visit': 'Pay Per Visit Members', 
                'past_due_6_30': 'Past Due 6-30 Days',
                'past_due_30_plus': 'Past Due 30+ Days',
                'past_due_training': 'PT Past Due Members',
                'expiring_soon': 'Expiring Soon Members',
                'prospects': 'Prospects',
                'other_statuses': 'Other Status Members'
            };
            
            const categoryTitle = categoryTitles[categoryKey] || categoryKey;
            document.getElementById('modalCategoryTitle').textContent = `${categoryTitle} Campaign Manager`;
            document.getElementById('modalCategoryValue').value = categoryKey;
            
            // Load campaign status and member data
            loadCampaignStatus(categoryKey);
            loadCategoryMembers(categoryKey);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('categoryCampaignModal'));
            modal.show();
        }

        function loadCampaignStatus(categoryKey) {
            debugLog('📊 Loading campaign status for:', categoryKey);
            
            // Check if there's an existing campaign for this category
            fetch(`/api/campaigns/status/${categoryKey}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.campaign) {
                        currentCampaignData = data.campaign;
                        displayCampaignStatus(data.campaign);
                        
                        // Start progress tracking if campaign is active
                        if (data.campaign.status === 'running') {
                            startProgressTracking();
                        }
                    } else {
                        // No existing campaign
                        displayNoCampaignStatus();
                    }
                })
                .catch(error => {
                    debugLog('Campaign status API not available:', error.message);
                    displayNoCampaignStatus();
                });
        }

        function displayCampaignStatus(campaign) {
            const statusSection = document.getElementById('campaignStatusSection');
            const progressSection = document.getElementById('campaignProgressSection');
            const continueBtn = document.getElementById('continueCampaignBtn');
            
            if (campaign.status === 'running') {
                // Show active campaign
                statusSection.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-play me-2"></i>
                        <strong>Campaign Active:</strong> "${campaign.name}" is currently running
                        <div class="mt-2">
                            <small class="text-muted">Started: ${formatDateTime(campaign.started_at)}</small>
                        </div>
                    </div>
                `;
                
                // Show progress section
                progressSection.style.display = 'block';
                updateProgressDisplay(campaign.progress);
                
            } else if (campaign.status === 'paused') {
                // Show paused campaign
                statusSection.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-pause me-2"></i>
                        <strong>Campaign Paused:</strong> "${campaign.name}" 
                        <div class="mt-2">
                            <small class="text-muted">Progress: ${campaign.sent_count}/${campaign.total_count} sent</small>
                        </div>
                    </div>
                `;
                
                continueBtn.style.display = 'inline-block';
                progressSection.style.display = 'block';
                updateProgressDisplay(campaign.progress);
                
            } else if (campaign.status === 'completed') {
                // Show completed campaign
                statusSection.innerHTML = `
                    <div class="alert alert-success">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>Campaign Completed:</strong> "${campaign.name}"
                        <div class="mt-2">
                            <small class="text-muted">
                                Completed: ${formatDateTime(campaign.completed_at)} • 
                                ${campaign.sent_count} messages sent • 
                                ${campaign.delivered_count} delivered
                            </small>
                        </div>
                    </div>
                `;
                
                progressSection.style.display = 'none';
            }
        }

        function displayNoCampaignStatus() {
            const statusSection = document.getElementById('campaignStatusSection');
            const progressSection = document.getElementById('campaignProgressSection');
            const continueBtn = document.getElementById('continueCampaignBtn');
            
            statusSection.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Ready to start:</strong> No active campaign for this category
                </div>
            `;
            
            progressSection.style.display = 'none';
            continueBtn.style.display = 'none';
        }

        function loadCategoryMembers(categoryKey) {
            debugLog('👥 Loading members for category:', categoryKey);
            
            const memberPreview = document.getElementById('memberPreviewList');
            const totalCountBadge = document.getElementById('totalMemberCount');
            const remainingCountBadge = document.getElementById('remainingMemberCount');
            
            // Show loading
            memberPreview.innerHTML = `
                <div class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-2">Loading members...</p>
                </div>
            `;
            
            // Get members for this category
            const endpoint = categoryKey === 'prospects' ? '/api/prospects/all' : '/api/members/all';
            
            fetch(endpoint)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const allMembers = data.members || data.prospects || data.data || [];
                        const categoryMembers = filterMembersByCategory(allMembers, categoryKey);
                        
                        displayMemberPreview(categoryMembers);
                        updateMemberCounts(categoryMembers.length, categoryMembers.length);
                    } else {
                        memberPreview.innerHTML = `
                            <div class="text-center py-4 text-danger">
                                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                                <p>Error loading members</p>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    debugError('Error loading category members:', error);
                    memberPreview.innerHTML = `
                        <div class="text-center py-4 text-danger">
                            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                            <p>Network error loading members</p>
                        </div>
                    `;
                });
        }

        function filterMembersByCategory(members, categoryKey) {
            return members.filter(member => {
                const statusMsg = (member.status_message || '').toLowerCase();
                
                switch(categoryKey) {
                    case 'good_standing':
                        return statusMsg.includes('good standing') || statusMsg.includes('active');
                    case 'pay_per_visit':
                        return statusMsg.includes('pay per visit');
                    case 'past_due_6_30':
                        return statusMsg.includes('past due 6-30') || statusMsg.includes('past due 6 to 30');
                    case 'past_due_30_plus':
                        return statusMsg.includes('past due more than 30') || statusMsg.includes('past due 30+');
                    case 'past_due_training':
                        return parseFloat(member.past_due_amount || 0) > 0 && member.member_type === 'training';
                    case 'expiring_soon':
                        return statusMsg.includes('expire') || statusMsg.includes('expiring');
                    case 'prospects':
                        return true; // All prospects
                    case 'other_statuses':
                        return statusMsg && !statusMsg.includes('good standing') && !statusMsg.includes('pay per visit') && !statusMsg.includes('past due');
                    default:
                        return false;
                }
            });
        }

        function displayMemberPreview(members) {
            const memberPreview = document.getElementById('memberPreviewList');
            
            if (members.length === 0) {
                memberPreview.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-2"></i>
                        <p class="text-muted">No members in this category</p>
                    </div>
                `;
                return;
            }
            
            // ADDED: Select All checkbox header
            const selectAllHeader = `
                <div class="border-bottom pb-2 mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="selectAllMembers" onchange="toggleSelectAll(this)">
                        <label class="form-check-label fw-bold" for="selectAllMembers">
                            <i class="fas fa-check-square me-1"></i>
                            Select All (${members.length} members)
                        </label>
                    </div>
                </div>
            `;
            
            // ADDED: Checkbox for each member
            const membersHtml = members.map((member, index) => `
                <div class="member-item border-bottom pb-2 mb-2">
                    <div class="d-flex align-items-start">
                        <div class="form-check me-2 mt-1">
                            <input class="form-check-input member-checkbox" type="checkbox" 
                                   id="member-${index}" 
                                   data-member-id="${member.prospect_id || member.id}" 
                                   data-member-name="${member.full_name || `${member.firstName || ''} ${member.lastName || ''}`.trim()}"
                                   data-member-email="${member.email || ''}"
                                   data-member-phone="${member.mobile_phone || member.phone || ''}"
                                   onchange="updateSelectionCount()">
                        </div>
                        <label class="flex-grow-1" for="member-${index}" style="cursor: pointer;">
                            <div class="fw-medium">${member.full_name || `${member.firstName || ''} ${member.lastName || ''}`.trim()}</div>
                            <div class="small text-muted">${member.email || member.mobile_phone || 'No contact'}</div>
                            ${member.status_message ? `<div class="small text-info">${member.status_message}</div>` : ''}
                            ${member.past_due_amount && parseFloat(member.past_due_amount) > 0 ? 
                                `<div class="small text-danger">Past Due: $${parseFloat(member.past_due_amount).toFixed(2)}</div>` : ''}
                        </label>
                    </div>
                </div>
            `).join('');
            
            // ADDED: Selection counter
            const selectionCounter = `
                <div class="alert alert-success mt-3" id="selectionCounterAlert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong id="selectedCount">0</strong> of <strong>${members.length}</strong> members selected
                </div>
            `;
            
            memberPreview.innerHTML = selectAllHeader + membersHtml + selectionCounter;
            
            // Store members data for campaign launch
            window.currentCategoryMembers = members;
        }

        function updateMemberCounts(total, remaining) {
            document.getElementById('totalMemberCount').textContent = total;
            document.getElementById('remainingMemberCount').textContent = remaining;
        }

        // ADDED: Toggle Select All functionality
        function toggleSelectAll(checkbox) {
            const memberCheckboxes = document.querySelectorAll('.member-checkbox');
            memberCheckboxes.forEach(cb => {
                cb.checked = checkbox.checked;
            });
            updateSelectionCount();
            debugLog(`🔘 Select All ${checkbox.checked ? 'checked' : 'unchecked'}: ${memberCheckboxes.length} members`);
        }

        // ADDED: Update selection count display
        function updateSelectionCount() {
            const checkedBoxes = document.querySelectorAll('.member-checkbox:checked');
            const selectedCountElement = document.getElementById('selectedCount');
            if (selectedCountElement) {
                selectedCountElement.textContent = checkedBoxes.length;
            }
            
            // Update Select All checkbox state
            const selectAllCheckbox = document.getElementById('selectAllMembers');
            const allCheckboxes = document.querySelectorAll('.member-checkbox');
            if (selectAllCheckbox && allCheckboxes.length > 0) {
                selectAllCheckbox.checked = checkedBoxes.length === allCheckboxes.length;
                selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
            }
            
            debugLog(`✅ Selection updated: ${checkedBoxes.length} members selected`);
        }

        // Campaign Control Functions
        function showCampaignEditor(mode) {
            debugLog('📝 Showing campaign editor in mode:', mode);
            
            const editor = document.getElementById('campaignEditor');
            const modeInput = document.getElementById('editorMode');
            
            editor.style.display = 'block';
            modeInput.value = mode;
            
            if (mode === 'template') {
                // Pre-fill with category-appropriate template
                loadCategoryTemplate(currentCategory);
                document.getElementById('campaignTemplate').focus();
            } else if (mode === 'fresh') {
                // Clear form for fresh start
                document.getElementById('categoryCampaignForm').reset();
                document.getElementById('maxRecipients').value = 999999;  // Unlimited
                document.getElementById('campaignName').focus();
            }
        }

        function loadCategoryTemplate(categoryKey) {
            const templates = {
                'good_standing': {
                    name: 'Good Standing Check-in',
                    message: 'Hi {first_name}! We hope you\'re enjoying your membership at Anytime Fitness. Is there anything we can do to help you reach your fitness goals?'
                },
                'pay_per_visit': {
                    name: 'Pay Per Visit Promotion',
                    message: 'Hi {first_name}! Ready to take your fitness to the next level? Ask us about our membership options to save on your visits!'
                },
                'past_due_6_30': {
                    name: 'Payment Reminder - Gentle',
                    message: 'Hi {first_name}, this is a friendly reminder that your membership payment is past due. Please update your payment method at your convenience.'
                },
                'past_due_30_plus': {
                    name: 'Payment Reminder - Urgent',
                    message: 'Hi {first_name}, your membership payment is significantly overdue. Please contact us immediately to resolve this and avoid service interruption.'
                },
                'past_due_training': {
                    name: 'PT Payment Reminder',
                    message: 'Hi {first_name}, your personal training account has an outstanding balance. Please contact us to discuss payment options.'
                },
                'expiring_soon': {
                    name: 'Membership Renewal',
                    message: 'Hi {first_name}, your membership expires soon. Contact us to renew and keep working toward your fitness goals!'
                },
                'prospects': {
                    name: 'Prospect Follow-up',
                    message: 'Hi {first_name}! Ready to start your fitness journey with Anytime Fitness? We\'d love to help you get started with a great membership deal!'
                }
            };
            
            const template = templates[categoryKey];
            if (template) {
                document.getElementById('campaignName').value = template.name;
                document.getElementById('campaignMessage').value = template.message;
            }
        }

        function loadCampaignTemplate() {
            const templateSelect = document.getElementById('campaignTemplate');
            const selected = templateSelect.value;
            
            if (!selected) return;
            
            const templates = {
                'welcome': {
                    message: 'Welcome to Anytime Fitness, {first_name}! We\'re excited to have you as part of our fitness family. If you need help getting started, our team is here for you!'
                },
                'payment_reminder': {
                    message: 'Hi {first_name}, this is a friendly reminder that your membership payment is due. Please update your payment method or contact us for assistance.'
                },
                'check_in': {
                    message: 'Hey {first_name}! We noticed you haven\'t been in lately. Your fitness goals are waiting - come back and let\'s crush them together!'
                },
                'promotion': {
                    message: 'Exciting news, {first_name}! We have a special promotion just for our valued members. Limited time offer - contact us for details!'
                },
                'followup': {
                    message: 'Hi {first_name}, how has your fitness journey been going? We\'d love to hear about your progress and see how we can help you reach your goals!'
                }
            };
            
            const template = templates[selected];
            if (template) {
                document.getElementById('campaignMessage').value = template.message;
            }
        }

        function continueCampaign() {
            debugLog('▶️ Continuing existing campaign for:', currentCategory);
            
            if (!currentCampaignData) {
                showAlert('error', 'No campaign data available to continue');
                return;
            }
            
            // Resume the paused campaign
            const continueBtn = document.getElementById('continueCampaignBtn');
            continueBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Resuming...';
            continueBtn.disabled = true;
            
            fetch(`/api/campaigns/${currentCampaignData.id}/resume`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'Campaign resumed successfully!');
                    
                    // Update status display
                    currentCampaignData.status = 'running';
                    displayCampaignStatus(currentCampaignData);
                    
                    // Start progress tracking
                    startProgressTracking();
                } else {
                    showAlert('error', data.error || 'Failed to resume campaign');
                }
            })
            .catch(error => {
                debugError('Error resuming campaign:', error);
                showAlert('error', 'Network error resuming campaign');
            })
            .finally(() => {
                continueBtn.innerHTML = '<i class="fas fa-play me-2"></i>Continue from Where Left Off';
                continueBtn.disabled = false;
            });
        }

        function launchCampaign() {
            debugLog('🚀 Launching new campaign for:', currentCategory);
            
            const form = document.getElementById('categoryCampaignForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get form data
            const formData = {
                category: currentCategory,
                name: document.getElementById('campaignName').value,
                message: document.getElementById('campaignMessage').value,
                type: document.getElementById('messageType').value,
                subject: document.getElementById('emailSubject').value || '',
                max_recipients: parseInt(document.getElementById('maxRecipients').value),
                notes: document.getElementById('campaignNotes').value || '',
                save_as_template: document.getElementById('saveAsTemplate').checked,
                mode: document.getElementById('editorMode').value
            };
            
            // Update button state
            const launchBtn = document.getElementById('launchCampaignBtn');
            launchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Launching...';
            launchBtn.disabled = true;
            
            // Send campaign
            fetch('/api/campaigns/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', `Campaign "${formData.name}" launched successfully!`);
                    
                    // Update current campaign data
                    currentCampaignData = {
                        id: data.campaign_id,
                        name: formData.name,
                        category: formData.category,
                        status: 'running',
                        started_at: new Date().toISOString(),
                        total_count: data.total_recipients || 0,
                        sent_count: 0,
                        delivered_count: 0,
                        progress: {
                            percentage: 0,
                            sent: 0,
                            total: data.total_recipients || 0
                        }
                    };
                    
                    // Update display
                    displayCampaignStatus(currentCampaignData);
                    startProgressTracking();
                    
                    // Hide editor
                    document.getElementById('campaignEditor').style.display = 'none';
                    
                    // Update card progress on main page
                    updateCardProgress(currentCategory, 0, 'Starting...');
                    
                } else {
                    showAlert('error', data.error || 'Failed to launch campaign');
                }
            })
            .catch(error => {
                debugError('Error launching campaign:', error);
                showAlert('error', 'Network error launching campaign');
            })
            .finally(() => {
                launchBtn.innerHTML = '<i class="fas fa-rocket me-2"></i>Launch Campaign';
                launchBtn.disabled = false;
            });
        }

        function pauseCampaign() {
            debugLog('⏸️ Pausing campaign');
            
            if (!currentCampaignData) return;
            
            fetch(`/api/campaigns/${currentCampaignData.id}/pause`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentCampaignData.status = 'paused';
                    displayCampaignStatus(currentCampaignData);
                    stopProgressTracking();
                    showAlert('success', 'Campaign paused');
                }
            })
            .catch(error => {
                debugError('Error pausing campaign:', error);
            });
        }

        function resumeCampaign() {
            debugLog('▶️ Resuming campaign');
            continueCampaign();
        }

        function stopCampaign() {
            if (!confirm('Are you sure you want to stop this campaign? This action cannot be undone.')) {
                return;
            }
            
            debugLog('⏹️ Stopping campaign');
            
            if (!currentCampaignData) return;
            
            fetch(`/api/campaigns/${currentCampaignData.id}/stop`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentCampaignData.status = 'stopped';
                    displayCampaignStatus(currentCampaignData);
                    stopProgressTracking();
                    showAlert('warning', 'Campaign stopped');
                }
            })
            .catch(error => {
                debugError('Error stopping campaign:', error);
            });
        }

        // Progress Tracking Functions
        function startProgressTracking() {
            debugLog('📊 Starting progress tracking');
            
            if (campaignProgressInterval) {
                clearInterval(campaignProgressInterval);
            }
            
            campaignProgressInterval = setInterval(() => {
                updateCampaignProgress();
            }, 2000); // Update every 2 seconds
            
            // Initial update
            updateCampaignProgress();
        }

        function stopProgressTracking() {
            debugLog('⏹️ Stopping progress tracking');
            
            if (campaignProgressInterval) {
                clearInterval(campaignProgressInterval);
                campaignProgressInterval = null;
            }
        }

        function updateCampaignProgress() {
            if (!currentCampaignData || !currentCampaignData.id) return;
            
            fetch(`/api/campaigns/${currentCampaignData.id}/progress`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Update local campaign data
                        currentCampaignData.progress = data.progress;
                        currentCampaignData.sent_count = data.progress.sent;
                        currentCampaignData.delivered_count = data.progress.delivered;
                        
                        // Update progress display
                        updateProgressDisplay(data.progress);
                        
                        // Update card progress on main page
                        updateCardProgress(currentCategory, data.progress.percentage, 
                            `${data.progress.sent}/${data.progress.total} sent`);
                        
                        // Check if campaign is complete
                        if (data.progress.percentage >= 100 || data.campaign_status === 'completed') {
                            currentCampaignData.status = 'completed';
                            currentCampaignData.completed_at = new Date().toISOString();
                            stopProgressTracking();
                            displayCampaignStatus(currentCampaignData);
                            showAlert('success', 'Campaign completed successfully!');
                        }
                    }
                })
                .catch(error => {
                    debugLog('Progress update error (expected during development):', error.message);
                });
        }

        function updateProgressDisplay(progress) {
            const progressBar = document.getElementById('campaignProgressBar');
            const progressText = document.getElementById('campaignProgressText');
            const progressCount = document.getElementById('campaignProgressCount');
            const progressBadge = document.getElementById('campaignProgressBadge');
            
            if (progressBar) {
                progressBar.style.width = `${progress.percentage || 0}%`;
            }
            
            if (progressText) {
                const status = progress.percentage >= 100 ? 'Complete' : 'Sending messages...';
                progressText.textContent = status;
            }
            
            if (progressCount) {
                progressCount.textContent = `${progress.sent || 0} / ${progress.total || 0} sent`;
            }
            
            if (progressBadge) {
                if (progress.percentage >= 100) {
                    progressBadge.textContent = 'Completed';
                    progressBadge.className = 'badge bg-success';
                } else {
                    progressBadge.textContent = 'In Progress';
                    progressBadge.className = 'badge bg-primary';
                }
            }
        }

        function updateCardProgress(categoryKey, percentage, text) {
            const progressBar = document.getElementById(`${categoryKey}-progress-bar`);
            const progressBadge = document.getElementById(`${categoryKey}-progress-badge`);
            const progressText = document.getElementById(`${categoryKey}-progress-text`);
            
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
            }
            
            if (progressBadge) {
                if (percentage >= 100) {
                    progressBadge.textContent = 'Completed';
                    progressBadge.className = 'badge bg-success';
                } else if (percentage > 0) {
                    progressBadge.textContent = 'In Progress';
                    progressBadge.className = 'badge bg-primary';
                } else {
                    progressBadge.textContent = 'Not Started';
                    progressBadge.className = 'badge bg-secondary';
                }
            }
            
            if (progressText) {
                progressText.textContent = text || 'Ready to start campaign';
            }
        }

        function previewCampaign() {
            const name = document.getElementById('campaignName').value || 'Untitled Campaign';
            const message = document.getElementById('campaignMessage').value || '';
            const maxRecipients = document.getElementById('maxRecipients').value || 'Unlimited';
            
            if (!message.trim()) {
                showAlert('error', 'Please enter a message to preview');
                return;
            }
            
            // Show preview with variable substitution example
            const previewMessage = message
                .replace(/{name}/g, 'John Doe')
                .replace(/{first_name}/g, 'John')
                .replace(/{email}/g, 'john.doe@example.com')
                .replace(/{phone}/g, '(555) 123-4567');
            
            const preview = `Campaign Preview:

Campaign: ${name}
Category: ${getCategoryTitle(currentCategory)}
Recipients: ${maxRecipients === '999999' ? 'Unlimited' : maxRecipients}

Sample Message:
"${previewMessage}"

Note: Variables like {first_name} will be automatically replaced with actual member data when sent.`;
            
            alert(preview);
        }

        function getCategoryTitle(categoryKey) {
            const titles = {
                'good_standing': 'Good Standing Members',
                'pay_per_visit': 'Pay Per Visit Members',
                'past_due_6_30': 'Past Due 6-30 Days',
                'past_due_30_plus': 'Past Due 30+ Days',
                'past_due_training': 'PT Past Due Members',
                'expiring_soon': 'Expiring Soon Members',
                'prospects': 'Prospects',
                'other_statuses': 'Other Status Members'
            };
            return titles[categoryKey] || categoryKey;
        }

        function formatDateTime(dateString) {
            if (!dateString) return 'Unknown';
            try {
                return new Date(dateString).toLocaleString();
            } catch {
                return dateString;
            }
        }

        // Message Type Handler for email subject field
        document.addEventListener('change', function(event) {
            if (event.target && event.target.id === 'messageType') {
                const emailSubjectDiv = document.getElementById('emailSubjectDiv');
                if (event.target.value === 'email') {
                    emailSubjectDiv.style.display = 'block';
                    document.getElementById('emailSubject').required = true;
                } else {
                    emailSubjectDiv.style.display = 'none';
                    document.getElementById('emailSubject').required = false;
                }
            }
        });

        function showStatusError(message) {
            debugError('🚨 Status error:', message);
            
            // Show error in all tab contents
            ['good-standing', 'pay-per-visit', 'past-due-6-30', 'past-due-30', 'past-due-training', 'expiring-soon', 'other-statuses'].forEach(categoryKey => {
                const contentDiv = document.getElementById(`${categoryKey}-content`);
                if (contentDiv) {
                    contentDiv.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                            <h6 class="text-warning">Unable to Load Campaign Data</h6>
                            <p class="text-muted small">${message}</p>
                            <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadStatusCampaigns()">
                                <i class="fas fa-retry me-1"></i> Try Again
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Message Type Handler
        document.addEventListener('change', function(event) {
            if (event.target && event.target.id === 'statusMessageType') {
                const emailSubjectDiv = document.getElementById('statusEmailSubjectDiv');
                if (event.target.value === 'email') {
                    emailSubjectDiv.style.display = 'block';
                    document.getElementById('statusEmailSubject').required = true;
                } else {
                    emailSubjectDiv.style.display = 'none';
                    document.getElementById('statusEmailSubject').required = false;
                }
            }
        });

        // Placeholder functions for message inbox and campaign progress
        function loadInbox() {
            debugLog('📨 Loading message inbox...');
            // Placeholder implementation
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Message Inbox</h6>
                        <p class="text-muted small">Inbox functionality will be implemented soon.</p>
                    </div>
                `;
            }
        }

        function loadCampaignProgress() {
            debugLog('📊 Loading campaign progress...');
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                fetch('/api/campaigns/progress')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.campaigns && data.campaigns.length > 0) {
                            displayCampaignProgress(data.campaigns);
                        } else {
                            progressContainer.innerHTML = `
                                <div class="text-center py-4">
                                    <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                                    <h6 class="text-muted">No active campaigns</h6>
                                    <p class="text-muted small">Campaign progress will appear here after sending.</p>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        debugLog('Campaign progress API not available, showing placeholder:', error.message);
                        progressContainer.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                                <h6 class="text-muted">Campaign Progress</h6>
                                <p class="text-muted small">Progress tracking will be available after implementing campaign API.</p>
                            </div>
                        `;
                    });
            }
        }

        function displayCampaignProgress(campaigns) {
            const progressContainer = document.getElementById('progressContainer');
            const progressHtml = campaigns.map(campaign => `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">${campaign.name}</h6>
                        <span class="badge ${campaign.status === 'completed' ? 'bg-success' : 'bg-primary'}">${campaign.status}</span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar" style="width: ${campaign.progress || 0}%"></div>
                    </div>
                    <small class="text-muted">${campaign.sent_count || 0} sent • ${campaign.delivered_count || 0} delivered</small>
                </div>
            `).join('');
            
            progressContainer.innerHTML = progressHtml;
        }

        async function syncMessages() {
            debugLog('🔄 Syncing messages from ClubOS...');

            // Show loading state
            showAlert('info', 'Syncing messages from ClubOS...');

            try {
                const response = await fetch('/api/messages/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        owner_id: window.currentOwnerId || 'default'
                    })
                });

                const data = await response.json();

                if (data.success || response.ok) {
                    const messageCount = data.stored_count || data.message_count || 'messages';
                    showAlert('success', `Successfully synced ${messageCount} messages from ClubOS!`);

                    // Refresh the messaging inbox to show new messages
                    if (typeof loadMessagingInbox === 'function') {
                        setTimeout(() => loadMessagingInbox(), 1000);
                    } else {
                        // Reload page if function not available
                        setTimeout(() => location.reload(), 1500);
                    }
                } else {
                    showAlert('danger', `Sync failed: ${data.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error syncing messages:', error);
                showAlert('danger', `Error syncing messages: ${error.message}`);
            }
        }

        function searchMessages() {
            const query = document.getElementById('messageSearch').value;
            debugLog('🔍 Searching messages for:', query);
            showAlert('info', 'Message search functionality will be implemented soon.');
        }

        function resetAllProgress() {
            if (confirm('Are you sure you want to reset all campaign progress? This action cannot be undone.')) {
                debugLog('🔄 Resetting all campaign progress...');
                showAlert('info', 'Progress reset functionality will be implemented soon.');
            }
        }

        // Helper function to show alerts
        function showAlert(type, message) {
            // Create alert element
            const alertId = 'campaign-alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <strong>${type === 'success' ? 'Success!' : 'Error:'}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Add to page
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Initialize page data when DOM is ready
        document.addEventListener('DOMContentLoaded', async function() {
            debugLog('Messaging page loaded - initializing data...');
            
            // Initialize Bootstrap tabs
            initializeBootstrapTabs();
            
            // CRITICAL FIX: Auto-sync from ClubOS on page load (Phase 1 requirement)
            debugLog('🔄 AUTO-SYNC: Fetching latest messages from ClubOS...');
            try {
                const syncResponse = await fetch('/api/messages/sync', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        owner_id: window.currentOwnerId || '187032782'
                    })
                });
                const syncData = await syncResponse.json();
                debugLog('✅ AUTO-SYNC complete:', syncData);
            } catch (error) {
                console.error('❌ AUTO-SYNC error:', error);
                // Continue even if sync fails
            }
            
            // Load messaging inbox (now with fresh data)
            loadMessagingInbox();
            
            // Load all sections (with graceful fallbacks for missing APIs)
            loadStatusCampaigns();
            loadInbox();
            loadCampaignProgress();
            loadSavedCampaigns();
            
            // CRITICAL FIX: Start background polling every 30 seconds (Phase 1 requirement)
            debugLog('⏰ Starting background message polling (30s interval)...');
            setInterval(async () => {
                debugLog('🔄 BACKGROUND POLL: Checking for new ClubOS messages...');
                try {
                    const pollResponse = await fetch('/api/messages/sync', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            owner_id: window.currentOwnerId || '187032782'
                        })
                    });
                    const pollData = await pollResponse.json();
                    
                    // If new messages found, auto-refresh inbox
                    if (pollData.stored_count && pollData.stored_count > 0) {
                        debugLog(`📬 NEW MESSAGES: ${pollData.stored_count} new messages received!`);
                        loadMessagingInbox(); // Refresh to show new messages
                        
                        // Optional: Show notification
                        if (window.Notification && Notification.permission === "granted") {
                            new Notification('New Messages', {
                                body: `You have ${pollData.stored_count} new messages`,
                                icon: '/static/images/logo.png'
                            });
                        }
                    }
                } catch (error) {
                    console.error('❌ Background poll error:', error);
                }
            }, 30000); // Poll every 30 seconds
            
            debugLog('All messaging data loaded with auto-sync and background polling active!');
        });

        // Campaign Template Functions
        function useCampaignTemplate(category) {
            debugLog(`🚀 Using campaign template: ${category}`);
            
            // Get template data based on category
            const templates = {
                welcome: {
                    name: 'Welcome New Members',
                    message: 'Welcome to Anytime Fitness! We\'re excited to have you as part of our fitness family. If you have any questions or need help getting started, don\'t hesitate to reach out to our team.',
                    target: 'new'
                },
                check_in: {
                    name: 'Check-in Reminder',
                    message: 'Hi! We noticed you haven\'t been in lately and wanted to check on you. Remember, your fitness goals are waiting for you at the gym. Come back and let\'s crush them together!',
                    target: 'inactive'
                },
                payment_due: {
                    name: 'Payment Reminder',
                    message: 'This is a friendly reminder that your membership payment is due. Please update your payment method or contact us to discuss your account. We\'re here to help!',
                    target: 'past_due'
                },
                promotion: {
                    name: 'Special Promotion',
                    message: 'Exciting news! We have a special promotion just for our valued members. Check out our latest offers and take advantage of exclusive deals. Limited time only!',
                    target: 'all'
                },
                followup: {
                    name: 'Member Follow-up',
                    message: 'How has your fitness journey been going? We\'d love to hear about your progress and see if there\'s anything we can do to help you reach your goals even faster.',
                    target: 'all'
                }
            };
            
            const template = templates[category];
            if (template) {
                // Populate the editor form
                document.getElementById('templateCampaignName').value = template.name;
                document.getElementById('templateCampaignMessage').value = template.message;
                document.getElementById('templateTargetGroup').value = template.target;
                
                showAlert('success', `Template "${template.name}" loaded successfully! Customize and launch when ready.`);
            }
        }

        function editCampaignTemplate(category) {
            debugLog(`✏️ Editing campaign template: ${category}`);
            useCampaignTemplate(category);
            // Focus on the message field for editing
            document.getElementById('templateCampaignMessage').focus();
        }

        function createCustomCampaign() {
            debugLog('➕ Creating new custom campaign');
            
            // Clear the editor form
            document.getElementById('templateCampaignName').value = '';
            document.getElementById('templateCampaignMessage').value = '';
            document.getElementById('templateTargetGroup').value = 'all';
            document.getElementById('templateMaxRecipients').value = 999999;  // Unlimited
            document.getElementById('saveAsNewTemplate').checked = false;
            
            // Focus on the name field
            document.getElementById('templateCampaignName').focus();
            
            showAlert('info', 'Ready to create your custom campaign! Fill out the form and launch when ready.');
        }

        function launchTemplateCampaign() {
            debugLog('🚀 Launching template campaign...');
            
            const name = document.getElementById('templateCampaignName').value.trim();
            const message = document.getElementById('templateCampaignMessage').value.trim();
            const targetGroup = document.getElementById('templateTargetGroup').value;
            const maxRecipients = parseInt(document.getElementById('templateMaxRecipients').value);
            const saveAsTemplate = document.getElementById('saveAsNewTemplate').checked;
            
            if (!name || !message) {
                showAlert('error', 'Please fill out campaign name and message before launching.');
                return;
            }
            
            // Map target groups to categories
            const categoryMapping = {
                'all': ['good_standing', 'pay_per_visit'],
                'new': ['good_standing'],
                'inactive': ['inactive'],
                'past_due': ['past_due'],
                'good_standing': ['good_standing'],
                'expiring_soon': ['expiring_soon']
            };
            
            const categories = categoryMapping[targetGroup] || [targetGroup];
            
            // Create campaign data using the existing API format
            const campaignData = {
                name: name,
                message: message,
                type: 'sms',
                categories: categories,
                max_recipients: maxRecipients,
                notes: `Template campaign: ${name}`,
                save_as_template: saveAsTemplate
            };
            
            debugLog('📤 Sending template campaign:', campaignData);
            
            // Show sending indicator
            const launchBtn = event.target;
            const originalText = launchBtn.innerHTML;
            launchBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Sending...';
            launchBtn.disabled = true;
            
            // Send campaign using existing API
            fetch('/api/campaigns/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(campaignData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', `✅ Campaign sent successfully! ${data.message}`);
                    
                    // Refresh campaign history to show the new campaign
                    setTimeout(() => {
                        loadCampaignHistory();
                    }, 1000);
                    
                    // Clear form if it was a new template
                    if (saveAsTemplate) {
                        document.getElementById('templateCampaignForm').reset();
                        document.getElementById('templateMaxRecipients').value = 999999;  // Unlimited
                    }
                } else {
                    showAlert('error', `❌ Campaign failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                debugError('❌ Error launching template campaign:', error);
                showAlert('error', `❌ Network error: ${error.message}`);
            })
            .finally(() => {
                // Restore button
                launchBtn.innerHTML = originalText;
                launchBtn.disabled = false;
            });
        }

        function previewTemplateCampaign() {
            debugLog('👁️ Previewing template campaign...');
            
            const name = document.getElementById('templateCampaignName').value.trim();
            const message = document.getElementById('templateCampaignMessage').value.trim();
            const targetGroup = document.getElementById('templateTargetGroup').value;
            const maxRecipients = parseInt(document.getElementById('templateMaxRecipients').value);
            
            if (!message) {
                showAlert('error', 'Please enter a message to preview.');
                return;
            }
            
            // Show preview in a simple alert or modal
            const preview = `Campaign Preview:
Name: ${name || 'Untitled Campaign'}
Target: ${getTargetGroupDisplay(targetGroup)}
Recipients: ${maxRecipients === '999999' ? 'Unlimited' : maxRecipients}
Message: "${message}"`;
            
            alert(preview);
        }

        function getTargetGroupDisplay(value) {
            const groups = {
                'all': 'All Members',
                'new': 'New Members (< 30 days)',
                'inactive': 'Inactive Members',
                'past_due': 'Past Due Members',
                'good_standing': 'Members in Good Standing',
                'expiring_soon': 'Memberships Expiring Soon'
            };
            return groups[value] || value;
        }

        function loadSavedCampaigns() {
            debugLog('📚 Loading saved campaign templates...');
            // This function would load user's saved templates from the server
            // For now, we show the predefined templates
            showAlert('info', 'Campaign templates loaded successfully!');
        }

        function loadCampaignHistory() {
            debugLog('📊 Loading campaign history...');
            
            const container = document.getElementById('campaignHistoryContainer');
            if (!container) return;
            
            // Show loading state
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="loading-spinner"></div>
                    <p class="text-muted mt-2">Loading campaign history...</p>
                </div>
            `;
            
            // Load actual campaign history from API with authentication handling
            fetch('/api/campaigns/history')
                .then(response => {
                    debugLog('📊 Campaign templates API response status:', response.status);
                    
                    // Handle authentication redirect (status 302 or HTML response)
                    if (!response.ok || response.headers.get('content-type')?.includes('text/html')) {
                        debugLog('🔒 API requires authentication, showing placeholder');
                        throw new Error('Authentication required');
                    }
                    
                    return response.json();
                })
                .then(data => {
                    debugLog('📊 Campaign history API data:', data);
                    
                    if (data.success && data.campaigns && data.campaigns.length > 0) {
                        // Display actual campaign history
                        const campaignsHtml = data.campaigns.slice(0, 10).map(campaign => {
                            const createdDate = campaign.created_at ? new Date(campaign.created_at).toLocaleDateString() : 'Unknown';
                            const successfulSends = campaign.successful_sends || 0;
                            const failedSends = campaign.failed_sends || 0;
                            const totalSends = successfulSends + failedSends;
                            const successRate = totalSends > 0 ? Math.round((successfulSends / totalSends) * 100) : 0;
                            
                            return `
                                <div class="col-12 mb-2">
                                    <div class="card border-0 shadow-sm">
                                        <div class="card-body p-3">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div class="flex-grow-1">
                                                    <h6 class="card-title mb-1 fw-semibold">${campaign.campaign_name || 'Unnamed Campaign'}</h6>
                                                    <p class="card-text small text-muted mb-2">${(campaign.message_text || '').substring(0, 80)}${(campaign.message_text || '').length > 80 ? '...' : ''}</p>
                                                    <div class="d-flex gap-3 flex-wrap">
                                                        <small class="text-muted">
                                                            <i class="fas fa-calendar me-1"></i>
                                                            ${createdDate}
                                                        </small>
                                                        <small class="text-success">
                                                            <i class="fas fa-check me-1"></i>
                                                            ${successfulSends} sent
                                                        </small>
                                                        ${failedSends > 0 ? `<small class="text-warning">
                                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                                            ${failedSends} failed
                                                        </small>` : ''}
                                                        <small class="text-info">
                                                            <i class="fas fa-percentage me-1"></i>
                                                            ${successRate}% success
                                                        </small>
                                                        ${campaign.categories ? `<small class="text-muted">
                                                            <i class="fas fa-tags me-1"></i>
                                                            ${campaign.categories}
                                                        </small>` : ''}
                                                    </div>
                                                </div>
                                                <div class="d-flex gap-2">
                                                    <button class="btn btn-sm btn-outline-success" onclick="useAsTemplate(${campaign.id})" title="Use as Template">
                                                        <i class="fas fa-copy"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-primary" onclick="continueCampaignFromHistory(${campaign.id})" title="Continue Campaign">
                                                        <i class="fas fa-play"></i>
                                                    </button>
                                                    <button class="btn btn-sm btn-outline-info" onclick="viewCampaignDetails(${campaign.id})" title="View Details">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }).join('');
                        
                        container.innerHTML = campaignsHtml;
                        
                    } else {
                        // Show empty state
                        container.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-history fa-2x text-muted mb-3"></i>
                                <p class="text-muted">No campaign history yet</p>
                                <small class="text-muted">Sent campaigns will appear here for easy reuse</small>
                            </div>
                        `;
                    }
                })
                .catch(error => {
                    debugError('❌ Error loading campaign history:', error);
                    
                    // Show appropriate message based on error type
                    if (error.message.includes('Authentication')) {
                        container.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-lock fa-2x text-info mb-3"></i>
                                <p class="text-muted">Campaign History</p>
                                <small class="text-muted">Please log in to view saved campaign templates</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="window.location.href='/login'">
                                        <i class="fas fa-sign-in-alt me-1"></i>Login
                                    </button>
                                </div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                                <p class="text-muted">Error loading campaign history</p>
                                <small class="text-muted">${error.message}</small>
                                <div class="mt-2">
                                    <button class="btn btn-sm btn-outline-primary" onclick="loadCampaignHistory()">
                                        <i class="fas fa-retry me-1"></i>Try Again
                                    </button>
                                </div>
                            </div>
                        `;
                    }
                });
        }

        function reuseCampaign(campaignId) {
            debugLog(`🔄 Reusing campaign: ${campaignId}`);
            showAlert('info', `Campaign ${campaignId} loaded for reuse. Check the Templates tab to customize and launch.`);
        }

        function reuseCampaignTemplate(templateId) {
            debugLog(`🔄 Reusing campaign template: ${templateId}`);
            
            // Mark template as used and load its data
            fetch(`/api/campaign-templates/${templateId}/use`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.template) {
                    // Switch to the Templates tab
                    const templatesTab = document.getElementById('campaign-templates-tab');
                    if (templatesTab) {
                        templatesTab.click();
                    }
                    
                    // Populate the template editor with the saved data
                    setTimeout(() => {
                        document.getElementById('templateCampaignName').value = data.template.name;
                        document.getElementById('templateCampaignMessage').value = data.template.message;
                        document.getElementById('templateTargetGroup').value = data.template.target_group;
                        document.getElementById('templateMaxRecipients').value = data.template.max_recipients;
                        
                        showAlert('success', `Template "${data.template.name}" loaded successfully! Customize and launch when ready.`);
                    }, 500);
                } else {
                    showAlert('error', data.message || 'Error loading campaign template');
                }
            })
            .catch(error => {
                debugError('❌ Error reusing campaign template:', error);
                showAlert('error', 'Network error loading campaign template');
            });
        }

        function editSavedTemplate(templateId) {
            debugLog(`✏️ Editing saved template: ${templateId}`);
            
            // Load template for editing (same as reuse but with edit intent)
            fetch(`/api/campaign-templates/${templateId}/use`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.template) {
                    // Switch to Templates tab
                    const templatesTab = document.getElementById('campaign-templates-tab');
                    if (templatesTab) {
                        templatesTab.click();
                    }
                    
                    // Populate editor and focus for editing
                    setTimeout(() => {
                        document.getElementById('templateCampaignName').value = data.template.name;
                        document.getElementById('templateCampaignMessage').value = data.template.message;
                        document.getElementById('templateTargetGroup').value = data.template.target_group;
                        document.getElementById('templateMaxRecipients').value = data.template.max_recipients;
                        document.getElementById('saveAsNewTemplate').checked = true;
                        
                        // Focus on message field for editing
                        document.getElementById('templateCampaignMessage').focus();
                        document.getElementById('templateCampaignMessage').select();
                        
                        showAlert('info', `Template "${data.template.name}" loaded for editing. Make changes and save as new template.`);
                    }, 500);
                } else {
                    showAlert('error', data.message || 'Error loading template for editing');
                }
            })
            .catch(error => {
                debugError('❌ Error loading template for editing:', error);
                showAlert('error', 'Network error loading template');
            });
        }

        function useAsTemplate(campaignId) {
            debugLog(`� Using campaign ${campaignId} as template`);
            
            // Get campaign data from database
            fetch(`/api/campaigns/history`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.campaigns) {
                        const campaign = data.campaigns.find(c => c.id === campaignId);
                        if (campaign) {
                            // Determine category based on campaign categories or default to past_due_training
                            let categoryKey = 'past_due_training'; // default
                            if (campaign.categories) {
                                if (campaign.categories.includes('past_due_30_plus')) categoryKey = 'past_due_30_plus';
                                else if (campaign.categories.includes('past_due_6_30')) categoryKey = 'past_due_6_30';
                                else if (campaign.categories.includes('expiring_soon')) categoryKey = 'expiring_soon';
                                else if (campaign.categories.includes('prospects')) categoryKey = 'prospects';
                                else if (campaign.categories.includes('good_standing')) categoryKey = 'good_standing';
                                else if (campaign.categories.includes('pay_per_visit')) categoryKey = 'pay_per_visit';
                            }
                            
                            // Open the appropriate campaign modal
                            openCampaignModal(categoryKey);
                            
                            // Wait for modal to load, then populate with campaign data
                            setTimeout(() => {
                                const messageField = document.getElementById('campaignMessage');
                                if (messageField) {
                                    messageField.value = campaign.message_text || '';
                                    showAlert('success', `Campaign "${campaign.campaign_name}" loaded as template! Modify as needed and launch.`);
                                } else {
                                    showAlert('warning', 'Campaign modal opened - manually enter the message content.');
                                }
                            }, 800);
                            
                        } else {
                            showAlert('error', 'Campaign not found');
                        }
                    } else {
                        showAlert('error', 'Error loading campaign data');
                    }
                })
                .catch(error => {
                    debugError('❌ Error loading campaign template:', error);
                    showAlert('error', 'Network error loading campaign');
                });
        }

        function continueCampaignFromHistory(campaignId) {
            debugLog(`▶️ Continuing campaign ${campaignId} from where it left off`);
            
            // Get campaign data from database
            fetch(`/api/campaigns/history`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.campaigns) {
                        const campaign = data.campaigns.find(c => c.id === campaignId);
                        if (campaign) {
                            // Determine category for progress tracking
                            let categoryKey = 'past_due_training'; // default
                            if (campaign.categories) {
                                const categories = campaign.categories.split(',').map(c => c.trim());
                                if (categories.includes('past_due_30_plus')) categoryKey = 'past_due_30_plus';
                                else if (categories.includes('past_due_6_30')) categoryKey = 'past_due_6_30';
                                else if (categories.includes('expiring_soon')) categoryKey = 'expiring_soon';
                                else if (categories.includes('prospects')) categoryKey = 'prospects';
                                else if (categories.includes('good_standing')) categoryKey = 'good_standing';
                                else if (categories.includes('pay_per_visit')) categoryKey = 'pay_per_visit';
                            }
                            
                            // Open the campaign modal for continuation
                            openCampaignModal(categoryKey);
                            
                            // Set up the campaign for continuation
                            setTimeout(() => {
                                const messageField = document.getElementById('campaignMessage');
                                if (messageField) {
                                    messageField.value = campaign.message_text || '';
                                }
                                
                                // Check if there's existing progress for this campaign
                                checkCampaignProgress(campaignId, categoryKey, campaign);
                                
                            }, 800);
                            
                        } else {
                            showAlert('error', 'Campaign not found');
                        }
                    } else {
                        showAlert('error', 'Error loading campaign data');
                    }
                })
                .catch(error => {
                    debugError('❌ Error continuing campaign:', error);
                    showAlert('error', 'Network error loading campaign');
                });
        }
        
        function checkCampaignProgress(campaignId, categoryKey, campaign) {
            debugLog(`🔍 Checking progress for campaign ${campaignId} in category ${categoryKey}`);
            
            // Check campaign progress table to see where we left off
            fetch('/api/campaigns/progress')
            .then(response => response.json())
            .then(data => {
                if (data.success && data.progress) {
                    // Find progress for this specific category
                    const categoryProgress = data.progress.find(p => p.category === categoryKey);
                    
                    if (categoryProgress) {
                        const remaining = (categoryProgress.total_members_in_category || 0) - (categoryProgress.last_processed_index || 0);
                        const lastProcessed = categoryProgress.last_processed_index || 0;
                        const total = categoryProgress.total_members_in_category || 0;
                        
                        if (remaining > 0) {
                            showAlert('info', 
                                `Campaign "${campaign.campaign_name}" will continue from member ${lastProcessed + 1} ` +
                                `of ${total}. ${remaining} members remaining to process.`
                            );
                        } else {
                            showAlert('warning', 
                                `Campaign "${campaign.campaign_name}" appears to be complete. ` +
                                `All ${total} members in category "${getCategoryTitle(categoryKey)}" were already processed. ` +
                                `This will restart the campaign for the same category.`
                            );
                        }
                    } else {
                        showAlert('info', 
                            `Campaign "${campaign.campaign_name}" loaded for continuation. ` +
                            `This will send to members in category "${getCategoryTitle(categoryKey)}" who haven't received this message yet.`
                        );
                    }
                } else {
                    showAlert('success', 
                        `Campaign "${campaign.campaign_name}" loaded for continuation. Ready to send!`
                    );
                }
            })
            .catch(error => {
                debugLog('⚠️ Could not check campaign progress:', error);
                showAlert('success', 
                    `Campaign "${campaign.campaign_name}" loaded for continuation. Ready to send!`
                );
            });
        }

        function viewCampaignDetails(campaignId) {
            debugLog(`👁️ Viewing campaign details: ${campaignId}`);
            
            // Get campaign data from database
            fetch(`/api/campaigns/history`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.campaigns) {
                        const campaign = data.campaigns.find(c => c.id === campaignId);
                        if (campaign) {
                            const createdDate = campaign.created_at ? new Date(campaign.created_at).toLocaleString() : 'Unknown';
                            const successfulSends = campaign.successful_sends || 0;
                            const failedSends = campaign.failed_sends || 0;
                            const totalSends = successfulSends + failedSends;
                            const successRate = totalSends > 0 ? Math.round((successfulSends / totalSends) * 100) : 0;
                            
                            // Show modal with campaign details
                            const modalHtml = `
                                <div class="modal fade" id="campaignDetailsModal" tabindex="-1">
                                    <div class="modal-dialog modal-lg">
                                        <div class="modal-content">
                                            <div class="modal-header">
                                                <h5 class="modal-title">Campaign Details: ${campaign.campaign_name || 'Unnamed Campaign'}</h5>
                                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                            </div>
                                            <div class="modal-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <h6>Campaign Information</h6>
                                                        <p><strong>Created:</strong> ${createdDate}</p>
                                                        <p><strong>Message Type:</strong> ${campaign.message_type || 'SMS'}</p>
                                                        ${campaign.subject ? `<p><strong>Subject:</strong> ${campaign.subject}</p>` : ''}
                                                        ${campaign.categories ? `<p><strong>Categories:</strong> ${campaign.categories}</p>` : ''}
                                                    </div>
                                                    <div class="col-md-6">
                                                        <h6>Delivery Statistics</h6>
                                                        <p><strong>Total Recipients:</strong> ${campaign.total_recipients || totalSends}</p>
                                                        <p><strong>Successful Sends:</strong> <span class="text-success">${successfulSends}</span></p>
                                                        <p><strong>Failed Sends:</strong> <span class="text-warning">${failedSends}</span></p>
                                                        <p><strong>Success Rate:</strong> <span class="text-info">${successRate}%</span></p>
                                                    </div>
                                                </div>
                                                <div class="mt-3">
                                                    <h6>Message Content</h6>
                                                    <div class="p-3 bg-light rounded">
                                                        <pre style="white-space: pre-wrap; font-family: inherit;">${campaign.message_text || 'No message content available'}</pre>
                                                    </div>
                                                </div>
                                                ${campaign.errors ? `
                                                    <div class="mt-3">
                                                        <h6>Errors</h6>
                                                        <div class="p-3 bg-warning bg-opacity-10 rounded">
                                                            <pre style="white-space: pre-wrap; font-family: inherit;">${campaign.errors}</pre>
                                                        </div>
                                                    </div>
                                                ` : ''}
                                                ${campaign.notes ? `
                                                    <div class="mt-3">
                                                        <h6>Notes</h6>
                                                        <p>${campaign.notes}</p>
                                                    </div>
                                                ` : ''}
                                            </div>
                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-success" onclick="useAsTemplate(${campaignId}); $('#campaignDetailsModal').modal('hide');">
                                                    <i class="fas fa-copy me-1"></i> Use as Template
                                                </button>
                                                <button type="button" class="btn btn-primary" onclick="continueCampaignFromHistory(${campaignId}); $('#campaignDetailsModal').modal('hide');">
                                                    <i class="fas fa-play me-1"></i> Continue Campaign
                                                </button>
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Remove any existing modal
                            const existingModal = document.getElementById('campaignDetailsModal');
                            if (existingModal) {
                                existingModal.remove();
                            }
                            
                            // Add modal to page and show it
                            document.body.insertAdjacentHTML('beforeend', modalHtml);
                            const modal = new bootstrap.Modal(document.getElementById('campaignDetailsModal'));
                            modal.show();
                            
                        } else {
                            showAlert('error', 'Campaign not found');
                        }
                    } else {
                        showAlert('error', 'Error loading campaign details');
                    }
                })
                .catch(error => {
                    debugError('❌ Error viewing campaign details:', error);
                    showAlert('error', 'Network error loading campaign details');
                });
        }

        function viewCampaignStats() {
            debugLog('📈 Viewing campaign statistics...');
            
            // Load actual campaign statistics
            fetch('/api/campaign-templates')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.templates) {
                        const totalCampaigns = data.templates.length;
                        const totalUsage = data.templates.reduce((sum, t) => sum + (t.usage_count || 0), 0);
                        const mostUsed = data.templates.reduce((prev, current) => 
                            (prev.usage_count > current.usage_count) ? prev : current, data.templates[0]);
                        
                        const stats = `Campaign Statistics:
                        
• Total saved templates: ${totalCampaigns}
• Total times used: ${totalUsage}
• Most popular template: "${mostUsed?.name}" (${mostUsed?.usage_count || 0} times)
• Categories: ${[...new Set(data.templates.map(t => t.category))].join(', ')}`;
                        
                        alert(stats);
                    } else {
                        alert('No campaign statistics available yet. Send some campaigns to see stats!');
                    }
                })
                .catch(error => {
                    debugError('❌ Error loading campaign stats:', error);
                    alert('Error loading campaign statistics');
                });
        }
</script>
{% endblock %}
