{% extends "base.html" %}

{% block title %}ClubOS Messaging Center - Anytime Fitness Dashboard{% endblock %}

{% block extra_css %}
<style>
    .message-item {
        transition: background-color 0.15s ease, border-left-color 0.15s ease;
        border-left: 4px solid transparent;
        background: white;
        border-radius: var(--border-radius-medium);
        margin-bottom: 0.5rem;
        box-shadow: var(--shadow-2);
    }
    .message-item:hover {
        background-color: var(--af-gray-50);
        border-left-color: var(--af-purple-primary);
        cursor: pointer;
        box-shadow: var(--shadow-4);
    }
    .message-item.unread {
        background-color: #e3f2fd;
        border-left-color: var(--af-purple-primary);
    }
    .message-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--border-radius-small);
    }
    .campaign-card {
        transition: box-shadow 0.15s ease;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-2);
    }
    .campaign-card:hover {
        box-shadow: var(--shadow-4);
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--af-purple-primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .message-content {
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .message-actions {
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .message-item:hover .message-actions {
        opacity: 1;
    }
    .fluent-card {
        background: white;
        border-radius: var(--border-radius-large);
        box-shadow: var(--shadow-4);
        border: none;
    }
    .fluent-header {
        background: linear-gradient(135deg, var(--af-purple-primary), var(--af-purple-dark));
        color: white;
        border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        padding: 1rem 1.5rem;
    }
    .btn-fluent-primary {
        background: var(--af-purple-primary);
        border: none;
        color: white;
        border-radius: var(--border-radius-medium);
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    .btn-fluent-primary:hover {
        background: var(--af-purple-dark);
        color: white;
        box-shadow: var(--shadow-4);
    }
    .btn-fluent-outline {
        border: 1px solid var(--af-purple-primary);
        color: var(--af-purple-primary);
        background: transparent;
        border-radius: var(--border-radius-medium);
        padding: 0.5rem 1rem;
        transition: background 0.15s ease, color 0.15s ease;
    }
    .btn-fluent-outline:hover {
        background: var(--af-purple-primary);
        color: white;
        box-shadow: var(--shadow-4);
    }
    
    /* Status Tabs Styling */
    .nav-tabs .nav-link {
        border: none !important;
        transition: all 0.3s ease;
        background: transparent !important;
    }
    .nav-tabs .nav-link:hover {
        background: rgba(111, 66, 193, 0.1) !important;
        border: none !important;
    }
    .nav-tabs .nav-link.active {
        background: white !important;
        border-bottom: 3px solid var(--af-purple-primary) !important;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .nav-tabs .nav-link.active i {
        color: var(--af-purple-primary) !important;
    }
    .nav-tabs .nav-link.active span.fw-bold {
        color: var(--af-purple-primary) !important;
    }
    
    /* Campaign Action Panel */
    .campaign-action-panel {
        background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
        border-radius: var(--border-radius-medium);
        border: 1px solid #e9ecef;
        margin-bottom: 1rem;
    }
    .campaign-controls {
        background: white;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-2);
        padding: 1.5rem;
    }
    .member-preview {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius-small);
        background: white;
    }
    .member-item {
        padding: 0.75rem;
        border-bottom: 1px solid #f1f3f4;
        transition: background-color 0.2s ease;
    }
    .member-item:hover {
        background-color: #f8f9fa;
    }
    .member-item:last-child {
        border-bottom: none;
    }
    
    /* Fix scrolling issues - Remove problematic scroll overrides */
    .messaging-page {
        position: relative;
    }
    
    /* Fix tab positioning - prevent detaching */
    .nav-tabs {
        position: relative;
        z-index: 5;
        background: #f8f9fa;
        margin-bottom: 1rem;
        border-bottom: 1px solid #dee2e6;
    }
    
    /* Ensure proper scrolling */
    .tab-content {
        position: relative;
    }
    
    .tab-pane {
        position: relative;
    }
    
    /* Member preview scrolling */
    .member-preview {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid #e9ecef;
        border-radius: var(--border-radius-small);
        background: white;
    }
    
    /* Simple Modal Fix - Remove conflicts */
    .modal {
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1055;
        width: 100%;
        height: 100%;
        overflow: hidden;
        outline: 0;
    }
    
    .modal-dialog {
        position: relative;
        width: auto;
        margin: 0.5rem;
        pointer-events: none;
    }
    
    .modal-content {
        position: relative;
        display: flex;
        flex-direction: column;
        width: 100%;
        pointer-events: auto;
        background-color: #fff;
        background-clip: padding-box;
        border: 1px solid rgba(0,0,0,.2);
        border-radius: 0.3rem;
        outline: 0;
    }
    
    .modal input,
    .modal textarea,
    .modal select {
        pointer-events: auto !important;
        -webkit-user-select: text !important;
        -moz-user-select: text !important;
        -ms-user-select: text !important;
        user-select: text !important;
    }
</style>
{% endblock %}

{% block content %}
<div class="messaging-page">
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1 fw-bold" style="color: var(--af-black-primary);">
            <i class="fas fa-comments me-2" style="color: var(--af-purple-primary);"></i>
            ClubOS Messaging Center
        </h1>
        <p class="text-muted mb-0">Marketing campaigns and message management</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-fluent-outline" onclick="syncMessages()">
            <i class="fas fa-sync-alt me-1"></i>
            Sync Messages
        </button>
        <button class="btn btn-fluent-primary" onclick="loadStatusCampaigns()">
            <i class="fas fa-refresh me-1"></i>
            Refresh Categories
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="row g-4">
    <!-- Status-Based Campaign Cards -->
    <div class="col-12">
        <div class="fluent-card">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-bullhorn me-2"></i>
                    Campaign Management by Status Category
                </h5>
                <p class="mb-0 small opacity-75">Create and run targeted campaigns for each member status group</p>
            </div>
            <div class="card-body p-0">
                <!-- Status Tabs Navigation -->
                <ul class="nav nav-tabs nav-fill border-0" id="statusTabs" role="tablist" style="background: #f8f9fa;">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active position-relative text-center fw-bold border-0" 
                                id="good-standing-tab" data-bs-toggle="tab" data-bs-target="#good-standing-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-check-circle text-success mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Good Standing</span>
                                <span class="badge bg-success rounded-pill mt-1" id="good-standing-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="pay-per-visit-tab" data-bs-toggle="tab" data-bs-target="#pay-per-visit-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-credit-card text-info mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Pay Per Visit</span>
                                <span class="badge bg-info rounded-pill mt-1" id="pay-per-visit-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="past-due-6-30-tab" data-bs-toggle="tab" data-bs-target="#past-due-6-30-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-exclamation-triangle text-warning mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Past Due 6-30</span>
                                <span class="badge bg-warning text-dark rounded-pill mt-1" id="past-due-6-30-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="past-due-30-tab" data-bs-toggle="tab" data-bs-target="#past-due-30-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-times-circle text-danger mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Past Due 30+</span>
                                <span class="badge bg-danger rounded-pill mt-1" id="past-due-30-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="past-due-training-tab" data-bs-toggle="tab" data-bs-target="#past-due-training-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-dumbbell text-danger mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">PT Past Due</span>
                                <span class="badge bg-danger rounded-pill mt-1" id="past-due-training-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="expiring-soon-tab" data-bs-toggle="tab" data-bs-target="#expiring-soon-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-clock text-warning mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Expiring Soon</span>
                                <span class="badge bg-warning text-dark rounded-pill mt-1" id="expiring-soon-count">0</span>
                            </div>
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link position-relative text-center fw-bold border-0" 
                                id="other-statuses-tab" data-bs-toggle="tab" data-bs-target="#other-statuses-panel" 
                                type="button" role="tab" style="padding: 15px 10px; background: transparent;">
                            <div class="d-flex flex-column align-items-center">
                                <i class="fas fa-ellipsis-h text-secondary mb-1" style="font-size: 1.5rem;"></i>
                                <span class="fw-bold text-dark small">Other</span>
                                <span class="badge bg-secondary rounded-pill mt-1" id="other-statuses-count">0</span>
                            </div>
                        </button>
                    </li>
                </ul>

                <!-- Tab Content Panels -->
                <div class="tab-content border-0" id="statusTabContent" style="min-height: 500px;">
                    <!-- Good Standing Panel -->
                    <div class="tab-pane fade show active" id="good-standing-panel" role="tabpanel">
                        <div class="p-4" id="good-standing-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Pay Per Visit Panel -->
                    <div class="tab-pane fade" id="pay-per-visit-panel" role="tabpanel">
                        <div class="p-4" id="pay-per-visit-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Past Due 6-30 Days Panel -->
                    <div class="tab-pane fade" id="past-due-6-30-panel" role="tabpanel">
                        <div class="p-4" id="past-due-6-30-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Past Due 30+ Days Panel -->
                    <div class="tab-pane fade" id="past-due-30-panel" role="tabpanel">
                        <div class="p-4" id="past-due-30-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Past Due Training Clients Panel -->
                    <div class="tab-pane fade" id="past-due-training-panel" role="tabpanel">
                        <div class="p-4" id="past-due-training-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Expiring Soon Panel -->
                    <div class="tab-pane fade" id="expiring-soon-panel" role="tabpanel">
                        <div class="p-4" id="expiring-soon-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>

                    <!-- Other Statuses Panel -->
                    <div class="tab-pane fade" id="other-statuses-panel" role="tabpanel">
                        <div class="p-4" id="other-statuses-content">
                            <!-- Content will be loaded dynamically -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Secondary Row for Message Inbox and Progress -->
<div class="row g-4 mt-2">
    <!-- Message Inbox -->
    <div class="col-md-6">
        <div class="fluent-card">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-inbox me-2"></i>
                    Message Inbox
                </h5>
            </div>
            <div class="card-body p-3">
                <div class="mb-3">
                    <label for="messageSearch" class="form-label visually-hidden">Search Messages</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageSearch" placeholder="Search messages..." style="border-radius: var(--border-radius-medium);">
                        <button class="btn btn-fluent-outline" type="button" onclick="searchMessages()" title="Search Messages" aria-label="Search Messages">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="messagesContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading messages...</p>
                    </div>
                </div>
                <!-- Threading Container for Message Threads -->
                <div id="threadsContainer" class="mt-3">
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                        <p class="text-muted">Loading message threads...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
        
    <!-- Campaign Progress Tracking -->
    <div class="col-md-6">
        <div class="fluent-card">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-chart-line me-2"></i>
                    Campaign Progress
                </h5>
                <button class="btn btn-sm btn-fluent-outline" onclick="loadCampaignProgress()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body p-3">
                <div id="progressContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading progress...</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-warning" onclick="resetAllProgress()">
                        <i class="fas fa-redo"></i> Reset All Progress
                    </button>
                    <small class="text-muted ms-2">Use to restart campaigns from beginning</small>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- Status Category Campaign Modal -->
<div class="modal fade" id="statusCampaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: var(--border-radius-large);">
            <div class="modal-header" style="background: var(--af-purple-primary); color: white; border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-bullhorn me-2"></i>
                    <span id="modalCategoryTitle">Campaign Setup</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close Modal"></button>
            </div>
            <div class="modal-body">
                <form id="statusCampaignForm">
                    <input type="hidden" id="modalCategoryValue" value="">
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Target Group:</strong> <span id="modalCategoryInfo"></span>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusCampaignName" class="form-label fw-semibold">Campaign Name</label>
                        <input type="text" class="form-control" id="statusCampaignName" required style="border-radius: var(--border-radius-medium);" placeholder="Enter campaign name">
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusCampaignMessage" class="form-label fw-semibold">Message Content</label>
                        <textarea class="form-control" id="statusCampaignMessage" rows="4" required style="border-radius: var(--border-radius-medium);" placeholder="Enter your message here..."></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusMessageType" class="form-label fw-semibold">Message Type</label>
                        <select class="form-select" id="statusMessageType" required style="border-radius: var(--border-radius-medium);">
                            <option value="sms">SMS Text Message</option>
                            <option value="email">Email Message</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="statusEmailSubjectDiv" style="display: none;">
                        <label for="statusEmailSubject" class="form-label fw-semibold">Email Subject</label>
                        <input type="text" class="form-control" id="statusEmailSubject" style="border-radius: var(--border-radius-medium);">
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusRecipientLimit" class="form-label fw-semibold">Max Recipients</label>
                        <input type="number" class="form-control" id="statusRecipientLimit" value="100" min="1" max="1000" required style="border-radius: var(--border-radius-medium);">
                        <div class="form-text">
                            <small class="text-muted">Maximum number of people to send this campaign to (1-1000)</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="statusCampaignNotes" class="form-label fw-semibold">Campaign Notes</label>
                        <textarea class="form-control" id="statusCampaignNotes" rows="3" placeholder="Add notes about this campaign (internal use only)" style="border-radius: var(--border-radius-medium);"></textarea>
                        <div class="form-text">
                            <small class="text-muted">These notes are for your reference and won't be sent to recipients</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-fluent-primary" onclick="saveStatusCampaign()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Send Campaign
                </button>
            </div>
        </div>
    </div>
</div>
</div> <!-- End messaging-page wrapper -->
{% endblock %}

{% block extra_js %}
<script>
        // Debug logging system - set to false for production
        const DEBUG_MODE = true;
        
        function debugLog(...args) {
            if (DEBUG_MODE) {
                console.log(...args);
            }
        }
        
        function debugError(...args) {
            console.error(...args); // Always show errors
        }
        
        function debugWarn(...args) {
            if (DEBUG_MODE) {
                console.warn(...args);
            }
        }

        // Bootstrap tabs initialization (moved to main DOMContentLoaded)
        function initializeBootstrapTabs() {
            var triggerTabList = [].slice.call(document.querySelectorAll('#statusTabs button'));
            triggerTabList.forEach(function (triggerEl) {
                var tabTrigger = new bootstrap.Tab(triggerEl);
                triggerEl.addEventListener('click', function (event) {
                    event.preventDefault();
                    tabTrigger.show();
                });
            });
        }

        function loadStatusCampaigns() {
            debugLog('🔄 Loading status campaigns...');
            
            // Load data for all status categories including training clients using correct endpoints
            Promise.all([
                fetch('/api/prospects/all')
                    .then(r => {
                        debugLog('📞 Prospects API response status:', r.status);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .catch(e => {
                        debugError('❌ Prospects API error:', e.message);
                        return { success: false, error: e.message, source: 'prospects' };
                    }),
                fetch('/api/members/all')
                    .then(r => {
                        debugLog('📞 Members API response status:', r.status);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .catch(e => {
                        debugError('❌ Members API error:', e.message);
                        return { success: false, error: e.message, source: 'members' };
                    }),
                fetch('/api/training/clients')
                    .then(r => {
                        debugLog('📞 Training API response status:', r.status);
                        if (!r.ok) throw new Error(`HTTP ${r.status}`);
                        return r.json();
                    })
                    .catch(e => {
                        debugError('❌ Training API error:', e.message);
                        return { success: false, error: e.message, source: 'training' };
                    })
            ])
            .then(([prospectsData, membersData, trainingData]) => {
                debugLog('📊 API Responses received:', { 
                    prospects: prospectsData.success ? 'SUCCESS' : `FAILED: ${prospectsData.error}`,
                    members: membersData.success ? 'SUCCESS' : `FAILED: ${membersData.error}`,
                    training: trainingData.success ? 'SUCCESS' : `FAILED: ${trainingData.error}`
                });
                
                // Extract data with better error handling
                const prospects = prospectsData.success ? (prospectsData.prospects || prospectsData.data || []) : [];
                const allMembers = membersData.success ? (membersData.members || membersData.data || []) : [];
                const trainingClients = trainingData.success ? (trainingData.training_clients || trainingData.clients || trainingData.data || []) : [];
                
                debugLog('📈 Processed data counts:', { 
                    prospects: prospects.length, 
                    members: allMembers.length, 
                    trainingClients: trainingClients.length 
                });
                
                // Log sample data for debugging
                if (allMembers.length > 0) {
                    debugLog('👤 Sample member data:', {
                        first: allMembers[0],
                        status_messages: allMembers.slice(0, 5).map(m => m.status_message).filter(Boolean)
                    });
                }
                
                // Categorize members by status_message patterns
                categorizeSpecificMembers(allMembers, trainingClients);
                
                debugLog('✅ Status campaigns loaded and categorized successfully');
            })
            .catch(error => {
                debugError('❌ Critical error in loadStatusCampaigns:', error);
                showStatusError('Failed to load campaign data. Please try refreshing the page.');
            });
        }

        function categorizeSpecificMembers(allMembers, trainingClients) {
            debugLog('🏷️ Starting member categorization...');
            
            // Initialize all categories
            const categories = {
                'good-standing': [],
                'pay-per-visit': [],
                'past-due-6-30': [],
                'past-due-30': [],
                'past-due-training': [],
                'expiring-soon': [],
                'other-statuses': []
            };
            
            // Process regular members by status_message
            allMembers.forEach(member => {
                const statusMsg = (member.status_message || '').toLowerCase();
                
                if (statusMsg.includes('good standing') || statusMsg.includes('active')) {
                    categories['good-standing'].push(member);
                } else if (statusMsg.includes('pay per visit')) {
                    categories['pay-per-visit'].push(member);
                } else if (statusMsg.includes('past due 6-30') || statusMsg.includes('past due 6 to 30')) {
                    categories['past-due-6-30'].push(member);
                } else if (statusMsg.includes('past due more than 30') || statusMsg.includes('past due 30+')) {
                    categories['past-due-30'].push(member);
                } else if (statusMsg.includes('expiring') || statusMsg.includes('expires')) {
                    categories['expiring-soon'].push(member);
                } else if (statusMsg && statusMsg !== 'null' && statusMsg !== '') {
                    categories['other-statuses'].push(member);
                }
            });
            
            // Add past due training clients to their special category
            if (trainingClients && trainingClients.length > 0) {
                const pastDueTrainingClients = trainingClients.filter(client => {
                    const amountPastDue = parseFloat(client.amount_past_due || 0);
                    const statusMsg = (client.status_message || '').toLowerCase();
                    return amountPastDue > 0 || statusMsg.includes('past due');
                });
                categories['past-due-training'] = pastDueTrainingClients;
            }
            
            debugLog('📋 Categorization results:', {
                'good-standing': categories['good-standing'].length,
                'pay-per-visit': categories['pay-per-visit'].length,
                'past-due-6-30': categories['past-due-6-30'].length,
                'past-due-30': categories['past-due-30'].length,
                'past-due-training': categories['past-due-training'].length,
                'expiring-soon': categories['expiring-soon'].length,
                'other-statuses': categories['other-statuses'].length
            });
            
            // Update tab badges with counts
            Object.keys(categories).forEach(categoryKey => {
                const count = categories[categoryKey].length;
                const badge = document.getElementById(`${categoryKey}-count`);
                if (badge) {
                    badge.textContent = count;
                    badge.className = `badge rounded-pill mt-1 ${getBadgeClass(categoryKey, count)}`;
                }
            });
            
            // Generate content for each category
            Object.keys(categories).forEach(categoryKey => {
                generateCategoryContent(categoryKey, categories[categoryKey]);
            });
        }

        function getBadgeClass(category, count) {
            if (count === 0) return 'bg-secondary';
            
            switch(category) {
                case 'good-standing': return 'bg-success';
                case 'pay-per-visit': return 'bg-info';
                case 'past-due-6-30': return 'bg-warning text-dark';
                case 'past-due-30': case 'past-due-training': return 'bg-danger';
                case 'expiring-soon': return 'bg-warning text-dark';
                default: return 'bg-secondary';
            }
        }

        function generateCategoryContent(categoryKey, members) {
            const contentDiv = document.getElementById(`${categoryKey}-content`);
            if (!contentDiv) return;
            
            if (members.length === 0) {
                contentDiv.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-users fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">No members in this category</h6>
                        <p class="text-muted small">This category will populate when members match the criteria.</p>
                    </div>
                `;
                return;
            }
            
            // Generate campaign interface for this category
            const categoryTitle = getCategoryTitle(categoryKey);
            const memberPreview = members.slice(0, 10).map(member => `
                <div class="member-item">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${member.full_name || `${member.firstName || ''} ${member.lastName || ''}`.trim()}</strong>
                            <div class="small text-muted">${member.email || member.mobile_phone || 'No contact info'}</div>
                            ${member.status_message ? `<div class="small text-info">${member.status_message}</div>` : ''}
                            ${member.amount_past_due && parseFloat(member.amount_past_due) > 0 ? 
                                `<div class="small text-danger">Past Due: $${parseFloat(member.amount_past_due).toFixed(2)}</div>` : ''}
                        </div>
                    </div>
                </div>
            `).join('');
            
            contentDiv.innerHTML = `
                <div class="campaign-action-panel">
                    <div class="campaign-controls">
                        <div class="row g-4">
                            <div class="col-md-7">
                                <h6 class="fw-bold mb-3">
                                    <i class="fas fa-bullhorn me-2 text-primary"></i>
                                    ${categoryTitle} Campaign
                                </h6>
                                <p class="text-muted mb-3">
                                    Create a targeted campaign for ${members.length} member${members.length !== 1 ? 's' : ''} in this category.
                                </p>
                                <button class="btn btn-fluent-primary" onclick="openStatusCampaignModal('${categoryKey}', '${categoryTitle}', ${members.length})">
                                    <i class="fas fa-paper-plane me-2"></i>
                                    Create Campaign (${members.length} recipients)
                                </button>
                            </div>
                            <div class="col-md-5">
                                <h6 class="fw-bold mb-3">Member Preview</h6>
                                <div class="member-preview">
                                    ${memberPreview}
                                    ${members.length > 10 ? `
                                        <div class="text-center py-2 border-top">
                                            <small class="text-muted">... and ${members.length - 10} more members</small>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function getCategoryTitle(categoryKey) {
            const titles = {
                'good-standing': 'Good Standing Members',
                'pay-per-visit': 'Pay Per Visit Members',
                'past-due-6-30': 'Past Due 6-30 Days',
                'past-due-30': 'Past Due 30+ Days',
                'past-due-training': 'Past Due Training Clients',
                'expiring-soon': 'Expiring Soon',
                'other-statuses': 'Other Status Members'
            };
            return titles[categoryKey] || categoryKey;
        }

        function openStatusCampaignModal(categoryKey, categoryTitle, memberCount) {
            debugLog('📝 Opening campaign modal for:', categoryKey, memberCount, 'members');
            
            // Set modal data
            document.getElementById('modalCategoryValue').value = categoryKey;
            document.getElementById('modalCategoryTitle').textContent = categoryTitle + ' Campaign';
            document.getElementById('modalCategoryInfo').textContent = `${memberCount} member${memberCount !== 1 ? 's' : ''} in ${categoryTitle.toLowerCase()}`;
            
            // Reset form
            document.getElementById('statusCampaignForm').reset();
            document.getElementById('statusRecipientLimit').value = Math.min(memberCount, 100);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('statusCampaignModal'));
            modal.show();
        }

        function saveStatusCampaign() {
            const form = document.getElementById('statusCampaignForm');
            const submitBtn = event.target;
            const originalText = submitBtn.innerHTML;
            
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get form data
            const formData = {
                category: document.getElementById('modalCategoryValue').value,
                name: document.getElementById('statusCampaignName').value,
                message: document.getElementById('statusCampaignMessage').value,
                type: document.getElementById('statusMessageType').value,
                subject: document.getElementById('statusEmailSubject').value || '',
                recipientLimit: parseInt(document.getElementById('statusRecipientLimit').value),
                notes: document.getElementById('statusCampaignNotes').value || ''
            };
            
            debugLog('💾 Saving status campaign:', formData);
            
            // Update button state
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Sending...';
            submitBtn.disabled = true;
            
            // Send campaign (placeholder - implement actual sending logic)
            fetch('/api/campaigns/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', `Campaign "${formData.name}" sent successfully to ${data.sent_count || 'selected'} recipients!`);
                    
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('statusCampaignModal'));
                    modal.hide();
                    
                    // Refresh progress
                    loadCampaignProgress();
                } else {
                    showAlert('danger', `Failed to send campaign: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                debugError('❌ Campaign send error:', error);
                showAlert('danger', 'Failed to send campaign. Please try again.');
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function showStatusError(message) {
            debugError('🚨 Status error:', message);
            
            // Show error in all tab contents
            ['good-standing', 'pay-per-visit', 'past-due-6-30', 'past-due-30', 'past-due-training', 'expiring-soon', 'other-statuses'].forEach(categoryKey => {
                const contentDiv = document.getElementById(`${categoryKey}-content`);
                if (contentDiv) {
                    contentDiv.innerHTML = `
                        <div class="text-center py-4">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning mb-3"></i>
                            <h6 class="text-warning">Unable to Load Campaign Data</h6>
                            <p class="text-muted small">${message}</p>
                            <button class="btn btn-outline-primary btn-sm mt-2" onclick="loadStatusCampaigns()">
                                <i class="fas fa-retry me-1"></i> Try Again
                            </button>
                        </div>
                    `;
                }
            });
        }

        // Message Type Handler
        document.addEventListener('change', function(event) {
            if (event.target && event.target.id === 'statusMessageType') {
                const emailSubjectDiv = document.getElementById('statusEmailSubjectDiv');
                if (event.target.value === 'email') {
                    emailSubjectDiv.style.display = 'block';
                    document.getElementById('statusEmailSubject').required = true;
                } else {
                    emailSubjectDiv.style.display = 'none';
                    document.getElementById('statusEmailSubject').required = false;
                }
            }
        });

        // Placeholder functions for message inbox and campaign progress
        function loadInbox() {
            debugLog('📨 Loading message inbox...');
            // Placeholder implementation
            const container = document.getElementById('messagesContainer');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-2x text-muted mb-3"></i>
                        <h6 class="text-muted">Message Inbox</h6>
                        <p class="text-muted small">Inbox functionality will be implemented soon.</p>
                    </div>
                `;
            }
        }

        function loadCampaignProgress() {
            debugLog('📊 Loading campaign progress...');
            const progressContainer = document.getElementById('progressContainer');
            if (progressContainer) {
                fetch('/api/campaigns/progress')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success && data.campaigns && data.campaigns.length > 0) {
                            displayCampaignProgress(data.campaigns);
                        } else {
                            progressContainer.innerHTML = `
                                <div class="text-center py-4">
                                    <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                                    <h6 class="text-muted">No active campaigns</h6>
                                    <p class="text-muted small">Campaign progress will appear here after sending.</p>
                                </div>
                            `;
                        }
                    })
                    .catch(error => {
                        debugLog('Campaign progress API not available, showing placeholder:', error.message);
                        progressContainer.innerHTML = `
                            <div class="text-center py-4">
                                <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                                <h6 class="text-muted">Campaign Progress</h6>
                                <p class="text-muted small">Progress tracking will be available after implementing campaign API.</p>
                            </div>
                        `;
                    });
            }
        }

        function displayCampaignProgress(campaigns) {
            const progressContainer = document.getElementById('progressContainer');
            const progressHtml = campaigns.map(campaign => `
                <div class="border rounded p-3 mb-2">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0">${campaign.name}</h6>
                        <span class="badge ${campaign.status === 'completed' ? 'bg-success' : 'bg-primary'}">${campaign.status}</span>
                    </div>
                    <div class="progress mb-2" style="height: 8px;">
                        <div class="progress-bar" style="width: ${campaign.progress || 0}%"></div>
                    </div>
                    <small class="text-muted">${campaign.sent_count || 0} sent • ${campaign.delivered_count || 0} delivered</small>
                </div>
            `).join('');
            
            progressContainer.innerHTML = progressHtml;
        }

        function syncMessages() {
            debugLog('🔄 Syncing messages...');
            showAlert('info', 'Message sync functionality will be implemented soon.');
        }

        function searchMessages() {
            const query = document.getElementById('messageSearch').value;
            debugLog('🔍 Searching messages for:', query);
            showAlert('info', 'Message search functionality will be implemented soon.');
        }

        function resetAllProgress() {
            if (confirm('Are you sure you want to reset all campaign progress? This action cannot be undone.')) {
                debugLog('🔄 Resetting all campaign progress...');
                showAlert('info', 'Progress reset functionality will be implemented soon.');
            }
        }

        // Helper function to show alerts
        function showAlert(type, message) {
            // Create alert element
            const alertId = 'campaign-alert-' + Date.now();
            const alertHtml = `
                <div id="${alertId}" class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;">
                    <strong>${type === 'success' ? 'Success!' : 'Error:'}</strong> ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            // Add to page
            document.body.insertAdjacentHTML('beforeend', alertHtml);
            
            // Auto-remove after 5 seconds
            setTimeout(() => {
                const alertElement = document.getElementById(alertId);
                if (alertElement) {
                    alertElement.remove();
                }
            }, 5000);
        }

        // Initialize page data when DOM is ready
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('Messaging page loaded - initializing data...');
            
            // Initialize Bootstrap tabs
            initializeBootstrapTabs();
            
            // Load all sections (with graceful fallbacks for missing APIs)
            loadStatusCampaigns();
            loadInbox();
            loadCampaignProgress();
            
            debugLog('All messaging data loaded!');
        });
</script>
{% endblock %}
