{% extends "base.html" %}

{% block title %}ClubOS Messaging Center - Anytime Fitness Dashboard{% endblock %}

{% block extra_css %}
<style>
    .message-item {
        transition: all 0.2s ease;
        border-left: 4px solid transparent;
        background: white;
        border-radius: var(--border-radius-medium);
        margin-bottom: 0.5rem;
        box-shadow: var(--shadow-2);
    }
    .message-item:hover {
        background-color: var(--af-gray-50);
        border-left-color: var(--af-purple-primary);
        cursor: pointer;
        box-shadow: var(--shadow-4);
    }
    .message-item.unread {
        background-color: #e3f2fd;
        border-left-color: var(--af-purple-primary);
    }
    .message-badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
        border-radius: var(--border-radius-small);
    }
    .campaign-card {
        transition: all 0.2s ease;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--shadow-2);
    }
    .campaign-card:hover {
        transform: translateY(-2px);
        box-shadow: var(--shadow-8);
    }
    .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid var(--af-purple-primary);
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
        margin: 0 auto;
    }
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    .message-content {
        max-height: 100px;
        overflow: hidden;
        text-overflow: ellipsis;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
    }
    .message-actions {
        opacity: 0;
        transition: opacity 0.2s ease;
    }
    .message-item:hover .message-actions {
        opacity: 1;
    }
    .fluent-card {
        background: white;
        border-radius: var(--border-radius-large);
        box-shadow: var(--shadow-4);
        border: none;
    }
    .fluent-header {
        background: linear-gradient(135deg, var(--af-purple-primary), var(--af-purple-dark));
        color: white;
        border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;
        padding: 1rem 1.5rem;
    }
    .btn-fluent-primary {
        background: var(--af-purple-primary);
        border: none;
        color: white;
        border-radius: var(--border-radius-medium);
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    .btn-fluent-primary:hover {
        background: var(--af-purple-dark);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-4);
    }
    .btn-fluent-outline {
        border: 1px solid var(--af-purple-primary);
        color: var(--af-purple-primary);
        background: transparent;
        border-radius: var(--border-radius-medium);
        padding: 0.5rem 1rem;
        transition: all 0.2s ease;
    }
    .btn-fluent-outline:hover {
        background: var(--af-purple-primary);
        color: white;
        transform: translateY(-1px);
        box-shadow: var(--shadow-4);
    }
</style>
{% endblock %}

{% block content %}
<!-- Header Section -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="h2 mb-1 fw-bold" style="color: var(--af-black-primary);">
            <i class="fas fa-comments me-2" style="color: var(--af-purple-primary);"></i>
            ClubOS Messaging Center
        </h1>
        <p class="text-muted mb-0">Marketing campaigns and message management</p>
    </div>
    <div class="d-flex gap-2">
        <button class="btn btn-fluent-outline" onclick="syncMessages()">
            <i class="fas fa-sync-alt me-1"></i>
            Sync Messages
        </button>
        <button class="btn btn-fluent-primary" onclick="createCampaign()">
            <i class="fas fa-plus me-1"></i>
            New Campaign
        </button>
    </div>
</div>

<!-- Main Content -->
<div class="row g-4">
    <!-- Marketing Campaigns -->
    <div class="col-md-6">
        <div class="fluent-card">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-bullhorn me-2"></i>
                    Marketing Campaigns
                </h5>
            </div>
            <div class="card-body p-3">
                <div id="campaignsContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading campaigns...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Campaign Progress Tracking -->
        <div class="fluent-card mt-4">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-chart-line me-2"></i>
                    Campaign Progress
                </h5>
                <button class="btn btn-sm btn-fluent-outline" onclick="loadCampaignProgress()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
            <div class="card-body p-3">
                <div id="progressContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading progress...</p>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-warning" onclick="resetAllProgress()">
                        <i class="fas fa-redo"></i> Reset All Progress
                    </button>
                    <small class="text-muted ms-2">Use to restart campaigns from beginning</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Message Inbox -->
    <div class="col-md-6">
        <div class="fluent-card">
            <div class="fluent-header">
                <h5 class="mb-0 fw-semibold">
                    <i class="fas fa-inbox me-2"></i>
                    Message Inbox
                </h5>
            </div>
            <div class="card-body p-3">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" class="form-control" id="messageSearch" placeholder="Search messages..." style="border-radius: var(--border-radius-medium);">
                        <button class="btn btn-fluent-outline" type="button" onclick="searchMessages()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="messagesContainer">
                    <div class="text-center py-4">
                        <div class="loading-spinner"></div>
                        <p class="text-muted mt-2">Loading messages...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Campaign Modal -->
<div class="modal fade" id="campaignModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: var(--border-radius-large);">
            <div class="modal-header" style="background: var(--af-purple-primary); color: white; border-radius: var(--border-radius-large) var(--border-radius-large) 0 0;">
                <h5 class="modal-title">
                    <i class="fas fa-bullhorn me-2"></i>
                    Create Marketing Campaign
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="campaignForm">
                    <div class="mb-3">
                        <label for="campaignName" class="form-label fw-semibold">Campaign Name</label>
                        <input type="text" class="form-control" id="campaignName" required style="border-radius: var(--border-radius-medium);">
                    </div>
                    <div class="mb-3">
                        <label for="campaignMessage" class="form-label fw-semibold">Message Content</label>
                        <textarea class="form-control" id="campaignMessage" rows="4" required style="border-radius: var(--border-radius-medium);"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="targetAudience" class="form-label fw-semibold">Target Audience</label>
                        <select class="form-select" id="targetAudience" required style="border-radius: var(--border-radius-medium);">
                            <option value="">Loading categories...</option>
                        </select>
                        <div class="form-text">
                            <small class="text-muted">Categories are loaded from your ClubHub member data</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="messageType" class="form-label fw-semibold">Message Type</label>
                        <select class="form-select" id="messageType" required style="border-radius: var(--border-radius-medium);">
                            <option value="sms">SMS Text Message</option>
                            <option value="email">Email Message</option>
                        </select>
                    </div>
                    <div class="mb-3" id="emailSubjectDiv" style="display: none;">
                        <label for="emailSubject" class="form-label fw-semibold">Email Subject</label>
                        <input type="text" class="form-control" id="emailSubject" style="border-radius: var(--border-radius-medium);">
                    </div>
                    <div class="mb-3">
                        <label for="recipientLimit" class="form-label fw-semibold">Max Recipients</label>
                        <input type="number" class="form-control" id="recipientLimit" value="100" min="1" max="1000" required style="border-radius: var(--border-radius-medium);">
                        <div class="form-text">
                            <small class="text-muted">Maximum number of people to send this campaign to (1-1000)</small>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="campaignNotes" class="form-label fw-semibold">Campaign Notes</label>
                        <textarea class="form-control" id="campaignNotes" rows="3" placeholder="Add notes about this campaign (internal use only)" style="border-radius: var(--border-radius-medium);"></textarea>
                        <div class="form-text">
                            <small class="text-muted">These notes are for your reference and won't be sent to recipients</small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-fluent-primary" onclick="saveCampaign()">
                    <i class="fas fa-paper-plane me-1"></i>
                    Send Campaign
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
        // Load data when page loads
document.addEventListener('DOMContentLoaded', function() {
            loadCampaigns();
    loadMessages();
    loadCampaignProgress();
        });

        function loadCampaigns() {
            fetch('/api/campaigns/history')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                        displayCampaigns(data.campaigns);
        } else {
                        displayCampaigns([]);
        }
    })
    .catch(error => {
                    console.error('Error loading campaigns:', error);
                    displayCampaigns([]);
                });
        }

        function displayCampaigns(campaigns) {
            const container = document.getElementById('campaignsContainer');
            
            if (campaigns.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-bullhorn fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No campaigns yet</h5>
                        <p class="text-muted">Create your first marketing campaign to get started.</p>
                        <button class="btn btn-fluent-primary" onclick="createCampaign()">
                            <i class="fas fa-plus me-1"></i>
                            Create Campaign
                        </button>
                    </div>
                `;
                return;
            }

            const campaignsHtml = campaigns.map(campaign => `
                <div class="campaign-card p-3 mb-3" style="background: white; border-radius: var(--border-radius-medium); box-shadow: var(--shadow-2);">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h6 class="mb-1 fw-semibold">${campaign.name || 'Untitled Campaign'}</h6>
                            <p class="text-muted small mb-2">${(campaign.message_text || '').substring(0, 100)}${(campaign.message_text || '').length > 100 ? '...' : ''}</p>
                            ${campaign.notes ? `<p class="text-info small mb-2"><i class="fas fa-sticky-note me-1"></i>${campaign.notes}</p>` : ''}
                            <div class="d-flex gap-2">
                                <span class="badge" style="background: var(--af-purple-primary);">${campaign.categories}</span>
                                <span class="badge bg-success">Sent</span>
                                <span class="badge bg-info">${campaign.successful_sends || 0}/${campaign.total_recipients || 0} sent</span>
                            </div>
                        </div>
                        <div class="text-end">
                            <small class="text-muted">${new Date(campaign.created_at).toLocaleDateString()}</small>
                        </div>
                    </div>
                </div>
            `).join('');

            container.innerHTML = campaignsHtml;
        }

        function loadMessages() {
            console.log('üîÑ Loading messages...');
            // Add cache-busting parameter to force fresh data
            fetch('/api/messages?t=' + Date.now())
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            displayMessages(data.messages);
        } else {
                        displayMessages([]);
        }
    })
    .catch(error => {
                    console.error('Error loading messages:', error);
                    displayMessages([]);
                });
        }

function displayMessages(messages) {
    const container = document.getElementById('messagesContainer');
    
            if (messages.length === 0) {
        container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                        <h5 class="text-muted">No messages</h5>
                        <p class="text-muted">Messages will appear here when received.</p>
            </div>
        `;
        return;
    }
    
            const messagesHtml = messages.map(message => {
                // Extract member name from message content
                console.log('Processing message:', message.content);
                const extractedName = extractMemberNameFromContent(message.content);
                console.log('Extracted name:', extractedName);
                console.log('Message member_id:', message.member_id);
                console.log('Message from_user:', message.from_user);
                const memberName = extractedName || message.member_id || message.from_user || 'Unknown';
                console.log('Final member name:', memberName);
                
                // Clean up the message content for display
                let displayContent = message.content;
                if (memberName && displayContent.startsWith(memberName)) {
                    // Remove the member name from the beginning of the content for cleaner display
                    displayContent = displayContent.substring(memberName.length).trim();
                }
                
                // Format timestamp
                const timestamp = new Date(message.timestamp);
                const timeString = timestamp.toLocaleDateString() + ' ' + timestamp.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                console.log(`üé® Rendering message for: ${memberName}`);
                return `
                    <div class="message-item p-3" onclick="goToMemberProfile('${memberName}')">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <div class="d-flex align-items-center mb-2">
                                    <div class="rounded-circle d-flex align-items-center justify-content-center me-2" 
                                         style="width: 36px; height: 36px; font-size: 14px; font-weight: bold; background: var(--af-purple-primary); color: white;">
                                        ${memberName.split(' ').map(n => n[0]).join('').toUpperCase()}
                                    </div>
                                    <div>
                                        <strong class="d-block fw-semibold" style="color: var(--af-black-primary);">${memberName}</strong>
                                        <small class="text-muted">${timeString}</small>
                                    </div>
                                </div>
                                <div class="message-content text-muted mb-2">
                                    ${displayContent || 'No message content'}
                                </div>
                                <div class="d-flex gap-1">
                                    ${message.is_confirmation ? '<span class="badge bg-success message-badge">‚úì Confirmed</span>' : ''}
                                    ${message.is_opt_in ? '<span class="badge message-badge" style="background: var(--af-purple-primary); color: white;">üì± Opt-in</span>' : ''}
                                    ${message.is_opt_out ? '<span class="badge bg-warning message-badge">üö´ Opt-out</span>' : ''}
                                    ${message.has_emoji ? '<span class="badge bg-info message-badge">üòä Emoji</span>' : ''}
                                </div>
                            </div>
                            <div class="message-actions">
                                <button class="btn btn-sm btn-fluent-outline" onclick="event.stopPropagation(); goToMemberProfile('${memberName}')">
                                    <i class="fas fa-user me-1"></i>
                                    View Profile
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = messagesHtml;
            console.log(`‚úÖ Rendered ${messages.length} messages with names`);
        }

        function searchMessages() {
            const query = document.getElementById('messageSearch').value;
            if (!query.trim()) {
                loadMessages();
                return;
            }

            fetch(`/api/messages/search?q=${encodeURIComponent(query)}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
                        displayMessages(data.messages);
        }
    })
    .catch(error => {
                    console.error('Error searching messages:', error);
                });
        }

        function syncMessages() {
            const button = event.target;
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Syncing...';
            button.disabled = true;

            fetch('/api/messages/sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ owner_id: '187032782' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    loadMessages();
                    showAlert('success', `Successfully synced ${data.stored_count} messages from ClubOS`);
                } else {
                    showAlert('danger', 'Error syncing messages');
                }
            })
            .catch(error => {
                console.error('Error syncing messages:', error);
                showAlert('danger', 'Error syncing messages');
            })
            .finally(() => {
                button.innerHTML = originalText;
                button.disabled = false;
            });
        }

        function createCampaign() {
            const modal = new bootstrap.Modal(document.getElementById('campaignModal'));
            
            // Load member categories when modal opens
            loadMemberCategories();
            
            // Handle message type change
            document.getElementById('messageType').addEventListener('change', function() {
                const emailSubjectDiv = document.getElementById('emailSubjectDiv');
                if (this.value === 'email') {
                    emailSubjectDiv.style.display = 'block';
                    document.getElementById('emailSubject').required = true;
                } else {
                    emailSubjectDiv.style.display = 'none';
                    document.getElementById('emailSubject').required = false;
                }
            });
            
            modal.show();
        }

        function loadMemberCategories() {
            console.log('üîÑ Loading member categories for campaign...');
            
            fetch('/api/members/categories')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        populateCategoryOptions(data.categories);
                    } else {
                        console.error('Failed to load categories:', data);
                        // Fallback to basic categories
                        populateFallbackCategories();
                    }
                })
                .catch(error => {
                    console.error('Error loading categories:', error);
                    // Fallback to basic categories
                    populateFallbackCategories();
                });
        }

        function populateCategoryOptions(categories) {
            const select = document.getElementById('targetAudience');
            select.innerHTML = '<option value="">Select audience...</option>';
            
            // Add "All Members" option first
            select.innerHTML += '<option value="all_members">All Members (All Categories)</option>';
            
            // Add each category with member count
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = `${category.label} (${category.count} members)`;
                select.appendChild(option);
            });
            
            // Add prospects option
            select.innerHTML += '<option value="prospects">Prospects</option>';
            
            console.log(`‚úÖ Loaded ${categories.length} member categories for campaign targeting`);
            
            // Remove the "required" attribute temporarily during loading and re-add it
            select.removeAttribute('required');
            setTimeout(() => {
                select.setAttribute('required', 'required');
            }, 100);
        }

        function populateFallbackCategories() {
            const select = document.getElementById('targetAudience');
            select.innerHTML = `
                <option value="">Select audience...</option>
                <option value="all_members">All Members</option>
                <option value="green">Green Status Members</option>
                <option value="past_due">Past Due Members</option>
                <option value="inactive">Inactive Members</option>
                <option value="active">Active Members</option>
                <option value="prospects">Prospects</option>
            `;
            console.log('‚ö†Ô∏è Using fallback categories due to API error');
        }

        function saveCampaign() {
            const form = document.getElementById('campaignForm');
            
            // Validate form
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const messageType = document.getElementById('messageType').value;
            const targetAudience = document.getElementById('targetAudience').value;
            
            // Validate that a target audience is selected
            if (!targetAudience || targetAudience === '') {
                showAlert('danger', 'Please select a target audience for your campaign.');
                return;
            }
            
            const campaignData = {
                name: document.getElementById('campaignName').value,
                message: document.getElementById('campaignMessage').value,
                type: messageType,
                categories: [targetAudience], // Convert to array for API
                max_recipients: parseInt(document.getElementById('recipientLimit').value) || 100,
                notes: document.getElementById('campaignNotes').value
            };
            
            // Add email subject if it's an email campaign
            if (messageType === 'email') {
                campaignData.subject = document.getElementById('emailSubject').value;
            }

            console.log('üì§ Sending campaign:', campaignData);

            // Show loading state
            const submitBtn = document.querySelector('#campaignModal .btn-fluent-primary');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Sending...';
            submitBtn.disabled = true;

            fetch('/api/campaigns/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(campaignData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    bootstrap.Modal.getInstance(document.getElementById('campaignModal')).hide();
                    loadCampaigns(); // Refresh campaigns list
                    loadCampaignProgress(); // Refresh progress tracking
                    
                    const results = data.campaign_results;
                    showAlert('success', 
                        `Campaign sent successfully! ` + 
                        `${results.successful}/${results.total} messages sent. ` +
                        (results.failed > 0 ? `${results.failed} failed.` : '')
                    );
                    
                    // Clear form
                    form.reset();
                } else {
                    console.error('Campaign error response:', data);
                    showAlert('danger', `Campaign failed: ${data.error || 'Unknown error'}`);
                }
            })
            .catch(error => {
                console.error('Error sending campaign:', error);
                showAlert('danger', `Error sending campaign: ${error.message || 'Network error'}`);
            })
            .finally(() => {
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            });
        }

        function extractMemberNameFromContent(content) {
            console.log('üîç extractMemberNameFromContent called with:', content);
            if (!content) {
                console.log('‚ùå No content provided');
                return null;
            }
            
            // Handle cases like "Susy MoncadaConfirmarAug 29" - extract just the name part
            const nameMatch = content.match(/^([A-Z][a-z]+ [A-Z][a-z]+)/);
            if (nameMatch) {
                const name = nameMatch[1];
                // Skip if it's a system word
                if (!/^(System|ClubOS|Confirm|Cancel|Reminder|Notification|Ok|Thanks|Yes|No)/i.test(name)) {
                    return name;
                }
            }
            
            // Fallback: try to find names at the beginning of the content
    const lines = content.split('\n');
    for (const line of lines) {
        const trimmed = line.trim();
        if (trimmed && trimmed.length > 3 && trimmed.length < 50) {
                    const nameMatch = trimmed.match(/^([A-Z][a-z]+ [A-Z][a-z]+)/);
                    if (nameMatch) {
                        const name = nameMatch[1];
                        if (!/^(System|ClubOS|Confirm|Cancel|Reminder|Notification|Ok|Thanks|Yes|No)/i.test(name)) {
                            return name;
                        }
                    }
                }
            }
            
            // Try to find any name pattern in the content
    const namePattern = /([A-Z][a-z]+ [A-Z][a-z]+)/g;
    const matches = content.match(namePattern);
    if (matches && matches.length > 0) {
        for (const match of matches) {
                    if (!/^(System|ClubOS|Confirm|Cancel|Reminder|Notification|Ok|Thanks|Yes|No)/i.test(match)) {
                return match;
            }
        }
    }
    
    return null;
}

function goToMemberProfile(memberName) {
            console.log(`üîç Searching for: ${memberName}`);
    
            // Search for the name in members
    fetch(`/api/members/search?q=${encodeURIComponent(memberName)}`)
    .then(response => response.json())
                .then(memberData => {
                    if (memberData.success && memberData.members && memberData.members.length > 0) {
                        // Found member - navigate to member page
                        const member = memberData.members[0];
                        const memberId = member.guid || member.prospect_id || member.id;
                        console.log(`‚úÖ Found member: ${member.full_name} (ID: ${memberId})`);
                        window.location.href = `/member/${memberId}`;
        return;
    }
    
                    // Not found in members, search prospects
                    return fetch('/api/prospects/all');
                })
                .then(prospectResponse => {
                    if (!prospectResponse) return; // Already handled member case
                    
                    return prospectResponse.json();
                })
                .then(prospectData => {
                    if (prospectData && prospectData.success && prospectData.prospects) {
                        // Search through prospects for the name
                        const prospect = prospectData.prospects.find(p => {
                            const fullName = `${p.firstName || ''} ${p.lastName || ''}`.trim();
                            return fullName.toLowerCase().includes(memberName.toLowerCase()) ||
                                   memberName.toLowerCase().includes(fullName.toLowerCase());
                        });
                        
                        if (prospect) {
                            // Found prospect - navigate to prospect page
                            const prospectId = prospect.prospect_id || prospect.id;
                            console.log(`‚úÖ Found prospect: ${prospect.firstName} ${prospect.lastName} (ID: ${prospectId})`);
                            window.location.href = `/prospect/${prospectId}`;
        return;
    }
                    }
                    
                    // Not found anywhere - show error
                    console.log(`‚ùå Not found: ${memberName}`);
                    // Don't show alert since navigation might still work
    })
    .catch(error => {
                    console.error('‚ùå Error searching:', error);
                    alert(`Error searching for ${memberName}`);
                });
        }

        function showAlert(type, message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 5000);
        }

        // Campaign Progress Functions
        function loadCampaignProgress() {
            fetch('/api/campaigns/progress')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        displayCampaignProgress(data.progress);
                    } else {
                        console.error('Error loading progress:', data.error);
                    }
                })
                .catch(error => {
                    console.error('Error loading campaign progress:', error);
                });
        }

        function displayCampaignProgress(progress) {
            const container = document.getElementById('progressContainer');
            
            if (progress.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-4">
                        <i class="fas fa-chart-line fa-2x text-muted mb-3"></i>
                        <p class="text-muted">No campaign progress yet</p>
                        <small class="text-muted">Progress will be tracked after sending campaigns</small>
                    </div>
                `;
                return;
            }
            
            const progressHtml = progress.map(item => {
                const lastDate = new Date(item.last_campaign_date);
                const dateString = lastDate.toLocaleDateString() + ' ' + lastDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                
                return `
                    <div class="progress-item p-3 mb-2" style="background: white; border-radius: var(--border-radius-medium); border-left: 4px solid var(--af-purple-primary);">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1 fw-semibold">${item.category}</h6>
                                <p class="mb-1 text-muted small">Last processed: Member ${item.last_processed_member_id} (Index ${item.last_processed_index})</p>
                                <p class="mb-0 text-muted small">Total in category: ${item.total_members_in_category}</p>
                            </div>
                            <div class="text-end">
                                <small class="text-muted">${dateString}</small>
                                <br>
                                <button class="btn btn-sm btn-outline-warning mt-1" onclick="resetCategoryProgress('${item.category}')">
                                    <i class="fas fa-redo"></i> Reset
                                </button>
                            </div>
                        </div>
                        <div class="mt-2">
                            <small class="text-muted">${item.notes || 'No notes'}</small>
                        </div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = progressHtml;
        }

        function resetCategoryProgress(category) {
            if (!confirm(`Reset campaign progress for "${category}"? Next campaign will start from the beginning.`)) {
                return;
            }
            
            fetch('/api/campaigns/reset-progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ category: category })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', `Campaign progress reset for ${category}`);
                    loadCampaignProgress();
                } else {
                    showAlert('error', 'Failed to reset progress: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error resetting progress:', error);
                showAlert('error', 'Failed to reset progress');
            });
        }

        function resetAllProgress() {
            if (!confirm('Reset ALL campaign progress? All campaigns will start from the beginning.')) {
                return;
            }
            
            fetch('/api/campaigns/reset-progress', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ category: 'all' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('success', 'All campaign progress reset');
                    loadCampaignProgress();
                } else {
                    showAlert('error', 'Failed to reset progress: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error resetting all progress:', error);
                showAlert('error', 'Failed to reset progress');
            });
        }

        // Search on Enter key
        document.getElementById('messageSearch').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                searchMessages();
            }
        });
</script>
{% endblock %}