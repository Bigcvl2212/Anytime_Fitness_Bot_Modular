{% extends "base.html" %}
{% block title %}My Credentials{% endblock %}
{% block page_title %}Manager Credentials{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-8 offset-md-2">
            <!-- Success/Error Messages -->
            {% if success_message %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
                <i class="fas fa-check-circle"></i> {{ success_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            {% if error_message %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                <i class="fas fa-exclamation-circle"></i> {{ error_message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}

            <!-- Credentials Form -->
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-key"></i> Your API Credentials</h5>
                    <small>These credentials are used to access ClubOS, ClubHub, and Square for your gym</small>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('admin.save_manager_credentials') }}" id="credentialsForm">
                        <!-- ClubOS Credentials -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-building"></i> ClubOS Credentials</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="clubos_username" class="form-label">ClubOS Username</label>
                                    <input type="text" class="form-control" id="clubos_username" name="clubos_username"
                                           value="{{ credentials.clubos_username or '' }}" required>
                                    <small class="form-text text-muted">Your ClubOS login username</small>
                                </div>
                                <div class="mb-3">
                                    <label for="clubos_password" class="form-label">ClubOS Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="clubos_password" name="clubos_password"
                                               value="{{ credentials.clubos_password or '' }}" required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('clubos_password')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Your ClubOS login password</small>
                                </div>
                            </div>
                        </div>

                        <!-- ClubHub Credentials -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-users"></i> ClubHub Credentials</h6>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="clubhub_email" class="form-label">ClubHub Email</label>
                                    <input type="email" class="form-control" id="clubhub_email" name="clubhub_email"
                                           value="{{ credentials.clubhub_email or '' }}" required>
                                    <small class="form-text text-muted">Your ClubHub login email</small>
                                </div>
                                <div class="mb-3">
                                    <label for="clubhub_password" class="form-label">ClubHub Password</label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="clubhub_password" name="clubhub_password"
                                               value="{{ credentials.clubhub_password or '' }}" required>
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('clubhub_password')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">Your ClubHub login password</small>
                                </div>
                            </div>
                        </div>

                        <!-- Square Credentials -->
                        <div class="card mb-4">
                            <div class="card-header bg-light">
                                <h6 class="mb-0"><i class="fas fa-credit-card"></i> Square Credentials</h6>
                            </div>
                            <div class="card-body">
                                <!-- Help Alert -->
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Need help getting your Square token?</h6>
                                    <button type="button" class="btn btn-sm btn-primary mt-2" data-bs-toggle="modal" data-bs-target="#squareHelpModal">
                                        üìñ Click here for step-by-step instructions
                                    </button>
                                </div>

                                <div class="mb-3">
                                    <label for="square_access_token" class="form-label">
                                        Square Access Token
                                        <span class="badge bg-warning text-dark">Required</span>
                                    </label>
                                    <div class="input-group">
                                        <input type="password" class="form-control" id="square_access_token" name="square_access_token"
                                               value="{{ credentials.square_access_token or '' }}" required
                                               placeholder="Starts with EAA...">
                                        <button class="btn btn-outline-secondary" type="button" onclick="togglePassword('square_access_token')">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                    </div>
                                    <small class="form-text text-muted">
                                        <a href="https://developer.squareup.com/apps" target="_blank" class="text-decoration-none">
                                            üîó Open Square Developer Dashboard
                                        </a>
                                    </small>
                                </div>
                                <div class="mb-3">
                                    <label for="square_location_id" class="form-label">
                                        Square Location ID
                                        <span class="badge bg-warning text-dark">Required</span>
                                    </label>
                                    <input type="text" class="form-control" id="square_location_id" name="square_location_id"
                                           value="{{ credentials.square_location_id or '' }}" required
                                           placeholder="e.g., L1234ABCD5678">
                                    <small class="form-text text-muted">Found in the same place as your Access Token</small>
                                </div>
                            </div>
                        </div>

                        <!-- Submit Buttons -->
                        <div class="d-flex justify-content-between">
                            <button type="button" class="btn btn-secondary" onclick="testCredentials()">
                                <i class="fas fa-vial"></i> Test Credentials
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Credentials
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Security Notice -->
            <div class="alert alert-info mt-4">
                <i class="fas fa-shield-alt"></i> <strong>Security Notice:</strong>
                Your credentials are encrypted and stored securely. They are only accessible when you're logged in
                and are never shared with other managers.
            </div>
        </div>
    </div>
</div>

<!-- Square Help Modal -->
<div class="modal fade" id="squareHelpModal" tabindex="-1" aria-labelledby="squareHelpModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="squareHelpModalLabel">
                    <i class="fas fa-graduation-cap"></i> How to Get Your Square Access Token
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <strong>‚è±Ô∏è This takes about 2-3 minutes!</strong> Don't worry, it's easier than it sounds.
                </div>

                <h6 class="mt-3"><strong>Step 1: Log into Square Developer Portal</strong></h6>
                <ol>
                    <li>Open this link in a new tab:
                        <a href="https://developer.squareup.com/apps" target="_blank" class="btn btn-sm btn-outline-primary">
                            üîó Square Developer Dashboard
                        </a>
                    </li>
                    <li>Log in with your <strong>normal Square email and password</strong> (the one you use to run your business)</li>
                    <li>If prompted, click "Allow" to access the developer portal</li>
                </ol>

                <hr>

                <h6><strong>Step 2: Create or Select Your App</strong></h6>
                <ol>
                    <li>You'll see a list of apps (or it might be empty)</li>
                    <li>If you already have an app called "Gym Bot" or similar, click on it</li>
                    <li>If not, click <strong>"Create App"</strong>:
                        <ul>
                            <li>App Name: "Gym Bot" (or anything you want)</li>
                            <li>Click "Save"</li>
                        </ul>
                    </li>
                </ol>

                <hr>

                <h6><strong>Step 3: Get Your Access Token</strong></h6>
                <ol>
                    <li>In your app, click <strong>"Credentials"</strong> in the left menu</li>
                    <li>You'll see two sections: "Sandbox" and "Production"</li>
                    <li>Look for <strong>"Production"</strong> section</li>
                    <li>Find <strong>"Access Token"</strong> - it starts with "EAA..."</li>
                    <li>Click the <strong>üëÅÔ∏è "Show"</strong> button to reveal it</li>
                    <li><strong>Copy the entire token</strong> (it's long - about 60 characters)</li>
                    <li>Paste it into the "Square Access Token" field above ‚òùÔ∏è</li>
                </ol>

                <div class="alert alert-warning">
                    <strong>‚ö†Ô∏è Important:</strong> Use the <strong>PRODUCTION</strong> token, not Sandbox!
                </div>

                <hr>

                <h6><strong>Step 4: Get Your Location ID</strong></h6>
                <ol>
                    <li>Still in the Credentials page, scroll down a bit</li>
                    <li>Find <strong>"Location ID"</strong> under Production</li>
                    <li>It looks like: <code>L1234ABCD5678</code></li>
                    <li><strong>Copy it</strong> and paste into the "Square Location ID" field above ‚òùÔ∏è</li>
                </ol>

                <hr>

                <div class="alert alert-success">
                    <h6><strong>‚úÖ You're Done!</strong></h6>
                    <p class="mb-0">Now just paste those two values into the form above and click "Save Credentials"</p>
                </div>

                <hr>

                <h6><strong>‚ùì Common Issues</strong></h6>
                <div class="accordion" id="helpAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                I don't see "Production" - only "Sandbox"
                            </button>
                        </h2>
                        <div id="help1" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                Your Square account needs to be activated for production. Contact Square support or check your account status.
                                In the meantime, you can use Sandbox tokens for testing (but they won't work with real transactions).
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                I can't find the Credentials page
                            </button>
                        </h2>
                        <div id="help2" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                Make sure you clicked on your app name first. The left sidebar should show: Overview, Credentials, OAuth, etc.
                                If you don't see it, try refreshing the page or logging out and back in.
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                The token is too long to copy
                            </button>
                        </h2>
                        <div id="help3" class="accordion-collapse collapse" data-bs-parent="#helpAccordion">
                            <div class="accordion-body">
                                Click the "Show" button, then triple-click on the token to select all of it. Press Ctrl+C (Windows) or Cmd+C (Mac) to copy.
                                Make sure you get the entire thing - it should start with "EAA" and be about 60 characters long.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <a href="https://developer.squareup.com/apps" target="_blank" class="btn btn-primary">
                    üöÄ Open Square Developer Portal
                </a>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<script>
function togglePassword(fieldId) {
    const field = document.getElementById(fieldId);
    const button = field.nextElementSibling;
    const icon = button.querySelector('i');

    if (field.type === 'password') {
        field.type = 'text';
        icon.classList.remove('fa-eye');
        icon.classList.add('fa-eye-slash');
    } else {
        field.type = 'password';
        icon.classList.remove('fa-eye-slash');
        icon.classList.add('fa-eye');
    }
}

function testCredentials() {
    const formData = new FormData(document.getElementById('credentialsForm'));

    fetch('/admin/test_credentials', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('‚úÖ Credentials test successful!\n\n' + data.message);
        } else {
            alert('‚ùå Credentials test failed:\n\n' + data.message);
        }
    })
    .catch(error => {
        alert('‚ùå Error testing credentials: ' + error);
    });
}
</script>
{% endblock %}
